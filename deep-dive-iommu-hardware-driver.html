<!DOCTYPE html>
<html lang="zh_cn">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="duma" />

        <meta name="description" content="ç¡¬ä»¶æ¶æ„ ä¸ºäº†è®©å¤§å®¶å¯¹iommuæœ‰ä¸ªç›´è§‚çš„è®¤è¯†ï¼Œæˆ‘ä»¬å…ˆä»ç¡¬ä»¶æ¶æ„ä¸Šçœ‹ä¸€ä¸‹iommuæ˜¯ä¸ªä»€ä¹ˆä¸œä¸œã€‚ å›¾1 å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œiommuå°±æ˜¯ä¸Šå›¾æ‰€å±•ç¤ºçš„DMA Remapping Unitï¼Œé€šå¸¸ä¸€å°ç¡¬ä»¶æœåŠ¡å™¨ä¸Šä¼šæœ‰å¤šä¸ªDMA Remapping â€¦
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="iommu, articles, " />
        <title>æ·±å…¥äº†è§£iommuç³»åˆ—ä¸€ï¼šiommuç¡¬ä»¶æ¶æ„å’Œé©±åŠ¨åˆå§‹åŒ–  Â· KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link href="https://kernelnote.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢ - Full Atom Feed" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LRRMJ08SPD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LRRMJ08SPD');
</script>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./pages/about.html">about</a></li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<!-- æ–‡ç« å¤´éƒ¨åŒºåŸŸ -->
<header class="article-header">
    <div class="article-header-container">
        <!-- ä½œè€…ä¿¡æ¯åŒºåŸŸ -->
        <div class="article-author-section">
            <img src="./images/wechat.jpeg" alt="å‘¨æ¯…åš" class="author-avatar">
            <div class="author-info">
                <h3 class="author-name">å‘¨å®œæ³¢</h3>
                <p class="author-title">AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆ | AI Agentä¸“å®¶</p>
            </div>
        </div>

        <!-- æ–‡ç« æ ‡é¢˜å’Œå…ƒä¿¡æ¯ -->
        <div class="article-meta-section">
            <h1 class="article-title">
                æ·±å…¥äº†è§£iommuç³»åˆ—ä¸€ï¼šiommuç¡¬ä»¶æ¶æ„å’Œé©±åŠ¨åˆå§‹åŒ–
            </h1>

            <div class="article-meta-info">
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“…</span>
                    <time datetime="2022-01-18T20:14:00+08:00">äºŒ 18 ä¸€æœˆ 2022</time>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“</span>
                    <span class="category-tag">articles</span>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ·ï¸</span>
                    <span class="article-tag">iommu</span>
                </div>
            </div>

            <!-- å¤šåª’ä½“é“¾æ¥åŒºåŸŸ -->
        </div>
    </div>
</header>

<!-- æ–‡ç« ä¸»ä½“å†…å®¹ -->
<div class="article-container">
    <div class="article-main">
        <!-- æ–‡ç« å†…å®¹ -->
            <main class="article-content article-content-no-toc">
                
                <h4>ç¡¬ä»¶æ¶æ„</h4>
<p>ä¸ºäº†è®©å¤§å®¶å¯¹iommuæœ‰ä¸ªç›´è§‚çš„è®¤è¯†ï¼Œæˆ‘ä»¬å…ˆä»ç¡¬ä»¶æ¶æ„ä¸Šçœ‹ä¸€ä¸‹iommuæ˜¯ä¸ªä»€ä¹ˆä¸œä¸œã€‚</p>
<p><img alt="iommu" src="images/iommu.png">
<center>å›¾1 </center></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œiommuå°±æ˜¯ä¸Šå›¾æ‰€å±•ç¤ºçš„DMA Remapping Unitï¼Œé€šå¸¸ä¸€å°ç¡¬ä»¶æœåŠ¡å™¨ä¸Šä¼šæœ‰å¤šä¸ªDMA Remapping Unitï¼Œå®ƒä¸‹é¢å¯ä»¥å¯¹æ¥pcieè®¾å¤‡ï¼Œä¹Ÿå¯ä»¥å¯¹æ¥ioapic, HPETè®¾å¤‡ã€‚åœ¨åé¢çš„è¡Œæ–‡å½“ä¸­ç»Ÿä¸€ç®€ç§°ä¸ºDMARï¼Œé€šå¸¸DMA Remapping Unité›†æˆåœ¨Root Complexå½“ä¸­ï¼Œç³»ç»Ÿå½“ä¸­æ‰€æœ‰çš„å¤–è®¾çš„DMAæ“ä½œç†è®ºä¸Šéƒ½è¦ç»è¿‡DMAR(ä¾‹å¤–å°±æ˜¯åœ¨p2pé€šä¿¡çš„åœºæ™¯ä¸‹ä¸”pcie switch å¼€äº†ATSåŠŸèƒ½é‚£å°±ä¸ç”¨å†åˆ°DMARè½¬ä¸€åœˆäº†)ã€‚ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªpciè®¾å¤‡åœ¨æœ‰iommuçš„åœºæ™¯ä¸‹å…¶è¿›è¡Œä¸€æ¬¡read dmaæ“ä½œçš„ç›¸å…³æµç¨‹ã€‚</p>
<p><img alt="mem_read" src="images/mem_read.png">
<center>å›¾2 </center></p>
<p>åœ¨è™šæ‹ŸåŒ–å‡ºç°ä¹‹å‰ï¼Œ iommuç¡¬ä»¶ä¸»è¦åŠŸèƒ½å°±æ˜¯å°†iovaè½¬æ¢æˆhpaï¼Œå®ƒçš„å‡ºç°ä¸»è¦è§£å†³äº†ä¸¤ä¸ªé—®é¢˜ã€‚ä¸€ä¸ªæ˜¯<strong>è®©åªæœ‰32ä½DMAèƒ½åŠ›çš„è®¾å¤‡èƒ½å¤Ÿè®¿é—®å¤§äº4Gä»¥ä¸Šçš„å†…å­˜åœ°å€ç©ºé—´</strong>ï¼Œè¿™ä¸ªå¸¦æ¥çš„æ”¶ç›Šæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚ä½ çš„ç³»ç»Ÿæœ‰6Gçš„å†…å­˜ï¼Œä½ æŒ‚äº†ä¸€ä¸ª32ä½DMAèƒ½åŠ›çš„å¤–è®¾ï¼Œå¦‚æœä½ åœ¨é©±åŠ¨é‡Œé¢åˆ†é…äº†ä¸€ä¸ªåœ¨4Gä»¥ä¸Šçš„bufferï¼Œè¿™ä¸ªæ—¶å€™ç”±äºç¡¬ä»¶ä¸èƒ½ç›´æ¥dmaè¿™ä¸ªbufferï¼Œå› æ­¤ä½ éœ€è¦åœ¨ä½äº4Gçš„ç©ºé—´åˆ†é…ä¸€ä¸ªtmp bufferè®©ç¡¬ä»¶å…ˆæŠŠæ•°æ®dmaåˆ°è¿™ä¸ªtmp bufferä¸Šï¼Œç„¶åä½ å†ä»è¿™ä¸ªtmp bufferæŠŠæ•°æ®copyåˆ°ä½ çš„dst bufferä¸Šã€‚ä½ çœ‹è¿™æ ·ä¸€æ¥äºŒå»æ•ˆç‡å°±å˜çš„æä¸ºä½ä¸‹ï¼Œè€Œä¸”å¯¹å¼€å‘è€…æ¥è¯´ä¹Ÿéå¸¸çš„ä¸å‹å¥½ã€‚å¦‚æœæœ‰äº†iommuè¿™ä¸ªäº‹æƒ…å°±æ¯”è¾ƒå¥½è§£å†³ï¼Œç›´æ¥æŠŠiovaæ˜ å°„è¿™ä¸ªdst bufferä¸Šå°±è§£å†³äº†ã€‚</p>
<p>å¼•å…¥iommuçš„å¦å¤–ä¸€ä¸ªæ”¶ç›Šå°±æ˜¯å¯ä»¥æŠŠ<strong>å¤šä¸ªåˆ†æ•£çš„dmaæ“ä½œèšåˆæˆä¸€ä¸ªè¿ç»­çš„DMAæ“ä½œ</strong>ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œé©±åŠ¨ç¨‹åºå¯èƒ½åˆ†é…ä¸¤ä¸ªå¤§å°ä¸º4KBçš„ä¸”åœ¨ç‰©ç†å†…å­˜åœ°å€ä¸Šä¸è¿ç»­çš„bufferï¼Œé‚£ä¹ˆé€šè¿‡dma_map_sgtableè¿™æ ·çš„apiå¯ä»¥ç›´æ¥æŠŠå®ƒä»¬åˆå¹¶æˆä¸€ä¸ª8KBçš„åœ¨iovaä¸Šæ˜¯è¿ç»­çš„DMAæ“ä½œï¼Œè¿™æ ·ä¸€æ¥åŸæ¥éœ€è¦ä¸¤æ¬¡DMAæ“ä½œç°åœ¨åªéœ€è¦ä¸€æ¬¡æ“ä½œå°±æå®šäº†ã€‚</p>
<p>éšç€è™šæ‹ŸåŒ–æŠ€æœ¯åœ¨æ•°æ®ä¸­å¿ƒå¤§è§„æ¨¡çš„ä½¿ç”¨ï¼Œiommuçš„ä¸»è¦ä½œç”¨ä¹Ÿç”±åŸæ¥å•æ–¹é¢çš„è½¬æ¢åŠŸèƒ½å˜æˆäº†è½¬æ¢åŠ éš”ç¦»ã€‚åœ¨sriovåœºæ™¯iommuçš„éš”ç¦»ä½œç”¨ä¸»è¦ä½“ç°åœ¨é¿å…ç›´é€šç»™è™šæ‹ŸæœºAçš„å¤–è®¾DMAåˆ°è™šæ‹ŸæœºBçš„å†…å­˜ï¼Œä¹‹æ‰€ä»¥èƒ½åšåˆ°è¿™ä¸€ç‚¹è¿˜è¦åˆ©ç›Šäºpcieåè®®åœ¨tlpä¸Šçš„å¢å¼ºï¼Œåœ¨pcieåœºæ™¯ä¸‹æ¯ä¸ªå¤–è®¾å‘å‡ºçš„dmaè¯·æ±‚éƒ½æ‰“ä¸Šäº†ä¸è¿™ä¸ªè®¾å¤‡ç›¸å…³è”çš„å…·æœ‰å”¯ä¸€æ€§çš„flagä¹Ÿå³è®¾å¤‡çš„bdfå·ï¼Œè€Œé€šè¿‡è¿™ä¸ªbdfå·å¯ä»¥ç´¢å¼•åˆ°è¿™ä¸ªè®¾å¤‡çš„iovaè½¬æ¢è¡¨ã€‚è¿™ä¸€ç‚¹æ˜¯æ—©æœŸpciåè®®æ˜¯æ— æ³•å®ç°çš„ï¼Œå› ä¸ºæ—©æœŸpciè®¾å¤‡æ˜¯é€šè¿‡ä»²è£æœºåˆ¶æ¥å®ç°å¯¹pciæ€»çº¿çš„ç‹¬å çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªpciè®¾å¤‡èƒ½ä½¿ç”¨pciæ€»çº¿ï¼Œå› æ­¤åœ¨è¿™ç§æƒ…å†µpciè®¾å¤‡çš„dmaè¯·æ±‚å½“ä¸­æ˜¯æ²¡æœ‰bdfå·çš„ã€‚</p>
<h4>iommuç¡¬ä»¶ä½¿èƒ½</h4>
<p>åœ¨æœåŠ¡å™¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œbiosé€šè¿‡DMAR ACPI è¡¨æ¥æ£€æµ‹iommuç¡¬ä»¶ï¼Œè¿™å¼ è¡¨çš„å…·ä½“ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img alt="dmar_acpi_table" src="images/dmar_acpi_table.png">
<center>å›¾3 </center></p>
<p><img alt="dmar_acpi_table2" src="images/dmar_acpi_table2.png">
<center>å›¾4 </center></p>
<p>è€Œåœ¨remapping structuresè¿™ä¸ªlisté‡Œé¢ç›®å‰æ”¯æŒ5ç§ç±»å‹ä¿¡æ¯ï¼š</p>
<p><img alt="rmap_structure" src="images/rmap_structure.png"></p>
<p>è€Œ drhdè¿™ä¸ªå°±æ˜¯ç”¨æ¥æè¿°çœŸå®çš„iommuç¡¬ä»¶çš„ç»“æ„ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹drhd format</p>
<p><img alt="drhd" src="images/drhd.png">
<center>å›¾5 </center></p>
<p>ç»“åˆä¸Šé¢çš„å›¾æˆ‘ä»¬é‡ç‚¹ä»‹ç»å‡ ä¸ªFieldï¼Œä¸€ä¸ªæ˜¯segment numberä½ å¯ä»¥ç†è§£ä¸ºä¸æŸä¸ªdma remapping unitå…³è”çš„pci domainï¼›ä¸€ä¸ªæ˜¯device scopeä¹Ÿå°±æ˜¯æ–‡ç« å¼€å¤´æ‰€æè¿°çš„æ¯ä¸ªdmar unitä¸‹å¯ä»¥å…³è”ä¸åŒçš„è®¾å¤‡ï¼›ä¸€ä¸ªæ˜¯INCLUDE_PCI_ALLè¿™ä¸ªæ ‡å¿—ä½ï¼Œå½“è¿™ä¸ªbitè¢«è®¾ç½®ä¸Šæ—¶é©±åŠ¨ä¼šæ‰«æpcie busä¸‹é¢çš„æ‰€æœ‰è®¾å¤‡å¹¶æŠŠè¿™äº›è®¾å¤‡è·Ÿè¿™ä¸ªdmar unit å…³è”èµ·æ¥ï¼Œå¦‚æœè¿™ä¸ªbitæ²¡æœ‰è®¾ç½®ä¸Šåˆ™é©±åŠ¨éœ€è¦è§£ædevice scope ç„¶åæŠŠè¿™ä¸ªscopeä¸‹é¢çš„è®¾å¤‡è·Ÿè¿™ä¸ªdmar unitå…³è”èµ·æ¥ã€‚æœ€åä¸€ä¸ªå°±æ˜¯register base addresså®ƒå®šä¹‰ä¸€ç³»åˆ—çš„registerã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹é©±åŠ¨é‡Œé¢ä¸ä¹‹ç›¸å¯¹åº”çš„ç»“æ„ä½“çš„å®šä¹‰ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="nx">struct</span><span class="w"> </span><span class="nx">dmar_drhd_unit</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">struct</span><span class="w"> </span><span class="nx">list_head</span><span class="w"> </span><span class="nx">list</span><span class="p">;</span><span class="w">          </span><span class="cm">/* list of drhd units   */</span>
<span class="w">        </span><span class="nx">struct</span><span class="w">  </span><span class="nx">acpi_dmar_header</span><span class="w"> </span><span class="o">*</span><span class="nx">hdr</span><span class="p">;</span><span class="w">  </span><span class="cm">/* ACPI header          */</span>
<span class="w">        </span><span class="kt">u64</span><span class="w">     </span><span class="nx">reg_base_addr</span><span class="p">;</span><span class="w">          </span><span class="cm">/* register base address*/</span>
<span class="w">        </span><span class="nx">struct</span><span class="w">  </span><span class="nx">dmar_dev_scope</span><span class="w"> </span><span class="o">*</span><span class="nx">devices</span><span class="p">;</span><span class="cm">/* target device array  */</span>
<span class="w">        </span><span class="nx">int</span><span class="w">     </span><span class="nx">devices_cnt</span><span class="p">;</span><span class="w">            </span><span class="cm">/* target device count  */</span>
<span class="w">        </span><span class="kt">u16</span><span class="w">     </span><span class="nx">segment</span><span class="p">;</span><span class="w">                </span><span class="cm">/* PCI domain           */</span>
<span class="w">        </span><span class="kt">u8</span><span class="w">      </span><span class="nx">ignored</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span><span class="w">              </span><span class="cm">/* ignore drhd          */</span>
<span class="w">        </span><span class="kt">u8</span><span class="w">      </span><span class="nx">include_all</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="nx">struct</span><span class="w"> </span><span class="nx">intel_iommu</span><span class="w"> </span><span class="o">*</span><span class="nx">iommu</span><span class="p">;</span>
<span class="p">};</span><span class="w"> </span>
</code></pre></div>

<p>å…¶ä¸­ï¼Œstruct intel_iommu æ˜¯å¯¹iommuç¡¬ä»¶çš„ä¸€ä¸ªæŠ½è±¡ï¼Œå…¶åœ¨å†…æ ¸é‡Œé¢çš„ç›¸å…³å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">intel_iommu</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="n">__iomem</span><span class="w">    </span><span class="o">*</span><span class="n">reg</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Pointer to hardware regs, virtual addr */</span>
<span class="w">        </span><span class="n">u64</span><span class="w">             </span><span class="n">reg_phys</span><span class="p">;</span><span class="w"> </span><span class="cm">/* physical address of hw register set */</span>
<span class="w">        </span><span class="n">u64</span><span class="w">             </span><span class="n">reg_size</span><span class="p">;</span><span class="w"> </span><span class="cm">/* size of hw register set */</span>
<span class="w">        </span><span class="n">u64</span><span class="w">             </span><span class="n">cap</span><span class="p">;</span>
<span class="w">        </span><span class="n">u64</span><span class="w">             </span><span class="n">ecap</span><span class="p">;</span>
<span class="w">        </span><span class="n">u32</span><span class="w">             </span><span class="n">gcmd</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Holds TE, EAFL. Don&#39;t need SRTP, SFL, WBF */</span>
<span class="w">        </span><span class="n">raw_spinlock_t</span><span class="w">  </span><span class="n">register_lock</span><span class="p">;</span><span class="w"> </span><span class="cm">/* protect register handling */</span>
<span class="w">        </span><span class="kt">int</span><span class="w">             </span><span class="n">seq_id</span><span class="p">;</span><span class="w"> </span><span class="cm">/* sequence id of the iommu */</span>
<span class="w">        </span><span class="kt">int</span><span class="w">             </span><span class="n">agaw</span><span class="p">;</span><span class="w"> </span><span class="cm">/* agaw of this iommu */</span>
<span class="w">        </span><span class="kt">int</span><span class="w">             </span><span class="n">msagaw</span><span class="p">;</span><span class="w"> </span><span class="cm">/* max sagaw of this iommu */</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="n">pr_irq</span><span class="p">;</span>
<span class="w">        </span><span class="n">u16</span><span class="w">             </span><span class="n">segment</span><span class="p">;</span><span class="w">     </span><span class="cm">/* PCI segment# */</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">   </span><span class="n">name</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span><span class="w">    </span><span class="cm">/* Device Name */</span>

<span class="cp">#ifdef CONFIG_INTEL_IOMMU</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">   </span><span class="o">*</span><span class="n">domain_ids</span><span class="p">;</span><span class="w"> </span><span class="cm">/* bitmap of domains */</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">dmar_domain</span><span class="w"> </span><span class="o">***</span><span class="n">domains</span><span class="p">;</span><span class="w"> </span><span class="cm">/* ptr to domains */</span>
<span class="w">        </span><span class="n">spinlock_t</span><span class="w">      </span><span class="n">lock</span><span class="p">;</span><span class="w"> </span><span class="cm">/* protect context, domain ids*/</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">root_entry</span><span class="w"> </span><span class="o">*</span><span class="n">root_entry</span><span class="p">;</span><span class="w"> </span><span class="cm">/* virtual address */</span>
<span class="w">        </span><span class="p">.......</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>å…¶ä¸­çš„dmar_domainå’Œroot_entryå°†åœ¨iovaåˆ°hpaçš„è½¬æ¢å½“ä¸­èµ·åˆ°éå¸¸é‡è¦çš„ä½œç”¨ï¼Œè¿™é‡Œå¤§å®¶å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä¸€å¼ å›¾å…ˆæœ‰ä¸ªæ•´ä½“çš„è®¤çŸ¥</p>
<p><img alt="iotlb" src="images/iotlb.png">
<center>å›¾6 </center></p>
<p>ä¸Šå›¾å±•ç¤ºçš„æ˜¯å¦‚ä½•ä½¿ç”¨bdfå·æ‰¾åˆ°ç›¸åº”çš„iovaè½¬æ¢è¡¨ä»¥åŠè¿›è¡Œåœ°å€è½¬æ¢çš„æµç¨‹ï¼Œç›¸å…³çš„ç»†èŠ‚æˆ‘ä»¬å°†åœ¨ä¸‹é¢çš„è¡Œæ–‡å½“ä¸­è¯¦ç»†ä»‹ç»ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹iommuä»å‘ç°åˆ°åˆå§‹åŒ–çš„æ•´ä¸ªæµç¨‹æ˜¯æ€ä¹ˆæ ·çš„ã€‚intel iommuçš„å‘ç°æ˜¯ä»IOMMU_INIT_POST(detect_intel_iommu)è¿™ä¸ªåœ°æ–¹å¼€å§‹çš„ï¼Œæˆ‘ä»¬å…ˆæ¥å…ˆçœ‹ä¸€ä¸Šdetect_intel_iommuè¿™ä¸ªå‡½æ•°å…·ä½“åšäº†å“ªäº›äº‹æƒ…ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="nc">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="n">detect_intel_iommu</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">        </span><span class="nc">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">        </span><span class="n">struct</span><span class="w"> </span><span class="n">dmar_res_callback</span><span class="w"> </span><span class="n">validate_drhd_cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="p">.</span><span class="n">cb</span><span class="o">[</span><span class="n">ACPI_DMAR_TYPE_HARDWARE_UNIT</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dmar_validate_one_drhd</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">ignore_unhandled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">        </span><span class="err">}</span><span class="p">;</span>

<span class="w">        </span><span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmar_global_lock</span><span class="p">);</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dmar_table_detect</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">                </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">!</span><span class="n">dmar_walk_dmar_table</span><span class="p">((</span><span class="n">struct</span><span class="w"> </span><span class="n">acpi_table_dmar</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">dmar_tbl</span><span class="p">,</span>
<span class="w">                                            </span><span class="o">&amp;</span><span class="n">validate_drhd_cb</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="err">!</span><span class="n">no_iommu</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="err">!</span><span class="n">iommu_detected</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="err">!</span><span class="n">dmar_disabled</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="n">iommu_detected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="cm">/* Make sure ACS will be enabled */</span>
<span class="w">                </span><span class="n">pci_request_acs</span><span class="p">();</span>
<span class="w">        </span><span class="err">}</span>

<span class="n">#ifdef</span><span class="w"> </span><span class="n">CONFIG_X86</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">                </span><span class="n">x86_init</span><span class="p">.</span><span class="n">iommu</span><span class="p">.</span><span class="n">iommu_init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intel_iommu_init</span><span class="p">;</span>
<span class="n">#endif</span>

<span class="w">        </span><span class="n">early_acpi_os_unmap_memory</span><span class="p">((</span><span class="n">void</span><span class="w"> </span><span class="n">__iomem</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">dmar_tbl</span><span class="p">,</span><span class="w"> </span><span class="n">dmar_tbl_size</span><span class="p">);</span>
<span class="w">        </span><span class="n">dmar_tbl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmar_global_lock</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="vm">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div>

<p>è¿™ä¸ªå‡½æ•°ä¸»è¦ä½œç”¨å°±æ˜¯è·å–dmar acpiè¡¨ï¼Œç„¶åè§£æè¡¨é‡Œé¢çš„ç›¸å…³ä¿¡æ¯å¦‚æœè¡¨é‡Œé¢remapping structureä¸ºdrhdåˆ™é€šè¿‡cbå‡½æ•°æ¥éªŒè¯dma remapping hardware unitæ˜¯å¦å¯ç”¨ï¼Œå…·ä½“å¤§å®¶å¯ä»¥å»çœ‹ä¸€ä¸‹<code>dmar_validate_one_dh</code>ç›¸å…³å®ç°è¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚è¿˜æœ‰å°±æ˜¯æŒ‡å®šiommu_initå‡½æ•°å…¥å£ä¸ºintel_iommu_initã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°é‡Œé¢ä¸»è¦åšäº†å“ªäº›äº‹æƒ…ã€‚</p>
<ul>
<li>iommu_init_mempool</li>
</ul>
<p>ä¸ºiova, iommu_dmoain, devinfoåˆ›å»ºå†…å­˜æ± </p>
<ul>
<li>dmar_table_init</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">struct</span><span class="w"> </span><span class="n">dmar_res_callback</span><span class="w"> </span><span class="n">cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="p">.</span><span class="n">print_entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">ignore_unhandled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">arg</span><span class="o">[</span><span class="n">ACPI_DMAR_TYPE_HARDWARE_UNIT</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">drhd_count</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">cb</span><span class="o">[</span><span class="n">ACPI_DMAR_TYPE_HARDWARE_UNIT</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dmar_parse_one_drhd</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">cb</span><span class="o">[</span><span class="n">ACPI_DMAR_TYPE_RESERVED_MEMORY</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dmar_parse_one_rmrr</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">cb</span><span class="o">[</span><span class="n">ACPI_DMAR_TYPE_ROOT_ATS</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dmar_parse_one_atsr</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">cb</span><span class="o">[</span><span class="n">ACPI_DMAR_TYPE_HARDWARE_AFFINITY</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dmar_parse_one_rhsa</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">cb</span><span class="o">[</span><span class="n">ACPI_DMAR_TYPE_NAMESPACE</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dmar_parse_one_andd</span><span class="p">,</span>
<span class="w">        </span><span class="err">}</span><span class="p">;</span>
</code></pre></div>

<p>è§£ædmarè¡¨ä¸­ä¸åŒç±»å‹çš„remapping structuresï¼Œä¸Šæ–‡çš„å›¾ä¸­å·²ç»è¿›è¡Œäº†ç›¸å…³è¯´æ˜ï¼Œç›®å‰åªæ”¯æŒ5ç±»ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯HARDWARE_UNITï¼ŒRESERVED_MEMORYï¼ŒROOT_ATS ï¼ŒHARDWARE_AFFINITYï¼ŒNAMESPACEã€‚å…¶ä¸­hardware_unitæŒ‡çš„å°±æ˜¯iommuç¡¬ä»¶ï¼Œè€ŒATSæŒ‡çš„æ˜¯pcie çš„ä¸€ä¸ªé‡è¦featureè¿™é‡Œæˆ‘ä»¬ä¹Ÿä¸ç»†è¯´ã€‚æˆ‘ä»¬é‡ç‚¹è®²ä¸€ä¸‹RESERVED_MEMORYå’Œ HARDWARE_AFFINITYã€‚HARDWARE_AFFINITYå…·ä½“æŒ‡çš„æ˜¯Remapping Hardware Status Affinity(RHSA)ä¿¡æ¯ï¼Œä¸»è¦å› ä¸ºåœ¨numaæ¶æ„ä¸‹iommuç¡¬ä»¶å¯èƒ½ä¼šè·¨nodeï¼Œè€Œé€šè¿‡RHSAä¿¡æ¯æ¥æŠ¥å‘Šcpuå’Œå†…å­˜è·Ÿæ¯ä¸ªiommuç¡¬ä»¶çš„äº²å’Œæ€§ï¼Œä»è€Œ ä¿è¯äº†iommuç¡¬ä»¶çš„perfomaceã€‚RESERVED_MEMORY ç±»å‹çš„structuresæè¿°çš„æ˜¯ä¸“é—¨ç»™ä¸€äº›è®¾å¤‡é¢„ç•™çš„DMAå†…å­˜ä¿¡æ¯ï¼ŒRMRR çš„å†…å­˜åŒºåŸŸå¿…é¡»æ˜¯4kå¯¹é½çš„ï¼ŒåŸåˆ™ä¸ŠRMRRåªé’ˆå¯¹ä¸€äº›legacyè®¾å¤‡æ¯”å¦‚USBï¼ŒUMA graphicsç­‰è®¾å¤‡æ¥ä½¿ç”¨ï¼Œè€Œå…¶ä»–è®¾å¤‡ç±»å‹ä¸€èˆ¬ä¸å»ºè®®ä½¿ç”¨RMRRã€‚</p>
<ul>
<li>dmar_dev_scope_init</li>
</ul>
<p>è¿™ä¸ªå‡½æ•°é‡Œé¢ä¸»è¦æ˜¯åˆå§‹åŒ–æ¯ä¸ªdmar unit(iommuç¡¬ä»¶)ä¸‹æŒ‚è½½çš„è®¾å¤‡ã€‚</p>
<ul>
<li>dmar_init_reserved_ranges</li>
</ul>
<p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯reservedä¸€äº›iova rangesé˜²æ­¢è¢«å…¶ä»–è®¾å¤‡dmaï¼Œæ¯”å¦‚ioapicçš„iovaåœ°å€èŒƒå›´è¿˜æœ‰å°±æ˜¯å„ä¸ªpci/pcieè®¾å¤‡çš„mmioåœ°å€ç©ºé—´ã€‚</p>
<ul>
<li>init_no_remapping_devices</li>
</ul>
<p>è¿™ä¸ªå‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯å¿½ç•¥ä¸‹é¢æ²¡æœ‰è®¾å¤‡æˆ–è€…åªæœ‰gfxè®¾å¤‡(æ˜¾å¡é©±åŠ¨ä¸ä¼šè°ƒç”¨dmaç›¸å…³çš„apiè¿›è¡Œç›¸å…³çš„æ“ä½œ)çš„dmar unitç¡¬ä»¶</p>
<ul>
<li>init_dmars</li>
</ul>
<p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨ä»å®ƒçš„åå­—ä¹ŸåŸºæœ¬èƒ½çœ‹çš„å‡ºæ¥å°±æ˜¯å¯¹dma remapping åšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œã€‚å…·ä½“çš„æ¯”å¦‚æŠŠæ¯ä¸ªdrhdå…³è”åˆ°<code>struct intel_iommu</code>ï¼Œå‡è®¾ç³»ç»Ÿå½“ä¸­å¦‚æœæœ‰nä¸ªdmaç¡¬ä»¶åˆ™ç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªå¤§å°ä¸ºn<em> sizeof(struct  intel_iommu</em>)çš„g_iommuæ•°ç»„ï¼Œé¦–å…ˆé€šè¿‡<code>intel_iommu_init_qi</code> ä¸ºæ¯ä¸ªiommuåˆå§‹åŒ–Invalidation Translation Caches æœºåˆ¶ï¼Œç›®å‰æœ‰ä¸¤ç§ä¸€ç§æ˜¯<code>Register-based invalidation interface</code>ï¼Œå¦å¤–ä¸€ç§æ˜¯<code>Queued invalidation interface</code>ï¼›å…¶æ¬¡é€šè¿‡<code>iommu_init_domains</code> ä¸ºæ¯ä¸ªintel_iommuåˆ†é…domain_idså’Œdmar_domainsï¼ŒåŒæ—¶ä¸ºæ¯ä¸ªintel_iommuåˆ†é…root_entryå³root_tableçš„åŸºå€(å›¾6)ï¼Œç„¶åå†™åˆ°åŸºå€å¯„å­˜å™¨RTADDR_REGå½“ä¸­ã€‚</p>
<ul>
<li>hw_pass_through &amp;iommu_pass_through</li>
</ul>
<p>å‰è€…è¡¨ç¤ºiommuç¡¬ä»¶æ˜¯å¦æœ‰ç›´é€šèƒ½åŠ›æ˜¯é€šè¿‡è¯»iommuç¡¬ä»¶çš„ecapæ¥è·å–çš„ï¼Œè€Œåè€…æ˜¯é€šè¿‡kernelçš„cmdlineäººä¸ºè®¾ç½®iommu=ptæ¥å®ç°çš„ã€‚å¦‚æœè®¾ç½®ä¸ºptï¼Œåˆ™iommu_pass_throughè®¾ç½®ä¸º1ï¼Œç›¸åº”çš„iommu_identify_mappingä¼šè®¾ç½®ä¸ºIDENTMAP_ALLã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œç³»ç»Ÿä¼šé€šè¿‡si_domain_initåˆ›å»ºä¸€ä¸ªå…¨å±€çš„dmar_domain(ä½ å¯ä»¥ç†è§£å®ƒå­˜å‚¨äº†æ‰€æœ‰çš„å›¾6å½“ä¸­address translationçš„é¡µè¡¨)ï¼Œsiè¡¨ç¤ºçš„æ˜¯staticå³é™æ€çš„ï¼Œä¹‹æ‰€ä»¥è¯´æ˜¯é™æ€çš„æ˜¯å› ä¸ºsi_domainä¼šæŠŠæ¯ä¸ªnodeä¸Šçš„å†…å­˜æå‰å»ºç«‹å¥½iovaåˆ°hpaçš„mappingï¼š</p>
<div class="highlight"><pre><span></span><code>        for_each_online_node(nid) {
                unsigned long start_pfn, end_pfn;
                int i;

                for_each_mem_pfn_range(i, nid, &amp;start_pfn, &amp;end_pfn, NULL) {
                        ret = iommu_domain_identity_map(si_domain,
                                        PFN_PHYS(start_pfn), PFN_PHYS(end_pfn));
                        if (ret)
                                return ret;
                }
        }
</code></pre></div>

<p>ç„¶åå†æŠŠæ¯ä¸ªiommuä¸‹é¢æŒ‚ç€çš„è®¾å¤‡è·Ÿsi_domainå…³è”èµ·æ¥ï¼Œå…·ä½“åšæ³•æ˜¯è¯´å…ˆæ‰¾åˆ°è¿™ä¸ªè®¾å¤‡æ‰€å±çš„iommuåœ¨é©±åŠ¨å±‚çš„è¡¨ç°å°±æ˜¯æ‰¾åˆ°æ‰€å±çš„struct intel_iommuç»“æ„ä½“ï¼Œç„¶åé€šè¿‡è¿™ä¸ªè®¾å¤‡æ‰€åœ¨çš„buså·æ‰¾åˆ°å…¶åœ¨root_tableçš„ä½ç½®ï¼Œå†é€šè¿‡devfnåˆ›å»ºç›¸å¯¹åº”çš„context_entryï¼Œç„¶åæŠŠsi_dmainçš„pgdè®¾ç½®ä¸ºcontex_entryçš„åŸºå€ï¼Œå…·ä½“è§<code>iommu_prepare_static_identity_mapping(hw_pass_through)</code>å‡½æ•°ã€‚</p>
<ul>
<li>bus_set_iommu(&amp;pci_bus_type, &amp;intel_iommu_ops)</li>
</ul>
<p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯ä¸ºpci_busè®¾ç½®intel_iommu_opsï¼Œå¹¶é€šè¿‡iommu_bus_initåšä¸€äº›åˆåŒ–çš„å·¥ä½œã€‚å…·ä½“çš„å·¥ä½œåŒ…æ‹¬ä¸ºbusæ³¨å†Œé€šçŸ¥å›è°ƒå‡½æ•°ï¼Œè¿˜æœ‰å°±æ˜¯é€šè¿‡<code>add_iommu_group</code>ç»™æ¯ä¸ªè®¾å¤‡åˆ›å»ºiommu_groupï¼Œä¸€ä¸ªiommu_groupå¯ä»¥å¯¹ä¸€ä¸ªè®¾å¤‡ä¹Ÿå¯ä»¥å¯¹åº”å¤šä¸ªè®¾å¤‡ï¼Œè‡³äºå…·ä½“æ˜¯å¦‚ä½•åˆ†ç»„æˆ‘ä»¬çœ‹ä¸€ä¸‹å…·ä½“çš„å‡½æ•°å®ç°ï¼Œè¿™æ®µé€»è¾‘æœ€ç»ˆä¼šè°ƒç”¨åˆ°pci_device_groupå‡½æ•°ï¼š</p>
<div class="highlight"><pre><span></span><code>struct iommu_group *pci_device_group(struct device *dev)
{
    struct pci_dev <span class="gs">*pdev = to_pci_dev(dev);</span>

<span class="gs">    /*</span>
     <span class="k">*</span> Find the upstream DMA alias for the device.  A device must not
     <span class="k">*</span> be aliased due to topology in order to have its own IOMMU group.
     <span class="k">*</span> If we find an alias along the way that already belongs to a
     <span class="k">*</span> group, use it.
     <span class="gs">*/  </span>
<span class="gs">    if (pci_for_each_dma_alias(pdev, get_pci_alias_or_group, &amp;data))</span>
<span class="gs">        return data.group;</span>

<span class="gs">    /*</span>
     <span class="k">*</span> Continue upstream from the point of minimum IOMMU granularity
     <span class="k">*</span> due to aliases to the point where devices are protected from
     <span class="k">*</span> peer-to-peer DMA by PCI ACS.  Again, if we find an existing
     <span class="k">*</span> group, use it.
     <span class="gs">*/</span>
<span class="gs">    for (bus = pdev-&gt;bus; !pci_is_root_bus(bus); bus = bus-&gt;parent) {</span>
<span class="gs">        if (!bus-&gt;self)</span>
<span class="gs">            continue;</span>

<span class="gs">        if (pci_acs_path_enabled(bus-&gt;self, NULL, REQ_ACS_FLAGS))</span>
<span class="gs">            break;</span>

<span class="gs">        pdev = bus-&gt;self;</span>
<span class="gs">        group = iommu_group_get(&amp;pdev-&gt;dev);</span>
<span class="gs">        if (group)</span>
<span class="gs">            return group;</span>
<span class="gs">   }</span>

<span class="gs">    /*</span>   
     <span class="k">*</span> Look for existing groups on device aliases.  If we alias another
     <span class="k">*</span> device or another device aliases us, use the same group.
     <span class="gs">*/</span>
<span class="gs">    group = get_pci_alias_group(pdev, (unsigned long *</span>)devfns);
    if (group)
        return group;

    /*   
     <span class="k">*</span> Look for existing groups on non-isolated functions on the same
     <span class="k">*</span> slot and aliases of those funcions, if any.  No need to clear
     <span class="k">*</span> the search bitmap, the tested devfns are still valid.
     <span class="gs">*/</span>
<span class="gs">    group = get_pci_function_alias_group(pdev, (unsigned long *</span>)devfns);
    if (group)
        return group;

    return iommu_group_alloc();
}
</code></pre></div>

<p>è¿™ä¸ªå‡½æ•°çš„æ ¸å¿ƒé€»è¾‘åœ¨äº<code>pci_acs_path_enabled</code>ï¼Œç®€å•æ¥è¯´å¦‚æœæ˜¯pcieçš„è®¾å¤‡åˆ™æ£€æŸ¥è¯¥è®¾å¤‡åˆ°root complexçš„è·¯å¾„ä¸Šå¦‚æœéƒ½å¼€å¯äº†ACSåˆ™è¿™ä¸ªè®¾å¤‡å°±å•ç‹¬æˆä¸€ä¸ªiommu_groupï¼Œå¦‚æœä¸æ˜¯åˆ™æ‰¾åˆ°å®ƒçš„alias groupå°±è¡Œäº†æ¯”å¦‚å¦‚æœè¿™ä¸ªæ˜¯ä¼ ç»Ÿçš„pci bus(æ²¡æœ‰pcieè¿™äº›ACSçš„ç‰¹æ€§)åˆ™è¿™ä¸ªpci busä¸‹é¢çš„æ‰€æœ‰è®¾å¤‡å°±ç»„åˆæˆä¸€ä¸ªiommu_groupã€‚</p>
<h4>æ€»ç»“</h4>
<p>æ–‡ç« ä¸»è¦è®²äº†ä¸€ä¸‹iommuç¡¬å¤±çš„æ¶æ„ä»¥åŠiommuç¡¬ä»¶åœ¨ç³»ç»Ÿå±‚é¢çš„åˆå§‹åŒ–çš„æ•´ä¸ªæµç¨‹ï¼Œ æ ¸å¿ƒçš„å°±æ˜¯iommuç¡¬ä»¶é€šè¿‡dmar acpiè¡¨è¢«ç³»ç»Ÿå‘ç°ï¼Œç„¶åè§£æè¡¨é‡Œé¢çš„ä¿¡æ¯ï¼Œç„¶åè§£ææ¯ä¸ªiommuç¡¬ä»¶ä¸‹çš„ç¡¬ä»¶è®¾å¤‡ï¼Œå¦‚æœiommuä¸ºptåˆ™ä¸ºæ¯ä¸ªç¡¬ä»¶è®¾å¤‡åˆ›å»ºstaticçš„ mapingè¡¨ï¼Œæ¥ç€ä¸ºæ¯ä¸ªpciè®¾å¤‡è¿›è¡Œåˆ†ç»„ã€‚è¿™é‡Œè¿˜æœ‰å‡ ä¸ªæ¦‚å¿µè¦ç†è§£ä¸€ä¸‹ï¼š
- struct inte_iommuï¼š iommuç¡¬ä»¶åœ¨é©±åŠ¨å±‚æ‰€å¯¹åº”çš„æ¦‚å¿µ
- struct iommu_group: ä¸€ä¸ªgroupä¸‹é¢å¯ä»¥å¯¹åº”å¤šä¸ªæˆ–è€…ä¸€ä¸ªç¡¬ä»¶è®¾å¤‡
- struct dmar_domain: dmar_domainé‡Œé¢å­˜å‚¨çš„æ˜¯iova-&gt;hpaçš„è½¬æ¢é¡µè¡¨ï¼Œä¸€ä¸ªdmar_domainå¯ä»¥ä¸ºå¤šä¸ªæˆ–è€…ä¸€ä¸ªè®¾å¤‡æœåŠ¡ã€‚
- struct iommu_domain:  ä¸€ä¸ªiommu_domainé‡Œé¢å¯ä»¥æœ‰å¤šä¸ªiommu_groupï¼Œç„¶åç”Ÿä¸ªiommu_groupé€šè¿‡iommu_domainæœ€ç»ˆæ‰¾åˆ°dmar_domainè¿›è¡Œè½¬æ¢ã€‚</p>
<h4>åè®°</h4>
<p>åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« é‡Œé¢ä¼šè¯¦ç»†è®²ä¸€ä¸‹åœ¨è™šæ‹ŸåŒ–å’Œéè™šæ‹ŸåŒ–åœºæ™¯ä¸‹ç³»ç»Ÿå¦‚ä½•é€šè¿‡iommuè¿›è¡Œdmaçš„ç›¸å…³æ“ä½œåŒ…æ‹¬ä¸­æ–­remappingçš„å¤„ç†ã€‚è¿™é‡Œå¤§å®¶å¯ä»¥å…ˆæƒ³ä¸€ä¸‹è¿™å‡ ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>è™šæ‹Ÿæœºé‡Œé¢æ˜¯æ²¡æœ‰iommuçš„ï¼Œé‚£dmaæ˜¯å¦‚ä½•è¿›è¡Œçš„ï¼Ÿ</li>
<li>åœ¨éè™šæ‹ŸåŒ–åœºæ™¯ä¸‹iommu=ptå’Œiommu disabledè¿™ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li>
<li>ä¸åŒintel iommuç¡¬ä»¶ä¸‹çš„ä¸¤ä¸ªpciè®¾å¤‡æ˜¯å¦‚ä½•å®ç°ç›´é€šç»™åŒä¸€ä¸ªvmçš„ï¼Ÿ</li>
<li>iommu ä¸­æ–­remappingåœ¨è™šæ‹ŸåŒ–å’Œéè™šæ‹ŸåŒ–åœºæ™¯æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</li>
</ul>

                <!-- å›¾ç‰‡ç”»å»Š -->
            </main>

        <!-- æ–‡ç« åº•éƒ¨åŒºåŸŸ -->
        <footer class="article-footer">
            <!-- æ ‡ç­¾åŒºåŸŸ -->
            <div class="article-tags-section">
                <h4>ğŸ·ï¸ ç›¸å…³æ ‡ç­¾</h4>
                <div class="tags-cloud">
                    <span class="tag-cloud-item">iommu</span>
                </div>
            </div>

            <!-- åˆ†äº«å’Œäº’åŠ¨ -->
            <div class="article-interaction">
                <div class="social-share">
                    <h4>ğŸ”— åˆ†äº«è¿™ç¯‡æ–‡ç« </h4>
                    <div class="share-buttons">
                        <a href="#" class="share-btn twitter" target="_blank">ğ• Twitter</a>
                        <a href="#" class="share-btn weibo" target="_blank">ğŸ“ å¾®åš</a>
                        <a href="#" class="share-btn linkedin" target="_blank">ğŸ’¼ LinkedIn</a>
                    </div>
                </div>
            </div>

            <!-- ä½œè€…ç­¾åæ¡£ -->
            <div class="author-signature">
                <div class="signature-content">
                    <h4>å…³äºä½œè€…</h4>
                    <p><strong>å‘¨å®œæ³¢</strong>ï¼Œå­—èŠ‚è·³åŠ¨ç«å±±å¼•æ“AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆï¼Œä¸“æ³¨AI Agentã€GPUæ± åŒ–ã€LLMæ¨ç†ä¼˜åŒ–ç­‰å‰æ²¿æŠ€æœ¯ã€‚</p>
                    <div class="author-social">
                        <a href="https://twitter.com/zhyblife99" target="_blank">ğ• Twitter</a>
                        <span class="wechat-hint">ğŸ’¬ å…³æ³¨å¾®ä¿¡å…¬ä¼—å·è·å–æ›´å¤šå†…å®¹</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <aside class="article-sidebar">
        <!-- æ–‡ç« ä¿¡æ¯å¡ç‰‡ -->
        <div class="sidebar-card article-info-card">
            <h3>ğŸ“Š æ–‡ç« ä¿¡æ¯</h3>
            <div class="info-list">
                <div class="info-item">
                    <span class="info-label">å‘å¸ƒæ—¶é—´</span>
                    <span class="info-value">äºŒ 18 ä¸€æœˆ 2022</span>
                </div>
                <div class="info-item">
                    <span class="info-label">åˆ†ç±»</span>
                    <span class="info-value">articles</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¢„è®¡é˜…è¯»</span>
                    <span class="info-value">~10 åˆ†é’Ÿ</span>
                </div>
            </div>
        </div>

        <!-- ç›¸å…³æ–‡ç« æ¨è -->
        <div class="sidebar-card related-articles-card">
            <h3>ğŸ“š ç›¸å…³æ–‡ç« </h3>
            <div class="related-list">
            </div>
        </div>

        <!-- æŠ€æœ¯æ ˆå±•ç¤º -->
        <div class="sidebar-card skills-card">
            <h3>ğŸš€ æŠ€æœ¯æ ˆ</h3>
            <div class="skills-list">
                <span class="skill-item">AI Agent</span>
                <span class="skill-item">GPUæ± åŒ–</span>
                <span class="skill-item">LLMæ¨ç†ä¼˜åŒ–</span>
                <span class="skill-item">é«˜æ€§èƒ½è™šæ‹ŸåŒ–</span>
            </div>
        </div>

        <!-- å…³æ³¨å…¬ä¼—å· -->
        <div class="sidebar-card wechat-card">
            <h3>ğŸ”” è®¢é˜…æ›´æ–°</h3>
            <div class="wechat-content">
                <p>æ‰«ç å…³æ³¨å¾®ä¿¡å…¬ä¼—å·</p>
                <img src="./images/qrcode.jpg" alt="å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç " class="sidebar-qrcode">
                <p class="wechat-name">KernelNote</p>
            </div>
        </div>
    </aside>
</div>

<!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
<button class="back-to-top" id="backToTop">
    <span>â†‘</span>
</button>

<script>
// è¿”å›é¡¶éƒ¨åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const backToTop = document.getElementById('backToTop');

    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTop.style.display = 'block';
        } else {
            backToTop.style.display = 'none';
        }
    });

    // ç‚¹å‡»è¿”å›é¡¶éƒ¨
    backToTop.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // ç›®å½•é«˜äº®
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = document.querySelectorAll('.article-content h2, .article-content h3, .article-content h4');

    function updateTocHighlight() {
        let current = '';
        headings.forEach((heading, index) => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100) {
                current = heading.id;
            }
        });

        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#' + current) {
                link.classList.add('active');
            }
        });
    }

    if (tocLinks.length > 0) {
        window.addEventListener('scroll', updateTocHighlight);
        updateTocHighlight();
    }

    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®å½•é¡¹
    tocLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});
</script>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>        <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>
    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>