<!DOCTYPE html>
<html lang="zh_cn">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="duma" />

        <meta name="description" content="åºè¨€ ä¸Šä¸€ç¯‡æ–‡ç« ä¸»è¦å†™äº†ä¸€ä¸‹iommuç¡¬ä»¶æ¶æ„ä»¥åŠå…¶åœ¨é©±åŠ¨å±‚çš„åˆå§‹åŒ–æµç¨‹ï¼Œé‚£è¿™ä¸€ç¯‡æˆ‘ä»¬ä¼šèŠ±ç‚¹æ—¶é—´æ¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹iommuåˆ†åˆ«åœ¨è™šæ‹ŸåŒ–å’Œéè™šæ‹ŸåŒ–åœºæ™¯ä¸‹ dma remappingçš„å·¥ä½œåŸç† éè™šæ‹ŸåŒ–åœºæ™¯ åœ¨éè™šæ‹ŸåŒ–åœºæ™¯ä¸‹å¦‚ â€¦
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="iommu, articles, " />
        <title>æ·±å…¥äº†è§£iommuç³»åˆ—äºŒï¼šiommu å·¥ä½œåŸç†è§£æä¹‹dma remapping  Â· KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link href="https://kernelnote.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢ - Full Atom Feed" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LRRMJ08SPD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LRRMJ08SPD');
</script>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./pages/about.html">about</a></li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<!-- æ–‡ç« å¤´éƒ¨åŒºåŸŸ -->
<header class="article-header">
    <div class="article-header-container">
        <!-- ä½œè€…ä¿¡æ¯åŒºåŸŸ -->
        <div class="article-author-section">
            <img src="./images/wechat.jpeg" alt="å‘¨æ¯…åš" class="author-avatar">
            <div class="author-info">
                <h3 class="author-name">å‘¨å®œæ³¢</h3>
                <p class="author-title">AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆ | AI Agentä¸“å®¶</p>
            </div>
        </div>

        <!-- æ–‡ç« æ ‡é¢˜å’Œå…ƒä¿¡æ¯ -->
        <div class="article-meta-section">
            <h1 class="article-title">
                æ·±å…¥äº†è§£iommuç³»åˆ—äºŒï¼šiommu å·¥ä½œåŸç†è§£æä¹‹dma remapping
            </h1>

            <div class="article-meta-info">
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“…</span>
                    <time datetime="2022-02-06T00:00:00+08:00">æ—¥ 06 äºŒæœˆ 2022</time>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“</span>
                    <span class="category-tag">articles</span>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ·ï¸</span>
                    <span class="article-tag">iommu</span>
                </div>
            </div>

            <!-- å¤šåª’ä½“é“¾æ¥åŒºåŸŸ -->
        </div>
    </div>
</header>

<!-- æ–‡ç« ä¸»ä½“å†…å®¹ -->
<div class="article-container">
    <div class="article-main">
        <!-- æ–‡ç« å†…å®¹ -->
            <main class="article-content article-content-no-toc">
                
                <h3>åºè¨€</h3>
<p>ä¸Šä¸€ç¯‡æ–‡ç« ä¸»è¦å†™äº†ä¸€ä¸‹iommuç¡¬ä»¶æ¶æ„ä»¥åŠå…¶åœ¨é©±åŠ¨å±‚çš„åˆå§‹åŒ–æµç¨‹ï¼Œé‚£è¿™ä¸€ç¯‡æˆ‘ä»¬ä¼šèŠ±ç‚¹æ—¶é—´æ¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹iommuåˆ†åˆ«åœ¨è™šæ‹ŸåŒ–å’Œéè™šæ‹ŸåŒ–åœºæ™¯ä¸‹ dma remappingçš„å·¥ä½œåŸç†</p>
<h3>éè™šæ‹ŸåŒ–åœºæ™¯</h3>
<p>åœ¨éè™šæ‹ŸåŒ–åœºæ™¯ä¸‹å¦‚æœä¸æ˜¯æ˜¾ç¤ºçš„åœ¨cmdlineé‡Œé¢æŠŠiommuè®¾ç½®ä¸ºdisabledåˆ™ä¸€èˆ¬éƒ½ä¼šé»˜è®¤enable iommuç¡¬ä»¶ï¼Œå¦å¤–è¿˜æœ‰ä¸€ç§å¸¸ç”¨çš„æ–¹å¼å°±æ˜¯iommu=ptè¿™ç§æ–¹å¼è·Ÿdefaultè®¾ç½®çš„å”¯ä¸€åŒºåˆ«æ˜¯ä¼šä¸ä¼šæå‰å»ºç«‹static mapã€‚ä¸ºäº†è®©å¤§å®¶æœ‰ä¸ªæ›´æ¸…æ™°çš„è®¤çŸ¥ï¼Œæˆ‘ä»¬åœ¨å†…æ ¸é‡Œé¢æ‰¾æ®µdmaæ“ä½œç›¸å…³çš„ä»£ç å¹¶ä»¥æ­¤ä¸ºå¼€ç«¯å¯¹iommuçš„dmaå·¥ä½œæœºåˆ¶è¿›è¡Œå‰–æã€‚</p>
<div class="highlight"><pre><span></span><code><span class="nx">static</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">e100_xmit_prepare</span><span class="p">(</span><span class="nx">struct</span><span class="w"> </span><span class="nx">nic</span><span class="w"> </span><span class="o">*</span><span class="nx">nic</span><span class="p">,</span><span class="w"> </span><span class="nx">struct</span><span class="w"> </span><span class="nx">cb</span><span class="w"> </span><span class="o">*</span><span class="nx">cb</span><span class="p">,</span>
<span class="w">        </span><span class="nx">struct</span><span class="w"> </span><span class="nx">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="nx">skb</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="nx">dma_addr_t</span><span class="w"> </span><span class="nx">dma_addr</span><span class="p">;</span>
<span class="w">        </span><span class="nx">cb</span><span class="o">-&gt;</span><span class="nx">command</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">nic</span><span class="o">-&gt;</span><span class="nx">tx_command</span><span class="p">;</span>

<span class="w">        </span><span class="nx">dma_addr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">pci_map_single</span><span class="p">(</span><span class="nx">nic</span><span class="o">-&gt;</span><span class="nx">pdev</span><span class="p">,</span>
<span class="w">                                  </span><span class="nx">skb</span><span class="o">-&gt;</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">skb</span><span class="o">-&gt;</span><span class="nx">len</span><span class="p">,</span><span class="w"> </span><span class="nx">PCI_DMA_TODEVICE</span><span class="p">);</span>
<span class="w">        </span><span class="cm">/* If we can&#39;t map the skb, have the upper layer try later */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pci_dma_mapping_error</span><span class="p">(</span><span class="nx">nic</span><span class="o">-&gt;</span><span class="nx">pdev</span><span class="p">,</span><span class="w"> </span><span class="nx">dma_addr</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">dev_kfree_skb_any</span><span class="p">(</span><span class="nx">skb</span><span class="p">);</span>
<span class="w">                </span><span class="nx">skb</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">NULL</span><span class="p">;</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="nx">ENOMEM</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="o">.........</span>
<span class="p">}</span>
</code></pre></div>

<p>ä¸Šé¢çš„ä»£ç ç‰‡æ–­æ˜¯æ‘˜è‡³äºå†…æ ¸e100ç½‘å¡é©±åŠ¨ï¼Œæ ¸å¿ƒé€»è¾‘å°±æ˜¯å…ˆæŠŠskbçš„åœ°å€åšä¸€ä¸‹dma mapï¼Œç„¶åè®©ç¡¬ä»¶å¯ä»¥ç›´æ¥dmaè¿™æ®µæ•°æ®ï¼Œå…¶ä¸­ä½¿ç”¨çš„<code>pci_map_single</code>è¿™ä¸ªå‡½æ•°æœ€ç»ˆä¼šè°ƒåˆ°</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">inline</span><span class="w"> </span><span class="n">dma_addr_t</span><span class="w"> </span><span class="n">dma_map_single_attrs</span><span class="p">(</span><span class="n">struct</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
<span class="w">                                              </span><span class="n">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span>
<span class="w">                                              </span><span class="k">enum</span><span class="w"> </span><span class="n">dma_data_direction</span><span class="w"> </span><span class="n">dir</span><span class="p">,</span>
<span class="w">                                              </span><span class="n">unsigned</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="n">struct</span><span class="w"> </span><span class="n">dma_map_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_dma_ops</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">        </span><span class="n">dma_addr_t</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>

<span class="w">        </span><span class="n">kmemcheck_mark_initialized</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">        </span><span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">valid_dma_direction</span><span class="p">(</span><span class="n">dir</span><span class="p">));</span>
<span class="w">        </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map_page</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span>
<span class="w">                             </span><span class="n">offset_in_page</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="p">,</span>
<span class="w">                             </span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p">);</span>
<span class="w">        </span><span class="n">debug_dma_map_page</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span>
<span class="w">                           </span><span class="n">offset_in_page</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="p">,</span>
<span class="w">                           </span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>å¦‚æœæœ‰iommuç¡¬ä»¶çš„æƒ…å†µä¸‹(ä»¥intel iommuä¸ºä¾‹)ä»–æœ€ç»ˆä¸ºèµ°åˆ°<code>intel_map_page</code>ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„æ ¸å¿ƒé€»è¾‘</p>
<div class="highlight"><pre><span></span><code><span class="nx">static</span><span class="w"> </span><span class="nx">dma_addr_t</span><span class="w"> </span><span class="nx">__intel_map_single</span><span class="p">(</span><span class="nx">struct</span><span class="w"> </span><span class="nx">device</span><span class="w"> </span><span class="o">*</span><span class="nx">dev</span><span class="p">,</span><span class="w"> </span><span class="nx">phys_addr_t</span><span class="w"> </span><span class="nx">paddr</span><span class="p">,</span>
<span class="w">                                     </span><span class="nx">size_t</span><span class="w"> </span><span class="nx">size</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">dir</span><span class="p">,</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="nx">dma_mask</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="nx">struct</span><span class="w"> </span><span class="nx">dmar_domain</span><span class="w"> </span><span class="o">*</span><span class="nx">domain</span><span class="p">;</span>
<span class="w">        </span><span class="nx">phys_addr_t</span><span class="w"> </span><span class="nx">start_paddr</span><span class="p">;</span>
<span class="w">        </span><span class="nx">unsigned</span><span class="w"> </span><span class="nx">long</span><span class="w"> </span><span class="nx">iova_pfn</span><span class="p">;</span>
<span class="w">        </span><span class="nx">int</span><span class="w"> </span><span class="nx">prot</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="nx">int</span><span class="w"> </span><span class="nx">ret</span><span class="p">;</span>
<span class="w">        </span><span class="nx">struct</span><span class="w"> </span><span class="nx">intel_iommu</span><span class="w"> </span><span class="o">*</span><span class="nx">iommu</span><span class="p">;</span>
<span class="w">        </span><span class="nx">unsigned</span><span class="w"> </span><span class="nx">long</span><span class="w"> </span><span class="nx">paddr_pfn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">paddr</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nx">PAGE_SHIFT</span><span class="p">;</span>

<span class="w">        </span><span class="nx">BUG_ON</span><span class="p">(</span><span class="nx">dir</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">DMA_NONE</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">iommu_no_mapping</span><span class="p">(</span><span class="nx">dev</span><span class="p">))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">paddr</span><span class="p">;</span>

<span class="w">        </span><span class="nx">domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">get_valid_domain_for_dev</span><span class="p">(</span><span class="nx">dev</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">domain</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="nx">iommu</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">domain_get_iommu</span><span class="p">(</span><span class="nx">domain</span><span class="p">);</span>
<span class="w">        </span><span class="nx">size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">aligned_nrpages</span><span class="p">(</span><span class="nx">paddr</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="p">);</span>

<span class="w">        </span><span class="nx">iova_pfn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">intel_alloc_iova</span><span class="p">(</span><span class="nx">dev</span><span class="p">,</span><span class="w"> </span><span class="nx">domain</span><span class="p">,</span><span class="w"> </span><span class="nx">dma_to_mm_pfn</span><span class="p">(</span><span class="nx">size</span><span class="p">),</span><span class="w"> </span><span class="nx">dma_mask</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">iova_pfn</span><span class="p">)</span>
<span class="w">                </span><span class="nx">goto</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * Check if DMAR supports zero-length reads on write only</span>
<span class="cm">         * mappings..</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">dir</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">DMA_TO_DEVICE</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">dir</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">DMA_BIDIRECTIONAL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>\
<span class="w">                        </span><span class="p">!</span><span class="nx">cap_zlr</span><span class="p">(</span><span class="nx">iommu</span><span class="o">-&gt;</span><span class="nx">cap</span><span class="p">))</span>
<span class="w">                </span><span class="nx">prot</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="nx">DMA_PTE_READ</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">dir</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">DMA_FROM_DEVICE</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">dir</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">DMA_BIDIRECTIONAL</span><span class="p">)</span>
<span class="w">                </span><span class="nx">prot</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="nx">DMA_PTE_WRITE</span><span class="p">;</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * paddr - (paddr + size) might be partial page, we should map the whole</span>
<span class="cm">         * page.  Note: if two part of one page are separately mapped, we</span>
<span class="cm">         * might have two guest_addr mapping to the same host paddr, but this</span>
<span class="cm">         * is not a big problem</span>
<span class="cm">         */</span>
<span class="w">         </span><span class="nx">ret</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">domain_pfn_mapping</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span><span class="w"> </span><span class="nx">mm_to_dma_pfn</span><span class="p">(</span><span class="nx">iova_pfn</span><span class="p">),</span>
<span class="w">                                 </span><span class="nx">mm_to_dma_pfn</span><span class="p">(</span><span class="nx">paddr_pfn</span><span class="p">),</span><span class="w"> </span><span class="nx">size</span><span class="p">,</span><span class="w"> </span><span class="nx">prot</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">ret</span><span class="p">)</span>
<span class="w">                </span><span class="nx">goto</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* it&#39;s a non-present to present mapping. Only flush if caching mode */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cap_caching_mode</span><span class="p">(</span><span class="nx">iommu</span><span class="o">-&gt;</span><span class="nx">cap</span><span class="p">))</span>
<span class="w">                </span><span class="nx">iommu_flush_iotlb_psi</span><span class="p">(</span><span class="nx">iommu</span><span class="p">,</span><span class="w"> </span><span class="nx">domain</span><span class="p">,</span>
<span class="w">                                      </span><span class="nx">mm_to_dma_pfn</span><span class="p">(</span><span class="nx">iova_pfn</span><span class="p">),</span>
<span class="w">                                      </span><span class="nx">size</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">                </span><span class="nx">iommu_flush_write_buffer</span><span class="p">(</span><span class="nx">iommu</span><span class="p">);</span>

<span class="w">        </span><span class="nx">start_paddr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="nx">phys_addr_t</span><span class="p">)</span><span class="nx">iova_pfn</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nx">PAGE_SHIFT</span><span class="p">;</span>
<span class="w">        </span><span class="nx">start_paddr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">paddr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="nx">PAGE_MASK</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">start_paddr</span><span class="p">;</span>

<span class="nx">error</span><span class="p">:</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">iova_pfn</span><span class="p">)</span>
<span class="w">                </span><span class="nx">free_iova_fast</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">iovad</span><span class="p">,</span><span class="w"> </span><span class="nx">iova_pfn</span><span class="p">,</span><span class="w"> </span><span class="nx">dma_to_mm_pfn</span><span class="p">(</span><span class="nx">size</span><span class="p">));</span>
<span class="w">        </span><span class="nx">pr_err</span><span class="p">(</span><span class="s">&quot;Device %s request: %zx@%llx dir %d --- failed\n&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">dev_name</span><span class="p">(</span><span class="nx">dev</span><span class="p">),</span><span class="w"> </span><span class="nx">size</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">unsigned</span><span class="w"> </span><span class="nx">long</span><span class="w"> </span><span class="nx">long</span><span class="p">)</span><span class="nx">paddr</span><span class="p">,</span><span class="w"> </span><span class="nx">dir</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>æˆ‘ä»¬æ¥å¥½å¥½èµ°è¯»ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼Œé¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦ä¸º<code>iommu_no_mapping</code>ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›paddrä¹Ÿå³ç‰©ç†åœ°å€ã€‚å†æ¥çœ‹çœ‹<code>iommu_no_mapping</code>è¿™ä¸ªå‡½æ•°çš„å…·ä½“é€»è¾‘ã€‚</p>
<div class="highlight"><pre><span></span><code>static int iommu_no_mapping(struct device <span class="gs">*dev)</span>
<span class="gs">{</span>
<span class="gs">        int found;</span>

<span class="gs">        if (iommu_dummy(dev))</span>
<span class="gs">                return 1;</span>

<span class="gs">        if (!iommu_identity_mapping)</span>
<span class="gs">                return 0;</span>

<span class="gs">        found = identity_mapping(dev);</span>
<span class="gs">        if (found) {</span>
<span class="gs">                if (iommu_should_identity_map(dev, 0))</span>
<span class="gs">                        return 1;</span>
<span class="gs">                else {</span>
<span class="gs">                        /*</span>
                         <span class="k">*</span> 32 bit DMA is removed from si_domain and fall back
                         <span class="k">*</span> to non-identity mapping.
                         <span class="gs">*/</span>
<span class="gs">                        dmar_remove_one_dev_info(si_domain, dev);</span>
<span class="gs">                        pr_info(&quot;32bit %s uses non-identity mapping\n&quot;,</span>
<span class="gs">                                dev_name(dev));</span>
<span class="gs">                        return 0;</span>
<span class="gs">                }</span>
<span class="gs">        } else {</span>
<span class="gs">                /*</span>
                 <span class="k">*</span> In case of a detached 64 bit DMA device from vm, the device
                 <span class="k">*</span> is put into si_domain for identity mapping.
                 */
                if (iommu_should_identity_map(dev, 0)) {
                        int ret;
                        ret = domain_add_dev_info(si_domain, dev);
                        if (!ret) {
                                pr_info(&quot;64bit %s uses identity mapping\n&quot;,
                                        dev_name(dev));
                                return 1;
                        }
                }
        }

        return 0;
}
</code></pre></div>

<p>ä»å®ç°æ¥çœ‹ï¼Œé¦–å…ˆä¼šåˆ¤æ–­<code>iommu_identity_mapping</code>æ˜¯å¦ä¸ºç©º(å¦‚æœå¤§å®¶è¯»è¿‡ä¸Šä¸€ç¯‡æ–‡ç« åº”è¯¥çŸ¥é“å½“iommu=ptçš„æ—¶å€™è¿™ä¸ªå˜é‡æ˜¯ä¸ä¼šä¸ºç©ºçš„)å¦‚æœä¸ºç©ºåˆ™è¿”å›falseï¼Œè¿™é‡Œæˆ‘å…ˆçœ‹ä¸€ä¸‹ä¸ä¸ºç©ºçš„é€»è¾‘ã€‚æ¥ç€å‡½æ•°èµ°åˆ°<code>identity_mapping</code>ï¼Œè¿™ä¸ªå‡½æ•°çš„å®ç°å…·ä½“å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code>static int identity_mapping(struct device *dev)
{
        struct device_domain_info *info;

        if (likely(!iommu_identity_mapping))
                return 0;

        info = dev-&gt;archdata.iommu;
        if (info &amp;&amp; info != DUMMY_DEVICE_DOMAIN_INFO)
                return (info-&gt;domain == si_domain);

        return 0;
}
</code></pre></div>

<p>å¯ä»¥çœ‹åˆ°å‡½æ•°é‡Œé¢é¦–å…ˆåˆ¤æ–­<code>iommu_identity_mapping</code>æ˜¯å¦ä¸ºç©ºï¼Œé‚£ä¹ˆåœ¨iommut=ptçš„æƒ…å†µä¸‹è¿™ä¸ªæ˜¯ä¸ä¸ºç©ºçš„ï¼Œç„¶ååˆ¤æ–­è®¾å¤‡çš„domainæ˜¯å¦ä¸ºsi_domainï¼Œå½“ç„¶è¿™ä¸ªç­”æ¡ˆä¹Ÿæ˜¯è‚¯å®šçš„ã€‚å› æ­¤è¿™ä¸ªå‡½æ•°è¿”å›å€¼ä¸ºtrueï¼Œæ¥ç€å‡½æ•°èµ°åˆ°<code>iommu_should_identity_map(dev, 0)</code>ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°ä¸»è¦çš„åˆ¤æ–­å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¦‚æœè¿™ä¸ªè®¾å¤‡ä¸æ˜¯pciè®¾å¤‡ä¸”è¿™ä¸ªè®¾å¤‡æœ‰RMRRï¼Œåˆ™è¿™è¿”å›False.</li>
<li>å¦‚æœè¿™ä¸ªè®¾å¤‡æ˜¯pciè®¾å¤‡ï¼Œåˆ™ä¸‹é¢å‡ ç§æƒ…å†µä¼šè¿”å›Falseï¼š<ul>
<li>è¿™ä¸ªpciè®¾å¤‡æœ‰rmrr</li>
<li><code>iommu_identity_mapping</code> çš„å€¼ä¸æ˜¯IDENTMAP_ALL</li>
<li>æ˜¯pciè®¾å¤‡ä½†ä¸æ˜¯pcieè®¾å¤‡ï¼Œåˆ™å¦‚æœè®¾å¤‡ä¸æ˜¯ root bus æˆ–è€…è¯´pciè®¾å¤‡çš„ç§ç±»æ˜¯pci bridge</li>
<li>æ˜¯pcieè®¾å¤‡ä¸”pcie è®¾å¤‡æ˜¯pcie bridge</li>
</ul>
</li>
<li>å¦‚æœè¿™ä¸ªè®¾å¤‡æ˜¯32bitçš„è®¾å¤‡åˆ™è¿”å›false</li>
</ol>
<p>å¦‚æœè¿™ä¸ªå‡½æ•°è¿”å›falseåˆ™éœ€è¦ä»si_domainé‡Œé¢æŠŠè¿™ä¸ªè®¾å¤‡çš„mappingåˆ é™¤æ‰ï¼Œå¦‚æœè¿”å›Trueåˆ™ç›´æ¥è¿”å›ç‰©ç†åœ°å€ã€‚æ‰€ä»¥æ€»ç»“ä¸€ä¸‹åœ¨iommu=ptçš„åœºæ™¯ä¸‹ï¼Œç”±äºé™æ€æ˜ å°„çš„å­˜åœ¨æ‰€ä»¥ç›´æ¥è¿”å›paddrã€‚ä¸ºä»€ä¹ˆèƒ½å¤Ÿç›´æ¥è¿”å›ç‰©ç†åœ°å€è€Œä¸æ˜¯iovaå‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬å†è¯¦ç»†çš„ä»‹ç»ä¸€ä¸‹ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹<code>si_domain</code>çš„åˆå§‹åŒ–ï¼š</p>
<div class="highlight"><pre><span></span><code>static int __init si_domain_init(int hw)
{
        int nid, ret = 0;

        si_domain = alloc_domain(DOMAIN_FLAG_STATIC_IDENTITY);
        if (!si_domain)
                return -EFAULT;

        if (md_domain_init(si_domain, DEFAULT_DOMAIN_ADDRESS_WIDTH)) {
                domain_exit(si_domain);
                return -EFAULT;
        }

        pr_debug(&quot;Identity mapping domain allocated\n&quot;);
        //å¦‚æœhwä¸ºtrue,åˆ™ç›´æ¥è¿”å›
        if (hw)
                return 0;

        for_each_online_node(nid) {
                unsigned long start_pfn, end_pfn;
                int i;

                for_each_mem_pfn_range(i, nid, &amp;start_pfn, &amp;end_pfn, NULL) {
                        ret = iommu_domain_identity_map(si_domain,
                                        PFN_PHYS(start_pfn), PFN_PHYS(end_pfn));
                        if (ret)
                                return ret;
                }
        }

        return 0;
}
</code></pre></div>

<p>é¦–å…ˆï¼Œhwè¿™ä¸ªå‚æ•°è¾“å…¥ä¸ºhw_pass_throughï¼Œå®ƒæŒ‡çš„æ˜¯iommuç¡¬ä»¶ä¸Šæ˜¯å¦æ”¯æŒpaas throughç¿»è¯‘æ¨¡å¼å³iovaå°±æ˜¯çœŸå®çš„ç‰©ç†åœ°å€ä¸éœ€è¦å†èµ°ä¸€éä»iovaè½¬æ¢åˆ°hpaçš„æµç¨‹ã€‚é‚£ä¹ˆä»ä¸Šé¢çš„å‡½æ•°å®ç°ä¹Ÿèƒ½çœ‹åˆ°å¦‚æœhwä¸ºtrueåˆ™si_domainä¸ä¼šå†å»åšç›¸å…³å†…å­˜mapping(å…³äºhwä¸ºfalseçš„æƒ…å†µåé¢æˆ‘ä»¬å†åˆ†æï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœiommuç¡¬ä»¶æ”¯æŒhwä¸”iommué…ç½®äº†ptåˆ™è¿™ç§åœºæ™¯ä¸‹ç¡¬ä»¶çš„DMAåˆ°è¾¾iommuä¹‹åä¸éœ€è¦èµ°é¡µè¡¨ç¿»è¯‘ç›´æ¥è·Ÿmemory controllerè¿›è¡Œäº¤äº’å°±å¯ä»¥äº†ã€‚<strong>ä½†æ˜¯å¤§å®¶å†ä»”ç»†æƒ³ä¸€ä¸‹iommuç¡¬ä»¶æ˜¯å¦‚ä½•çŸ¥é“å“ªäº›è®¾å¤‡çš„dmaè¦èµ°é¡µè¡¨è¿›è¡Œè½¬æ¢ï¼Œå“ªäº›è®¾å¤‡çš„dmaä¸éœ€è¦è¿›è¡Œåœ°å€è½¬æ¢å‘¢ï¼Ÿ</strong> ä¸ºäº†æ›´å¥½çš„è§£é‡Šè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥å›å¿†ä¸€ä¸‹dmaçš„é¡µè¡¨æ˜¯å¦‚ä½•ç¡®å®šçš„</p>
<p><img alt="iotlb" src="images/iotlb.png">
<center>å›¾1</center>
ä»ä¸Šé¢è¿™å¼ å›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªè®¾å¤‡çš„iovaé¡µè¡¨é¦–å…ˆæ˜¯é€šè¿‡buså·åœ¨root tableé‡Œé¢æ‰¾åˆ°ç›¸åº”çš„root_entryï¼Œç„¶åå†é€šè¿‡devfnåœ¨context tableé‡Œé¢æ‰¾åˆ°å¯¹åº”çš„context_entryï¼Œç„¶åæ‰èƒ½æ‰¾åˆ°çœŸæ­£çš„é¡µè¡¨ã€‚ä»vt-dçš„specæ¥çœ‹ï¼Œcontex_entryçš„formaté‡Œé¢æœ‰ä¸€ä¸ªæ ‡å¿—ä½(TT)æ¥è¡¨æ˜è¿™ä¸ªè®¾å¤‡çš„DMAæ˜¯å¦æ˜¯paasthrougï¼Œå…·ä½“å¦‚ä¸‹:</p>
<p><img alt="contex_entry" src="images/contex_entry.png">
<center>å›¾2</center></p>
<p>æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹å¯¹å›¾2ä¸­ç›¸å…³å­—æ®µçš„è¯¦ç»†æè¿°ï¼š</p>
<p><img alt="tt" src="images/tt.png">
<center>å›¾3</center>
ä»å›¾3ä¸­å¯ä»¥çœ‹åˆ°TTè¿™ä¸ªå­—æ®µä¸º10bæ—¶è¡¨ç¤ºè¿™ä¸ªdmaæ˜¯ä¸éœ€è¦è¿›è¡Œé¡µè¡¨è½¬æ¢çš„ï¼Œæ‰€ä»¥<strong>iommuå°±æ˜¯é€šè¿‡è¿™ä¸ªå­—æ®µæ¥è¿›è¡ŒåŒºåˆ†æ˜¯å¦è¦é€šè¿‡é¡µè¡¨è¿›è¡Œè½¬æ¢çš„</strong>ã€‚ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯è¿™ä¸ªTTä¸ºpaasthroughçš„translation typeæ˜¯ä»€ä¹ˆæ—¶å€™è®¾ç½®çš„ï¼Ÿå›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦å›å½’åˆ°å†…æ ¸ç›¸å…³ä»£ç å½“ä¸­ã€‚ç›®å‰æˆ‘ä»¬æ¡ä»¶æ˜¯hwä¸ºtrueï¼Œä¸”iommu=ptçš„æƒ…å†µï¼Œæˆ‘ä»¬è¿˜æ˜¯å›åˆ°<code>intel_iommu_init</code>çš„è¿™ä¸ªå‡½æ•°å½“ä¸­</p>
<div class="highlight"><pre><span></span><code>        if (iommu_identity_mapping) {
                ret = iommu_prepare_static_identity_mapping(hw_pass_through);
                if (ret) {
                        pr_crit(&quot;Failed to setup IOMMU pass-through\n&quot;);
                        goto free_iommu;
                }
        }
</code></pre></div>

<p>ä¸Šé¢è¿™ä¸ªå‡½æ•°ç‰‡æ–­æˆªå–è‡ª<code>init_dmars</code>è¿™ä¸ªå‡½æ•°ï¼Œå…¶æ ¸å¿ƒå‡½æ•°ä¸º<code>iommu_prepare_static_identity_mapping</code>ï¼Œå®ƒæœ€ç»ˆä¼šè°ƒåˆ°<code>domain_add_dev_info</code> è¿™ä¸ªå‡½æ•°å¹¶æœ€ç»ˆèµ°åˆ°<code>domain_context_mapping_one</code></p>
<div class="highlight"><pre><span></span><code><span class="nx">static</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">domain_context_mapping_one</span><span class="p">(</span><span class="nx">struct</span><span class="w"> </span><span class="nx">dmar_domain</span><span class="w"> </span><span class="o">*</span><span class="nx">domain</span><span class="p">,</span>
<span class="w">                                      </span><span class="nx">struct</span><span class="w"> </span><span class="nx">intel_iommu</span><span class="w"> </span><span class="o">*</span><span class="nx">iommu</span><span class="p">,</span>
<span class="w">                                      </span><span class="kt">u8</span><span class="w"> </span><span class="nx">bus</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="nx">devfn</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="o">......</span>
<span class="w">    </span><span class="c1">//è®¾ç½®translation type ä¸º paas through</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hw_pass_through</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">domain_type_is_si</span><span class="p">(</span><span class="nx">domain</span><span class="p">))</span>
<span class="w">                </span><span class="nx">translation</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">CONTEXT_TT_PASS_THROUGH</span><span class="p">;</span>
<span class="w">    </span><span class="o">......</span>
<span class="w">    </span><span class="c1">//è·å–è¿™ä¸ªè®¾å¤‡åœ¨contex tableè¡¨é‡Œé¢çš„åœ°å€</span>
<span class="w">    </span><span class="nx">context</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">iommu_context_addr</span><span class="p">(</span><span class="nx">iommu</span><span class="p">,</span><span class="w"> </span><span class="nx">bus</span><span class="p">,</span><span class="w"> </span><span class="nx">devfn</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">context</span><span class="p">)</span>
<span class="w">           </span><span class="nx">goto</span><span class="w"> </span><span class="nx">out_unlock</span><span class="p">;</span>

<span class="w">     </span><span class="nx">ret</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">context_present</span><span class="p">(</span><span class="nx">context</span><span class="p">))</span>
<span class="w">            </span><span class="nx">goto</span><span class="w"> </span><span class="nx">out_unlock</span><span class="p">;</span>

<span class="w">      </span><span class="nx">pgd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">pgd</span><span class="p">;</span><span class="w"> </span><span class="c1">//iovaé¡µè¡¨åŸºå€</span>

<span class="w">      </span><span class="nx">context_clear_entry</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
<span class="w">      </span><span class="nx">context_set_domain_id</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span><span class="w"> </span><span class="nx">did</span><span class="p">);</span>

<span class="w">    </span><span class="o">......</span><span class="p">.</span>
<span class="w">    </span><span class="c1">//ä¸‹é¢å‡½æ•°å¯ä»¥çœ‹å‡ºå¦‚æœæ˜¯åœ¨paas throughæ¨¡å¼ä¸‹ä¸ä¼šè®¾ç½®iovaé¡µè¡¨åœ°å€</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">translation</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">CONTEXT_TT_PASS_THROUGH</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">agaw</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">agaw</span><span class="p">;</span><span class="w"> </span><span class="nx">agaw</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">iommu</span><span class="o">-&gt;</span><span class="nx">agaw</span><span class="p">;</span><span class="w"> </span><span class="nx">agaw</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">ret</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="nx">ENOMEM</span><span class="p">;</span>
<span class="w">                        </span><span class="nx">pgd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">phys_to_virt</span><span class="p">(</span><span class="nx">dma_pte_addr</span><span class="p">(</span><span class="nx">pgd</span><span class="p">));</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">dma_pte_present</span><span class="p">(</span><span class="nx">pgd</span><span class="p">))</span>
<span class="w">                                </span><span class="nx">goto</span><span class="w"> </span><span class="nx">out_unlock</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="nx">info</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">iommu_support_dev_iotlb</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span><span class="w"> </span><span class="nx">iommu</span><span class="p">,</span><span class="w"> </span><span class="nx">bus</span><span class="p">,</span><span class="w"> </span><span class="nx">devfn</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">info</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">info</span><span class="o">-&gt;</span><span class="nx">ats_supported</span><span class="p">)</span>
<span class="w">                        </span><span class="nx">translation</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">CONTEXT_TT_DEV_IOTLB</span><span class="p">;</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                        </span><span class="nx">translation</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">CONTEXT_TT_MULTI_LEVEL</span><span class="p">;</span>

<span class="w">                </span><span class="c1">//épaas throughæ¨¡å¼ä¸‹éœ€è¦è®¾ç½®iovaé¡µè¡¨çš„åŸºåœ°å€</span>
<span class="w">                </span><span class="nx">context_set_address_root</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span><span class="w"> </span><span class="nx">virt_to_phys</span><span class="p">(</span><span class="nx">pgd</span><span class="p">));</span>
<span class="w">                </span><span class="nx">context_set_address_width</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span><span class="w"> </span><span class="nx">iommu</span><span class="o">-&gt;</span><span class="nx">agaw</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="cm">/*</span>
<span class="cm">                 * In pass through mode, AW must be programmed to</span>
<span class="cm">                 * indicate the largest AGAW value supported by</span>
<span class="cm">                 * hardware. And ASR is ignored by hardware.</span>
<span class="cm">                 */</span>
<span class="w">                </span><span class="nx">context_set_address_width</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span><span class="w"> </span><span class="nx">iommu</span><span class="o">-&gt;</span><span class="nx">msagaw</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// è®¾ç½®è½¬æ¢ç±»å‹</span>
<span class="w">        </span><span class="nx">context_set_translation_type</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span><span class="w"> </span><span class="nx">translation</span><span class="p">)</span>

<span class="p">}</span>
</code></pre></div>

<p>çœ‹å®Œä¹‹åå¤§å®¶åº”è¯¥æœ‰ä¸ªæ¯”è¾ƒæ¸…æ™°çš„ç†è§£ï¼Œä¸Šé¢ä¸»è¦ç†äº†ä¸€ä¸‹åœ¨iommu=ptï¼Œhwä¸ºtrueçš„æƒ…å†µï¼›å¦‚æœhwä¸ºfalseçš„æƒ…å†µåˆä¼šæ€ä¹ˆæ ·äº†ï¼Ÿå…·ä½“çš„é€»è¾‘è¿˜æ˜¯è¦ä»<code>init_dmars</code>è¿™ä¸ªå‡½æ•°å¼€å§‹çœ‹èµ·ï¼Œé€šè¿‡åˆ†æå¯ä»¥çœ‹åˆ°å› ä¸ºhw=falseä¹Ÿå°±æ˜¯è¯´iommuç¡¬ä»¶ä¸æ”¯æŒpaas through çš„translation typeï¼Œæ‰€ä»¥å¿…é¡»è¦æ˜¯åˆ›å»ºé¡µè¡¨çš„ï¼Œä½†æ˜¯å› ä¸ºæ˜¯é™æ€æ˜ å°„å³iovaå°±ç­‰äºhpaï¼Œæ‰€ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥è¿”å›paddrçš„ï¼Œä½†æ˜¯æ•ˆç‡è‚¯å®šæ˜¯æ²¡æ³•è·Ÿhw=trueç›¸æ¯”çš„ã€‚</p>
<p>èŠå®Œiommu=ptçš„å„ç§æƒ…å†µä¹‹åï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹iommuä¸ºé»˜è®¤è®¾ç½®çš„æƒ…å†µä¸‹è®¾å¤‡æ˜¯å¦‚ä½•è¿›è¡Œdmaæ“ä½œçš„ã€‚ è¿˜æ˜¯å…ˆè¦ä»<code>intel_iommu_init</code>è¿™ä¸ªå‡½æ•°é‡Œé¢çš„<code>init_dmars</code>çœ‹èµ·ï¼Œä»è¿™ç›¸å…³çš„é€»è¾‘æ¥çœ‹åŒºåˆ«åœ¨äºä¸ä¼šæå‰åˆ›å»ºsi_domain(å³æå‰åšå¥½iovaçš„æ˜ å°„)ï¼Œé‚£å®ƒæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯åœ¨dma_mapçš„æ—¶å€™è€Œä¸”dma mapç›¸å…³çš„apiè¿”å›çš„iovaï¼Œå¦‚æœå¤§å®¶æ„Ÿå…´è¶£å¯ä»¥å»ä»”ç»†è¯»ä¸€ä¸‹<code>__intel_map_single</code>è¿™ä¸ªå‡½æ•°ï¼Œéƒ¨åˆ†æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="c1">//å¦‚æœdevæ²¡æœ‰åˆ›å»ºdomainåˆ™é‡æ–°åˆ›å»ºï¼ŒåŒæ—¶å°†å…¶åŠ å…¥åˆ°contex tableé‡Œé¢</span>
<span class="w">        </span><span class="nx">domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">get_valid_domain_for_dev</span><span class="p">(</span><span class="nx">dev</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">domain</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="nx">iommu</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">domain_get_iommu</span><span class="p">(</span><span class="nx">domain</span><span class="p">);</span>
<span class="w">        </span><span class="nx">size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">aligned_nrpages</span><span class="p">(</span><span class="nx">paddr</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//åˆ†é…iova</span>
<span class="w">        </span><span class="nx">iova_pfn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">intel_alloc_iova</span><span class="p">(</span><span class="nx">dev</span><span class="p">,</span><span class="w"> </span><span class="nx">domain</span><span class="p">,</span><span class="w"> </span><span class="nx">dma_to_mm_pfn</span><span class="p">(</span><span class="nx">size</span><span class="p">),</span><span class="w"> </span><span class="nx">dma_mask</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">iova_pfn</span><span class="p">)</span>
<span class="w">                </span><span class="nx">goto</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
</code></pre></div>

<h3>è™šæ‹ŸåŒ–åœºæ™¯</h3>
<p>iommuåœ¨è™šæ‹ŸåŒ–åœºæ™¯æ‰®æ¼”ç€éå¸¸é‡è¦çš„ä½œç”¨ï¼Œå°¤å…¶æ˜¯åœ¨è®¾å¤‡ç›´é€šçš„åœºæ™¯ã€‚å¤§å®¶éƒ½çŸ¥é“åœ¨è™šæ‹Ÿæœºé‡Œé¢æ˜¯æ²¡æœ‰iommuçš„ï¼Œguest é‡Œé¢çš„æ‰€æœ‰çš„dma_opsèµ°çš„éƒ½æ˜¯noiommu(å½“ç„¶ä¹‹å‰ä¹Ÿæœ‰äººåœ¨æ¨viommuçš„æ–¹æ¡ˆ)ï¼Œæ‰€ä»¥å½“ä½ åœ¨guesté‡Œé¢ä½¿ç”¨dma_mapè¿™ç§ç±»ä¼¼çš„apiçš„æ—¶å€™ï¼Œå…¶è¿”å›çš„éƒ½æ˜¯gpaã€‚è¿™æ ·é—®é¢˜å°±æ¥äº†ï¼Œä½ æƒ³æƒ³å¦‚æœè™šæ‹Ÿæœºä½¿ç”¨çš„æ˜¯virtio-net or virtio-blkè¿™ç§å®Œå…¨æ¨¡æ‹Ÿçš„è®¾å¤‡è¿˜å¥½ï¼Œå› ä¸ºå…¶æœ¬è´¨éƒ½è¿˜æ˜¯å…±äº«å†…å­˜è¿˜æ˜¯åœ¨mmuå±‚åšè½¬æ¢ã€‚ä½†æ˜¯åœ¨ç›´é€šè®¾å¤‡çš„åœºæ™¯ä¸‹ï¼Œå®ƒå°±æ˜¯è·ŸçœŸçš„å¤–è®¾æ‰“äº¤é“ï¼Œè€Œå¤–è®¾æ˜¯æ— æ³•ç›´æ¥dma gpaçš„ï¼Œå®ƒå¿…ç„¶è¦åšä¸€å±‚è½¬æ¢ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹è™šæ‹ŸåŒ–åœºæ™¯ä¸‹iommuæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>
<p>é¦–å…ˆï¼Œå¦‚æœä½ è¦åœ¨è™šæ‹Ÿæœºåœºæ™¯ä¸‹åšè®¾å¤‡ç›´é€šé‚£æˆ‘ä»¬ç»å¸¸ä¼šåœ¨kernel cmdlineé‡Œé¢åšiommu=pt, intel_iommu=on(å½“ç„¶ä¹Ÿå¯ä»¥æ˜¯amd, arm)ã€‚ç„¶åæŠŠvfæˆ–è€…pfä»åŸæ¥çš„é©±åŠ¨unbindæ‰ï¼Œç„¶åbindåˆ°<code>vfio_pci</code>ï¼Œæ¥ç€åœ¨å¯åŠ¨è™šæ‹Ÿæœºçš„æ—¶å€™æˆ‘ä»¬éœ€è¦å¯¹è®¾å¤‡åœ¨vfioå±‚é¢è¿›è¡Œç›¸å…³çš„åˆå§‹åŒ–ï¼Œç„¶åå¹¶å¯¹guestæ‰€æœ‰çš„å†…å­˜åšvfio_dma_mapã€‚iommu=ptè¿™ä¸ªç”±äºå‰é¢å·²ç»åˆ†æè¿‡äº†ï¼Œè¿™é‡Œæˆ‘å°±ä¸å†ç»†è®²ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æŠŠvfæˆ–è€…pfä»åŸæ¥çš„é©±åŠ¨unbindçš„è¿‡ç¨‹ä¸­è·Ÿiommuç›¸å…³çš„å“ªäº›ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="nx">static</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">device_notifier</span><span class="p">(</span><span class="nx">struct</span><span class="w"> </span><span class="nx">notifier_block</span><span class="w"> </span><span class="o">*</span><span class="nx">nb</span><span class="p">,</span>
<span class="w">                                  </span><span class="nx">unsigned</span><span class="w"> </span><span class="nx">long</span><span class="w"> </span><span class="nx">action</span><span class="p">,</span><span class="w"> </span><span class="nx">void</span><span class="w"> </span><span class="o">*</span><span class="nx">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="nx">struct</span><span class="w"> </span><span class="nx">device</span><span class="w"> </span><span class="o">*</span><span class="nx">dev</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span>
<span class="w">        </span><span class="nx">struct</span><span class="w"> </span><span class="nx">dmar_domain</span><span class="w"> </span><span class="o">*</span><span class="nx">domain</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">iommu_dummy</span><span class="p">(</span><span class="nx">dev</span><span class="p">))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">action</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">BUS_NOTIFY_REMOVED_DEVICE</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="nx">domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">find_domain</span><span class="p">(</span><span class="nx">dev</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">domain</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="nx">dmar_remove_one_dev_info</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span><span class="w"> </span><span class="nx">dev</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">domain_type_is_vm_or_si</span><span class="p">(</span><span class="nx">domain</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">devices</span><span class="p">))</span>
<span class="w">                </span><span class="nx">domain_exit</span><span class="p">(</span><span class="nx">domain</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">static</span><span class="w"> </span><span class="nx">struct</span><span class="w"> </span><span class="nx">notifier_block</span><span class="w"> </span><span class="nx">device_nb</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="nx">notifier_call</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">device_notifier</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>

<p>è¿™ä¸ªæ˜¯æ¯”è¾ƒæ ¸å¿ƒçš„åœ°æ–¹ï¼Œä»ä¸Šé¢çš„é€»è¾‘å¯ä»¥çœ‹å‡ºè®¾å¤‡ä»å…¶åŸæ¥çš„driver unbindçš„æ—¶å€™ä¼šå¦‚æœè¿™ä¸ªè®¾å¤‡å·²ç»æœ‰äº†ç›¸å…³çš„dmar_domainæ¯”å¦‚ä¹‹å‰è¯´çš„åœ¨ptçš„åœºæ™¯ä¸‹ä¼šæå‰åˆ›å»ºå¥½é™æ€mapping si_domainï¼Œé‚£ä¹ˆè¿™æ—¶å€™ä¼šæŠŠè®¾å¤‡ä»si_domainç§»é™¤ã€‚</p>
<p>ç„¶åå†çœ‹æŠŠè®¾å¤‡bindåˆ°vfio-pci driverçš„æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿæœ€ç»ˆå…¶ä¼šè°ƒåˆ°<code>vfio_pci_probe</code>è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œå…¶æ ¸å¿ƒçš„é€»è¾‘å…·ä½“å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>vfio_iommu_group_get</code></li>
</ul>
<p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯åˆ¤æ–­è¿™ä¸ªè®¾å¤‡æ˜¯å¦å±äºæŸä¸ªiommu_groupï¼Œå¦‚æœæ²¡æœ‰åˆ™æŠ¥é”™ã€‚</p>
<ul>
<li><code>vfio_add_group_dev</code></li>
</ul>
<p>è¿™ä¸ªå‡½æ•°é¦–å…ˆä»è¯¥è®¾å¤‡æ‰€å±çš„iommu_groupæ‰¾åˆ°ç›¸åº”çš„<code>vfio_group</code>ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™ä¼šä¸ºè¿™ä¸ª<code>iommu_group</code>åˆ›å»º<code>vfio_group</code>ï¼›ç„¶åå†æŠŠè¿™ä¸ªdevè·Ÿ<code>vfio_device</code>å…³è”èµ·æ¥ï¼ŒåŒæ—¶ä¸ºè¿™ä¸ª<code>vfio_dev</code>ç»‘å®š<code>vfio_device_ops</code></p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">vfio_device_ops</span><span class="w"> </span><span class="n">vfio_pci_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">.</span><span class="n">name</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;vfio-pci&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="o">.</span><span class="n">open</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">vfio_pci_open</span><span class="p">,</span>
<span class="w">        </span><span class="o">.</span><span class="n">release</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">vfio_pci_release</span><span class="p">,</span>
<span class="w">        </span><span class="o">.</span><span class="n">ioctl</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">vfio_pci_ioctl</span><span class="p">,</span>
<span class="w">        </span><span class="o">.</span><span class="n">read</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">vfio_pci_read</span><span class="p">,</span>
<span class="w">        </span><span class="o">.</span><span class="n">write</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">vfio_pci_write</span><span class="p">,</span>
<span class="w">        </span><span class="o">.</span><span class="n">mmap</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">vfio_pci_mmap</span><span class="p">,</span>
<span class="w">        </span><span class="o">.</span><span class="n">request</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">vfio_pci_request</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>

<p>ä¸Šé¢æˆ‘ä»¬ä¸»è¦æ˜¯èŠäº†ä¸€ä¸‹è®¾å¤‡ç›´é€šä¹‹å‰çš„ä¸€äº›å‡†å¤‡å·¥ä½œï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹qemuä¾§ç›´é€šè®¾å¤‡vfioç›¸å…³çš„æ“ä½œï¼Œä¸ºäº†è®©å¤§å®¶æ›´çš„å¥½ç†è§£æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬è¦æŠŠpci device 0000:06:0d.0 ç›´é€šç»™vmï¼Œåˆ™çœ‹ä¸€ä¸‹ç›¸å…³çš„ä¿¡æ¯ï¼š</p>
<blockquote>
<p>readlink /sys/bus/pci/devices/0000:06:0d.0/iommu_group</p>
<p>../../../../kernel/iommu_groups/26</p>
</blockquote>
<p>ç„¶åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹qemuä¾§vfioè®¾å¤‡çš„åˆå§‹æ“ä½œå‡½æ•°vfio_realizeï¼Œç›¸å…³çš„é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li>vfio_get_group</li>
</ul>
<blockquote>
<p>snprintf(path, sizeof(path), "/dev/vfio/%d", groupid);</p>
<p>group-&gt;fd = qemu_open(path, O_RDWR);</p>
</blockquote>
<p>é¦–å…ˆæ‰“å¼€è¿™ä¸ªgroupï¼Œä»¥ä¸Šé¢çš„deviceä¸ºä¾‹å­åˆ™è¿™ä¸ªgroupidä¸º26ï¼Œè¿™ä¸ªopenå‡½æ•°å¯¹åº”çš„æ˜¯opså‡½æ•°å¦‚ä¸‹:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">file_operations</span><span class="w"> </span><span class="n">vfio_group_fops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">.</span><span class="n">owner</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="w">        </span><span class="o">.</span><span class="n">unlocked_ioctl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vfio_group_fops_unl_ioctl</span><span class="p">,</span>
<span class="c1">#ifdef CONFIG_COMPAT</span>
<span class="w">        </span><span class="o">.</span><span class="n">compat_ioctl</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">vfio_group_fops_compat_ioctl</span><span class="p">,</span>
<span class="c1">#endif</span>
<span class="w">        </span><span class="o">.</span><span class="n">open</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">vfio_group_fops_open</span><span class="p">,</span>
<span class="w">        </span><span class="o">.</span><span class="n">release</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">vfio_group_fops_release</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>

<p><code>vfio_group_fops_open</code>å‡½æ•°æ ¸å¿ƒé€»è¾‘å°±æ˜¯è¦æ‰¾åˆ°è¿™ä¸ªè®¾å¤‡æ‰€å±äºçš„<code>vfio_group</code>å¹¶æŠŠå®ƒèµ‹ç»™è¿™ä¸ªfileï¼Œé‚£è¿™ä¸ª<code>vfio_group</code>æ˜¯åœ¨è®¾å¤‡bindåˆ°<code>vfio_pci</code>çš„æ—¶å€™åˆ›å»ºçš„ã€‚ç´§æ¥ç€ä¼šåˆ¤æ–­è¿™ä¸ªè®¾å¤‡çš„vfio groupæ˜¯å¦å¯ç”¨ï¼Œç›¸å…³é€»è¾‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="kr">group</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">VFIO_GROUP_GET_STATUS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error_setg_errno</span><span class="p">(</span><span class="n">errp</span><span class="p">,</span><span class="w"> </span><span class="n">errno</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;failed to get group %d status&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">groupid</span><span class="p">);</span>
<span class="w">        </span><span class="n">goto</span><span class="w"> </span><span class="n">close_fd_exit</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VFIO_GROUP_FLAGS_VIABLE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error_setg</span><span class="p">(</span><span class="n">errp</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;group %d is not viable&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">groupid</span><span class="p">);</span>
<span class="w">        </span><span class="n">error_append_hint</span><span class="p">(</span><span class="n">errp</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;Please ensure all devices within the iommu_group &quot;</span>
<span class="w">                          </span><span class="s">&quot;are bound to their vfio bus driver.\n&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">goto</span><span class="w"> </span><span class="n">close_fd_exit</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>é€šè¿‡ioctlè°ƒåˆ°vfioæ¨¡å—å½“ä¸­ï¼Œå…·ä½“çš„é€»è¾‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">vfio_group_viable</span><span class="p">(</span><span class="kr">group</span><span class="p">))</span>
<span class="w">            </span><span class="n">status</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VFIO_GROUP_FLAGS_VIABLE</span><span class="p">;</span>

<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="kr">group</span><span class="o">-&gt;</span><span class="n">container</span><span class="p">)</span>
<span class="w">             </span><span class="n">status</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VFIO_GROUP_FLAGS_CONTAINER_SET</span><span class="p">;</span>
</code></pre></div>

<p>ç´§æ¥ç€ä¼šè°ƒç”¨<code>vfio_connect_container</code>ï¼Œ è¿™ä¸ªcontaineræ˜¯vfioå±‚é¢çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå®ƒè·Ÿvmçš„address spaceç›¸å…³è”ï¼Œè¿™ä¸ªå‡½æ•°çš„å…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li>
<p>å¦‚æœcontainerå­˜åœ¨ï¼Œåˆ™ç›´æ¥è°ƒç”¨<code>VFIO_GROUP_SET_CONTAINER</code> è¿™ä¸ªioctlå°†è¿™ä¸ªè®¾å¤‡æ‰€å±çš„vfio_groupè·Ÿè¿™ä¸ªcontaineå…³è”èµ·æ¥ï¼Œå…·ä½“è¿™ä¸ªioctlåˆ°åº•åšäº†å“ªäº›äº‹æƒ…ï¼Œæˆ‘ä»¬åé¢å†è¯¦ç»†è¯´</p>
</li>
<li>
<p>å¦‚æœcontainerä¸å­˜åœ¨ï¼Œåˆ™éœ€è¦å…ˆåˆ›å»ºå‡ºæ¥ï¼Œå…·ä½“çš„åˆ›å»ºé€»è¾‘å¦‚ä¸‹</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>fd = qemu_open(&quot;/dev/vfio/vfio&quot;, O_RDWR);
</code></pre></div>

<p>è¿™ä¸ªcontainerå°±æ˜¯è¿™åœ¨ä¸ªæ—¶å€™åˆ›å»ºå‡ºæ¥çš„ï¼Œå®ƒåœ¨vfioå±‚è°ƒç”¨çš„æ˜¯vfio_opsçš„openå‡½æ•°ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code>static int vfio_fops_open(struct inode *inode, struct file *filep)
{
        struct vfio_container *container;

        container = kzalloc(sizeof(*container), GFP_KERNEL);
        if (!container)
                return -ENOMEM;

        INIT_LIST_HEAD(&amp;container-&gt;group_list);
        init_rwsem(&amp;container-&gt;group_lock);
        kref_init(&amp;container-&gt;kref);

        filep-&gt;private_data = container;

        return 0;
}
</code></pre></div>

<p>æ¥ç€è°ƒç”¨<code>vfio_init_container</code>å‡½æ•°ï¼Œé¦–å…ˆå»è·å–ä¸€ä¸‹<code>iommu_type</code>ï¼Œç›®å‰çš„é€»è¾‘æ˜¯<code>VFIO_TYPE1v2_IOMMU</code>ä¼˜å…ˆ(åœ¨driver/vfio/vfio_iommu_type1.c)ï¼Œç„¶åé€šè¿‡<code>VFIO_GROUP_SET_CONTAINER</code>è¿™ä¸ªioctlå…·ä½“åšçš„äº‹æƒ…ã€‚å®ƒæœ€ç»ˆä¼šè°ƒåˆ°<code>vfio_group_set_container</code> è¿™ä¸ªå‡½æ•°ï¼Œå…¶æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹:</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container</span><span class="o">-&gt;</span><span class="n">iommu_driver</span><span class="p">;</span>
<span class="w">        </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">driver</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">attach_group</span><span class="p">(</span><span class="n">container</span><span class="o">-&gt;</span><span class="n">iommu_data</span><span class="p">,</span>
<span class="w">                                                </span><span class="kr">group</span><span class="o">-&gt;</span><span class="n">iommu_group</span><span class="p">);</span>
<span class="w">                </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">                        </span><span class="n">goto</span><span class="w"> </span><span class="n">unlock_out</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>

<p>æ³¨æ„è¿™ä¸ªæ—¶å€™ç”±äºdriverç›®å‰è¿˜æ²¡æœ‰è®¾ç½®æ‰€ä»¥ä¸ºç©ºï¼Œæ•…è¿™ä¸ªå‡½æ•°ä¸»è¦çš„ä½œç”¨å°±æ˜¯æŠŠè¿™ä¸ªè®¾å¤‡æ‰€å±çš„vfio_groupè·Ÿè¿™ä¸ªcontainerå…³è”èµ·æ¥ï¼Œç„¶åå°†è¿™ä¸ªvfio_groupæ·»åŠ åˆ°containerçš„group_listã€‚æ¥ç€è°ƒç”¨<code>VFIO_SET_IOMMU</code>è¿™ä¸ªioctlä¸ºè¿™ä¸ªcontaineråšç›¸å…³é…ç½®ï¼Œå…¥å£å‡½æ•°ä¸º<code>vfio_ioctl_set_iommu</code>å…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li>
<p><code>vfio_iommu_type1_open</code>
åˆ›å»ºä¸€ä¸ª<code>vfio_iommu</code>ï¼Œå¹¶åˆå§‹åŒ–è¿™ä¸ª<code>vfio_iommu</code> çš„<code>domain_list</code>ï¼Œåˆå§‹åŒ–è¿™ä¸ªiommuçš„<code>dma_list</code>ä¸ºRB_ROOTã€‚</p>
</li>
<li>
<p><code>__vfio_container_attach_groups</code></p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">static</span><span class="w"> </span><span class="nt">int</span><span class="w"> </span><span class="nt">__vfio_container_attach_groups</span><span class="o">(</span><span class="nt">struct</span><span class="w"> </span><span class="nt">vfio_container</span><span class="w"> </span><span class="o">*</span><span class="nt">container</span><span class="o">,</span>
<span class="w">                                          </span><span class="nt">struct</span><span class="w"> </span><span class="nt">vfio_iommu_driver</span><span class="w"> </span><span class="o">*</span><span class="nt">driver</span><span class="o">,</span>
<span class="w">                                          </span><span class="nt">void</span><span class="w"> </span><span class="o">*</span><span class="nt">data</span><span class="o">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="err">struct</span><span class="w"> </span><span class="err">vfio_group</span><span class="w"> </span><span class="err">*group</span><span class="p">;</span>
<span class="w">        </span><span class="err">int</span><span class="w"> </span><span class="err">ret</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">-ENODEV</span><span class="p">;</span>

<span class="w">        </span><span class="err">list_for_each_entry(group,</span><span class="w"> </span><span class="err">&amp;container-&gt;group_list,</span><span class="w"> </span><span class="err">container_next)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="err">ret</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">driver-&gt;ops-&gt;attach_group(data,</span><span class="w"> </span><span class="err">group-&gt;iommu_group)</span><span class="p">;</span>
<span class="w">                </span><span class="err">if</span><span class="w"> </span><span class="err">(ret)</span>
<span class="w">                        </span><span class="err">goto</span><span class="w"> </span><span class="err">unwind</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nt">return</span><span class="w"> </span><span class="nt">ret</span><span class="o">;</span>

<span class="nt">unwind</span><span class="o">:</span>
<span class="w">        </span><span class="nt">list_for_each_entry_continue_reverse</span><span class="o">(</span><span class="nt">group</span><span class="o">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nt">container-</span><span class="o">&gt;</span><span class="nt">group_list</span><span class="o">,</span>
<span class="w">                                             </span><span class="nt">container_next</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="err">driver-&gt;ops-&gt;detach_group(data,</span><span class="w"> </span><span class="err">group-&gt;iommu_group)</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nt">return</span><span class="w"> </span><span class="nt">ret</span><span class="o">;</span>
<span class="err">}</span>
</code></pre></div>

<p>ä»å®ç°æ¥çœ‹ï¼Œéå†<code>container-&gt;group_list</code>é‡Œé¢çš„groupï¼ˆè¿™ä¸ªæ—¶å€™åº”è¯¥åªæœ‰ä¸€ä¸ª)ï¼Œç„¶åè°ƒç”¨<code>attach_group</code> è¿™ä¸ªcallbackå‡½æ•°ï¼Œå…¶æœ€ç»ˆè°ƒç”¨çš„å‡½æ•°ä¸º<code>vfio_iommu_type1_attach_group</code> ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°æ ¸å¿ƒé€»è¾‘ï¼š</p>
<ol>
<li>
<p>é¦–å…ˆéå†ä¼ å…¥çš„å‚æ•°1ä¹Ÿå°±æ˜¯<code>vfio_iommu</code>çš„<code>domain_list</code>æ¯ä¸€ä¸ª<code>vfio_domain</code>ï¼Œç„¶åéå†æ¯ä¸ª<code>vfio_domain-&gt;group_list</code>å½“ä¸­çš„<code>vfio_group</code>ï¼Œåˆ¤æ–­è¯¥è®¾å¤‡æ‰€å±äºçš„<code>iommu_group</code>å·²ç»attachè¿‡ã€‚</p>
</li>
<li>
<p>å¦‚æœstep1é‡Œé¢æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™æ–°å»º<code>vfio_group</code>å’Œ<code>vfio_domain</code>ï¼Œå¹¶æŠŠ<code>vfio_group-&gt;iommu_group</code>æŒ‡å‘è¯¥è®¾å¤‡æ‰€å±çš„iommu_group</p>
</li>
<li>
<p>åˆ¤æ–­è¯¥è®¾å¤‡çš„<code>iommu_group</code>ä¸‹çš„æ¯ä¸ªè®¾å¤‡çš„bus typeæ˜¯å¦ä¸ºvfio busã€‚</p>
</li>
<li>
<p>é€šè¿‡<code>iommu_domain_alloc</code>ä¸ºæ–°å»ºçš„vfio_domainåˆ›æ–°çš„<code>iommu_domain</code>ï¼Œå…¶æœ€ç»ˆè°ƒç”¨çš„å‡½æ•°ä¸º<code>intel_iommu_domain_alloc</code> </p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="nx">static</span><span class="w"> </span><span class="nx">struct</span><span class="w"> </span><span class="nx">iommu_domain</span><span class="w"> </span><span class="o">*</span><span class="nx">intel_iommu_domain_alloc</span><span class="p">(</span><span class="nx">unsigned</span><span class="w"> </span><span class="k">type</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="nx">struct</span><span class="w"> </span><span class="nx">dmar_domain</span><span class="w"> </span><span class="o">*</span><span class="nx">dmar_domain</span><span class="p">;</span>
<span class="w">        </span><span class="nx">struct</span><span class="w"> </span><span class="nx">iommu_domain</span><span class="w"> </span><span class="o">*</span><span class="nx">domain</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">IOMMU_DOMAIN_UNMANAGED</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">NULL</span><span class="p">;</span>

<span class="w">        </span><span class="nx">dmar_domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">alloc_domain</span><span class="p">(</span><span class="nx">DOMAIN_FLAG_VIRTUAL_MACHINE</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">dmar_domain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">pr_err</span><span class="p">(</span><span class="s">&quot;Can&#39;t allocate dmar_domain\n&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">md_domain_init</span><span class="p">(</span><span class="nx">dmar_domain</span><span class="p">,</span><span class="w"> </span><span class="nx">DEFAULT_DOMAIN_ADDRESS_WIDTH</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">pr_err</span><span class="p">(</span><span class="s">&quot;Domain initialization failed\n&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="nx">domain_exit</span><span class="p">(</span><span class="nx">dmar_domain</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">domain_update_iommu_cap</span><span class="p">(</span><span class="nx">dmar_domain</span><span class="p">);</span>

<span class="w">        </span><span class="nx">domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">dmar_domain</span><span class="o">-&gt;</span><span class="nx">domain</span><span class="p">;</span>
<span class="w">        </span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">aperture_start</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">aperture_end</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nx">__DOMAIN_MAX_ADDR</span><span class="p">(</span><span class="nx">dmar_domain</span><span class="o">-&gt;</span><span class="nx">gaw</span><span class="p">);</span>
<span class="w">        </span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">force_aperture</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">domain</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>å…¶æ ¸å¿ƒé€»è¾‘ä¸ºåˆ›å»ºdmar_domainï¼Œç„¶ååˆå§‹åŒ–iovaé¡µè¡¨çš„pgd</p>
<div class="highlight"><pre><span></span><code><span class="nx">static</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">md_domain_init</span><span class="p">(</span><span class="nx">struct</span><span class="w"> </span><span class="nx">dmar_domain</span><span class="w"> </span><span class="o">*</span><span class="nx">domain</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">guest_width</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="nx">int</span><span class="w"> </span><span class="nx">adjust_width</span><span class="p">;</span>

<span class="w">        </span><span class="nx">init_iova_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">iovad</span><span class="p">,</span><span class="w"> </span><span class="nx">VTD_PAGE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="nx">IOVA_START_PFN</span><span class="p">);</span>
<span class="w">        </span><span class="nx">domain_reserve_special_ranges</span><span class="p">(</span><span class="nx">domain</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* calculate AGAW */</span>
<span class="w">        </span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">gaw</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">guest_width</span><span class="p">;</span>
<span class="w">        </span><span class="nx">adjust_width</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">guestwidth_to_adjustwidth</span><span class="p">(</span><span class="nx">guest_width</span><span class="p">);</span>
<span class="w">        </span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">agaw</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">width_to_agaw</span><span class="p">(</span><span class="nx">adjust_width</span><span class="p">);</span>

<span class="w">        </span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">iommu_coherency</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">iommu_snooping</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">iommu_superpage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">max_addr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* always allocate the top pgd */</span>
<span class="w">        </span><span class="c1">//dmaè¿›è¡Œè½¬æ¢çš„é¡µè¡¨åŸºåœ°å€ï¼Œå¯ä»¥å‚è€ƒå›¾1</span>
<span class="w">        </span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">pgd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="nx">struct</span><span class="w"> </span><span class="nx">dma_pte</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="nx">alloc_pgtable_page</span><span class="p">(</span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">nid</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">pgd</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="nx">ENOMEM</span><span class="p">;</span>
<span class="w">        </span><span class="nx">domain_flush_cache</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span><span class="w"> </span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">pgd</span><span class="p">,</span><span class="w"> </span><span class="nx">PAGE_SIZE</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>ç´§æ¥ç€è°ƒç”¨ <code>iommu_attach_group</code>ï¼Œå°†<code>iommu_group</code>ä¸‹é¢çš„è®¾å¤‡ç»‘å®šåˆ°æ–°å»ºçš„iommu_domainä¸Šï¼Œå‡½æ•°æœ€ç»ˆä¼šè°ƒåˆ°<code>intel_iommu_attach_device</code> è¿™ä¸ªå‡½æ•°ï¼Œå…·ä½“çš„è°ƒç”¨é€»è¾‘å¦‚ä¸‹ï¼š</p>
<blockquote>
<ul>
<li><code>intel_iommu_attach_device</code></li>
<li><code>domain_add_dev_info</code>
        - <code>dmar_insert_one_dev_info</code>
           - <code>domain_attach_iommu</code>
           - <code>domain_context_mapping</code>
               - <code>domain_context_mapping_one</code></li>
</ul>
</blockquote>
<p>ä¸»è¦å®ç°çš„å°±æ˜¯æŠŠcontext tableå»ºç«‹èµ·æ¥ï¼Œå¹¶è®¾ç½®ç›¸å…³çš„context entryçš„å±æ€§ç­‰ã€‚ç„¶ååˆå§‹åŒ–è¿™ä¸ª<code>vfio_domain</code>çš„<code>group_list</code>ï¼Œå¹¶æŠŠè¿™ä¸ªvfio_groupæ·»åŠ åˆ°è¿™ä¸ªè¿™ä¸ªgroupå½“ä¸­ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">);</span>
<span class="w">    </span><span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">group</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">)</span>
</code></pre></div>

<p>æ¥ç€å¾€ä¸‹çœ‹ç›¸å…³çš„é€»è¾‘</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">domain_list</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">ops</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">ops</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                    </span><span class="n">d</span><span class="o">-&gt;</span><span class="n">prot</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">iommu_detach_group</span><span class="p">(</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span><span class="w"> </span><span class="n">iommu_group</span><span class="p">);</span>
<span class="w">                        </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">iommu_attach_group</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span><span class="w"> </span><span class="n">iommu_group</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">group</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">);</span>
<span class="w">                                </span><span class="n">iommu_domain_free</span><span class="p">(</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">);</span>
<span class="w">                                </span><span class="n">kfree</span><span class="p">(</span><span class="n">domain</span><span class="p">);</span>
<span class="w">                                </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">                                </span><span class="kr">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span>

<span class="w">                        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iommu_attach_group</span><span class="p">(</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span><span class="w"> </span><span class="n">iommu_group</span><span class="p">);</span>
<span class="w">                        </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">                                </span><span class="n">goto</span><span class="w"> </span><span class="n">out_domain</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>

<p>ä¸ºäº†æ›´å¥½çš„ç†è§£ä¸Šé¢çš„è¿™æ®µé€»è¾‘ï¼Œå…ˆå›å¿†ä¸‹è¿™å‡ ä¸ªæ¦‚å¿µï¼šcontainer, vfio_iommu, vfio_group, <code>vfio_domain</code>ã€‚å…¶ä¸­containeræ˜¯per vmçš„ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªvmåªä¼šæœ‰ä¸€ä¸ªcontainerï¼›<code>vfio_iommu</code>æ˜¯åœ¨containeråˆå§‹åŒ–çš„æ—¶å€™åˆ›å»ºçš„ï¼Œå®ƒä¹Ÿæ˜¯per vmçš„ï¼›<code>vfio_group</code>è·Ÿ<code>iommu_group</code>æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæœ‰å¤šå°‘ä¸ª<code>iommu_group</code>å°±åº”è¯¥æœ‰å¤šå°‘ä¸ª<code>vfio_group</code>ï¼›å…³äº<code>vfio_domain</code>æ•°é‡æˆ‘ä»¬éœ€è¦åˆ†æä¸€ä¸‹ä¸Šé¢çš„ä»£ç ç‰‡æ®µï¼Œä»å®ç°æ¥çœ‹<strong>å¦‚æœæ–°åˆ›å»ºçš„domainçš„opså’Œprot(å±æ€§IOMMU_CACHE, IOMMU_READ, IOMMU_WRITE)è·Ÿå·²ç»å­˜åœ¨çš„domainç›¸åŒåˆ™ç›´æ¥æŠŠè¿™ä¸ªiommu_groupç›´æ¥attachåˆ°å·²å­˜åœ¨çš„domainä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´å¤šä¸ªiommu_groupæˆ–è€…è¯´vfio_groupå¯¹åº”ä¸€ä¸ªvfio_domain</strong>ã€‚æ¥ç€å¾€ä¸‹ç»§ç»­ï¼Œå¦‚æœä¸æ»¡è¶³ä¸Šé¢æ‰€è¯´çš„æ¡ä»¶(æˆ–è€…åˆæ¬¡åˆ›å»ºiommu domain_listä¸ºç©ºçš„æ—¶å€™)åˆ™</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="o">/*</span><span class="w"> </span><span class="n">replay</span><span class="w"> </span><span class="n">mappings</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">domains</span><span class="w"> </span><span class="o">*/</span>
<span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">vfio_iommu_replay</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span><span class="w"> </span><span class="n">domain</span><span class="p">);</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">     </span><span class="n">goto</span><span class="w"> </span><span class="n">out_detach</span><span class="p">;</span>
<span class="c1">// å°†æ–°åˆ›å»ºçš„domainåŠ åˆ°vfio_iommuçš„domain_listé“¾è¡¨é‡Œé¢</span>
<span class="w"> </span><span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">domain_list</span><span class="p">);</span>
</code></pre></div>

<p><code>vfio_iommu_replay</code> è¿™ä¸ªå‡½æ•°çš„ä¸»è¦é€»è¾‘æ˜¯æ‰¾åˆ°<code>iommu-&gt;domain_list</code> çš„ç¬¬ä¸€ä¸ªdomainï¼Œç„¶åæŠŠ<code>iommu-&gt;dma_list</code> ä¸‹çš„æ‰€æœ‰çš„dmaåŒºåŸŸå…¨éƒ¨mappingåˆ°æ–°åˆ›å»ºçš„domainé‡Œé¢(å½“ç„¶åœ¨åˆå§‹åŒ–é˜¶æ®µè¿™ä¸¤è€…éƒ½æ˜¯ä¸ºç©ºçš„)ã€‚ä¹‹æ‰€ä»¥æ˜¯ç¬¬ä¸€ä¸ªæ˜¯å› ä¸ºæ–°åˆ›å»ºçš„domainéƒ½æ˜¯æ’åœ¨domain_listçš„é¦–éƒ¨ï¼Œè€Œå¤´éƒ¨çš„domain mappingé‡Œé¢åŒ…å«äº†å…¶åé¢çš„æ‰€æœ‰domainçš„dma mappingã€‚æ ¸å¿ƒé€»è¾‘èµ°å®Œï¼Œå›åˆ°<code>vfio_ioctl_set_iommu</code> å‡½æ•°ï¼Œè¿™é‡Œä¼šæŠŠæ‰¾åˆ°çš„driverå’Œæ–°åˆ›å»ºçš„<code>vfio_iommu</code>èµ‹å€¼ç»™container</p>
<div class="highlight"><pre><span></span><code><span class="nx">container</span><span class="o">-&gt;</span><span class="nx">iommu_driver</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">driver</span><span class="p">;</span><span class="w"> </span><span class="c1">//vfio iommu type1</span>
<span class="nx">container</span><span class="o">-&gt;</span><span class="nx">iommu_data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span><span class="w"> </span><span class="c1">// vfio_iommu</span>
</code></pre></div>

<p>è‡³æ­¤ï¼Œvfio_realizeå½“ä¸­è·Ÿvm dmaç›¸å…³æ•°æ®ç»“æ„åˆå§‹åŒ–æœ‰å…³çš„å·¥ä½œå·²ç»å®Œæˆï¼Œé‚£æˆ‘ä»¬çœ‹ä¸€ä¸‹dma é¡µè¡¨çš„åˆå§‹åŒ–ã€‚qemuå½“ä¸­æ˜¯é€šè¿‡æ³¨å†Œmemory region listener callbackæ¥å°†vmæ‰€æœ‰çš„å†…å­˜éƒ½mappingèµ·æ¥çš„ï¼Œå…·ä½“è°ƒç”¨é€»è¾‘</p>
<div class="highlight"><pre><span></span><code><span class="nx">vfio_dma_map</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span><span class="w"> </span><span class="nx">iova</span><span class="p">,</span><span class="w"> </span><span class="nx">int128_get64</span><span class="p">(</span><span class="nx">llsize</span><span class="p">),</span>
<span class="w">                       </span><span class="nx">vaddr</span><span class="p">,</span><span class="w"> </span><span class="nx">section</span><span class="o">-&gt;</span><span class="nx">readonly</span><span class="p">);</span>
</code></pre></div>

<p>è¿™é‡Œé¢iovaå°±æ˜¯gpaï¼Œ vaddrå°±æ˜¯hvaï¼Œå®ƒæ˜¯é€šè¿‡<code>VFIO_IOMMU_MAP_DMA</code> è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ¥å®ç°çš„ï¼Œç„¶åç»§ç»­è¿½ä¸€ä¸‹è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„å®ç°</p>
<blockquote>
<ul>
<li><code>vfio_dma_do_map</code><ul>
<li><code>vfio_find_dma</code> // checkä¸€ä¸‹ vfio_iommuçš„dma_list(çº¢é»‘æ ‘)é‡Œé¢æ˜¯å¦å·²ç»æœ‰äº†è¿™ä¸ªdma mapçš„iovaåŒºåŸŸ</li>
<li><code>vfio_link_dma</code> //å°†è¦åšdma mapçš„iovaåŒºåŸŸæ’å…¥åˆ° dma_listã€‚</li>
<li><code>vfio_pin_pages</code> //ä¸ºhvaåˆ†é…ç›¸å¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œç„¶åpinè¯¥ç‰©ç†é¡µ</li>
<li><code>vfio_iommu_map</code> //ä¸ºiommu-&gt;domain_listæ¯ä¸ªdomainåšmapping<ul>
<li><code>iommu_map</code>
           -&gt; <code>intel_iommu_map</code>
                    -&gt;<code>domain_pfn_mapping</code> //å®Œæˆiovaåˆ°pfnçš„æ˜ å°„å³gpa-&gt;hpa</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>å› ä¸ºiovaæ˜¯gpaï¼Œæ‰€ä»¥å½“guesté‡Œé¢ä½¿ç”¨dma_map apiç›´æ¥è¿”å›gpaåœ°å€ï¼Œä½†æ˜¯ç”±äºé¡µè¡¨é‡Œé¢æ˜ å°„çš„ä¹Ÿæ˜¯iova-&gt;hpaï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ç¡¬ä»¶å‘å‡ºçš„dmaæ“ä½œå°±èƒ½æ­£ç¡®è¿›è¡Œäº†ã€‚</p>
<h3>æ€»ç»“</h3>
<p>ä¸Šä¸€ç¯‡æˆ‘ä»¬ç•™äº†å‡ ä¸ªé—®é¢˜ï¼Œé‚£ä¹ˆç»“åˆä¸Šé¢çš„åˆ†ææˆ‘ä»¬åŸºæœ¬ä¸Šå¯ä»¥å›ç­”äº†
Q: åœ¨éè™šæ‹ŸåŒ–åœºæ™¯ä¸‹iommu=ptå’Œiommu disabledè¿™ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p>
<p>A: åŒºåˆ«åœ¨äºæ˜¯å¦éœ€è¦èµ°é¡µè¡¨è½¬æ¢ï¼Œé‚£ä¹ˆåœ¨ptåœºæ™¯ä¸‹åº”ç”¨è°ƒç”¨dma map ç›¸å…³apiå…¶è¿”å›çš„éƒ½æ˜¯çœŸå®çš„ç‰©ç†åœ°å€ï¼Œå¦‚æœhwæ”¯æŒpassthrough translationåˆ™ä¸éœ€è¦èµ°ï¼Œå¦‚æœä¸æ”¯æŒåˆ™éœ€è¦èµ°åªä¸éœ€è¦iovaå°±ç­‰hpaã€‚è€Œdisableçš„æƒ…å†µä¸‹å…¶è¿”å›çš„æ˜¯iovaä¸”å¿…é¡»è¦èµ°é¡µè¡¨è½¬æ¢</p>
<p>Qï¼šè™šæ‹Ÿæœºé‡Œé¢æ˜¯æ²¡æœ‰iommuçš„ï¼Œé‚£dmaæ˜¯å¦‚ä½•è¿›è¡Œçš„ï¼Ÿ</p>
<p>Aï¼š è™šæ‹Ÿæœºé‡Œé¢æ²¡æœ‰iommué‚£ä¹ˆå…¶æ‰€æœ‰ä½¿ç”¨dma mapçš„åœ°æ–¹è¿”å›çš„éƒ½æ˜¯gpaï¼Œåœ¨ç›´é€šçš„åœºæ™¯éœ€è¦éœ€è¦å€ŸåŠ©äºiommu dma remappingæœºåˆ¶æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚</p>
<p>Qï¼šä¸åŒintel iommuç¡¬ä»¶ä¸‹çš„ä¸¤ä¸ªpciè®¾å¤‡æ˜¯å¦‚ä½•å®ç°ç›´é€šç»™åŒä¸€ä¸ªvmçš„ï¼Ÿ</p>
<p>Aï¼š ä¸åŒintel_iommuçš„ä¸¤ä¸Špciè®¾å¤‡ç›´é€šç»™åŒä¸€ä¸ªvmçš„æ—¶å€™ï¼Œè¿™ä¸¤ä¸ªè®¾å¤‡ä½¿ç”¨çš„iovaé¡µè¡¨çš„åŸºåœ°æ˜¯ä¸€æ ·çš„ï¼Œå³åŒä¸€ä¸ªdmar_domainçš„pgdã€‚</p>

                <!-- å›¾ç‰‡ç”»å»Š -->
            </main>

        <!-- æ–‡ç« åº•éƒ¨åŒºåŸŸ -->
        <footer class="article-footer">
            <!-- æ ‡ç­¾åŒºåŸŸ -->
            <div class="article-tags-section">
                <h4>ğŸ·ï¸ ç›¸å…³æ ‡ç­¾</h4>
                <div class="tags-cloud">
                    <span class="tag-cloud-item">iommu</span>
                </div>
            </div>

            <!-- åˆ†äº«å’Œäº’åŠ¨ -->
            <div class="article-interaction">
                <div class="social-share">
                    <h4>ğŸ”— åˆ†äº«è¿™ç¯‡æ–‡ç« </h4>
                    <div class="share-buttons">
                        <a href="#" class="share-btn twitter" target="_blank">ğ• Twitter</a>
                        <a href="#" class="share-btn weibo" target="_blank">ğŸ“ å¾®åš</a>
                        <a href="#" class="share-btn linkedin" target="_blank">ğŸ’¼ LinkedIn</a>
                    </div>
                </div>
            </div>

            <!-- ä½œè€…ç­¾åæ¡£ -->
            <div class="author-signature">
                <div class="signature-content">
                    <h4>å…³äºä½œè€…</h4>
                    <p><strong>å‘¨å®œæ³¢</strong>ï¼Œå­—èŠ‚è·³åŠ¨ç«å±±å¼•æ“AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆï¼Œä¸“æ³¨AI Agentã€GPUæ± åŒ–ã€LLMæ¨ç†ä¼˜åŒ–ç­‰å‰æ²¿æŠ€æœ¯ã€‚</p>
                    <div class="author-social">
                        <a href="https://twitter.com/zhyblife99" target="_blank">ğ• Twitter</a>
                        <span class="wechat-hint">ğŸ’¬ å…³æ³¨å¾®ä¿¡å…¬ä¼—å·è·å–æ›´å¤šå†…å®¹</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <aside class="article-sidebar">
        <!-- æ–‡ç« ä¿¡æ¯å¡ç‰‡ -->
        <div class="sidebar-card article-info-card">
            <h3>ğŸ“Š æ–‡ç« ä¿¡æ¯</h3>
            <div class="info-list">
                <div class="info-item">
                    <span class="info-label">å‘å¸ƒæ—¶é—´</span>
                    <span class="info-value">æ—¥ 06 äºŒæœˆ 2022</span>
                </div>
                <div class="info-item">
                    <span class="info-label">åˆ†ç±»</span>
                    <span class="info-value">articles</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¢„è®¡é˜…è¯»</span>
                    <span class="info-value">~10 åˆ†é’Ÿ</span>
                </div>
            </div>
        </div>

        <!-- ç›¸å…³æ–‡ç« æ¨è -->
        <div class="sidebar-card related-articles-card">
            <h3>ğŸ“š ç›¸å…³æ–‡ç« </h3>
            <div class="related-list">
            </div>
        </div>

        <!-- æŠ€æœ¯æ ˆå±•ç¤º -->
        <div class="sidebar-card skills-card">
            <h3>ğŸš€ æŠ€æœ¯æ ˆ</h3>
            <div class="skills-list">
                <span class="skill-item">AI Agent</span>
                <span class="skill-item">GPUæ± åŒ–</span>
                <span class="skill-item">LLMæ¨ç†ä¼˜åŒ–</span>
                <span class="skill-item">é«˜æ€§èƒ½è™šæ‹ŸåŒ–</span>
            </div>
        </div>

        <!-- å…³æ³¨å…¬ä¼—å· -->
        <div class="sidebar-card wechat-card">
            <h3>ğŸ”” è®¢é˜…æ›´æ–°</h3>
            <div class="wechat-content">
                <p>æ‰«ç å…³æ³¨å¾®ä¿¡å…¬ä¼—å·</p>
                <img src="./images/qrcode.jpg" alt="å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç " class="sidebar-qrcode">
                <p class="wechat-name">KernelNote</p>
            </div>
        </div>
    </aside>
</div>

<!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
<button class="back-to-top" id="backToTop">
    <span>â†‘</span>
</button>

<script>
// è¿”å›é¡¶éƒ¨åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const backToTop = document.getElementById('backToTop');

    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTop.style.display = 'block';
        } else {
            backToTop.style.display = 'none';
        }
    });

    // ç‚¹å‡»è¿”å›é¡¶éƒ¨
    backToTop.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // ç›®å½•é«˜äº®
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = document.querySelectorAll('.article-content h2, .article-content h3, .article-content h4');

    function updateTocHighlight() {
        let current = '';
        headings.forEach((heading, index) => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100) {
                current = heading.id;
            }
        });

        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#' + current) {
                link.classList.add('active');
            }
        });
    }

    if (tocLinks.length > 0) {
        window.addEventListener('scroll', updateTocHighlight);
        updateTocHighlight();
    }

    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®å½•é¡¹
    tocLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});
</script>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>        <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>
    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>