<!DOCTYPE html>
<html lang="zh_cn">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="duma" />

        <meta name="description" content="åºè¨€ è™šæ‹ŸåŒ–åœºæ™¯ä¸‹ï¼Œæœ‰æ—¶ä¸ºäº†æå‡è™šæ‹Ÿæœºioæ€§èƒ½é€šå¸¸ä¼šé€‰æ‹©æŠŠè®¾å¤‡ç›´é€šç»™vmã€‚è®¾å¤‡ç›´é€šè¦ä¹ˆä½¿ç”¨è®¾å¤‡çš„SRIOVæˆ–è€…SIOVèƒ½åŠ›ï¼Œè¦ä¹ˆæŠŠæ•´ä¸ªè®¾å¤‡éƒ½é€šç»™è™šæ‹Ÿæœºã€‚æœ‰äº›åœºæ™¯ä¸‹ï¼Œä¸ºäº† â€¦
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="vfio, articles, " />
        <title>èŠèŠvfio mdevå·¥ä½œåŸç†  Â· KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link href="https://kernelnote.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢ - Full Atom Feed" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LRRMJ08SPD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LRRMJ08SPD');
</script>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./pages/about.html">about</a></li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<!-- æ–‡ç« å¤´éƒ¨åŒºåŸŸ -->
<header class="article-header">
    <div class="article-header-container">
        <!-- ä½œè€…ä¿¡æ¯åŒºåŸŸ -->
        <div class="article-author-section">
            <img src="./images/wechat.jpeg" alt="å‘¨æ¯…åš" class="author-avatar">
            <div class="author-info">
                <h3 class="author-name">å‘¨å®œæ³¢</h3>
                <p class="author-title">AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆ | AI Agentä¸“å®¶</p>
            </div>
        </div>

        <!-- æ–‡ç« æ ‡é¢˜å’Œå…ƒä¿¡æ¯ -->
        <div class="article-meta-section">
            <h1 class="article-title">
                èŠèŠvfio mdevå·¥ä½œåŸç†
            </h1>

            <div class="article-meta-info">
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“…</span>
                    <time datetime="2022-05-31T20:30:00+08:00">äºŒ 31 äº”æœˆ 2022</time>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“</span>
                    <span class="category-tag">articles</span>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ·ï¸</span>
                    <span class="article-tag">vfio</span>
                </div>
            </div>

            <!-- å¤šåª’ä½“é“¾æ¥åŒºåŸŸ -->
        </div>
    </div>
</header>

<!-- æ–‡ç« ä¸»ä½“å†…å®¹ -->
<div class="article-container">
    <div class="article-main">
        <!-- æ–‡ç« å†…å®¹ -->
            <main class="article-content article-content-no-toc">
                
                <h4>åºè¨€</h4>
<p>è™šæ‹ŸåŒ–åœºæ™¯ä¸‹ï¼Œæœ‰æ—¶ä¸ºäº†æå‡è™šæ‹Ÿæœºioæ€§èƒ½é€šå¸¸ä¼šé€‰æ‹©æŠŠè®¾å¤‡ç›´é€šç»™vmã€‚è®¾å¤‡ç›´é€šè¦ä¹ˆä½¿ç”¨è®¾å¤‡çš„SRIOVæˆ–è€…SIOVèƒ½åŠ›ï¼Œè¦ä¹ˆæŠŠæ•´ä¸ªè®¾å¤‡éƒ½é€šç»™è™šæ‹Ÿæœºã€‚æœ‰äº›åœºæ™¯ä¸‹ï¼Œä¸ºäº†æå‡è®¾å¤‡åˆ©ç”¨ç‡æˆ‘ä»¬å¸Œæœ›èƒ½æŠŠåç«¯çš„ç¡¬ä»¶è®¾å¤‡åˆ‡åˆ†æˆæ›´å°çš„å®ä¾‹æä¾›ç»™æ›´å¤šçš„vmæ¥ä½¿ç”¨ï¼Œä½†æ˜¯è¿™ä¸ªè®¾å¤‡åˆæ²¡æœ‰SRIOVæˆ–è€…SIOVçš„èƒ½åŠ›(æ¯”å¦‚gpuï¼Œnvme)é‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œvfio mdevæ¡†æ¶å°±æ˜¯ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜è€Œç”Ÿçš„ã€‚</p>
<h4>vfio mdevæ¡†æ¶</h4>
<p>ä»å­—é¢ä¸Šçœ‹å°±çŸ¥é“è¿™ä¸ªæ¡†æ¶æ¶‰åŠåˆ°ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶vfio å’Œmdevã€‚é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªç»„ä»¶æ˜¯å¦‚ä½•åœ¨ä¸€èµ·æ¥å·¥ä½œçš„ã€‚æƒ³å¿…å¤§å®¶éƒ½åº”è¯¥æ¯”è¾ƒç†Ÿæ‚‰linuxå½“ä¸­çš„busï¼Œdriverï¼Œdeviceçš„æ¡†æ¶ï¼Œç®€å•è¯´æ¥æŸä¸ªdeviceå®ƒå¿…é¡»æŒ‚åœ¨æŸä¸ªå…·ä½“çš„busä¸Šï¼Œç„¶ådeviceç”±è·Ÿè¿™ä¸ªbusç»‘å®šçš„driveræ¥é©±åŠ¨ã€‚é‚£ä¹ˆåœ¨vfio_mdevè¿™ä¸ªæ¶æ„å½“ä¸­ï¼Œlinuxå†…æ ¸å®šä¹‰äº†ä¸€ç§å«<code>mdev_bus</code>çš„ bus_typeã€‚ç›¸å…³å®šä¹‰å…·ä½“å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="nx">struct</span><span class="w"> </span><span class="nx">bus_type</span><span class="w"> </span><span class="nx">mdev_bus_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="nx">name</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;mdev&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="nx">probe</span><span class="w">          </span><span class="p">=</span><span class="w"> </span><span class="nx">mdev_probe</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="nx">remove</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="nx">mdev_remove</span><span class="p">,</span>
<span class="p">};</span>
<span class="nx">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="nx">mdev_bus_type</span><span class="p">);</span>
</code></pre></div>

<p>è¿™é‡Œçš„<code>mdev_probe</code>å’Œ<code>mdev_remove</code>åˆ†åˆ«ä¼šåœ¨device probeå’Œremoveçš„æ—¶å€™è°ƒç”¨åˆ°ï¼Œé€šå¸¸æƒ…å†µä¸‹åœ¨bus probeå’Œremoveå‡½æ•°é‡Œé¢ä¼šå†è°ƒç”¨è·Ÿè¿™ä¸ªbus bindçš„ device driverçš„probeå’Œremoveå‡½æ•°ã€‚</p>
<p>æ¥ç€mdev core driveråœ¨åŠ è½½çš„æ—¶å€™ä¼šå°† mdev_bus æ³¨å†Œåˆ°ç³»ç»Ÿå½“ä¸­</p>
<div class="highlight"><pre><span></span><code><span class="nx">mdev_bus_register</span><span class="o">-&gt;</span><span class="nx">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mdev_bus_type</span><span class="p">)</span>
</code></pre></div>

<p><code>bus_register</code> è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯åˆå§‹åŒ–subsys_private ä»¥åŠ klist_devicesã€klist_driversè¿™ä¸¤ä¸ªklistï¼Œç„¶ååœ¨sysfsä¸‹åˆ›å»ºç›¸å…³ç›®å½•</p>
<div class="highlight"><pre><span></span><code>/sys/bus/mdev/
â”œâ”€â”€ devices
â”œâ”€â”€ drivers
â”œâ”€â”€ drivers_autoprobe
â”œâ”€â”€ drivers_probe
â””â”€â”€ uevent
</code></pre></div>

<p>ç„¶åæˆ‘ä»¬å†æ¥è®²vfioä¾§ï¼Œå…¶ä¸ºmdev busä¸“é—¨å¼€å‘äº†ä¸€ä¸ªvfio_mdev driver</p>
<div class="highlight"><pre><span></span><code>static struct mdev_driver vfio_mdev_driver = {
        .name   = &quot;vfio_mdev&quot;,
        .probe  = vfio_mdev_probe,
        .remove = vfio_mdev_remove,
}
</code></pre></div>

<p>ç´§æ¥ç€åœ¨vfio mdev driver loadçš„æ—¶å€™ä¼šå°†è‡ªå·±è·Ÿmdev busç»‘å®šèµ·æ¥ï¼Œå…·ä½“é€šè¿‡<code>mdev_register_driver</code> æ¥å®ç°</p>
<div class="highlight"><pre><span></span><code><span class="nx">int</span><span class="w"> </span><span class="nx">mdev_register_driver</span><span class="p">(</span><span class="nx">struct</span><span class="w"> </span><span class="nx">mdev_driver</span><span class="w"> </span><span class="o">*</span><span class="nx">drv</span><span class="p">,</span><span class="w"> </span><span class="nx">struct</span><span class="w"> </span><span class="nx">module</span><span class="w"> </span><span class="o">*</span><span class="nx">owner</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="cm">/* initialize common driver fields */</span>
<span class="w">        </span><span class="nx">drv</span><span class="o">-&gt;</span><span class="nx">driver</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">drv</span><span class="o">-&gt;</span><span class="nx">name</span><span class="p">;</span>
<span class="w">        </span><span class="nx">drv</span><span class="o">-&gt;</span><span class="nx">driver</span><span class="p">.</span><span class="nx">bus</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">mdev_bus_type</span><span class="p">;</span><span class="w"> </span><span class="c1">// bus è®¾ç½®ä¸ºmdev</span>
<span class="w">        </span><span class="nx">drv</span><span class="o">-&gt;</span><span class="nx">driver</span><span class="p">.</span><span class="nx">owner</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">owner</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* register with core */</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">drv</span><span class="o">-&gt;</span><span class="nx">driver</span><span class="p">);</span><span class="w"> </span><span class="c1">//æ³¨å†Œè¿™ä¸ª driver</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">driver_register</span><span class="o">-&gt;</span><span class="n">bus_add_driver</span>
</code></pre></div>

<p><code>bus_add_driver</code> è¿™ä¸ªå‡½æ•°é‡Œé¢ä¸»è¦å®ç°ä¸ºï¼šåˆå§‹åŒ–driver_privateï¼Œå°†driveræ”¾åˆ°ä¸Šå…¶æ‰€å±busçš„ klist_driversä¸Šï¼Œç„¶åé€šè¿‡<code>driver_attach</code> å»probe è¯¥ bus klist_devicesä¸Šçš„è®¾å¤‡ï¼Œæœ€ååœ¨sysfsä¸‹é¢åˆ›å»ºç›¸å…³çš„ç›®å½•</p>
<div class="highlight"><pre><span></span><code><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="o">/</span><span class="n">mdev</span><span class="o">/</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">devices</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">drivers</span>
<span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">vfio_mdev</span>
<span class="err">â”‚</span><span class="w">Â Â      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">bind</span>
<span class="err">â”‚</span><span class="w">Â Â      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="kr">module</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="kr">module</span><span class="o">/</span><span class="n">vfio_mdev</span>
<span class="err">â”‚</span><span class="w">Â Â      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">uevent</span>
<span class="err">â”‚</span><span class="w">Â Â      </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">unbind</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">drivers_autoprobe</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">drivers_probe</span>
<span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">uevent</span>
</code></pre></div>

<p>å¯ä»¥çœ‹åˆ° mdev busä¸‹é¢driverç›®å½•ä¸‹å·²ç»æœ‰å†…å®¹äº†ï¼Œè€Œæ­¤æ—¶devicesç›®å½•ä¸‹è¿˜æ˜¯ç©ºçš„ã€‚</p>
<h4>è®¾å¤‡åœ¨mdevæ¡†æ¶ä¸‹çš„ä½¿èƒ½</h4>
<p>é€šå¸¸æˆ‘ä»¬ä¼šä¸ºè¿™ä¸ªè®¾å¤‡é‡æ–°å†™ä¸€ä¸ªå…·æœ‰mdevåŠŸèƒ½çš„driverï¼Œè¿™ä¸ªdriverä¸è®¾å¤‡æœ¬èº«çš„driveræ‰€åšçš„äº‹æƒ…æ˜¯æœ‰æ‰€ä¸åŒçš„ã€‚mdev driverå…·ä½“è¦åšå“ªäº›äº‹æƒ…å‘¢ï¼Ÿå›ç­”è¿™ä¸ªé—®é¢˜ä¹‹å‰æˆ‘ä»¬å…ˆæ¥æƒ³æƒ³mdevéœ€è¦å¸®æˆ‘è§£å†³å“ªäº›é—®é¢˜ã€‚</p>
<ul>
<li>config spaceã€bar spaceã€pcie capbility</li>
</ul>
<p>å› ä¸ºæˆ‘ä»¬éœ€è¦ç»™vmå‘ˆç°ä¸€ä¸ªå®Œæ•´çš„è®¾å¤‡ï¼Œè€Œbackend ç‰©ç†è®¾å¤‡æ˜¯æ²¡æœ‰sriovåŠŸèƒ½çš„ï¼Œæ‰€ä»¥config spaceã€barä»¥åŠç›¸å…³çš„pci capæ˜¯éœ€è¦åœ¨è¿™ä¸ªmdev driveré‡Œé¢è¿›è¡Œæ¨¡æ‹Ÿã€‚</p>
<ul>
<li>
<p>mmio è®¿é—®</p>
<p>å›æƒ³ä¸€ä¸‹ï¼Œåœ¨sriovåœºæ™¯ä¸‹è®¾å¤‡çš„mmioæ˜¯passthroughç»™vmçš„(é™¤msix tableç›¸å…³mmio)ï¼Œvmä¾§å¯¹mmioçš„è®¿é—®éƒ½æ˜¯ä¸éœ€è¦hypervisorå‚ä¸çš„ã€‚è€Œåœ¨mdevåœºæ™¯ä¸‹ï¼Œç”±äºä¸€ä¸ªè®¾å¤‡è¦shareç»™å¤šä¸ªvmçš„ï¼Œæ‰€ä»¥è¿™ä¸ªäº›mmioçš„è®¿é—®æ“ä½œéƒ½æ˜¯éœ€è¦åœ¨mdev driverä¾§æ¥è¿›è¡Œå¤„ç†çš„ã€‚</p>
</li>
<li>
<p>dma</p>
<p>åœ¨sriovåœºæ™¯ä¸‹dmaçš„è½¬æ¢æ˜¯ç”±iommuç¡¬ä»¶ä¾§è‡ªåŠ¨å®Œæˆçš„ï¼Œè€Œåœ¨mdevåœºæ™¯ä¸‹ç”±äºåŒä¸€ä¸ªè®¾å¤‡è¦åœ¨å¤šä¸ªvmä¸‹å…±äº«æ— æ³•å†ä½¿ç”¨iommuåŠŸèƒ½(ç‰©ç†è®¾å¤‡ä¾§åªä¸€ä¸ªbdfå·ï¼Œå¤šä¸ªvmä¹‹é—´æ— æ³•è¿›è¡ŒåŒºåˆ†)ã€‚å› æ­¤ï¼Œmdevåœºæ™¯ä¸‹dmaçš„ç›¸å…³è½¬æ¢å’Œç›¸å…³æ“ä½œä¹Ÿæ˜¯éœ€è¦åœ¨é©±åŠ¨é‡Œé¢å®ç°ã€‚</p>
</li>
<li>
<p>ä¸­æ–­</p>
<p>sriovçš„åœºæ™¯ä¸‹ï¼Œä¸­æ–­é‡‡ç”¨çš„æ˜¯dma remappingå’Œposted interruptï¼Œè€Œä¹‹æ‰€ä»¥èƒ½è¿™ä¹ˆå¹²ä¸»è¦æ˜¯å› ä¸ºå…¶åç«¯å¯¹åº”çš„æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„VFï¼›è€Œåœ¨mdevåœºæ™¯ä¸‹ï¼Œå¤šä¸ªvm share ä¸€ä¸ªåç«¯ç¡¬ä»¶è®¾å¤‡åªèƒ½é€šè¿‡per vmçš„irqfdè¿™ç§æ–¹å¼ã€‚</p>
</li>
</ul>
<p>è®¾å¤‡çš„ mdev driveré™¤äº†éœ€è¦å®ç°çš„ç›¸å…³åŠŸèƒ½ä¹‹å¤–ï¼Œåœ¨é©±åŠ¨initçš„æ—¶å€™è¿˜éœ€è¦å°†è‡ªå·±æ³¨å†Œä¸ºè™šæ‹Ÿè®¾å¤‡çš„parentï¼Œå…·ä½“æ˜¯é€šè¿‡<code>mdev_register_device</code> æ¥å®ç°ã€‚è¿™ä¸ªå‡½æ•°çš„ä¸»è¦é€»è¾‘å°±æ˜¯åˆ›å»ºmdev_parentï¼Œç„¶åç»™parent devå’Œopsåˆ†åˆ«èµ‹å€¼ä¸ºå½“å‰çš„ç‰©ç†è®¾å¤‡ä»¥åŠè¯¥è®¾å¤‡mde_driverå½“ä¸­å®šä¹‰çš„opsï¼Œå½“ä¸­çš„å›è°ƒå‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">struct</span><span class="w"> </span><span class="n">mdev_parent_ops</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">struct</span><span class="w"> </span><span class="n">module</span><span class="w">   </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">attribute_group</span><span class="w"> </span><span class="o">**</span><span class="n">dev_attr_groups</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">attribute_group</span><span class="w"> </span><span class="o">**</span><span class="n">mdev_attr_groups</span><span class="p">;</span>
<span class="w">        </span><span class="n">struct</span><span class="w"> </span><span class="n">attribute_group</span><span class="w"> </span><span class="o">**</span><span class="n">supported_type_groups</span><span class="p">;</span>

<span class="w">        </span><span class="nb nb-Type">int</span><span class="w">     </span><span class="p">(</span><span class="o">*</span><span class="n">create</span><span class="p">)(</span><span class="n">struct</span><span class="w"> </span><span class="n">kobject</span><span class="w"> </span><span class="o">*</span><span class="n">kobj</span><span class="p">,</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">mdev_device</span><span class="w"> </span><span class="o">*</span><span class="n">mdev</span><span class="p">);</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w">     </span><span class="p">(</span><span class="o">*</span><span class="n">remove</span><span class="p">)(</span><span class="n">struct</span><span class="w"> </span><span class="n">mdev_device</span><span class="w"> </span><span class="o">*</span><span class="n">mdev</span><span class="p">);</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w">     </span><span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)(</span><span class="n">struct</span><span class="w"> </span><span class="n">mdev_device</span><span class="w"> </span><span class="o">*</span><span class="n">mdev</span><span class="p">);</span>
<span class="w">        </span><span class="nb nb-Type">void</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">release</span><span class="p">)(</span><span class="n">struct</span><span class="w"> </span><span class="n">mdev_device</span><span class="w"> </span><span class="o">*</span><span class="n">mdev</span><span class="p">);</span>
<span class="w">        </span><span class="n">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)(</span><span class="n">struct</span><span class="w"> </span><span class="n">mdev_device</span><span class="w"> </span><span class="o">*</span><span class="n">mdev</span><span class="p">,</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span>
<span class="w">                        </span><span class="n">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
<span class="w">        </span><span class="n">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="n">struct</span><span class="w"> </span><span class="n">mdev_device</span><span class="w"> </span><span class="o">*</span><span class="n">mdev</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span>
<span class="w">                         </span><span class="n">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
<span class="w">        </span><span class="n">long</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">ioctl</span><span class="p">)(</span><span class="n">struct</span><span class="w"> </span><span class="n">mdev_device</span><span class="w"> </span><span class="o">*</span><span class="n">mdev</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span>
<span class="w">                         </span><span class="n">unsigned</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w">     </span><span class="p">(</span><span class="o">*</span><span class="n">mmap</span><span class="p">)(</span><span class="n">struct</span><span class="w"> </span><span class="n">mdev_device</span><span class="w"> </span><span class="o">*</span><span class="n">mdev</span><span class="p">,</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<p>æœ€åï¼Œåœ¨sysfsä¸‹ç»™parentåˆ›å»ºç›¸åº”çš„ç›®å½•(ä»¥vfio_mdev sample mtty é©±åŠ¨ä¸ºä¾‹å­)</p>
<div class="highlight"><pre><span></span><code><span class="o">/</span><span class="nx">sys</span><span class="o">/</span><span class="nx">devices</span><span class="o">/</span><span class="kd">virtual</span><span class="o">/</span><span class="nx">mtty</span><span class="o">/</span>
<span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">mtty</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">mdev_supported_types</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">mtty</span><span class="o">-</span><span class="mi">1</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">available_instances</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">create</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">device_api</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">devices</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">name</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">mtty</span><span class="o">-</span><span class="mi">2</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">available_instances</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">create</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">device_api</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â      </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">devices</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â      </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">name</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">mtty_dev</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">sample_mtty_dev</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">power</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">async</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">autosuspend_delay_ms</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">control</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">runtime_active_kids</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">runtime_active_time</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">runtime_enabled</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">runtime_status</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">runtime_suspended_time</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">runtime_usage</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">subsystem</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="kd">class</span><span class="o">/</span><span class="nx">mtty</span>
<span class="w">    </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">uevent</span>
</code></pre></div>

<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•åˆ›å»ºå¯ä»¥é€šç»™vmçš„mdev instanceã€‚åŸæ¥åœ¨sriovåœºæ™¯ä¸‹éœ€è¦æŠŠè®¾å¤‡ä»åŸç”Ÿé©±åŠ¨unbindï¼Œç„¶åå†å°†å…¶bindåˆ°vfio-pciçš„é©±åŠ¨ä¸Šï¼›è€Œmdevè®¾å¤‡ä¹Ÿæœ‰ç±»ä¼¼è¿™æ ·çš„æµç¨‹ï¼Œä¸‹é¢è¿˜æ˜¯ä»¥mttyè¿™ä¸ªsampleä¸ºä¾‹å­æ¥çœ‹ä¸€ä¸‹ç›¸å…³æµç¨‹</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">echo</span><span class="w"> </span><span class="s">&quot;83b8f4f2-509f-382f-3c1e-e6bfe0fa1001&quot;</span><span class="w"> </span><span class="p">&gt;</span><span class="w">    </span>\
<span class="w">         </span><span class="o">/</span><span class="nx">sys</span><span class="o">/</span><span class="nx">devices</span><span class="o">/</span><span class="kd">virtual</span><span class="o">/</span><span class="nx">mtty</span><span class="o">/</span><span class="nx">mtty</span><span class="o">/</span><span class="nx">mdev_supported_types</span><span class="o">/</span><span class="nx">mtty</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="nx">create</span>
<span class="o">-----------</span>
<span class="nx">ç›´é€šç»™vmçš„æ—¶å€™</span><span class="err">ï¼Œ</span><span class="nx">qemuä¾§å‚æ•°é…ç½®</span>

<span class="o">-</span><span class="nx">device</span><span class="w"> </span><span class="nx">vfio</span><span class="o">-</span><span class="nx">pci</span><span class="p">,</span>\
<span class="w"> </span><span class="nx">sysfsdev</span><span class="p">=</span><span class="o">/</span><span class="nx">sys</span><span class="o">/</span><span class="nx">bus</span><span class="o">/</span><span class="nx">mdev</span><span class="o">/</span><span class="nx">devices</span><span class="o">/</span><span class="mi">83</span><span class="nx">b8f4f2</span><span class="o">-</span><span class="mi">509</span><span class="nx">f</span><span class="o">-</span><span class="mi">382</span><span class="nx">f</span><span class="o">-</span><span class="mi">3</span><span class="nx">c1e</span><span class="o">-</span><span class="nx">e6bfe0fa1001</span>
</code></pre></div>

<p>å½“å¾€createå»å†™uuidçš„æ—¶å€™ï¼Œä¼šè§¦å‘ <code>mdev_device_create</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦å®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ–°å»ºmdevè™šæ‹Ÿè®¾å¤‡ï¼Œå¹¶è¿›è¡Œç›¸å…³çš„åˆå§‹åŒ–</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nx">mdev</span><span class="o">-&gt;</span><span class="nx">parent</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">parent</span><span class="p">;</span><span class="w"> </span><span class="c1">//è¿™ä¸ªparentæŒ‡çš„æ˜¯åç«¯å¯¹åº”çš„ç‰©ç†è®¾å¤‡</span>
<span class="o">...</span><span class="p">..</span><span class="w"> </span><span class="c1">//skip</span>
<span class="nx">mdev</span><span class="o">-&gt;</span><span class="nx">dev</span><span class="p">.</span><span class="nx">parent</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="nx">dev</span><span class="p">;</span><span class="w">   </span><span class="c1">//æ–°åˆ›å»ºmdev-&gt;devå®ä¾‹ï¼Œå¹¶å°†å…¶çˆ¶æŒ‡å‘å½“å‰çš„devå³mtty-1</span>
<span class="nx">mdev</span><span class="o">-&gt;</span><span class="nx">dev</span><span class="p">.</span><span class="nx">bus</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">mdev_bus_type</span><span class="p">;</span>
<span class="nx">mdev</span><span class="o">-&gt;</span><span class="nx">dev</span><span class="p">.</span><span class="nx">release</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">mdev_device_release</span><span class="p">;</span>
<span class="nx">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mdev</span><span class="o">-&gt;</span><span class="nx">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%pUl&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">uuid</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span>
</code></pre></div>

<ul>
<li>è°ƒç”¨<code>device_register</code>å¯¹<code>mdev-&gt;dev</code>è¿›è¡Œåˆå§‹åŒ–</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">device_register</span><span class="o">-&gt;</span><span class="n">device_add</span><span class="o">-&gt;</span><span class="n">bus_probe_device</span><span class="o">-&gt;</span><span class="n">device_initial_probe</span><span class="o">-&gt;</span><span class="n">__device_attach_driver</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">...</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">probe</span>
</code></pre></div>

<p>æœ€ç»ˆä¸€è·¯ä¼šè°ƒåˆ°<code>mdev_probe</code>ï¼Œç„¶åå†è°ƒç”¨vfio_mdev driverçš„probeå‡½æ•°<code>vfio_mdev_probe</code>ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹mdev_probeå‡½æ•°å…·ä½“éƒ½å¹²äº†å•¥ã€‚</p>
<div class="highlight"><pre><span></span><code>static int mdev_probe(struct device *dev)
{
        struct mdev_driver *drv = to_mdev_driver(dev-&gt;driver);
        struct mdev_device *mdev = to_mdev_device(dev);
        int ret;

        ret = mdev_attach_iommu(mdev);
        if (ret)
                return ret;

        if (drv &amp;&amp; drv-&gt;probe) {
                ret = drv-&gt;probe(dev);
                if (ret)
                        mdev_detach_iommu(mdev);
        }

        return ret;
}
</code></pre></div>

<p>é¦–å…ˆé€šè¿‡<code>mdev_attach_iommu</code> å‡½æ•°ï¼Œ<strong>ä¸ºè¯¥mdevè®¾å¤‡åˆ›å»ºiommu_groupï¼Œç„¶åå°†è®¾å¤‡æ·»åŠ åˆ°è¿™ä¸ªiommu_groupé‡Œé¢ã€‚æ³¨æ„ï¼Œè¿™ä¸ªiommu_groupå¹¶æ²¡æœ‰åˆ›å»ºdefaultçš„domainï¼Œæ‰€ä»¥ä¸ä¼šåˆ›å»ºdomain_mappingã€‚æ¥ç€çœ‹ä¸€ä¸‹<code>vfio_mdev_probe</code> å‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢æ ¸å¿ƒé€»è¾‘å°±æ˜¯åˆ›å»ºvfio_groupå¹¶å°†å…¶è·Ÿiommu_groupå¯¹åº”èµ·æ¥ï¼Œç„¶åå†åˆ›å»ºvfio_deviceå¹¶å°†dev,vfio_groupå’Œå®šä¹‰çš„vfio_mdev_dev_opsç»‘å®šèµ·æ¥</strong>ã€‚æœ€åï¼Œå†è°ƒç”¨parent devçš„mdev_parent_opså½“ä¸­çš„createå‡½æ•°ã€‚è®¾å¤‡æˆåŠŸcreateä¹‹åè§†å›¾å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="o">/</span><span class="nx">sys</span><span class="o">/</span><span class="nx">bus</span><span class="o">/</span><span class="nx">mdev</span><span class="o">/</span><span class="nx">devices</span><span class="o">/</span><span class="mi">83</span><span class="nx">b8f4f2</span><span class="o">-</span><span class="mi">509</span><span class="nx">f</span><span class="o">-</span><span class="mi">382</span><span class="nx">f</span><span class="o">-</span><span class="mi">3</span><span class="nx">c1e</span><span class="o">-</span><span class="nx">e6bfe0fa1001</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">driver</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="nx">bus</span><span class="o">/</span><span class="nx">mdev</span><span class="o">/</span><span class="nx">drivers</span><span class="o">/</span><span class="nx">vfio_mdev</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">iommu_group</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="nx">kernel</span><span class="o">/</span><span class="nx">iommu_groups</span><span class="o">/</span><span class="mi">0</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">mdev_type</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">mdev_supported_types</span><span class="o">/</span><span class="nx">mtty</span><span class="o">-</span><span class="mi">1</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">power</span>
<span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">async</span>
<span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">autosuspend_delay_ms</span>
<span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">control</span>
<span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">runtime_active_kids</span>
<span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">runtime_active_time</span>
<span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">runtime_enabled</span>
<span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">runtime_status</span>
<span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">runtime_suspended_time</span>
<span class="err">â”‚</span><span class="w">Â Â  </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">runtime_usage</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">remove</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">subsystem</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="nx">bus</span><span class="o">/</span><span class="nx">mdev</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">uevent</span>
<span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">vendor</span>
<span class="w">    </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">sample_mdev_dev</span>
</code></pre></div>

<h4>mdev è®¾å¤‡ç›´é€šç»™vmçš„å®ç°</h4>
<p>å¦‚ä¸Šé¢æ‰€ç¤ºï¼Œmdev virtual devç›´é€šç»™vmèµ°çš„è¿˜æ˜¯qemuå½“ä¸­vfio pciçš„æ–¹å¼ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆå›å¿†ä¸€ä¸‹qemu vfio éƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚ç®€å•æ¥è¯´å°±æ˜¯å‡ ä¸ªæ¦‚å¿µï¼Œ<strong>ä¸€ç±»æ˜¯per vmçš„ï¼šcontainerï¼Œ vfio_iommu, vfio_domainï¼›å¦ä¸€ç±» per deviceçš„ï¼švfio_groupã€‚ä¸€ä¸ªcontainerä¸‹é¢åŒ…å«å¤šä¸ªvfio_groupï¼›ä¸€ä¸ªvfio_iommuçš„domain_listé‡Œé¢å½“å‰åªæœ‰ä¸€ä¸ªvfio_domain</strong>ã€‚åŒæ—¶è¿˜æœ‰å‡ ä¸ªfdï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<ul>
<li>
<p>group_fd = open("/dev/vfio/$group")</p>
<p>é€šè¿‡è¿™ä¸ªfdä¸‹å‘çš„ioctlä¸»è¦åšçš„äº‹æƒ…æœ‰ï¼šåˆ¤æ–­è¿™ä¸ªgroupæ˜¯å¦å¯ç”¨ï¼Œè·å–è¿™ä¸ªdevice fdï¼Œå°†è¿™ä¸ªgroupç»‘å®šåˆ°containerä¸‹é¢ã€‚</p>
</li>
<li>
<p>container_fd = open("/dev/vfio/vfio")</p>
<p>é€šè¿‡è¿™ä¸ªfdä¸‹å‘çš„ioctlä¸»è¦åšçš„äº‹æƒ…æœ‰ï¼šè·å–iommu type(æ˜¯type1è¿˜æ˜¯spapr_tce)ï¼Œå°†æ¯ä¸ªvfio_iommu attachåˆ°vfio_domainä¸Šã€‚å…¶ä¸­ï¼Œåé¢è¿™ä¸ªäº‹æƒ…è¦æ³¨æ„ä¸€ä¸‹å› ä¸ºåœ¨mdevçš„åœºæ™¯ä¸‹åœ¨é€»è¾‘ä¸Šæœ‰äº›åŒºåˆ«ï¼Œå…·ä½“è§<code>vfio_iommu_type1_attach_group</code></p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mdev_bus</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">bus</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">mdev_bus</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">!</span><span class="nx">iommu_present</span><span class="p">(</span><span class="nx">bus</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">symbol_put</span><span class="p">(</span><span class="nx">mdev_bus_type</span><span class="p">);</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">iommu</span><span class="o">-&gt;</span><span class="nx">external_domain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="nx">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">domain</span><span class="o">-&gt;</span><span class="nx">group_list</span><span class="p">);</span>
<span class="w">                                </span><span class="nx">iommu</span><span class="o">-&gt;</span><span class="nx">external_domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">domain</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span>
<span class="w">                                </span><span class="nx">kfree</span><span class="p">(</span><span class="nx">domain</span><span class="p">);</span>

<span class="w">                        </span><span class="nx">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">group</span><span class="o">-&gt;</span><span class="nx">next</span><span class="p">,</span>
<span class="w">                                 </span><span class="o">&amp;</span><span class="nx">iommu</span><span class="o">-&gt;</span><span class="nx">external_domain</span><span class="o">-&gt;</span><span class="nx">group_list</span><span class="p">);</span>
<span class="w">                        </span><span class="nx">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">iommu</span><span class="o">-&gt;</span><span class="nx">lock</span><span class="p">);</span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="nx">symbol_put</span><span class="p">(</span><span class="nx">mdev_bus_type</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>

<p><strong>ä»ä¸Šé¢çš„é€»è¾‘å¯ä»¥å¾—çŸ¥ï¼Œå¦‚æœæ˜¯mdevè®¾å¤‡åˆ™ä¼šä¸ºè¿™äº›è®¾å¤‡å•ç‹¬åˆ›å»ºä¸€ä¸ªexternal_domainè¡¨ç¤ºå…¶æ²¡æœ‰iommuèƒ½åŠ›</strong> ã€‚
å¦å¤–ï¼Œ<strong>vfio dma mapä¹Ÿæ˜¯é€šè¿‡container fdæ¥åšçš„ï¼Œå…·ä½“æ‰§è¡Œçš„æ˜¯å†…æ ¸ä¾§<code>vfio_dma_do_map</code> ï¼Œå‡½æ•°å®ç°å½“ä¸­å¦‚æœå‘ç°vmç›´é€šè®¾å¤‡å½“ä¸­åªæœ‰mdevè®¾å¤‡çš„è¯ï¼Œé‚£å®ƒæ˜¯ä¸ä¼šå»çœŸæ­£æ‰§è¡Œ pin and mapçš„</strong>ï¼Œå…·ä½“è§</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="o">/*</span><span class="w"> </span><span class="n">Don</span><span class="o">&#39;</span><span class="n">t</span><span class="w"> </span><span class="n">pin</span><span class="w"> </span><span class="nb">and</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="n">doesn</span><span class="o">&#39;</span><span class="n">t</span><span class="w"> </span><span class="n">contain</span><span class="w"> </span><span class="n">IOMMU</span><span class="w"> </span><span class="n">capable</span><span class="w"> </span><span class="n">domain</span><span class="o">*/</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>!<span class="n">IS_IOMMU_CAP_DOMAIN_IN_CONTAINER</span><span class="p">(</span><span class="n">iommu</span><span class="p">))</span>
<span class="w">                </span><span class="n">dma</span><span class="o">-&gt;</span><span class="nb">size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">                </span><span class="n">ret</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">vfio_pin_map_dma</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span><span class="w"> </span><span class="n">dma</span><span class="p">,</span><span class="w"> </span><span class="nb">size</span><span class="p">);</span>
</code></pre></div>

<ul>
<li>
<p>device fd</p>
<p>è®¾å¤‡çš„ç›¸å…³çš„æ“ä½œæ¯”å¦‚config spaceï¼Œmmioçš„è¯»å†™ï¼Œbar regionçš„mapä»¥åŠirqç›¸å…³çš„æ“ä½œéƒ½æ˜¯é€šè¿‡è¿™ä¸ªfdæ¥è¿›è¡Œçš„ï¼Œé‚£ä¹ˆåœ¨mdevçš„åœºæ™¯ æ‰€æœ‰çš„æ“ä½œæ¯”å¦‚read, write, ioctléƒ½æ˜¯å…ˆcallåˆ° vfio_mdev driverï¼Œç„¶åå†ç»è¿‡vfio_mdev callåˆ°parent opsæ³¨å†Œçš„callbackå‡½æ•°å³åº•å±‚ç¡¬ä»¶è®¾å¤‡mdev driver ops é‡Œé¢å®ç°çš„ callbackå‡½æ•°ã€‚</p>
</li>
</ul>
<h4>æ€»ç»“</h4>
<p>è¿™é‡Œæˆ‘å°±ä¸è¯¦ç»†ä»‹ç» mdev driverçš„å…·ä½“å®ç°äº†ï¼Œå¤§å®¶å¦‚æœæ„Ÿå…´è¶£å¯ä»¥å»çœ‹ä¸€ä¸‹intel vgpuï¼Œmdev nvmeç­‰è¿™äº› mdev driverçš„å®ç°ï¼Œçœ‹å®Œä¹‹åå¯èƒ½ä½ ä¼šå¯¹è¿™ç¯‡æ–‡ç« æœ‰æ›´å¤šçš„ç†è§£ã€‚ä»ä¸Šé¢æ¥çœ‹mdevçš„æ–¹æ¡ˆåœ¨æ€§èƒ½ä¸Šä¸å¯èƒ½åšçš„å¤ªé«˜ï¼Œsiovæ–¹æ¡ˆå½“ä¸­è™½ç„¶ä¹Ÿä½¿ç”¨äº†mdevï¼Œä½†æ˜¯siovå½“ä¸­æ•°æ®é¢é‡ä¸€äº›è¦è·¯å¾„è®¿é—®ä»ç„¶èµ°çš„æ˜¯passthroughçš„æ–¹å¼ã€‚ä½†æ˜¯ä¸ç®¡æ€ä¹ˆæ ·ï¼Œmdevç»™æˆ‘ä»¬æä¾›äº†è¿™æ ·ä¸€ç§èƒ½åŠ›ï¼Œè‡³äºæ˜¯å¦èƒ½ç”¨å°±å¾—çœ‹ä½ çš„åœºæ™¯å‘¢ã€‚</p>

                <!-- å›¾ç‰‡ç”»å»Š -->
            </main>

        <!-- æ–‡ç« åº•éƒ¨åŒºåŸŸ -->
        <footer class="article-footer">
            <!-- æ ‡ç­¾åŒºåŸŸ -->
            <div class="article-tags-section">
                <h4>ğŸ·ï¸ ç›¸å…³æ ‡ç­¾</h4>
                <div class="tags-cloud">
                    <span class="tag-cloud-item">vfio</span>
                </div>
            </div>

            <!-- åˆ†äº«å’Œäº’åŠ¨ -->
            <div class="article-interaction">
                <div class="social-share">
                    <h4>ğŸ”— åˆ†äº«è¿™ç¯‡æ–‡ç« </h4>
                    <div class="share-buttons">
                        <a href="#" class="share-btn twitter" target="_blank">ğ• Twitter</a>
                        <a href="#" class="share-btn weibo" target="_blank">ğŸ“ å¾®åš</a>
                        <a href="#" class="share-btn linkedin" target="_blank">ğŸ’¼ LinkedIn</a>
                    </div>
                </div>
            </div>

            <!-- ä½œè€…ç­¾åæ¡£ -->
            <div class="author-signature">
                <div class="signature-content">
                    <h4>å…³äºä½œè€…</h4>
                    <p><strong>å‘¨å®œæ³¢</strong>ï¼Œå­—èŠ‚è·³åŠ¨ç«å±±å¼•æ“AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆï¼Œä¸“æ³¨AI Agentã€GPUæ± åŒ–ã€LLMæ¨ç†ä¼˜åŒ–ç­‰å‰æ²¿æŠ€æœ¯ã€‚</p>
                    <div class="author-social">
                        <a href="https://twitter.com/zhyblife99" target="_blank">ğ• Twitter</a>
                        <span class="wechat-hint">ğŸ’¬ å…³æ³¨å¾®ä¿¡å…¬ä¼—å·è·å–æ›´å¤šå†…å®¹</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <aside class="article-sidebar">
        <!-- æ–‡ç« ä¿¡æ¯å¡ç‰‡ -->
        <div class="sidebar-card article-info-card">
            <h3>ğŸ“Š æ–‡ç« ä¿¡æ¯</h3>
            <div class="info-list">
                <div class="info-item">
                    <span class="info-label">å‘å¸ƒæ—¶é—´</span>
                    <span class="info-value">äºŒ 31 äº”æœˆ 2022</span>
                </div>
                <div class="info-item">
                    <span class="info-label">åˆ†ç±»</span>
                    <span class="info-value">articles</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¢„è®¡é˜…è¯»</span>
                    <span class="info-value">~10 åˆ†é’Ÿ</span>
                </div>
            </div>
        </div>

        <!-- ç›¸å…³æ–‡ç« æ¨è -->
        <div class="sidebar-card related-articles-card">
            <h3>ğŸ“š ç›¸å…³æ–‡ç« </h3>
            <div class="related-list">
            </div>
        </div>

        <!-- æŠ€æœ¯æ ˆå±•ç¤º -->
        <div class="sidebar-card skills-card">
            <h3>ğŸš€ æŠ€æœ¯æ ˆ</h3>
            <div class="skills-list">
                <span class="skill-item">AI Agent</span>
                <span class="skill-item">GPUæ± åŒ–</span>
                <span class="skill-item">LLMæ¨ç†ä¼˜åŒ–</span>
                <span class="skill-item">é«˜æ€§èƒ½è™šæ‹ŸåŒ–</span>
            </div>
        </div>

        <!-- å…³æ³¨å…¬ä¼—å· -->
        <div class="sidebar-card wechat-card">
            <h3>ğŸ”” è®¢é˜…æ›´æ–°</h3>
            <div class="wechat-content">
                <p>æ‰«ç å…³æ³¨å¾®ä¿¡å…¬ä¼—å·</p>
                <img src="./images/qrcode.jpg" alt="å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç " class="sidebar-qrcode">
                <p class="wechat-name">KernelNote</p>
            </div>
        </div>
    </aside>
</div>

<!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
<button class="back-to-top" id="backToTop">
    <span>â†‘</span>
</button>

<script>
// è¿”å›é¡¶éƒ¨åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const backToTop = document.getElementById('backToTop');

    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTop.style.display = 'block';
        } else {
            backToTop.style.display = 'none';
        }
    });

    // ç‚¹å‡»è¿”å›é¡¶éƒ¨
    backToTop.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // ç›®å½•é«˜äº®
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = document.querySelectorAll('.article-content h2, .article-content h3, .article-content h4');

    function updateTocHighlight() {
        let current = '';
        headings.forEach((heading, index) => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100) {
                current = heading.id;
            }
        });

        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#' + current) {
                link.classList.add('active');
            }
        });
    }

    if (tocLinks.length > 0) {
        window.addEventListener('scroll', updateTocHighlight);
        updateTocHighlight();
    }

    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®å½•é¡¹
    tocLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});
</script>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>        <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>
    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>