<!DOCTYPE html>
<html lang="zh_cn">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="duma" />

        <meta name="description" content="åºè¨€ ç³»åˆ—ä¸‰ä¸»è¦åˆ†æäº†interrupt remapingåº•å±‚ç¡¬ä»¶çš„æ¶æ„è®¾è®¡å’Œå·¥ä½œåŸç†ï¼ŒåŒæ—¶ä¹Ÿç®€è¦çš„æè¿°äº†ä¸€ä¸‹interrupt remappingåœ¨æ“ä½œç³»ç»Ÿå±‚é¢çš„åˆå§‹åŒ–æµç¨‹ã€‚é‚£ä¹ˆè¿™ä¸€ç¯‡æˆ‘ä»¬æ¥ä»”ç»†åˆ†æä¸€ä¸‹å®ƒåˆ°åº•æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ å·¥ä½œ â€¦
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="iommu, interrut remapping, articles, " />
        <title>æ·±å…¥äº†è§£iommuç³»åˆ—å››ï¼šinterrupt remapping å·¥ä½œæœºåˆ¶è§£æ  Â· KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link href="https://kernelnote.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢ - Full Atom Feed" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LRRMJ08SPD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LRRMJ08SPD');
</script>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./pages/about.html">about</a></li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<!-- æ–‡ç« å¤´éƒ¨åŒºåŸŸ -->
<header class="article-header">
    <div class="article-header-container">
        <!-- ä½œè€…ä¿¡æ¯åŒºåŸŸ -->
        <div class="article-author-section">
            <img src="./images/wechat.jpeg" alt="å‘¨æ¯…åš" class="author-avatar">
            <div class="author-info">
                <h3 class="author-name">å‘¨å®œæ³¢</h3>
                <p class="author-title">AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆ | AI Agentä¸“å®¶</p>
            </div>
        </div>

        <!-- æ–‡ç« æ ‡é¢˜å’Œå…ƒä¿¡æ¯ -->
        <div class="article-meta-section">
            <h1 class="article-title">
                æ·±å…¥äº†è§£iommuç³»åˆ—å››ï¼šinterrupt remapping å·¥ä½œæœºåˆ¶è§£æ
            </h1>

            <div class="article-meta-info">
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“…</span>
                    <time datetime="2022-03-05T00:00:00+08:00">å…­ 05 ä¸‰æœˆ 2022</time>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“</span>
                    <span class="category-tag">articles</span>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ·ï¸</span>
                    <span class="article-tag">iommu</span>
                    <span class="article-tag">interrut remapping</span>
                </div>
            </div>

            <!-- å¤šåª’ä½“é“¾æ¥åŒºåŸŸ -->
        </div>
    </div>
</header>

<!-- æ–‡ç« ä¸»ä½“å†…å®¹ -->
<div class="article-container">
    <div class="article-main">
        <!-- æ–‡ç« å†…å®¹ -->
            <main class="article-content article-content-no-toc">
                
                <h3>åºè¨€</h3>
<p>ç³»åˆ—ä¸‰ä¸»è¦åˆ†æäº†interrupt remapingåº•å±‚ç¡¬ä»¶çš„æ¶æ„è®¾è®¡å’Œå·¥ä½œåŸç†ï¼ŒåŒæ—¶ä¹Ÿç®€è¦çš„æè¿°äº†ä¸€ä¸‹interrupt remappingåœ¨æ“ä½œç³»ç»Ÿå±‚é¢çš„åˆå§‹åŒ–æµç¨‹ã€‚é‚£ä¹ˆè¿™ä¸€ç¯‡æˆ‘ä»¬æ¥ä»”ç»†åˆ†æä¸€ä¸‹å®ƒåˆ°åº•æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>
<h3>å·¥ä½œæœºåˆ¶</h3>
<h4>éè™šæ‹ŸåŒ–åœºæ™¯</h4>
<p>åœ¨éè™šæ‹ŸåŒ–åœºæ™¯ä¸‹å½“è®¾å¤‡å»enable msixä¸­æ–­çš„æ—¶å€™ï¼Œå…¶è°ƒç”¨è·¯å¾„æ˜¯è¿™æ ·çš„</p>
<div class="highlight"><pre><span></span><code><span class="n">pci_enable_msix_range</span><span class="o">-&gt;</span><span class="n">__pci_enable_msix_range</span><span class="o">-&gt;</span><span class="n">__pci_enable_msix</span>
<span class="o">-&gt;</span><span class="n">msix_capability_init</span><span class="o">-&gt;</span><span class="n">pci_msi_setup_msi_irqs</span>
</code></pre></div>

<p>è¿™é‡Œå¯¹pci_msi_setup_msi_irqsè¿›è¡Œä¸€ä¸‹è¯´æ˜</p>
<div class="highlight"><pre><span></span><code><span class="nx">static</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">pci_msi_setup_msi_irqs</span><span class="p">(</span><span class="nx">struct</span><span class="w"> </span><span class="nx">pci_dev</span><span class="w"> </span><span class="o">*</span><span class="nx">dev</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">nvec</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="k">type</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="nx">struct</span><span class="w"> </span><span class="nx">irq_domain</span><span class="w"> </span><span class="o">*</span><span class="nx">domain</span><span class="p">;</span>

<span class="w">        </span><span class="nx">domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">dev_get_msi_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">dev</span><span class="o">-&gt;</span><span class="nx">dev</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">domain</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">irq_domain_is_hierarchy</span><span class="p">(</span><span class="nx">domain</span><span class="p">))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">msi_domain_alloc_irqs</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">dev</span><span class="o">-&gt;</span><span class="nx">dev</span><span class="p">,</span><span class="w"> </span><span class="nx">nvec</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">arch_setup_msi_irqs</span><span class="p">(</span><span class="nx">dev</span><span class="p">,</span><span class="w"> </span><span class="nx">nvec</span><span class="p">,</span><span class="w"> </span><span class="k">type</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>é€šå¸¸éƒ½ä¼šdefaultèµ°arch_setup_msi_irqsï¼Œé™¤äº†åœ¨deviceTreeé‡Œé¢å¯¹è®¾å¤‡çš„irq_domainè¿›è¡Œäº†æ˜¾ç¤ºçš„ç»‘å®šåˆ™ä¼šç›´æ¥èµ°msi_domain_alloc_irqsã€‚æ¥ç€å¾€ä¸‹çœ‹</p>
<div class="highlight"><pre><span></span><code><span class="n">pci_msi_setup_msi_irqs</span><span class="o">-&gt;</span><span class="n">arch_setup_msi_irqs</span><span class="o">-&gt;</span><span class="n">native_setup_msi_irqs</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nx">int</span><span class="w"> </span><span class="nx">native_setup_msi_irqs</span><span class="p">(</span><span class="nx">struct</span><span class="w"> </span><span class="nx">pci_dev</span><span class="w"> </span><span class="o">*</span><span class="nx">dev</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">nvec</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="k">type</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="nx">struct</span><span class="w"> </span><span class="nx">irq_domain</span><span class="w"> </span><span class="o">*</span><span class="nx">domain</span><span class="p">;</span>
<span class="w">        </span><span class="nx">struct</span><span class="w"> </span><span class="nx">irq_alloc_info</span><span class="w"> </span><span class="nx">info</span><span class="p">;</span>

<span class="w">        </span><span class="nx">init_irq_alloc_info</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">info</span><span class="p">,</span><span class="w"> </span><span class="nx">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="nx">info</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">X86_IRQ_ALLOC_TYPE_MSI</span><span class="p">;</span>
<span class="w">        </span><span class="nx">info</span><span class="p">.</span><span class="nx">msi_dev</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">dev</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//æœ€ç»ˆè°ƒåˆ°intel_get_irq_domain,è¿”å›ir_msi_domain</span>
<span class="w">        </span><span class="nx">domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">irq_remapping_get_irq_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">info</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">domain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">NULL</span><span class="p">)</span>
<span class="w">                </span><span class="nx">domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">msi_default_domain</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">domain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">NULL</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="nx">ENOSYS</span><span class="p">;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">msi_domain_alloc_irqs</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">dev</span><span class="o">-&gt;</span><span class="nx">dev</span><span class="p">,</span><span class="w"> </span><span class="nx">nvec</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹<code>msi_domain_alloc_irqs</code> çš„è°ƒç”¨é“¾ï¼Œç„¶åå†ä¸€ä¸€åˆ†æç›¸å…³å‡½æ•°</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="n">msi_domain_alloc_irqs</span>
<span class="w">     </span><span class="o">-&gt;</span><span class="n">msi_domain_prepare_irqs</span>
<span class="w">     </span><span class="o">-&gt;</span><span class="n">__irq_domain_alloc_irqs</span>
<span class="w">     </span><span class="o">-&gt;</span><span class="n">msi_check_reservation_mode</span>
<span class="w">     </span><span class="p">....</span><span class="w">   </span><span class="c1">//çœç•¥éƒ¨åˆ†ä¸»è¦æ˜¯æœ‰äº›åˆ†æ”¯åˆ¤æ–­è¿™é‡Œå…ˆä¸listå‡ºæ¥ï¼Œåé¢æ¶‰åŠåˆ°çš„æ—¶å€™ä¼šå…·ä½“ä»‹ç»</span>
</code></pre></div>

<ul>
<li>
<p>msi_domain_prepare_irqs
   è°ƒç”¨<code>pci_msi_prepare</code> å‡½æ•°åšä¸€äº›åˆå§‹åŒ–çš„åŠ¨ä½œè®¾ç½®argçš„typeï¼Œmsi_dev, cpumaskç­‰</p>
</li>
<li>
<p>æ¥ç€éå†è¿™ä¸ªè®¾å¤‡msi_listå½“ä¸­çš„æ‰€æœ‰çš„msi_descï¼Œåœ¨è°ƒç”¨<code>__irq_domain_alloc_irqs</code> ä¸ºå…¶åˆ†é…irqä¹‹å‰å…ˆè°ƒç”¨<code>pci_msi_domain_set_desc-&gt;pci_msi_domain_calc_hwirq</code> ä¸ºæ¯ä¸ªmsi_descåˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„åˆå§‹IDå³hwirq(å…³äºå®ƒçš„ä½œç”¨æˆ‘ä»¬åé¢å†è¯´)ï¼Œæ¥ç€æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹__irq_domain_alloc_irqsçš„æ ¸å¿ƒé€»è¾‘ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªæ ¸å¿ƒå‡½æ•°çš„åŸºæœ¬è°ƒç”¨é“¾ï¼Œç„¶åæˆ‘ä»¬å†å¯¹ç›¸å…³çš„å‡½æ•°ä¸€ä¸€åˆ†æ</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w">      </span><span class="n">__irq_domain_alloc_irqs</span>
<span class="w">          </span><span class="o">-&gt;</span><span class="n">irq_domain_alloc_descs</span>
<span class="w">          </span><span class="o">-&gt;</span><span class="n">irq_domain_alloc_irq_data</span>
<span class="w">          </span><span class="o">-&gt;</span><span class="n">irq_domain_alloc_irqs_hierarchy</span>
<span class="w">          </span><span class="o">-&gt;</span><span class="n">irq_domain_insert_irq</span>
</code></pre></div>

<ul>
<li>
<p>é¦–å…ˆè°ƒç”¨ <code>irq_domain_alloc_descs</code> åˆ†é…irq_descï¼Œå…¶æ ¸å¿ƒé€»è¾‘å°±æ˜¯ä» allocated_irqsè¿™ä¸ªbitmapé‡Œé¢åˆ†é…æœªè¢«ä½¿ç”¨çš„irqã€‚</p>
</li>
<li>
<p>æ¥ç€è°ƒç”¨irq_domain_alloc_irq_dataï¼Œä¸ºæ¯ä¸ªirqçš„irq_data-&gt;domainä»¥åŠå…¶ä¸ºæ‰€å±domainçš„çˆ¶domainï¼Œçˆ·domain çš„irq_dataä½œç›¸å…³æ•°æ®åˆå§‹åŒ–ï¼Œé€»è¾‘å¦‚ä¸‹ï¼š</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w">            </span><span class="n">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nr_irqs</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">irq_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">irq_get_irq_data</span><span class="p">(</span><span class="n">virq</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">                </span><span class="n">irq_data</span><span class="o">-&gt;</span><span class="n">domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">domain</span><span class="p">;</span>

<span class="w">                </span><span class="n">for</span><span class="w"> </span><span class="p">(</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span><span class="w"> </span><span class="n">parent</span><span class="p">;</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">irq_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">irq_domain_insert_irq_data</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">irq_data</span><span class="p">);</span>
<span class="w">                        </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">irq_data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="n">irq_domain_free_irq_data</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">                                </span><span class="kr">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>static struct irq_data *irq_domain_insert_irq_data(struct irq_domain *domain,
                                                   struct irq_data *child)
{
        struct irq_data *irq_data;

        irq_data = kzalloc_node(sizeof(*irq_data), GFP_KERNEL,
                                irq_data_get_node(child));
        if (irq_data) {
                child-&gt;parent_data = irq_data;
                irq_data-&gt;irq = child-&gt;irq;
                irq_data-&gt;common = child-&gt;common;
                irq_data-&gt;domain = domain;
        }

        return irq_data;
}
</code></pre></div>

<ul>
<li>ç„¶åè°ƒç”¨<code>irq_domain_alloc_irqs_hierarchy</code>å‡½æ•°ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š</li>
</ul>
<div class="highlight"><pre><span></span><code>int irq_domain_alloc_irqs_hierarchy(struct irq_domain *domain,
                                    unsigned int irq_base,
                                    unsigned int nr_irqs, void *arg)
{
        return domain-&gt;ops-&gt;alloc(domain, irq_base, nr_irqs, arg);
}
</code></pre></div>

<p>æ³¨æ„è¿™é‡Œçš„domainä¸ºir_msi_domainï¼Œå…¶irq_domain_opså¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">irq_domain_ops</span><span class="w"> </span><span class="n">msi_domain_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">.</span><span class="n">alloc</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">msi_domain_alloc</span><span class="p">,</span>
<span class="w">        </span><span class="o">.</span><span class="n">free</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">msi_domain_free</span><span class="p">,</span>
<span class="w">        </span><span class="o">.</span><span class="n">activate</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">msi_domain_activate</span><span class="p">,</span>
<span class="w">        </span><span class="o">.</span><span class="n">deactivate</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">msi_domain_deactivate</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>

<p>æ‰€ä»¥å…¶è°ƒç”¨çš„allocçš„callbackä¸ºmsi_domain_allocå‡½æ•°ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å…¶å…·ä½“å®ç°ï¼š</p>
<ul>
<li>
<p>irq_find_mapping(domain, hwirq)ï¼Œé¦–å…ˆé€šè¿‡ä¸Šé¢æåˆ°çš„hwirqæ¥åˆ¤æ–­æ˜¯å¦å·²ç»åœ¨è¯¥domainå·²ç»è¿›è¡Œæ˜ å°„ã€‚</p>
</li>
<li>
<p>irq_domain_alloc_irqs_parentï¼Œå…ˆå°†å®ƒparent domainçš„irqä¹Ÿåˆ†é…å‡ºæ¥ã€‚ç”±äºir_msi_domainçš„çˆ¶domainä¸ºir_domainå…¶irq_domain_osä¸º<code>inel_ir_domain_ops</code>å…¶allocä¸º<code>intel_irq_remapping_alloc</code> è¿™ä¸ªå‡½æ•°ä¸ºä¸­æ–­remappingåŠŸèƒ½çš„æ ¸å¿ƒæ‰€åœ¨ï¼Œå› æ­¤æˆ‘ä»¬æ¥ä»”ç»†çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼š</p>
<ul>
<li>
<p>é¦–å…ˆè¿˜æ˜¯ç»§ç»­è°ƒç”¨irq_domain_alloc_irqs_parentï¼Œè€Œir_domainçš„çˆ¶domainä¸ºx86_vector_domainã€‚è€Œ<code>x86_vector_domain</code>çš„<code>alloc</code> callbackå‡½æ•°çš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯ç»™ç›¸åº”çš„irqåˆ†é…ç›¸å…³cpu lapic ä¸Šçš„ä¸­æ–­vectorï¼Œå¦‚æœä½ åœ¨alloc_irqçš„æ—¶å€™æŒ‡å®šäº†irq affinityçš„cpu_maskåˆ™ç›´æ¥ä»è¿™äº›cpuçš„lapicå½“ä¸­åˆ†é…ï¼›å¦‚æœä½ æ²¡æœ‰æŒ‡å®šåˆ™åœ¨ç³»ç»Ÿæ‰€æœ‰çš„cpuå½“ä¸­æ‰¾åˆ°åˆé€‚çš„cpu lapicç„¶ååªæ˜¯å…ˆreserve vectorç­‰åˆ°irq activeçš„æ—¶å€™æ‰çœŸæ­£å»åˆ†é…ã€‚è¿™é‡Œé¢æœ‰ä¸‰ä¸ªæ¦‚å¿µä¸€ä¸ªæ˜¯irqï¼Œä¸€ä¸ªæ˜¯hwirqï¼Œè¿˜æœ‰ä¸€ä¸ªå°±æ˜¯vectorï¼Œå¤§å®¶å¯èƒ½æœ‰ç‚¹æ™•ä»–ä»¬ä¹‹é—´åˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿç³»ç»Ÿé€šè¿‡irqæ¥æ‰¾åˆ°irq_descå’Œirq_dataï¼Œhwirqå’Œirqåœ¨ä¸€ä¸ªä¸­æ–­domainé‡Œé¢æ˜¯ä¸€ä¸€æ˜ å°„çš„å…³ç³»ï¼Œç„¶åvectoræ˜¯lapicæœ€ç»ˆèƒ½è¯†åˆ«çš„ä¸œè¥¿ä¹Ÿæ˜¯irteè¡¨é‡Œé¢çš„æœ€ç»ˆè¦å†™å…¥çš„ä¸­æ–­numberã€‚</p>
</li>
<li>
<p>æ¥ç€è°ƒç”¨alloc_irteå‡½æ•°å»åˆ†é…irteï¼Œå…¶æ ¸å¿ƒé€»è¾‘å°±æ˜¯ä»ä¸Šæ–‡æ‰€è¯´çš„bitmapå½“ä¸­æ‰¾åˆ°nvecä¸ªå¯ç”¨çš„interrupt remapping entryï¼ŒåŒæ—¶è¿”å›å¼€å§‹ä½ç½®å³åˆå§‹index</p>
</li>
<li>
<p>æ¥ç€ä¸ºæ¯ä¸ªirqå‡†å¤‡irteè¡¨å³è®¾ç½®subhandle, indexï¼Œè¿˜æœ‰å°±æ˜¯ä¸Šæ–‡æåˆ°irteä¸­çš„å…¶ä»–fieldï¼Œæœ€åå°±æ˜¯è®¾ç½®msi or msi-xä¿¡æ¯æ ¼å¼ã€‚</p>
</li>
</ul>
</li>
<li>
<p>å›åˆ°<code>msi_domain_alloc</code>å‡½æ•°ï¼Œæ¥ç€é€šè¿‡ä¸€ä¸ªloopå¯¹irqæ‰€å¯¹åº”çš„irq_dataç›¸å…³ä¿¡æ¯åšåˆå§‹åŒ–</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="n">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nr_irqs</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">//msi_initä¸ºmsi_domain_ops_init</span>
<span class="w">                </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">msi_init</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">virq</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">hwirq</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
<span class="w">                </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">msi_free</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="n">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
<span class="w">                                        </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">msi_free</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">virq</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                        </span><span class="n">irq_domain_free_irqs_top</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span><span class="w"> </span><span class="n">virq</span><span class="p">,</span><span class="w"> </span><span class="n">nr_irqs</span><span class="p">);</span>
<span class="w">                        </span><span class="kr">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>

<p>è¿™é‡Œçš„<code>msi_domain_ops_init</code> ä¸»è¦è°ƒç”¨çš„å‡½æ•°å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="n">msi_domain_ops_init</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">irq_domain_set_hwirq_and_chip</span><span class="w"> </span><span class="c1">//è®¾ç½®irq_dataå½“ä¸­çš„hwirqï¼Œchip, chip_data</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">__irq_set_handler</span><span class="w">     </span><span class="c1">//å¦‚æœmsi_domain_infoåˆå§‹åŒ–äº†handleråˆ™è¿›è¡Œè®¾ç½®</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">irq_set_handler_data</span><span class="w"> </span><span class="c1">//å¦‚æœmsi_domain_infoåˆå§‹åŒ–äº†handler_dataåˆ™è¿›è¡Œè®¾ç½®</span>

<span class="w">    </span><span class="n">handler</span><span class="w"> </span><span class="kr">and</span><span class="w"> </span><span class="n">hanadler_dataçš„å…·ä½“æƒ…å†µå¦‚ä¸‹</span>
<span class="w">    </span><span class="o">================================</span>

<span class="w">    </span><span class="n">static</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">msi_domain_info</span><span class="w"> </span><span class="n">pci_msi_ir_domain_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">flags</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">MSI_FLAG_USE_DEF_DOM_OPS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MSI_FLAG_USE_DEF_CHIP_OPS</span><span class="w"> </span><span class="o">|</span>
<span class="w">                          </span><span class="n">MSI_FLAG_MULTI_PCI_MSI</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MSI_FLAG_PCI_MSIX</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">ops</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pci_msi_domain_ops</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">chip</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pci_msi_ir_controller</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">handler</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">handle_edge_irq</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">handler_name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;edge&quot;</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>

<ul>
<li>åˆ†æå®Œ<code>msi_domain_alloc</code> ï¼Œè‡³æ­¤<code>irq_domain_alloc_irqs_hierarchy</code>çš„é€»è¾‘åŸºæœ¬çœ‹å®Œäº†ï¼Œä¹‹åæ¥ç€å¾€ä¸‹çœ‹ã€‚</li>
</ul>
<div class="highlight"><pre><span></span><code>        for (i = 0; i &lt; nr_irqs; i++)
                irq_domain_insert_irq(virq + i);
</code></pre></div>

<p><code>irq_domain_insert_irq</code>çš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯å®Œæˆvirqè·Ÿhwirqåœ¨ä¸åŒå±‚çº§çš„irq domainä¸­çš„mappingã€‚</p>
<p>ä¸Šé¢æŠŠ<code>__irq_domain_alloc_irqs</code> çš„é€»è¾‘åˆ†æå®Œäº†ï¼Œå›åˆ°<code>msi_domain_alloc_irqs</code> ç»§ç»­å¾€ä¸‹èµ°</p>
<div class="highlight"><pre><span></span><code>can_reserve = msi_check_reservation_mode(domain, info, dev);

========

static bool msi_check_reservation_mode(struct irq_domain *domain,
                                       struct msi_domain_info *info,
                                       struct device *dev)
{
        struct msi_desc <span class="gs">*desc;</span>
<span class="gs">        //bus_tokené€šå¸¸æƒ…å†µä¸‹éƒ½æ˜¯DOMAIN_BUS_PCI_MSI</span>
<span class="gs">        if (domain-&gt;bus_token != DOMAIN_BUS_PCI_MSI)</span>
<span class="gs">                return false;</span>
<span class="gs">        //å¦‚æœé…ç½®äº†CONFI_GENERIC_IRQ_RESERVATION_MODEçš„è¯è¿™ä¸ªflagæ˜¯ä¸€å®šä¼šè¢«ç½®ä¸Šçš„</span>
<span class="gs">        if (!(info-&gt;flags &amp; MSI_FLAG_MUST_REACTIVATE))</span>
<span class="gs">                return false;</span>
<span class="gs">        //CONFIG_PCI_MSI é»˜è®¤enableï¼Œç„¶åpci_mis_ignore_maskä»ä»£ç ä¸Šçœ‹æ²¡æœ‰è¢«ç½®1</span>
<span class="gs">        if (IS_ENABLED(CONFIG_PCI_MSI) &amp;&amp; pci_msi_ignore_mask)</span>
<span class="gs">                return false;</span>

<span class="gs">        /*</span>
         <span class="k">*</span> Checking the first MSI descriptor is sufficient. MSIX supports
         <span class="k">*</span> masking and MSI does so when the maskbit is set.
         */
        desc = first_msi_entry(dev);
        //é€šå¸¸æƒ…å†µä¸‹æ–°è®¾å¤‡ä¸€èˆ¬éƒ½æ˜¯MSIX
        return desc-&gt;msi_attrib.is_msix || desc-&gt;msi_attrib.maskbit;
}
</code></pre></div>

<p>æ¥ç€å¾€ä¸‹çœ‹</p>
<div class="highlight"><pre><span></span><code>        for_each_msi_entry(desc, dev) {
                virq = desc-&gt;irq;
                if (desc-&gt;nvec_used == 1)
                        dev_dbg(dev, &quot;irq %d for MSI\n&quot;, virq);
                else
                        dev_dbg(dev, &quot;irq [%d-%d] for MSI\n&quot;,
                                virq, virq + desc-&gt;nvec_used - 1);
                /*
                 <span class="k">*</span> This flag is set by the PCI layer as we need to activate
                 <span class="k">*</span> the MSI entries before the PCI layer enables MSI in the
                 <span class="k">*</span> card. Otherwise the card latches a random msi message.
                 */
                 //åœ¨åˆ›å»ºir_msi_domainçš„æ—¶å€™è¿™ä¸ªflagä¼šè¢«ç½®ä¸Š
                if (!(info-&gt;flags &amp; MSI_FLAG_ACTIVATE_EARLY))
                        continue;

                irq_data = irq_domain_get_irq_data(domain, desc-&gt;irq);
                if (!can_reserve)
                        irqd_clr_can_reserve(irq_data);
                ret = irq_domain_activate_irq(irq_data, can_reserve);
                if (ret)
                        goto cleanup;
        }
</code></pre></div>

<p>ä¸Šé¢çš„æ ¸å¿ƒé€»è¾‘åœ¨<code>irq_domain_activate_irq(irq_data, can_reserve)</code> ï¼Œå®ƒæœ€ç»ˆä¼šè°ƒåˆ°å‡½æ•°<code>__irq_domain_activate_irq</code> å®ƒçš„å…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code>static int __irq_domain_activate_irq(struct irq_data *irqd, bool reserve)
{
        int ret = 0;

        if (irqd &amp;&amp; irqd-&gt;domain) {
                struct irq_domain <span class="gs">*domain = irqd-&gt;domain;</span>

<span class="gs">                if (irqd-&gt;parent_data)</span>
<span class="gs">                        ret = __irq_domain_activate_irq(irqd-&gt;parent_data,</span>
<span class="gs">                                                        reserve);</span>
<span class="gs">                if (!ret &amp;&amp; domain-&gt;ops-&gt;activate) {</span>
<span class="gs">                        ret = domain-&gt;ops-&gt;activate(domain, irqd, reserve);</span>
<span class="gs">                        /*</span> Rollback in case of error */
                        if (ret &amp;&amp; irqd-&gt;parent_data)
                                __irq_domain_deactivate_irq(irqd-&gt;parent_data);
                }
        }
        return ret;
}
</code></pre></div>

<p>ä»å®ç°å¯ä»¥çœ‹å‡ºå®ƒä½¿ç”¨äº†é€’å½’é€»è¾‘ä¼˜å…ˆè°ƒç”¨æœ€ä¸Šå±‚çš„domainçš„activateå‡½æ•°ï¼Œä»ä¸Šç¯‡æ–‡ç« çš„æ¢³ç†å¯ä»¥çŸ¥é“ç³»ç»Ÿå½“ä¸­æ•´ä¸ªdomainçš„æœ‰å…³ç³»å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code>x86_vector_domain ---- çˆ¶äº²
      |
      |
   ir_domain   -------- å„¿å­
      |
      |
   ir_msi_domain -------å­™å­
</code></pre></div>

<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹x86_vector_domainçš„activateå®ç°</p>
<div class="highlight"><pre><span></span><code><span class="n">MANAGED_IRQ_SHUTDOWN_VECTOR</span>

<span class="n">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x86_vector_activate</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="n">irq_domain</span><span class="w"> </span><span class="o">*</span><span class="n">dom</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="n">irq_data</span><span class="w"> </span><span class="o">*</span><span class="n">irqd</span><span class="p">,</span>
<span class="w">                               </span><span class="n">bool</span><span class="w"> </span><span class="n">reserve</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="n">apic_chip_data</span><span class="w"> </span><span class="o">*</span><span class="n">apicd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">apic_chip_data</span><span class="p">(</span><span class="n">irqd</span><span class="p">);</span>
<span class="w">        </span><span class="k">unsigned</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>

<span class="w">        </span><span class="n">trace_vector_activate</span><span class="p">(</span><span class="n">irqd</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="n">apicd</span><span class="o">-&gt;</span><span class="n">is_managed</span><span class="p">,</span>
<span class="w">                              </span><span class="n">apicd</span><span class="o">-&gt;</span><span class="n">can_reserve</span><span class="p">,</span><span class="w"> </span><span class="n">reserve</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* Nothing to do for fixed assigned vectors */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">apicd</span><span class="o">-&gt;</span><span class="n">can_reserve</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">apicd</span><span class="o">-&gt;</span><span class="n">is_managed</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>

<span class="w">        </span><span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vector_lock</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reserve</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">irqd_is_managed_and_shutdown</span><span class="p">(</span><span class="n">irqd</span><span class="p">))</span>
<span class="w">                </span><span class="n">vector_assign_managed_shutdown</span><span class="p">(</span><span class="n">irqd</span><span class="p">);</span>
<span class="w">        </span><span class="p">........</span>
<span class="p">}</span>
</code></pre></div>

<p>ä»ä¸Šé¢çš„å®ç°æ¥çœ‹å½“reserveä¸ºtrueçš„æ—¶å€™ï¼Œé€šè¿‡vector_assign_managed_shutdownä¸ºæ¯ä¸ªirqè®¾ç½®vectorä¸º<code>MANAGED_IRQ_SHUTDOWN_VECTOR</code> å³å¹¶æ²¡æœ‰åˆ†é…å®é™…çš„vectorã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ir_domainçš„activateå‡½æ•°</p>
<div class="highlight"><pre><span></span><code>static int intel_irq_remapping_activate(struct irq_domain *domain,
                                        struct irq_data *irq_data, bool reserve)
{
        intel_ir_reconfigure_irte(irq_data, true);
        return 0;
}
</code></pre></div>

<p>æ ¸å¿ƒå®ç°ä¸»è¦æ˜¯ç”±<code>intel_ir_reconfigure_irte</code>æ¥å®ç°ï¼Œå…¶ä¸»è¦æŠŠåœ¨alloc irqé˜¶æ®µåˆ›å»ºçš„irte syncåˆ°ir_tableé‡Œé¢ã€‚</p>
<p>æœ€åçœ‹ä¸€ä¸‹ir_msi_domainçš„activateå‡½æ•°ï¼Œå…·ä½“å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code>static int msi_domain_activate(struct irq_domain *domain,
                               struct irq_data *irq_data, bool early)
{
        struct msi_msg msg[2] = { [1] = { }, };

        BUG_ON(irq_chip_compose_msi_msg(irq_data, msg));
        msi_check_level(irq_data-&gt;domain, msg);
        irq_chip_write_msi_msg(irq_data, msg);
        return 0;
}
</code></pre></div>

<p>æ ¸å¿ƒå°±æ˜¯é€šè¿‡irq_chip_wirte_msi_msgå°†msi or msix msgå†™å…¥åˆ°pcieè®¾å¤‡çš„msi cap çš„vector tableé‡Œé¢ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="w">                </span><span class="nx">writel</span><span class="p">(</span><span class="nx">msg</span><span class="o">-&gt;</span><span class="nx">address_lo</span><span class="p">,</span><span class="w"> </span><span class="kd">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">PCI_MSIX_ENTRY_LOWER_ADDR</span><span class="p">);</span>
<span class="w">                </span><span class="nx">writel</span><span class="p">(</span><span class="nx">msg</span><span class="o">-&gt;</span><span class="nx">address_hi</span><span class="p">,</span><span class="w"> </span><span class="kd">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">PCI_MSIX_ENTRY_UPPER_ADDR</span><span class="p">);</span>
<span class="w">                </span><span class="nx">writel</span><span class="p">(</span><span class="nx">msg</span><span class="o">-&gt;</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="kd">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">PCI_MSIX_ENTRY_DATA</span><span class="p">);</span>
</code></pre></div>

<p>è‡³æ­¤å·²ç»å®Œæˆäº†irqçš„æ•´ä¸ªåˆ†é…æµç¨‹ï¼Œä¸Šé¢è¿˜æœ‰ä¸€ä¸ªé—ç•™çš„é—®é¢˜é‚£å°±æ˜¯æ¯ä¸ªirqæ‰€å¯¹åº”çš„vectorå¹¶æ²¡æœ‰çœŸæ­£å»åˆ†é…ï¼Œé‚£å…·ä½“ä»€ä¹ˆæ—¶å€™å»åˆ†é…çš„å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯åœ¨request_irqçš„æ—¶å€™å»åˆ†é…çš„ï¼ŒåŒæ—¶ä¼šå†æ¬¡è°ƒç”¨æ¯ä¸ªdomainçš„activateå‡½æ•°ã€‚</p>
<h4>è™šæ‹ŸåŒ–åœºæ™¯</h4>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹åœ¨è®¾å¤‡ç›´é€šåœºæ™¯è¯¥è®¾å¤‡çš„ä¸­æ–­æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ï¼Œå…·ä½“çš„å®ç°æ˜¯ä»vfio_realizeå½“ä¸­çš„<code>vfio_msix_early_setup</code>å‡½æ•°å¼€å§‹çš„ã€‚<strong>è¿™ä¸ªå‡½æ•°é‡Œé¢é¦–å…ˆä¼šå»è¯»åˆå§‹åŒ–msixçš„table_bar, pba_bar, entriesç­‰ä¿¡æ¯ï¼Œç„¶åæ¥ç€è°ƒç”¨<code>vfio_pci_fixup_msix_region</code>å¯¹msix table æ‰€åœ¨çš„bar mmap regionè¿›è¡Œä¿®å‰ªã€‚è¿™é‡ŒèƒŒåçš„é€»è¾‘æ˜¯è¯´ç›´é€šè®¾å¤‡çš„mmioè®¿é—®(å³å¯¹barçš„è®¿é—®)é™¤äº†ç¬¬ä¸€æ¬¡ä¹‹å¤–ï¼Œåé¢éƒ½æ˜¯æŒ‰ç…§å†…å­˜é€šè¿‡EPTå¤„ç†çš„å³ä¸å†é€€å‡ºã€‚ä½†æ˜¯misxä¸­æ–­å¤„ç†è¿™ä¸€å—æœ‰äº›ç‰¹æ®Šï¼Œæ¯”å¦‚åœ¨guesté‡Œé¢æˆ‘ä»¬å¯èƒ½ä¿®æ”¹ç½‘å¡ä¸­æ–­çš„ç»‘æ ¸ä¿¡æ¯é‚£è¿™ä¸ªæ—¶å€™vmmè¿™ä¸€ä¾§å°±å¿…é¡»è¦æ„ŸçŸ¥é“å› ä¸ºè¦åŒæ­¥å»ä¿®æ”¹irteçš„å†…å®¹ï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°çš„ä¸»è¦ä½œç”¨å°±æ˜¯æŠŠmsi_tableç›¸å…³çš„åŒºåŸŸä»regioné‡Œé¢å»æ‰ï¼Œç„¶åé€šè¿‡çº¯æ¨¡æ‹Ÿçš„æ–¹å¼å»å®ç°guestå¯¹msix tableçš„ç›¸å…³è®¿é—®</strong>ã€‚äº¤ä»£å®Œè¿™ä¸ªèƒŒæ™¯ä¹‹åæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹</p>
<div class="highlight"><pre><span></span><code><span class="n">vfio_add_capabilities</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">vfio_msix_setup</span><span class="o">-&gt;</span><span class="n">vfio_msix_setup</span><span class="o">-&gt;</span><span class="n">msix_init</span>
</code></pre></div>

<p><code>msix_init</code> å‡½æ•°åšçš„äº‹æƒ…ä¸»è¦æœ‰åœ¨è®¾å¤‡çš„pcié…ç½®ç©ºé—´æ·»åŠ msix capï¼Œå®Œå–„msix_table, msix pbaåœ¨qemuä¾§æ¨¡æ‹Ÿé…ç½®ç©ºé—´çš„ä½ç½®ä¿¡æ¯ï¼Œå°†æ‰€æœ‰çš„vector maskä»¥åŠè®¾ç½®msix_table_mmio_opså’Œmsix_pba_mmio_opsï¼ŒåŒæ˜¯æŠŠæ‰€æœ‰çš„ä¸­æ–­vector maskæ‰ã€‚
ä¸Šé¢æŠŠqemuè¿™ä¸€ä¾§ç›´é€šè®¾å¤‡msixåˆå§‹åŒ–çš„æµç¨‹æ•´ç†å®Œäº†ï¼Œåé¢çš„æµç¨‹å°±æ˜¯vmå¯åŠ¨ä¹‹ååœ¨ç›¸å…³é©±åŠ¨å½“ä¸­é€šè¿‡<code>__pci_enable_msix-&gt;msix_capability_init</code>å»ç”³è¯·ä¸­æ–­vectoräº†ï¼Œå…·ä½“çš„é€»è¾‘å¯ä»¥å‚è€ƒä¸Šé¢éè™šæ‹ŸåŒ–åœºæ™¯çš„ç›¸å…³é€»è¾‘(åŒºåˆ«åœ¨é‡Œmsix msgçš„æ ¼å¼ä¸ºcompatibility format)ã€‚è¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸€ä¸‹ç”³è¯·ä¸­æ–­çš„è¿‡ç¨‹ä¸­ä¸åç«¯æ˜¯å¦‚ä½•äº¤äº’å¹¶ä¸”æˆåŠŸä½¿èƒ½çš„ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">msix_capability_init</span><span class="p">(</span><span class="n">struct</span><span class="w"> </span><span class="n">pci_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">msix_entry</span><span class="w"> </span><span class="o">*</span><span class="n">entries</span><span class="p">,</span>
<span class="w">                                </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">nvec</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">irq_affinity</span><span class="w"> </span><span class="o">*</span><span class="n">affd</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">        </span><span class="n">u16</span><span class="w"> </span><span class="n">control</span><span class="p">;</span>
<span class="w">        </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">__iomem</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="p">;</span>

<span class="w">        </span><span class="o">......</span><span class="w"> </span><span class="o">//</span><span class="err">ç•¥å»</span>

<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pci_msi_setup_msi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">nvec</span><span class="p">,</span><span class="w"> </span><span class="n">PCI_CAP_ID_MSIX</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">                </span><span class="n">goto</span><span class="w"> </span><span class="n">out_avail</span><span class="p">;</span>

<span class="w">        </span><span class="o">/*</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">MSI</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="n">honor</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">restrictions</span><span class="w"> </span><span class="o">*/</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msi_verify_entries</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">                </span><span class="n">goto</span><span class="w"> </span><span class="n">out_free</span><span class="p">;</span>

<span class="w">        </span><span class="o">/*</span>
<span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">devices</span><span class="w"> </span><span class="n">require</span><span class="w"> </span><span class="n">MSI</span><span class="o">-</span><span class="n">X</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">enabled</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">touch</span><span class="w"> </span><span class="n">the</span>
<span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">MSI</span><span class="o">-</span><span class="n">X</span><span class="w"> </span><span class="n">registers</span><span class="o">.</span><span class="w">  </span><span class="n">We</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">vectors</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">prevent</span>
<span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">interrupts</span><span class="w"> </span><span class="n">coming</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">they</span><span class="s1">&#39;re fully set up.</span>
<span class="w">         </span><span class="o">*/</span>
<span class="w">        </span><span class="n">pci_msix_clear_and_set_ctrl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                                </span><span class="n">PCI_MSIX_FLAGS_MASKALL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PCI_MSIX_FLAGS_ENABLE</span><span class="p">);</span>

<span class="w">        </span><span class="n">msix_program_entries</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">entries</span><span class="p">);</span>

<span class="w">        </span><span class="o">......</span><span class="w"> </span><span class="o">//</span><span class="err">ç•¥å»</span>

<span class="w">        </span><span class="n">pci_msix_clear_and_set_ctrl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">PCI_MSIX_FLAGS_MASKALL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="o">......</span><span class="w">  </span><span class="o">//</span><span class="err">ç•¥å»</span>

<span class="p">}</span>
</code></pre></div>

<p>ä¸Šé¢æ˜¯msix_capability_initçš„æ ¸å¿ƒé€»è¾‘ï¼Œå…¶ä¸­ç”³è¯·ä¸­æ–­çš„æ ¸å¿ƒå‡½æ•°pci_msi_setup_msi_irqsé‡Œé¢è·Ÿåç«¯éœ€è¦è¿›è¡Œäº¤äº’çš„å…³é”®éƒ¨åˆ†å°±æ˜¯æŠŠmsix msgå†™åˆ°åç«¯å³å†™msix tableã€‚é‚£æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹qemuä¾§çš„ç›¸å…³å®ç°</p>
<div class="highlight"><pre><span></span><code><span class="nx">static</span><span class="w"> </span><span class="nx">void</span><span class="w"> </span><span class="nx">msix_table_mmio_write</span><span class="p">(</span><span class="nx">void</span><span class="w"> </span><span class="o">*</span><span class="nx">opaque</span><span class="p">,</span><span class="w"> </span><span class="nx">hwaddr</span><span class="w"> </span><span class="kd">addr</span><span class="p">,</span>
<span class="w">                                  </span><span class="nx">uint64_t</span><span class="w"> </span><span class="nx">val</span><span class="p">,</span><span class="w"> </span><span class="nx">unsigned</span><span class="w"> </span><span class="nx">size</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nx">PCIDevice</span><span class="w"> </span><span class="o">*</span><span class="nx">dev</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">opaque</span><span class="p">;</span>
<span class="w">    </span><span class="nx">int</span><span class="w"> </span><span class="nx">vector</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kd">addr</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">PCI_MSIX_ENTRY_SIZE</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nx">was_masked</span><span class="p">;</span>

<span class="w">    </span><span class="nx">was_masked</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">msix_is_masked</span><span class="p">(</span><span class="nx">dev</span><span class="p">,</span><span class="w"> </span><span class="nx">vector</span><span class="p">);</span>
<span class="w">    </span><span class="nx">pci_set_long</span><span class="p">(</span><span class="nx">dev</span><span class="o">-&gt;</span><span class="nx">msix_table</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="kd">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">);</span>
<span class="w">    </span><span class="nx">msix_handle_mask_update</span><span class="p">(</span><span class="nx">dev</span><span class="p">,</span><span class="w"> </span><span class="nx">vector</span><span class="p">,</span><span class="w"> </span><span class="nx">was_masked</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>static void msix_handle_mask_update(PCIDevice *dev, int vector, bool was_masked)
{
    bool is_masked = msix_is_masked(dev, vector);
    //ç”±äºæ­¤æ—¶vectorè¿˜å¤„äºmaskedçŠ¶æ€ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›ã€‚
    if (is_masked == was_masked) {
        return;
    }

    msix_fire_vector_notifier(dev, vector, is_masked);

    if (!is_masked &amp;&amp; msix_is_pending(dev, vector)) {
        msix_clr_pending(dev, vector);
        msix_notify(dev, vector);
    }
}
</code></pre></div>

<p>æ³¨æ„ç”±äºè¿™ä¸ªæ—¶åˆ»vectorè¿˜æ˜¯maskçŠ¶æ€ï¼Œæ‰€ä»¥åªä¼šæ›´æ–°åç«¯msix_tableçš„ä¿¡æ¯ã€‚åä¸‹é¢çš„é€»è¾‘å½“ä¸­è¦ä¸åç«¯è¿›è¡Œäº¤äº’çš„é€»è¾‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="o">/*</span>
<span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">devices</span><span class="w"> </span><span class="n">require</span><span class="w"> </span><span class="n">MSI</span><span class="o">-</span><span class="n">X</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">enabled</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">touch</span><span class="w"> </span><span class="n">the</span>
<span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">MSI</span><span class="o">-</span><span class="n">X</span><span class="w"> </span><span class="n">registers</span><span class="p">.</span><span class="w">  </span><span class="n">We</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">vectors</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">prevent</span>
<span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">interrupts</span><span class="w"> </span><span class="n">coming</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">they</span><span class="o">&#39;</span><span class="n">re</span><span class="w"> </span><span class="n">fully</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">up</span><span class="p">.</span>
<span class="w">         </span><span class="o">*/</span>
<span class="w">        </span><span class="n">pci_msix_clear_and_set_ctrl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                                </span><span class="n">PCI_MSIX_FLAGS_MASKALL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PCI_MSIX_FLAGS_ENABLE</span><span class="p">);</span>

<span class="w">        </span><span class="n">msix_program_entries</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">entries</span><span class="p">);</span>

<span class="w">        </span><span class="p">......</span><span class="w"> </span><span class="c1">//ç•¥å»</span>

<span class="w">        </span><span class="n">pci_msix_clear_and_set_ctrl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">PCI_MSIX_FLAGS_MASKALL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</code></pre></div>

<p>ä¸Šé¢çš„é€»è¾‘å½“ä¸­<code>pci_msix_clear_and_set_ctrl</code> è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯å†™è®¾å¤‡çš„config_spaceç›¸å¯¹åº”çš„åç«¯å¤„ç†å‡½æ•°ä¸º<code>vfio_pci_write_config</code>ä¸‹é¢æˆªå–ä¸€ä¸‹å…¶æ ¸å¿ƒçš„å®ç°è¿›è¡Œç›¸å…³çš„åˆ†æï¼š</p>
<div class="highlight"><pre><span></span><code><span class="o">......</span>
<span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pdev</span><span class="o">-&gt;</span><span class="nx">cap_present</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">QEMU_PCI_CAP_MSIX</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">ranges_overlap</span><span class="p">(</span><span class="kd">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="p">,</span><span class="w"> </span><span class="nx">pdev</span><span class="o">-&gt;</span><span class="nx">msix_cap</span><span class="p">,</span><span class="w"> </span><span class="nx">MSIX_CAP_LENGTH</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">int</span><span class="w"> </span><span class="nx">is_enabled</span><span class="p">,</span><span class="w"> </span><span class="nx">was_enabled</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">msix_enabled</span><span class="p">(</span><span class="nx">pdev</span><span class="p">);</span>

<span class="w">        </span><span class="nx">pci_default_write_config</span><span class="p">(</span><span class="nx">pdev</span><span class="p">,</span><span class="w"> </span><span class="kd">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="p">);</span>

<span class="w">        </span><span class="nx">is_enabled</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">msix_enabled</span><span class="p">(</span><span class="nx">pdev</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">was_enabled</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">is_enabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">vfio_msix_enable</span><span class="p">(</span><span class="nx">vdev</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">was_enabled</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">!</span><span class="nx">is_enabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">vfio_msix_disable</span><span class="p">(</span><span class="nx">vdev</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="o">......</span>
</code></pre></div>

<p>å› ä¸ºè®¾ç½®äº†<code>PCI_MSIX_FLAGS_ENABLE</code> æ‰€ä»¥åœ¨qemuè¿™ä¸€ç«¯ä¼šèµ°åˆ°vfio_msix_enableçš„é€»è¾‘ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯åœ¨vfioè¿™ä¸€å±‚enable vector 0ä¸­çš„ä¸­æ–­åˆ°qemuä¾§å¦å¤–å°±æ˜¯ä¸ºè¿™ä¸ªè®¾å¤‡çš„<code>msix_vector_use_notifier</code> å’Œ<code>msix_vector_release_notifier</code>ã€‚æ¥ç€å†å›åˆ°guesté‡Œé¢çš„é€»è¾‘ï¼Œ<code>msix_program_entries</code> ä¼šå°†æ‰€æœ‰çš„ä¸­æ–­vector maskæ‰ï¼Œç„¶åå†clearæ‰msix ctr flagå½“ä¸­çš„<code>PCI_MSIX_FLAGS_MASKALL</code> ä½ã€‚è®²åˆ°è¿™é‡Œå¯èƒ½å¾ˆå¤šäººå°±ä¼šé—®vectoråˆ°åº•æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™unmaskçš„å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯åœ¨guesté‡Œé¢è°ƒç”¨request_irqçš„æ—¶å€™ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">request_irq</span><span class="o">-&gt;</span><span class="n">request_threaded_irq</span><span class="o">-&gt;</span><span class="n">__setup_irq</span><span class="o">-&gt;</span><span class="n">irq_startup</span><span class="o">-&gt;</span><span class="n">__irq_startup</span><span class="o">-&gt;</span><span class="n">unmask_irq</span><span class="o">-&gt;</span><span class="n">pci_msi_unmask_irq</span>
</code></pre></div>

<p>ä¸Šé¢çš„é€»è¾‘æˆ‘å°±ä¸ç»†è®²äº†ï¼Œå¤§å®¶å¦‚æœæœ‰å…´è¶£å¯ä»¥è‡ªå·±å»ç¿»é˜…ä¸€ä¸‹ç›¸å…³çš„ä»£ç ã€‚æˆ‘ä»¬ç€é‡æ¥çœ‹ä¸€ä¸‹qemuè¿™ä¸€ä¾§çš„ç›¸å…³é€»è¾‘ã€‚ç”±äºè¦unmask vectoræ‰€ä»¥è¦å†™msix_table mmioï¼Œåç«¯å¯¹åº”çš„å…·ä½“opså‡½æ•°å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="n">msix_table_mmio_write</span><span class="w"> </span><span class="o">-&gt;</span><span class="n">msix_fire_vector_notifier</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>static void msix_fire_vector_notifier(PCIDevice *dev,
                                      unsigned int vector, bool is_masked)
{
    MSIMessage msg;
    int ret;

    if (!dev-&gt;msix_vector_use_notifier) {
        return;
    }
    if (is_masked) {
        dev-&gt;msix_vector_release_notifier(dev, vector);
    } else {
        //ç”±äºæ˜¯unmaskï¼Œæ‰€ä»¥å…·ä½“çš„æ‰§è¡Œé€»è¾‘å¦‚ä¸‹
        msg = msix_get_message(dev, vector);
        ret = dev-&gt;msix_vector_use_notifier(dev, vector, msg);
        assert(ret &gt;= 0);
    }
}
</code></pre></div>

<p><code>msix_vector_use_notifier</code> è°ƒç”¨çš„callbackä¸º<code>vfio_msix_vector_use</code>å…¶æœ€ç»ˆè°ƒç”¨çš„å‡½æ•°ä¸º<code>vfio_msix_vector_do_use</code> ã€‚ä¸‹é¢æˆ‘ä»¬ç€é‡çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å…·ä½“é€»è¾‘æ˜¯ä»€ä¹ˆ</p>
<ul>
<li>
<p>é¦–å…ˆä¸ºè¯¥vectorçš„interrupt EventNotifieråˆå§‹åŒ–eventfdï¼Œç„¶åä¸ºè¿™ä¸ªfdè®¾ç½®handlerå‡½æ•°ä¸º<code>vfio_msi_interrupt</code></p>
</li>
<li>
<p>æ¥ç€è°ƒç”¨<code>vfio_add_kvm_msi_virq</code> ï¼Œè¿™ä¸ªå‡½æ•°é‡Œé¢é¦–å…ˆä¸ºvectorçš„kvm_interrupt è¿™ä¸ªEventNotifierå¯åŒ–eventfdï¼›æ¥ç€è°ƒç”¨<code>kvm_irqchip_add_msi_route</code>åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢é¦–å…ˆåœ¨used_gsi_bitmapé‡Œæ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„virqï¼Œæ¥ç€ä¸ºè¿™ä¸ªvectoråˆ›å»º <code>kvm_irq_routing_entry</code>å…¶æ ¸å¿ƒé€»è¾‘å°±æ˜¯åœ¨kvm_stateçš„irq_routeså¢åŠ ä¸€ä¸ªæ–°çš„entryï¼ŒåŒæ—¶æŠŠused_gsi_bitmapç»™æ›´æ–°æ‰ï¼›æ¥ç€è°ƒç”¨<code>kvm_arch_add_msi_route_post</code> ï¼Œè¿™ä¸ªå‡½æ•°é‡Œé¢ä¼šæ–°å»ºä¸€ä¸ª<code>MSIRouteEntry</code>ï¼Œç„¶åå°†å…¶åŠ åˆ°å…¨å±€çš„<code>msi_route_list</code>é‡Œé¢ã€‚æœ€åé€šè¿‡<code>kvm_irqchip_commit_routes</code>é€šè¿‡<code>KVM_SET_GSI_ROUTING</code> è¿™ä¸ªioctlæ¥è®¾ç½®irq routing(æ³¨æ„è¿™é‡Œqemuä¼šæŠŠkvm_state-&gt;irq_routesä½œä¸ºä¸€ä¸ªæ•´ä½“æ¥æäº¤)ï¼Œå…·ä½“çš„é€»è¾‘æˆ‘ä»¬éœ€è¦åˆ°kvmé‡Œé¢çœ‹ä¸€ä¸‹ç›¸å…³çš„é€»è¾‘ã€‚</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="n">setup_routing_entry</span><span class="o">-&gt;</span><span class="n">kvm_set_routing_entry</span>
</code></pre></div>

<p>å…¶æ ¸å¿ƒé€»è¾‘å°±æ˜¯å°†qemuä¾§çš„routing entry æ·»åŠ åˆ°<code>kvm-&gt;irq_routing</code> è¿™ä¸ªirqè·¯ç”±è¡¨é‡Œé¢ï¼Œç„¶åä¸åŒç±»å‹çš„è·¯ç”±å…¶å¯¹åº”çš„è¡¨é¡¹ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œæ¯”å¦‚åœ¨msi or msixçš„æƒ…å†µä¸‹è¡¨é¡¹æ˜¯è¿™æ ·çš„</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="nx">e</span><span class="o">-&gt;</span><span class="nx">set</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">kvm_set_msi</span><span class="p">;</span><span class="w"> </span><span class="c1">//å…·ä½“çš„ä¸­æ–­delivery å‡½æ•°</span>
<span class="w">    </span><span class="nx">e</span><span class="o">-&gt;</span><span class="nx">msi</span><span class="p">.</span><span class="nx">address_lo</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ue</span><span class="o">-&gt;</span><span class="nx">u</span><span class="p">.</span><span class="nx">msi</span><span class="p">.</span><span class="nx">address_lo</span><span class="p">;</span>
<span class="w">    </span><span class="nx">e</span><span class="o">-&gt;</span><span class="nx">msi</span><span class="p">.</span><span class="nx">address_hi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ue</span><span class="o">-&gt;</span><span class="nx">u</span><span class="p">.</span><span class="nx">msi</span><span class="p">.</span><span class="nx">address_hi</span><span class="p">;</span>
<span class="w">    </span><span class="nx">e</span><span class="o">-&gt;</span><span class="nx">msi</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ue</span><span class="o">-&gt;</span><span class="nx">u</span><span class="p">.</span><span class="nx">msi</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
</code></pre></div>

<p>ç„¶åå†å›åˆ°<code>vfio_add_kvm_msi_virq</code> å‡½æ•°æ¥ç€è°ƒç”¨<code>kvm_irqchip_add_irqfd_notifier_gsi</code> åœ¨kvmä¾§æ·»åŠ irqfd</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="n">kvm_irqfd</span><span class="w"> </span><span class="n">irqfd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w">  </span><span class="c1">// vector-&gt;kvm_interrupt çš„eventfd</span>
<span class="w">        </span><span class="p">.</span><span class="n">gsi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">virq</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">assign</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">KVM_IRQFD_FLAG_DEASSIGN</span><span class="p">,</span><span class="w"> </span><span class="c1">//assign ä¸ºtrue</span>
<span class="w">    </span><span class="p">};</span>


<span class="n">kvm_vm_ioctl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">KVM_IRQFD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">irqfd</span><span class="p">);</span>
</code></pre></div>

<p>å¦‚ä¸Šé¢æ‰€ç¤ºé€šè¿‡KVM_IRQFDå†æ¬¡callåˆ°kvmé‡Œé¢å…·ä½“è°ƒç”¨çš„å‡½æ•°<code>kvm_irqfd</code>ï¼Œæœ€ç»ˆè°ƒç”¨<code>kvm_irqfd_assign</code> å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°çš„å…·ä½“é€»è¾‘åœ¨kvmé‡Œé¢åˆ›å»ºä¸€ä¸ªç›¸åº”çš„<code>kvm_kernel_irqfd</code>ï¼Œç„¶åä¸ºè¿™ä¸ªirqfdåˆå§‹åŒ– irq injectï¼Œirq shutdownå‡½æ•°ä»¥åŠç›¸åº”çš„eventfdã€‚ç„¶åæŠŠirqfdåŠ åˆ°<code>kvm-&gt;irqfds.items</code>é‡Œé¢ã€‚å¦‚æœkvm enable äº†irq_bypassåˆ™éœ€è¦ä¸ºè¿™ä¸ªirqfdåˆå§‹åŒ–consumerç›¸å…³çš„æ•°æ®ç»“æ„ã€‚
å†å›åˆ°<code>vfio_msix_vector_do_use</code> è¿™ä¸ªå‡½æ•°æ¥ç€å¾€ä¸‹çœ‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="o">........</span>

<span class="w">    </span><span class="nt">if</span><span class="w"> </span><span class="o">(</span><span class="nt">vdev-</span><span class="o">&gt;</span><span class="nt">nr_vectors</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nt">nr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nt">1</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">vfio_disable_irqindex(&amp;vdev-&gt;vbasedev,</span><span class="w"> </span><span class="err">VFIO_PCI_MSIX_IRQ_INDEX)</span><span class="p">;</span>
<span class="w">        </span><span class="err">vdev-&gt;nr_vectors</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">nr</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">1</span><span class="p">;</span>
<span class="w">        </span><span class="err">ret</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">vfio_enable_vectors(vdev,</span><span class="w"> </span><span class="err">true)</span><span class="p">;</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">(ret)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="err">error_report(&quot;</span><span class="n">vfio</span><span class="p">:</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="kc">to</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">vectors</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">d</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>


<span class="o">.......</span>
</code></pre></div>

<p>æ ¸å¿ƒé€»è¾‘å¦‚ä¸Šé¢æ‰€ç¤ºï¼Œä»ä¸Šé¢çš„å®ç°æ‰€çœ‹é¦–å…ˆè°ƒç”¨<code>vfio_disable_irqindex</code>ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å…·ä½“å®ç°</p>
<div class="highlight"><pre><span></span><code>void vfio_disable_irqindex(VFIODevice *vbasedev, int index)
{
    struct vfio_irq_set irq_set = {
        .argsz = sizeof(irq_set),
        .flags = VFIO_IRQ_SET_DATA_NONE | VFIO_IRQ_SET_ACTION_TRIGGER,
        .index = index,
        .start = 0,
        .count = 0,
    };

    ioctl(vbasedev-&gt;fd, VFIO_DEVICE_SET_IRQS, &amp;irq_set);
}
</code></pre></div>

<p>åœ¨vfioä¾§å…¶è°ƒç”¨é€»è¾‘å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="n">vfio_pci_set_msi_trigger</span><span class="o">-&gt;</span><span class="n">vfio_msi_disable</span>
</code></pre></div>

<p>å…·ä½“çš„å‡½æ•°å®ç°æˆ‘è¿™é‡Œå°±ä¸è´´å‡ºæ¥äº†ï¼Œå…¶ä¸»è¦åšçš„äº‹æƒ…æœ‰
1. é‡Šæ”¾irq bypass ç›¸å…³æ•°æ®ç»“æ„ï¼Œé‡Šæ”¾eventfdç­‰
2. <code>pci_free_irq_vectors</code>  disableæ‰msixï¼Œé‡Šæ”¾ä¸ºè¿™ä¸ªè®¾å¤‡ç”³è¯·çš„irq
3. å°†num_ctxæ¸…0 ç„¶åè®¾ç½®irq_typeä¸º<code>VFIO_PCI_NUM_IRQS</code></p>
<p>è°ƒå®Œdisableå‡½æ•°ä¹‹åï¼Œqemué‡Œé¢ç´§æ¥ç€è°ƒç”¨<code>vfio_enable_vectors</code>ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå‡½æ•°çš„é‡ç‚¹éƒ¨åˆ†è§£æä¸€ä¸‹ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªirq_set</p>
<div class="highlight"><pre><span></span><code>    struct vfio_irq_set <span class="gs">*irq_set;</span>
<span class="gs">    ........</span>
<span class="gs">    irq_set = g_malloc0(argsz);</span>
<span class="gs">    irq_set-&gt;argsz = argsz;</span>
<span class="gs">    irq_set-&gt;flags = VFIO_IRQ_SET_DATA_EVENTFD | VFIO_IRQ_SET_ACTION_TRIGGER;</span>
<span class="gs">    irq_set-&gt;index = msix ? VFIO_PCI_MSIX_IRQ_INDEX : VFIO_PCI_MSI_IRQ_INDEX;</span>
<span class="gs">    irq_set-&gt;start = 0;</span>
<span class="gs">    irq_set-&gt;count = vdev-&gt;nr_vectors;</span>
<span class="gs">    fds = (int32_t *</span>)&amp;irq_set-&gt;data;
</code></pre></div>

<p>ç„¶åæ¥ç€å°†ç›®å‰ä¸ºæ­¢å°†è¦å’Œå·²ç»enableçš„vectorçš„fd (æ¯ä¸ªvectorçš„kvm_interrupt eventfd) å…¨éƒ¨æ·»åŠ åˆ°fdsï¼Œæ¥ç€è°ƒç”¨ioctl <code>VFIO_DEVICE_SET_IRQS</code> callåˆ°vfioï¼Œæˆ‘ä»¬æ¥ç€çœ‹vfioå½“ä¸­è¿™ä¸€å—çš„é€»è¾‘</p>
<div class="highlight"><pre><span></span><code><span class="n">vfio_pci_set_msi_trigger</span><span class="o">-&gt;</span><span class="n">vfio_msi_enable</span>
<span class="w">                        </span><span class="o">-&gt;</span><span class="n">vfio_msi_set_block</span>
</code></pre></div>

<p>vfio_msi_enableè¿™ä¸ªå‡½æ•°æœ€æ ¸å¿ƒçš„é€»è¾‘å°±æ˜¯ä¸ºè¿™ä¸ªç›´é€šè®¾å¤‡ç”³è¯·ç‰©ç†çš„irq(ä¹‹å‰ç”³è¯·çš„irqåœ¨æŠŠè¯¥è®¾å¤‡ä»åŸç”Ÿdriver removeçš„æ—¶å€™å·²ç»freeæ‰äº†)ï¼Œå…·ä½“è°ƒç”¨é€»è¾‘å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="n">pci_alloc_irq_vectors</span><span class="o">-&gt;</span><span class="n">pci_alloc_irq_vectors_affinity</span><span class="o">-&gt;</span><span class="n">__pci_enable_msix_range</span>
</code></pre></div>

<p>æ˜¯ä¸æ˜¯çœ‹åˆ°äº†è·Ÿéè™šæ‹ŸåŒ–åœºæ™¯ä¸‹çš„ä¸€æ ·çš„å‡½æ•°<code>__pci_enable_msix_range</code> , å…·ä½“å®ç°å¤§å®¶å¯ä»¥å‚ç…§ä¸Šä¸€èŠ‚å½“ä¸­çš„ç›¸å…³å®ç°é€»è¾‘ï¼›æ¥ç€å¾€ä¸‹çœ‹vfio_msi_set_bock</p>
<div class="highlight"><pre><span></span><code><span class="p">.........</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">start</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nf">count</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="err">!</span><span class="n">ret</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="nc">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fds</span><span class="w"> </span><span class="vm">?</span><span class="w"> </span><span class="n">fds</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vfio_msi_set_vector_signal</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">msix</span><span class="p">);</span>
<span class="w">        </span><span class="err">}</span>

<span class="p">.........</span>
</code></pre></div>

<p>å…³é”®å‡½æ•°ä¸º<code>vfio_msi_set_vector_signal</code> ï¼Œå…¶æ ¸å¿ƒå®ç°å°±æ˜¯é€šè¿‡request_irq ä¸ºè¯¥ç›´é€šè®¾å¤‡æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°vfio_msihandleråŒæ—¶register irq bypass producerã€‚è€Œvfio_msihandlerå°±æ˜¯é€šè¿‡ä¹‹å‰æ³¨å†Œçš„irqfd å°†ç›¸åº”çš„ä¸­æ–­deliveryåˆ°vmé‡Œé¢ã€‚</p>
<h3>æ€»ç»“å’Œæ€è€ƒ</h3>
<p>interrupt remappingçš„åŠŸèƒ½æœ€åˆæ˜¯ä¸ºäº†è§£å†³è™šæ‹ŸåŒ–ä¸­æ–­deliveryçš„é—®é¢˜è€Œæå‡ºçš„ï¼Œä½†æ˜¯ä»æˆ‘ä»¬çš„æ•´ç¯‡æ–‡ç« çš„åˆ†ææ¥çœ‹å®Œå…¨å¯ä»¥ä¸éœ€è¦è¿™ä¸ªremappingçš„åŠŸèƒ½ã€‚ä¸ºä»€ä¹ˆè¿™æ ·è¯´å‘¢ï¼Ÿå› ä¸ºé€šè¿‡åˆ†ææˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç›´é€šè®¾å¤‡ä¸­æ–­æ³¨å…¥è¿‡ç¨‹æ˜¯ç¡¬ä»¶ä¸­æ–­å…ˆæ‰“åˆ°hostï¼Œç„¶åwakeup ç›¸åº”çš„msi_handlerï¼›æ¥ç€msi_handleré€šè¿‡kvmé‡Œé¢æ³¨å†Œçš„irqfd è§¦å‘kvm_set_msiå°†ç›¸åº”çš„vectoræ³¨åˆ°vmé‡Œé¢ã€‚ä½†æ˜¯intelä»€ä¹ˆè¿˜è¦æè¿™ä¸ªå‘¢ï¼Ÿè¿™ä¸ªå°±ä¸å¾—ä¸è¯´ç›´é€šè®¾å¤‡çš„å¦å¤–ä¸€ç§ä¸­æ–­æ³¨å…¥æ–¹å¼post interruptï¼Œåé¢æˆ‘ä»¬å†æ¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹ã€‚</p>

                <!-- å›¾ç‰‡ç”»å»Š -->
            </main>

        <!-- æ–‡ç« åº•éƒ¨åŒºåŸŸ -->
        <footer class="article-footer">
            <!-- æ ‡ç­¾åŒºåŸŸ -->
            <div class="article-tags-section">
                <h4>ğŸ·ï¸ ç›¸å…³æ ‡ç­¾</h4>
                <div class="tags-cloud">
                    <span class="tag-cloud-item">iommu</span>
                    <span class="tag-cloud-item">interrut remapping</span>
                </div>
            </div>

            <!-- åˆ†äº«å’Œäº’åŠ¨ -->
            <div class="article-interaction">
                <div class="social-share">
                    <h4>ğŸ”— åˆ†äº«è¿™ç¯‡æ–‡ç« </h4>
                    <div class="share-buttons">
                        <a href="#" class="share-btn twitter" target="_blank">ğ• Twitter</a>
                        <a href="#" class="share-btn weibo" target="_blank">ğŸ“ å¾®åš</a>
                        <a href="#" class="share-btn linkedin" target="_blank">ğŸ’¼ LinkedIn</a>
                    </div>
                </div>
            </div>

            <!-- ä½œè€…ç­¾åæ¡£ -->
            <div class="author-signature">
                <div class="signature-content">
                    <h4>å…³äºä½œè€…</h4>
                    <p><strong>å‘¨å®œæ³¢</strong>ï¼Œå­—èŠ‚è·³åŠ¨ç«å±±å¼•æ“AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆï¼Œä¸“æ³¨AI Agentã€GPUæ± åŒ–ã€LLMæ¨ç†ä¼˜åŒ–ç­‰å‰æ²¿æŠ€æœ¯ã€‚</p>
                    <div class="author-social">
                        <a href="https://twitter.com/zhyblife99" target="_blank">ğ• Twitter</a>
                        <span class="wechat-hint">ğŸ’¬ å…³æ³¨å¾®ä¿¡å…¬ä¼—å·è·å–æ›´å¤šå†…å®¹</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <aside class="article-sidebar">
        <!-- æ–‡ç« ä¿¡æ¯å¡ç‰‡ -->
        <div class="sidebar-card article-info-card">
            <h3>ğŸ“Š æ–‡ç« ä¿¡æ¯</h3>
            <div class="info-list">
                <div class="info-item">
                    <span class="info-label">å‘å¸ƒæ—¶é—´</span>
                    <span class="info-value">å…­ 05 ä¸‰æœˆ 2022</span>
                </div>
                <div class="info-item">
                    <span class="info-label">åˆ†ç±»</span>
                    <span class="info-value">articles</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¢„è®¡é˜…è¯»</span>
                    <span class="info-value">~10 åˆ†é’Ÿ</span>
                </div>
            </div>
        </div>

        <!-- ç›¸å…³æ–‡ç« æ¨è -->
        <div class="sidebar-card related-articles-card">
            <h3>ğŸ“š ç›¸å…³æ–‡ç« </h3>
            <div class="related-list">
            </div>
        </div>

        <!-- æŠ€æœ¯æ ˆå±•ç¤º -->
        <div class="sidebar-card skills-card">
            <h3>ğŸš€ æŠ€æœ¯æ ˆ</h3>
            <div class="skills-list">
                <span class="skill-item">AI Agent</span>
                <span class="skill-item">GPUæ± åŒ–</span>
                <span class="skill-item">LLMæ¨ç†ä¼˜åŒ–</span>
                <span class="skill-item">é«˜æ€§èƒ½è™šæ‹ŸåŒ–</span>
            </div>
        </div>

        <!-- å…³æ³¨å…¬ä¼—å· -->
        <div class="sidebar-card wechat-card">
            <h3>ğŸ”” è®¢é˜…æ›´æ–°</h3>
            <div class="wechat-content">
                <p>æ‰«ç å…³æ³¨å¾®ä¿¡å…¬ä¼—å·</p>
                <img src="./images/qrcode.jpg" alt="å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç " class="sidebar-qrcode">
                <p class="wechat-name">KernelNote</p>
            </div>
        </div>
    </aside>
</div>

<!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
<button class="back-to-top" id="backToTop">
    <span>â†‘</span>
</button>

<script>
// è¿”å›é¡¶éƒ¨åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const backToTop = document.getElementById('backToTop');

    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTop.style.display = 'block';
        } else {
            backToTop.style.display = 'none';
        }
    });

    // ç‚¹å‡»è¿”å›é¡¶éƒ¨
    backToTop.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // ç›®å½•é«˜äº®
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = document.querySelectorAll('.article-content h2, .article-content h3, .article-content h4');

    function updateTocHighlight() {
        let current = '';
        headings.forEach((heading, index) => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100) {
                current = heading.id;
            }
        });

        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#' + current) {
                link.classList.add('active');
            }
        });
    }

    if (tocLinks.length > 0) {
        window.addEventListener('scroll', updateTocHighlight);
        updateTocHighlight();
    }

    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®å½•é¡¹
    tocLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});
</script>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>        <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>
    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>