<!DOCTYPE html>
<html lang="zh_cn">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="duma" />

        <meta name="description" content="åºè¨€ sriovçš„æŠ€æœ¯å¤§å®¶åŸºæœ¬ä¸Šéƒ½èƒ½è€³ç†Ÿèƒ½è¯¦äº†ï¼Œä½†æ˜¯å¤§å¤šä¹Ÿåªåœç•™åœ¨specå±‚é¢æˆ–è€…è¯´çŸ¥é“sriovå¦‚ä½•ä½¿èƒ½ä¸Šã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦æƒ³é€šè¿‡qemuä¾§å¯¹sirovåç«¯ç›¸å…³æ¨¡æ‹Ÿçš„è§£ææ¥è®©å¤§å®¶å¯¹sriovæœ‰ä¸€ä¸ªæ›´åŠ æ·±å…¥çš„ç†è§£ã€‚åç»­çš„è¡Œæ–‡ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢ - osä¾§ sriovç›¸å…³ä½¿èƒ½è§£æ - qemuä¾§å¯¹sriovæ¨¡æ‹Ÿ OSä¾§sriov ä½¿èƒ½ osåœ¨è®¾å¤‡æ‰«æè¿‡ç¨‹ä¸­ä¼šå¯¹è®¾å¤‡çš„ç›¸å…³capabilityè¿›è¡Œä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œï¼Œå…·ä½“å‡½æ•°è§ â€¦
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="pcie, SRIOV, articles, " />
        <title>æ·±å…¥è§£æqemuä¾§SRIOVå®ç°  Â· KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link href="https://kernelnote.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢ - Full Atom Feed" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LRRMJ08SPD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LRRMJ08SPD');
</script>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./pages/about.html">about</a></li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<!-- æ–‡ç« å¤´éƒ¨åŒºåŸŸ -->
<header class="article-header">
    <div class="article-header-container">
        <!-- ä½œè€…ä¿¡æ¯åŒºåŸŸ -->
        <div class="article-author-section">
            <img src="./images/wechat.jpeg" alt="å‘¨æ¯…åš" class="author-avatar">
            <div class="author-info">
                <h3 class="author-name">å‘¨å®œæ³¢</h3>
                <p class="author-title">AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆ | AI Agentä¸“å®¶</p>
            </div>
        </div>

        <!-- æ–‡ç« æ ‡é¢˜å’Œå…ƒä¿¡æ¯ -->
        <div class="article-meta-section">
            <h1 class="article-title">
                æ·±å…¥è§£æqemuä¾§SRIOVå®ç°
            </h1>

            <div class="article-meta-info">
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“…</span>
                    <time datetime="2022-06-26T00:00:00+08:00">æ—¥ 26 å…­æœˆ 2022</time>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“</span>
                    <span class="category-tag">articles</span>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ·ï¸</span>
                    <span class="article-tag">pcie</span>
                    <span class="article-tag">SRIOV</span>
                </div>
            </div>

            <!-- å¤šåª’ä½“é“¾æ¥åŒºåŸŸ -->
        </div>
    </div>
</header>

<!-- æ–‡ç« ä¸»ä½“å†…å®¹ -->
<div class="article-container">
    <div class="article-main">
        <!-- æ–‡ç« å†…å®¹ -->
            <main class="article-content article-content-no-toc">
                
                <h4>åºè¨€</h4>
<p>sriovçš„æŠ€æœ¯å¤§å®¶åŸºæœ¬ä¸Šéƒ½èƒ½è€³ç†Ÿèƒ½è¯¦äº†ï¼Œä½†æ˜¯å¤§å¤šä¹Ÿåªåœç•™åœ¨specå±‚é¢æˆ–è€…è¯´çŸ¥é“sriovå¦‚ä½•ä½¿èƒ½ä¸Šã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦æƒ³é€šè¿‡qemuä¾§å¯¹sirovåç«¯ç›¸å…³æ¨¡æ‹Ÿçš„è§£ææ¥è®©å¤§å®¶å¯¹sriovæœ‰ä¸€ä¸ªæ›´åŠ æ·±å…¥çš„ç†è§£ã€‚åç»­çš„è¡Œæ–‡ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢
- osä¾§ sriovç›¸å…³ä½¿èƒ½è§£æ
- qemuä¾§å¯¹sriovæ¨¡æ‹Ÿ</p>
<h4>OSä¾§sriov ä½¿èƒ½</h4>
<p>osåœ¨è®¾å¤‡æ‰«æè¿‡ç¨‹ä¸­ä¼šå¯¹è®¾å¤‡çš„ç›¸å…³capabilityè¿›è¡Œä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œï¼Œå…·ä½“å‡½æ•°è§<code>pci_init_capabilities</code>ã€‚å…¶ä¸­ä¼šè°ƒç”¨<code>pci_iov_init</code> å¯¹è®¾å¤‡sriov featureåšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code>int pci_iov_init(struct pci_dev *dev)
{
        int pos;

        if (!pci_is_pcie(dev))
                return -ENODEV;

        pos = pci_find_ext_capability(dev, PCI_EXT_CAP_ID_SRIOV);
        if (pos)
                return sriov_init(dev, pos);

        return -ENODEV;
}
</code></pre></div>

<p>é¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªpcieè®¾å¤‡ï¼Œå¦‚æœæ˜¯pcieè®¾å¤‡åˆ™æ¥ç€çœ‹è¯¥pcieè®¾å¤‡æ˜¯å¦æœ‰sriovåŠŸèƒ½(æ˜¯å¦æœ‰è¿™ä¸ªåŠŸèƒ½ä¸»è¦æ˜¯é€šè¿‡å…¶extend capæ˜¯å¦æœ‰SRIOV CAP ID æ¥ç¡®å®šçš„)ã€‚å¦‚æœæœ‰sriovåŠŸèƒ½åˆ™å¯¹å…¶è¿›è¡Œç›¸å…³çš„åˆå§‹åŒ–å·¥ä½œï¼Œå…·ä½“çš„å®ç°åœ¨<code>sriov_init</code> å½“ä¸­ã€‚ä¸ºäº†è®©å¤§å®¶æ›´å¥½çš„ç†è§£è¿™ä¸ªå‡½æ•°å½“ä¸­çš„ç›¸å…³é€»è¾‘ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹SRIOV extended capçš„ç»“æ„</p>
<p><img alt="2D0FE178-63E5-4547-9869-6C19586B95F1" src="images/2D0FE178-63E5-4547-9869-6C19586B95F1.png"></p>
<p>çœ‹å®Œä¹‹åï¼Œæˆ‘ä»¬æ¥ç»†åˆ†ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å®ç°
- è¯»å–sriov controlçš„å€¼ï¼Œå¦‚æœè¯»å–çš„å€¼æ˜¾ç¤ºè¯¥è®¾å¤‡çš„sriovå·²ç»ä½¿èƒ½åˆ™disable itï¼Œå®ç°æ–¹å¼ä¸ºå¾€<code>PCI_SRIOV_CTRL</code> å†™0
- ç„¶åé€šè¿‡<code>pci_ari_enabled(dev-&gt;bus)</code> åˆ¤æ–­è®¾å¤‡æ‰€æŒ‚åœ¨çš„busæ˜¯å¦enable äº†ari featureï¼Œå¦‚æœenableäº†åˆ™éœ€è¦å°†sriov controlçš„ARIä½äº†è¦ç½®ä¸Šã€‚<strong>å°†è¿™é‡Œè¦é‡ç‚¹è®²ä¸€ä¸‹ariï¼Œå®ƒçš„å…¨ç§°ä¸ºAlternative Routing-ID Interpretationï¼Œé‚£ä¹ˆä¸­æ–‡ä¹Ÿå¯è¯‘ä¸ºå¯æ›¿ä»£çš„route idå³å¯ä»¥æŠŠä¼ ç»Ÿçš„routing id æœºåˆ¶æ›¿æ¢æ‰ã€‚å…ˆæ¥è¯´ä¸€ä¸‹route idï¼Œåœ¨pcie é“¾è·¯ä¸Šï¼ŒtlpåŒ…å¸¸ç”¨çš„è·¯ç”±æ–¹å¼æœ‰ä¸¤ç§ã€‚ä¸€ç§æ˜¯åŸºäºbusã€deviceã€functionç»„åœ¨çš„ä¸€ä¸ª16 bitçš„idä¹Ÿå³routing idï¼Œè¿˜æœ‰ä¸€ç§å°±æ˜¯åŸºäºmmioæˆ–è€…pioåœ°å€è¿›è¡Œè·¯ç”±çš„æ–¹å¼ã€‚å†å›åˆ°ARIä¸Šï¼Œä¹‹æ‰€ä»¥å¼•å…¥è¿™ç§æœºåˆ¶åŸå› åœ¨äºä¼ ç»Ÿçš„routing idå½“ä¸­functionåªæœ‰3bitæœ€å¤šæ”¯æŒ8ä¸ªvfï¼Œå¾ˆæ˜æ˜¾æ˜¯æ— æ³•æ»¡è¶³å®é™…çš„åº”ç”¨åœºæ™¯çš„ï¼Œå› æ­¤ARIå°†device number(5 bits) åˆå¹¶åˆ°äº†Function numberå½“ä¸­ï¼Œè¿™æ ·routing idå°±å˜æˆäº†8-bit Bus Number + 8-bit Function Numberçš„æ ¼å¼ï¼Œæœ€å¤šæ”¯æŒçš„Busæ•°é‡ä¸å˜ï¼Œæ”¯æŒçš„Functionæ•°é‡å¢å¤§åˆ°256ä¸ª</strong>ã€‚æ³¨æ„ï¼Œé™¤äº†pfè®¾å¤‡æœ¬èº«éœ€è¦enable ARIä¹‹å¤–ï¼Œå…¶æ‰€åœ¨çš„root portæˆ–è€…pcie switch éƒ½éœ€è¦enable ARIã€‚
- ç´§æ¥ç€åˆ†åˆ«åœ¨ sriov extend capçš„<code>PCI_SRIOV_TOTAL_VF</code> ã€<code>PCI_SRIOV_SUP_PGSIZE</code>ç­‰ä½ç½®è¯»å–vfçš„æ€»æ•°é‡ä»¥åŠè®¾å¤‡æ‰€èƒ½æ”¯æŒçš„ç”¨æ¥æ˜ å°„barç©ºé—´çš„page å¤§å°ã€‚è¿™é‡Œè®²ä¸€ä¸‹<code>PCI_SRIOV_SUP_PGSIZE</code> å·¥ä½œåŸç†ï¼Œå®ƒæ€»å…±æœ‰32bitsï¼Œå‡è®¾å®ƒçš„ç¬¬nä½ç½®ä¸Šåˆ™è¡¨ç¤ºå…¶æ”¯æŒçš„é¡µå¤§å°ä¸º2çš„n+12æ¬¡æ–¹ã€‚ç›®å‰æ”¯æŒçš„é¡µå¤§å°æœ‰4kã€8kã€64kã€256kã€1Mã€4Mï¼Œå› æ­¤ä¸€èˆ¬æƒ…å†µä¸‹<code>PCI_SRIOV_SUP_PGSIZE</code> ä½ç½®å¤„å†™å…¥çš„å€¼ä¸º0x553ã€‚
- è·å–ç³»ç»Ÿæ”¯æŒçš„é¡µçš„å¤§å°ï¼Œå¹¶å°†å…¶å†™åˆ°sriov extend capbilityçš„<code>PCI_SRIOV_SYS_PGSIZE</code> å¤„ã€‚
- æ ¹æ®VF bar sizeæ¥è®¡ç®—è¯¥PFæ‰€éœ€è¦total resource(mmio å¤§å°)ï¼Œå…¶è®¡ç®—å…¬å¼ä¸ºVF_bar_size * total_vfå¹¶å°†å…¶å­˜å‚¨åœ¨<code>dev-&gt;resource[PCI_IOV_RESOURCES ~ PCI_IOV_RESOURCE_END]</code> å½“ä¸­ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PCI_SRIOV_NUM_BARS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">[</span><span class="n">i + PCI_IOV_RESOURCES</span><span class="o">]</span><span class="p">;</span>
<span class="w">                </span><span class="cm">/*</span>
<span class="cm">                 * If it is already FIXED, don&#39;t change it, something</span>
<span class="cm">                 * (perhaps EA or header fixups) wants it this way.</span>
<span class="cm">                 */</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">IORESOURCE_PCI_FIXED</span><span class="p">)</span>
<span class="w">                        </span><span class="n">bar64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">IORESOURCE_MEM_64</span><span class="p">)</span><span class="w"> </span><span class="vm">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                        </span><span class="o">//</span><span class="n">è·å–VF</span><span class="w"> </span><span class="n">bar0</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">bar5</span><span class="w"> </span><span class="k">size</span>
<span class="w">                        </span><span class="n">bar64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__pci_read_base</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">pci_bar_unknown</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span>
<span class="w">                                                </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PCI_SRIOV_BAR</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
<span class="w">                        </span><span class="k">continue</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">                        </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="nl">failed</span><span class="p">;</span>
<span class="w">                </span><span class="err">}</span>
<span class="w">                </span><span class="n">iov</span><span class="o">-&gt;</span><span class="n">barsz</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="n">æ›´æ–°</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="k">range</span>
<span class="w">                </span><span class="n">res</span><span class="o">-&gt;</span><span class="k">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="o">-&gt;</span><span class="k">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="n">pci_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;VF(n) BAR%d space: %pR (contains BAR%d for %d VFs)\n&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="p">);</span>
<span class="w">                </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">bar64</span><span class="p">;</span>
<span class="w">                </span><span class="n">nres</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="err">}</span>
</code></pre></div>

<p>é‚£ä¹ˆpfçš„æ¯ä¸ªvf  bar çš„mmio ç©ºé—´éƒ½æ˜¯ä»ç›¸åº”çš„ <code>PCI_IOV_RESOURCE</code> ~ <code>PCI_IOV_RESOURCE_END</code> resouceé‡Œé¢æ¥åˆ†é…ï¼Œå…·ä½“çš„vf mmio è®¡ç®—å…¬å¼å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code>&lt;VF BAR start&gt; + &lt;VF number&gt; * &lt;BAR sz&gt; + &lt;offset&gt;
</code></pre></div>

<ul>
<li>ä»<code>PCI_SRIOV_VF_DID</code> å¤„è¯»å–vf device_idï¼Œç„¶åé€šè¿‡<code>compute_max_vf_buses</code> æ¥è®¡ç®—vfæ‰€éœ€è¦ä½¿ç”¨çš„bus numï¼Œç„¶ååœ¨<code>pcibios_assign_all_buses</code> é‡Œé¢éœ€è¦å°†è¿™äº›bus num reserveå‡ºæ¥ã€‚å…·ä½“çš„è®¡ç®—é€»è¾‘å¤§å®¶å¯ä»¥çœ‹ä¸€ä¸‹ç›¸å…³å‡½æ•°å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œæˆ‘å°±ä¸è¯¦è¿°äº†ã€‚</li>
</ul>
<p>ä¸Šé¢åˆ†æå®Œäº†pcieè®¾å¤‡sriovçš„ç›¸å…³åˆå§‹åŒ–ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•å°†ä¸€ä¸ªPFçš„VFåˆ†é…å‡ºæ¥ã€‚é€šå¸¸æˆ‘ä»¬éœ€è¦åœ¨osä¾§æ‰‹åŠ¨è§¦å‘å¦‚ä¸‹çš„åŠ¨ä½œ</p>
<div class="highlight"><pre><span></span><code>echon $num &gt; /sys/bus/pci/devices/$bdf/sriov_numvfs
</code></pre></div>

<p>è€Œä¸Šé¢è¿™ä¸ªåŠ¨ä½œæœ€ç»ˆtriggeræ‰§è¡Œçš„å‡½æ•°ä¸º<code>sriov_numvfs_store</code> ï¼Œè¿™ä¸ªå‡½æ•°æœ€ç»ˆè¦æ‰§è¡Œçš„å‡½æ•°ä¸º</p>
<div class="highlight"><pre><span></span><code><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">sriov_configure</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="w"> </span><span class="n">num_vfs</span><span class="p">);</span>
</code></pre></div>

<p>ä¹Ÿå³è¿™ä¸ªPF æ‰€å±driverå½“ä¸­æ³¨å†Œçš„sriov_configureå‡½æ•°ã€‚ä¸€èˆ¬æ”¯æŒsriovçš„è®¾å¤‡driverå½“ä¸­éƒ½ä¼šæ³¨å†Œç›¸åº”çš„sriov_configure callbackå‡½æ•°ï¼Œæ¯”å¦‚<code>virtio_pci_sriov_configure</code>ï¼Œä¸‹é¢æˆ‘ä»¬å°±ä»¥å®ƒä¸ºä¾‹æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªcallbackå‡½æ•°ã€‚
- å…ˆåˆ¤æ–­è¿™ä¸ªdevçš„statusæ˜¯ä¸æ˜¯okçš„å³<code>VIRTIO_CONFIG_S_DRIVER_OK</code>
- å…ˆå†ç¡®è®¤ä¸€ä¸‹æ˜¯å¦æ”¯æŒsriovå³<code>VIRTIO_F_SR_IOV</code> ä½æ˜¯å¦ç½®ä¸Šã€‚
- <code>pci_vfs_assigned</code> åˆ¤æ–­vfæ˜¯å¦å·²ç»assigned ç»™äº†guestã€‚
- å¦‚æœè¦enableçš„num_vfsä¸ä¸º0åˆ™è°ƒç”¨<code>pci_enable_sriov</code> æ¥è¿›è¡Œvfçš„ä½¿èƒ½ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°<code>sriov_enable</code> å‡½æ•°ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªæ ¸å¿ƒå‡½æ•°çš„å…·ä½“å®ç°é€»è¾‘ï¼š
- åœ¨ <code>PCI_SRIOV_INITIAL_VF</code> å¤„è¯»å–initial vf æ•°é‡(ä¸€èˆ¬è¿™ä¸ªå€¼æ˜¯ç­‰total vfçš„)ï¼Œå¦‚æœè¿™ä¸ªå€¼è·Ÿtotal vfsä¸å¯¹ç­‰åˆ™è¿”å›é”™è¯¯
- æ¥ä¸‹æ¥åˆ¤æ–­ç”¨æˆ·è¦enableçš„vfæ•°é‡æ˜¯å¦å¤§äºtotal vfsï¼Œåˆ¤æ–­è®¾å¤‡çš„<code>PCI_IOV_RESOURCES</code> çš„æ•°é‡æ˜¯å¦æ­£ç¡®ï¼Œåˆ¤æ–­vf bus æœ€å¤§å€¼æ˜¯å¦è¶…è¿‡å…¶æ‰€å±busçš„bus_res.endä¹Ÿå³æœ€å¤§å€¼ä¸€èˆ¬ä¸º<code>0xff</code>ã€‚
- å¦‚æœä¸Šé¢çš„æ£€æŸ¥éƒ½é€šè¿‡äº†åˆ™å¼€å§‹enable resourceå³å¾€pci_commandå¤„å†™<code>PCI_COMMAND_IO</code> æˆ–è€…<code>PCI_COMMAND_MEMORY</code> å‘Šè¯‰pciè®¾å¤‡éœ€è¦å¼€å§‹å“åº”åé¢çš„ç›¸å…³IOæ“ä½œã€‚
- æ¥ç€é€šè¿‡å°†<strong>sriov control çš„<code>PCI_SRIOV_CTRL_VFE</code> å’Œ <code>PCI_SRIOV_CTRL_MSE</code> ç½®ä¸Šé€šçŸ¥åç«¯ä½¿èƒ½vfç›¸å…³çš„æ•°æ®é¢</strong>ã€‚
- æœ€åé€šè¿‡ä¸€ä¸ªloopæ¥å¯¹æ·»åŠ virtfnï¼Œå…·ä½“å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code>        for (i = 0; i &lt; initial; i++) {
                rc = pci_iov_add_virtfn(dev, i);
                if (rc)
                        goto failed;
        }
</code></pre></div>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸€ä¸‹ <code>pci_iov_add_virtfn</code> çš„å…·ä½“å®ç°ï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°æˆ‘æ¥çœ‹ä¸€ä¸‹vfæœ€ç»ˆçš„probeæµç¨‹ã€‚</p>
<ul>
<li><code>virtfn_add_bus</code>  è®¡ç®—VFçš„bus numï¼Œä»¥PF çš„busä¸ºparentå¯»æ‰¾VFçš„busï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™éœ€è¦é‡æ–°åˆ›å»ºä¸€ä¸ªã€‚VFçš„bus numè®¡ç®—å…¬å¼å¦‚ä¸‹</li>
</ul>
<div class="highlight"><pre><span></span><code>PF-&gt;bus-&gt;number + ((PF-&gt;devfn + PF-&gt;sriov-&gt;offset +
                                    PF-&gt;sriov-&gt;stride * vf_id) &gt;&gt; 8);
</code></pre></div>

<p>æ­£å¸¸æƒ…å†µä¸‹ VFå’ŒPFåº”è¯¥æ˜¯åœ¨åŒä¸€ä¸ªbusä¸Šã€‚</p>
<ul>
<li><code>pci_alloc_dev</code> ä¸ºVFåˆ›å»º <code>pci_dev</code> ç»“æ„ï¼ŒåŒæ—¶è®¡ç®—VFçš„devfnã€‚å…·ä½“çš„è®¡ç®—å…¬å¼å¦‚ä¸‹</li>
</ul>
<div class="highlight"><pre><span></span><code>(PF-&gt;devfn + PF-&gt;sriov-&gt;offset +
                PF-&gt;sriov-&gt;stride * vf_id) &amp; 0xff
</code></pre></div>

<ul>
<li><code>pci_setup_device</code> åˆå§‹åŒ–è®¾å¤‡ç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”å¦‚barå¤§å°ç­‰ã€‚ç´§æ¥ç€ä¸ºvfåˆ†é… bar mmioç©ºé—´ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PCI_SRIOV_NUM_BARS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">[</span><span class="n">i + PCI_IOV_RESOURCES</span><span class="o">]</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
<span class="w">                        </span><span class="k">continue</span><span class="p">;</span>
<span class="w">                </span><span class="n">virtfn</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pci_name</span><span class="p">(</span><span class="n">virtfn</span><span class="p">);</span>
<span class="w">                </span><span class="n">virtfn</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
<span class="w">                </span><span class="o">//</span><span class="k">get</span><span class="w"> </span><span class="n">VF</span><span class="w"> </span><span class="n">barçš„å¤§å°</span>
<span class="w">                </span><span class="k">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pci_iov_resource_size</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PCI_IOV_RESOURCES</span><span class="p">);</span>
<span class="w">                </span><span class="o">//</span><span class="n">é€šè¿‡VF</span><span class="w"> </span><span class="n">idæ¥è®¡ç®—ç›¸å…³çš„res</span><span class="w"> </span><span class="n">offset</span>
<span class="w">                </span><span class="n">virtfn</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="o">-&gt;</span><span class="k">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">                </span><span class="n">virtfn</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="k">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">virtfn</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request_resource</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">virtfn</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">                </span><span class="n">BUG_ON</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="w">        </span><span class="err">}</span>
</code></pre></div>

<p>ä»ä¸Šé¢çš„é€»è¾‘å¯ä»¥çœ‹å‡ºï¼Œä¸€ä¸ªVFçš„æ‰€æœ‰çš„bar mmio resourceéƒ½æ˜¯ä»è¿™ä¸ªPFçš„<code>PCI_IOV_RESOURCE</code> é‡Œé¢åˆ†é…çš„ã€‚</p>
<ul>
<li>æ¥ç€å°±æ˜¯å°†vfè·Ÿbusç»‘å®šï¼Œç„¶åå¯ä»¥probeå¯¹åº”çš„é©±åŠ¨äº†ã€‚å…·ä½“é€»è¾‘å¯ä»¥è§<code>pci_device_add</code> å’Œ<code>pci_bus_add_device</code> è¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚</li>
</ul>
<h4>qemuä¾§æ¨¡æ‹Ÿ</h4>
<p>qemu æœ€æ–°ä¸»å¹²ä¸Šå·²ç»åˆå…¥äº†sriovçš„ç›¸å…³æ¨¡æ‹Ÿï¼Œpatchæ¥è‡ªoracleçš„ä¸€ä½å…„å¼Ÿï¼Œè¯´å®è¯è¿™ä¸ªpatché¡¶å¤šä¹Ÿå°±èƒ½ç©ç©ï¼Œç¼ºçš„ä¸œè¥¿è¿˜æ¯”è¾ƒå¤šã€‚è¿™é‡Œæˆ‘ä»¬å°±ç»“åˆè¿™ä¸ªpatchå°†å°±ç€çœ‹ä¸€ä¸‹å§ï¼Œä»å¤§çš„æ–¹é¢è¿™ä¸ªpatchçš„åŠŸèƒ½åˆ†ä¸ºä¸¤ä¸ªæ–¹é¢ï¼šä¸€æ–¹é¢æ˜¯PFè®¾å¤‡sriov capå’Œvf barçš„åˆå§‹åŒ–ï¼Œå¦ä¸€æ–¹é¢æ˜¯vfä½¿èƒ½è¿‡ç¨‹ä¸­åç«¯ç›¸å¯¹åº”çš„å¤„ç†æ¯”å¦‚vf è®¾å¤‡çš„æ‹‰èµ·ç­‰ã€‚ä»£ç åœ¨<code>hw/pci/pcie_sriov.c</code> æ–‡ä»¶å½“ä¸­ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹pf sriov ç›¸å…³çš„åˆå§‹å·¥ä½œï¼Œæ¶‰åŠåˆ°çš„å‡½æ•°ä¸»è¦æœ‰<code>pcie_sriov_pf_init</code> å’Œ <code>pcie_sriov_pf_init_vf_bar</code>ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹pf_initè¿™ä¸ªå‡½æ•°å…·ä½“éƒ½åšäº†å“ªäº›å·¥ä½œ</p>
<ul>
<li>
<p>é€šè¿‡ <code>pcie_add_capability</code> ä¸ºPFæ·»åŠ  <code>PCI_EXT_CAP_ID_SRIOV</code> ï¼Œè¡¨æ˜è¯¥è®¾å¤‡æ”¯æŒsriovåŠŸèƒ½ã€‚</p>
</li>
<li>
<p>åˆå§‹åŒ– <code>PCI_SRIOV_VF_OFFSET</code>ã€<code>PCI_SRIOV_VF_STRIDE</code> ã€<code>PCI_SRIOV_SUP_PGSIZE</code> ã€<code>PCI_SRIOV_SYS_PGSIZE</code> ç­‰</p>
</li>
<li>
<p>åˆå§‹åŒ– <code>PCI_SRIOV_VF_DID</code> ã€<code>PCI_SRIOV_INITIAL_VF</code>ã€<code>PCI_SRIOV_TOTAL_VF</code>ã€<code>PCI_SRIOV_NUM_VF</code>ï¼Œå¹¶å°†sriov controlè®¾ç½®ä¸º<code>PCI_SRIOV_CTRL_VFE | PCI_SRIOV_CTRL_MSE | PCI_SRIOV_CTRL_ARI</code> ã€‚</p>
</li>
</ul>
<p>ä»ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡ºè¯¥å‡½æ•°æ‰€å®ç°çš„åŸºæœ¬ä¸Šéƒ½æ˜¯osä¾§sriov initæ—¶éœ€è¦åšåˆ°çš„ä¸€äº›é‡è¦ä¿¡æ¯ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹vf barçš„ç›¸å…³åˆå§‹åŒ–ï¼Œå®ç°åœ¨<code>pcie_sriov_pf_init_vf_bar</code> å‡½æ•°ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">void</span><span class="w"> </span><span class="n">pcie_sriov_pf_init_vf_bar</span><span class="p">(</span><span class="n">PCIDevice</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">region_num</span><span class="p">,</span>
<span class="w">                               </span><span class="n">uint8_t</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">dma_addr_t</span><span class="w"> </span><span class="k">size</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">    </span><span class="n">uint32_t</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">wmask</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint16_t</span><span class="w"> </span><span class="n">sriov_cap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="nf">exp</span><span class="p">.</span><span class="n">sriov_cap</span><span class="p">;</span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">sriov_cap</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">region_num</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">region_num</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PCI_NUM_REGIONS</span><span class="p">);</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">region_num</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PCI_ROM_SLOT</span><span class="p">);</span>

<span class="w">    </span><span class="n">wmask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="k">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">region_num</span><span class="w"> </span><span class="n">å°±æ˜¯bar</span><span class="w"> </span><span class="n">id</span><span class="err">ï¼Œ</span><span class="n">è·å–å…·ä½“çš„bar</span><span class="w"> </span><span class="n">åœ°å€</span>
<span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sriov_cap</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PCI_SRIOV_BAR</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">region_num</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>

<span class="w">    </span><span class="n">pci_set_long</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>
<span class="w">    </span><span class="o">//</span><span class="n">åœ¨wmaské‡Œé¢è®¾ç½®bar</span><span class="err">ï¼Œ</span><span class="n">åç»­osä¾§è®¡ç®—barå¤§å°æ—¶å€™ä¼šç”¨åˆ°</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PCI_BASE_ADDRESS_SPACE_IO</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">pci_set_quad</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wmask</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">wmask</span><span class="p">);</span>
<span class="w">        </span><span class="n">pci_set_quad</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmask</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="mi">0</span><span class="n">ULL</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">pci_set_long</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wmask</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">wmask</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">);</span>
<span class="w">        </span><span class="n">pci_set_long</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmask</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="n">dev</span><span class="o">-&gt;</span><span class="nf">exp</span><span class="p">.</span><span class="n">sriov_pf</span><span class="p">.</span><span class="n">vf_bar_type</span><span class="o">[</span><span class="n">region_num</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div>

<p>ä¸Šé¢çš„é€»è¾‘å®ç°äº†vf barçš„åˆå§‹åŒ–ï¼Œä½†æ˜¯æœ‰äº›åœ°æ–¹è¿˜éœ€è¦å®Œå–„ä¸€ä¸‹ã€‚å¦‚ä¸Šé¢åˆ†æï¼Œä¸€ä¸ªPFçš„æ‰€æœ‰çš„VF bar resource(æ¯”å¦‚bar0) æ˜¯åœ¨ç”±PFç»´æŠ¤çš„ä¸€ä¸ªå¤§çš„resource ç©ºé—´(å…¶å¤§å°vf_bar_size * total)å†…æ¥åˆ†é…çš„ã€‚å› æ­¤è¿™ä¸ªå‡½æ•°å¯ä»¥è¿™æ ·ä¼˜åŒ–ä¸€ä¸‹(åªåˆ—å‡ºéœ€è¦å¢åŠ çš„ä»£ç )</p>
<div class="highlight"><pre><span></span><code><span class="o">//</span><span class="n">åœ¨sriov_pfå½“ä¸­å®šä¹‰ä¸€ä¸ªvf_ioregions</span>
<span class="n">PCIIORegion</span><span class="w"> </span><span class="n">vf_ioregions</span><span class="o">[</span><span class="n">PCI_SRIOV_NUM_BARS</span><span class="o">]</span><span class="err">ï¼›</span>

<span class="o">//</span><span class="n">åœ¨pf_init_vf_barå‡½æ•°å½“ä¸­å¢åŠ ä»¥ä¸‹é€»è¾‘</span>
<span class="n">PCIIORegion</span><span class="w"> </span><span class="o">*</span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="nf">exp</span><span class="p">.</span><span class="n">sriov_pf</span><span class="p">.</span><span class="n">vf_regions</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">region_num</span><span class="p">;</span>
<span class="p">......</span>
<span class="n">r</span><span class="o">-&gt;</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PCI_BAR_UNMAPPED</span><span class="p">;</span>
<span class="n">r</span><span class="o">-&gt;</span><span class="k">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="nf">exp</span><span class="p">.</span><span class="n">sriov_pf</span><span class="p">.</span><span class="n">total_vfs</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">size</span><span class="p">;</span>
<span class="n">r</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="n">r</span><span class="o">-&gt;</span><span class="n">address_space</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pci_get_bus</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">address_space_mem</span><span class="p">;</span>
<span class="nc">char</span><span class="w"> </span><span class="n">vf_bar_name</span><span class="o">[</span><span class="n">8</span><span class="o">]</span><span class="p">;</span>
<span class="n">r</span><span class="o">-&gt;</span><span class="n">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_malloc0</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="n">MemoryRegion</span><span class="p">));</span>
<span class="n">g_snprintf</span><span class="p">(</span><span class="n">vf_bar_name</span><span class="p">,</span><span class="w"> </span><span class="n">sizeof</span><span class="p">(</span><span class="n">vf_bar_name</span><span class="p">),</span><span class="w"> </span><span class="ss">&quot;vf_bar%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">region_num</span><span class="p">);</span>
<span class="n">memory_region_init</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">,</span><span class="k">OBJECT</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="w"> </span><span class="n">vf_bar_name</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="o">-&gt;</span><span class="k">size</span><span class="p">);</span>
<span class="o">//</span><span class="w"> </span><span class="n">pf</span><span class="w"> </span><span class="n">åˆå§‹åŒ–çš„æ—¶å€™æ®µmmioç©ºé—´å¯ä»¥å…ˆä¸ä½¿èƒ½</span><span class="err">ï¼Œ</span><span class="n">å› ä¸ºä¸ç¡®å®šç”¨æˆ·æ˜¯å¦ä¼šæ‰“å¼€vfåŠŸèƒ½</span><span class="err">ã€‚</span>
<span class="n">memory_region_set_enabled</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">,</span><span class="w"> </span><span class="k">false</span><span class="p">);</span>
</code></pre></div>

<p>è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ˜¯åœ¨å…·ä½“è®¾å¤‡<code>realize</code> å‡½æ•°å½“ä¸­å»è°ƒç”¨ã€‚ä¸Šé¢æˆ‘ä»¬ä»‹ç»å®Œäº†pf çš„sriov featureçš„åˆå§‹åŒ–ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹sriov vf ä½¿èƒ½è¿‡ç¨‹å½“ä¸­qemuè¿™ä¸€ç«¯çš„ç›¸å…³actionã€‚osä¾§é©±åŠ¨é€šè¿‡å°†sriov control çš„<code>PCI_SRIOV_CTRL_VFE</code> å’Œ <code>PCI_SRIOV_CTRL_MSE</code> ç½®ä¸Šæ¥å‘ŠçŸ¥qemuè¿™ä¸€ä¾§è¦å¼€å§‹æ‹‰èµ·vfï¼Œå…·ä½“å®ç°æ˜¯åœ¨ <code>pcie_sriov_config_write</code> å‡½æ•°</p>
<div class="highlight"><pre><span></span><code><span class="nx">void</span><span class="w"> </span><span class="nx">pcie_sriov_config_write</span><span class="p">(</span><span class="nx">PCIDevice</span><span class="w"> </span><span class="o">*</span><span class="nx">dev</span><span class="p">,</span><span class="w"> </span><span class="nx">uint32_t</span><span class="w"> </span><span class="nx">address</span><span class="p">,</span>
<span class="w">                             </span><span class="nx">uint32_t</span><span class="w"> </span><span class="nx">val</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nx">uint32_t</span><span class="w"> </span><span class="nx">off</span><span class="p">;</span>
<span class="w">    </span><span class="nx">uint16_t</span><span class="w"> </span><span class="nx">sriov_cap</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">dev</span><span class="o">-&gt;</span><span class="nx">exp</span><span class="p">.</span><span class="nx">sriov_cap</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">sriov_cap</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">sriov_cap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">off</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">sriov_cap</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">off</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">PCI_EXT_CAP_SRIOV_SIZEOF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">trace_sriov_config_write</span><span class="p">(</span><span class="nx">dev</span><span class="o">-&gt;</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">PCI_SLOT</span><span class="p">(</span><span class="nx">dev</span><span class="o">-&gt;</span><span class="nx">devfn</span><span class="p">),</span>
<span class="w">                             </span><span class="nx">PCI_FUNC</span><span class="p">(</span><span class="nx">dev</span><span class="o">-&gt;</span><span class="nx">devfn</span><span class="p">),</span><span class="w"> </span><span class="nx">off</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">range_covers_byte</span><span class="p">(</span><span class="nx">off</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="p">,</span><span class="w"> </span><span class="nx">PCI_SRIOV_CTRL</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">dev</span><span class="o">-&gt;</span><span class="nx">exp</span><span class="p">.</span><span class="nx">sriov_pf</span><span class="p">.</span><span class="nx">num_vfs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(!(</span><span class="nx">val</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">PCI_SRIOV_CTRL_VFE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">unregister_vfs</span><span class="p">(</span><span class="nx">dev</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">val</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">PCI_SRIOV_CTRL_VFE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">//åˆ¤æ–­æ˜¯enable vfçš„ control</span>
<span class="w">                </span><span class="nx">register_vfs</span><span class="p">(</span><span class="nx">dev</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>ä¸Šé¢è¿™æ®µä»£ç æœ‰ç‚¹ç¼ºé™·å³å¦‚æœæ˜¯ <code>PCI_SRIOV_CTRL_MSE</code> åˆ™éœ€è¦enable ä¸Šé¢é¢å¤–æ·»åŠ çš„vf_ioregionsï¼Œä¸‹é¢å†™æ®µä¼ªä»£ç </p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PCI_SRIOV_NUM_BARS</span><span class="w"> </span><span class="p">;</span><span class="n">j</span><span class="w"> </span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="n">PCIIORegion</span><span class="w"> </span><span class="o">*</span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pf</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">.</span><span class="n">sriov_pf</span><span class="p">.</span><span class="n">vf_ioregions</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="n">memory_region_set_enabled</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">,</span><span class="w"> </span><span class="n">true</span><span class="p">);</span>
</code></pre></div>

<p>æ¥ç€æ¥çœ‹ <code>register_vfs</code> ï¼Œé¦–å…ˆè·å–vf_offsetã€vf_strideå’Œå‰ç«¯è¦enableçš„num_vfsã€‚å‰ä¸¤ä¸ªä¸»è¦æ˜¯ç”¨æ¥è®¡ç®—vfçš„devfnï¼Œå…·ä½“è®¡ç®—å…¬å¼è§ä¸Šé¢ã€‚ç„¶åé€šè¿‡ä¸€ä¸ªloop è°ƒç”¨<code>register_vf</code> æ¥åˆ†åˆ«å¯¹æ¯ä¸ªvfè¿›è¡Œä½¿èƒ½ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">PCIDevice</span><span class="w"> </span><span class="o">*</span><span class="n">register_vf</span><span class="p">(</span><span class="n">PCIDevice</span><span class="w"> </span><span class="o">*</span><span class="n">pf</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">devfn</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span>
<span class="w">                              </span><span class="n">uint16_t</span><span class="w"> </span><span class="n">vf_num</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PCIDevice</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pci_new</span><span class="p">(</span><span class="n">devfn</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="n">dev</span><span class="o">-&gt;</span><span class="nb">exp</span><span class="o">.</span><span class="n">sriov_vf</span><span class="o">.</span><span class="n">pf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pf</span><span class="p">;</span>
<span class="w">    </span><span class="n">dev</span><span class="o">-&gt;</span><span class="nb">exp</span><span class="o">.</span><span class="n">sriov_vf</span><span class="o">.</span><span class="n">vf_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vf_num</span><span class="p">;</span>
<span class="w">    </span><span class="n">PCIBus</span><span class="w"> </span><span class="o">*</span><span class="n">bus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pci_get_bus</span><span class="p">(</span><span class="n">pf</span><span class="p">);</span>
<span class="w">    </span><span class="n">Error</span><span class="w"> </span><span class="o">*</span><span class="n">local_err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="o">//</span><span class="n">vfè®¾å¤‡åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">qdev_realize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qdev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">qbus</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">local_err</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">local_err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error_report_err</span><span class="p">(</span><span class="n">local_err</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="o">/*</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">vid</span><span class="o">/</span><span class="n">did</span><span class="w"> </span><span class="n">according</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">sr</span><span class="o">/</span><span class="n">iov</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="n">pci_config_set_vendor_id</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">);</span>
<span class="w">    </span><span class="n">pci_config_set_device_id</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>ä¸Šé¢çš„é€»è¾‘æ ¸å¿ƒå°±åœ¨ä½¿ç”¨<code>qdev_realize</code> å¯¹vfè®¾å¤‡è¿›è¡Œåˆå§‹åŒ–ï¼Œå…·ä½“çš„æµç¨‹å¯ä»¥å‚è€ƒä¸€ä¸‹<a href="https://mp.weixin.qq.com/s/10gADhifKyb24bFomXQ8Ug">qemu QOMè§£æ</a>è¿™ç¯‡æ–‡ç« ã€‚åœ¨vfè®¾å¤‡åˆå§‹åŒ–è¿‡ç¨‹ä¸­æœ‰ä¸€ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œå°±æ˜¯é€šå¸¸pfåœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨<code>pci_register_bar</code> ï¼Œè€Œvfåœ¨åˆå§‹åŒ–çš„æ—¶å€™éœ€è¦è°ƒç”¨<code>pcie_sriov_vf_register_bar</code> ï¼Œå…·ä½“çš„å®ç°å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="n">void</span><span class="w"> </span><span class="n">pcie_sriov_vf_register_bar</span><span class="p">(</span><span class="n">PCIDevice</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">region_num</span><span class="p">,</span>
<span class="w">                                </span><span class="n">MemoryRegion</span><span class="w"> </span><span class="o">*</span><span class="n">memory</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">    </span><span class="n">PCIIORegion</span><span class="w"> </span><span class="o">*</span><span class="n">r</span><span class="p">;</span>
<span class="w">    </span><span class="n">PCIBus</span><span class="w"> </span><span class="o">*</span><span class="n">bus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pci_get_bus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="n">uint8_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="w">    </span><span class="n">pcibus_t</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memory_region_size</span><span class="p">(</span><span class="n">memory</span><span class="p">);</span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">pci_is_vf</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span><span class="w"> </span><span class="cm">/* PFs must use pci_register_bar */</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">region_num</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">region_num</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PCI_NUM_REGIONS</span><span class="p">);</span>
<span class="w">    </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="nf">exp</span><span class="p">.</span><span class="n">sriov_vf</span><span class="p">.</span><span class="n">pf</span><span class="o">-&gt;</span><span class="nf">exp</span><span class="p">.</span><span class="n">sriov_pf</span><span class="p">.</span><span class="n">vf_bar_type</span><span class="o">[</span><span class="n">region_num</span><span class="o">]</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="k">size</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">error_report</span><span class="p">(</span><span class="ss">&quot;%s: PCI region size must be a power&quot;</span>
<span class="w">                     </span><span class="ss">&quot; of two - type=0x%x, size=0x%&quot;</span><span class="n">FMT_PCIBUS</span><span class="p">,</span>
<span class="w">                     </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="p">);</span>
<span class="w">        </span><span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">io_regions</span><span class="o">[</span><span class="n">region_num</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memory</span><span class="p">;</span>
<span class="w">    </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">address_space</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PCI_BASE_ADDRESS_SPACE_IO</span>
<span class="w">        </span><span class="vm">?</span><span class="w"> </span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">address_space_io</span>
<span class="w">        </span><span class="err">:</span><span class="w"> </span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">address_space_mem</span><span class="p">;</span>
<span class="w">    </span><span class="n">r</span><span class="o">-&gt;</span><span class="k">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">size</span><span class="p">;</span>
<span class="w">    </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>

<span class="w">    </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pci_bar_address</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">region_num</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="o">-&gt;</span><span class="k">size</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PCI_BAR_UNMAPPED</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">memory_region_add_subregion_overlap</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">address_space</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</code></pre></div>

<p>å› ä¸ºä¸Šé¢çš„ç›¸å…³é€»è¾‘å·²ç»è¿›è¡Œäº†ä¸€äº›ä¿®æ”¹ï¼Œæ‰€ä»¥è¿™è¾¹ä¹Ÿéœ€è¦è¿›è¡Œç›¸å…³çš„ä¿®æ”¹ï¼Œä¿®æ”¹å®Œä¹‹åçš„è¿™ä¸ªå‡½æ•°å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="n">void</span><span class="w"> </span><span class="n">pcie_sriov_vf_register_bar</span><span class="p">(</span><span class="n">PCIDevice</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">region_num</span><span class="p">,</span>
<span class="w">                                </span><span class="n">MemoryRegion</span><span class="w"> </span><span class="o">*</span><span class="n">memory</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">    </span><span class="n">PCIIORegion</span><span class="w"> </span><span class="o">*</span><span class="n">r</span><span class="p">;</span>
<span class="w">    </span><span class="n">PCIBus</span><span class="w"> </span><span class="o">*</span><span class="n">bus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pci_get_bus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="n">uint8_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint16_t</span><span class="w"> </span><span class="n">vf_num</span><span class="p">;</span>
<span class="w">    </span><span class="n">pcibus_t</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memory_region_size</span><span class="p">(</span><span class="n">memory</span><span class="p">);</span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">pci_is_vf</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span><span class="w"> </span><span class="cm">/* PFs must use pci_register_bar */</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">region_num</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">region_num</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PCI_NUM_REGIONS</span><span class="p">);</span>
<span class="w">    </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="nf">exp</span><span class="p">.</span><span class="n">sriov_vf</span><span class="p">.</span><span class="n">pf</span><span class="o">-&gt;</span><span class="nf">exp</span><span class="p">.</span><span class="n">sriov_pf</span><span class="p">.</span><span class="n">vf_bar_type</span><span class="o">[</span><span class="n">region_num</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="n">vf_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="nf">exp</span><span class="p">.</span><span class="n">sriov_vf</span><span class="p">.</span><span class="n">vf_numbe</span><span class="p">;</span>
<span class="w">    </span><span class="n">PCIIORegion</span><span class="w"> </span><span class="o">*</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="nf">exp</span><span class="p">.</span><span class="n">sriov_pf</span><span class="p">.</span><span class="n">vf_regions</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">region_num</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/*get the bar size */</span>
<span class="w">    </span><span class="n">bar_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">region</span><span class="o">-&gt;</span><span class="k">size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="nf">exp</span><span class="p">.</span><span class="n">sriov_pf</span><span class="p">.</span><span class="n">total_vfs</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="k">size</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">error_report</span><span class="p">(</span><span class="ss">&quot;%s: PCI region size must be a power&quot;</span>
<span class="w">                     </span><span class="ss">&quot; of two - type=0x%x, size=0x%&quot;</span><span class="n">FMT_PCIBUS</span><span class="p">,</span>
<span class="w">                     </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="p">);</span>
<span class="w">        </span><span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">io_regions</span><span class="o">[</span><span class="n">region_num</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memory</span><span class="p">;</span>
<span class="w">    </span><span class="o">//</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">address_space</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="o">//</span><span class="w">    </span><span class="n">type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PCI_BASE_ADDRESS_SPACE_IO</span>
<span class="w">    </span><span class="o">//</span><span class="w">    </span><span class="vm">?</span><span class="w"> </span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">address_space_io</span>
<span class="w">    </span><span class="o">//</span><span class="w">    </span><span class="err">:</span><span class="w"> </span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">address_space_mem</span><span class="p">;</span>
<span class="w">    </span><span class="n">r</span><span class="o">-&gt;</span><span class="k">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">size</span><span class="p">;</span>
<span class="w">    </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/*vf mmio split from pf vf_iorgions*/</span>
<span class="w">    </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">address_stapce</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">region</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">;</span>

<span class="w">    </span><span class="o">//</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pci_bar_address</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">region_num</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="o">-&gt;</span><span class="k">size</span><span class="p">);</span>
<span class="w">    </span><span class="o">//</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PCI_BAR_UNMAPPED</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="o">//</span><span class="w">    </span><span class="n">memory_region_add_subregion_overlap</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">address_space</span><span class="p">,</span>
<span class="w">                                            </span><span class="o">//</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="o">//</span><span class="err">}</span>
<span class="w">    </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PCI_BAR_UNMAPPED</span><span class="p">;</span>
<span class="w">    </span><span class="n">memory_region_add_subregion</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">address_space</span><span class="p">,</span>
<span class="w">                                </span><span class="n">bar_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vf_number</span><span class="p">,</span>
<span class="w">                                </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">);</span>
<span class="w">    </span><span class="n">memory_region_set_enabled</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">,</span><span class="w"> </span><span class="k">true</span><span class="p">);</span>
<span class="err">}</span>
</code></pre></div>

<p>å¤§å®¶å¯ä»¥å¯¹æ¯”ä¸€ä¸‹è¿™ä¸ªå‡½æ•°åœ¨ä¿®æ”¹å‰åçš„å¯¹æ¯”ã€‚å¦å¤–ï¼Œä»å‰ç«¯çš„å®ç°é‡Œé¢å¯ä»¥çœ‹åˆ°è®¾å¤‡åˆå§‹åŒ–ä¼šå¯¹ vf bar çš„ç›¸å…³region resourceè¿›è¡Œæ›´æ–°ï¼Œ æ‰€ä»¥patché‡Œé¢åº”è¯¥åœ¨config writeæµç¨‹é‡Œé¢å†åŠ ä¸Šç›¸åº”çš„vf_ioregionsæ›´æ–°ï¼Œè¿™é‡Œå°±ä¸è¯¦è¿°äº†å¤§å®¶å¯ä»¥æ€è€ƒä¸€ä¸‹ã€‚</p>
<h4>æ€»ç»“</h4>
<p>ä¸Šé¢äº†èŠ±äº†ä¸€äº›ç¯‡å¹…å¯¹sriovçš„å‰åç«¯è¿›è¡Œäº†ä¸€äº›åˆ†æï¼Œå¸Œæœ›èƒ½å¯¹å„ä½çœ‹å®˜æœ‰äº›å¸®åŠ©ã€‚æ­£å¦‚å‰é¢æ‰€è¯´sriovä¸æ˜¯ä¸€é¡¹æ–°çš„æŠ€æœ¯ï¼Œä¹‹å‰åœ¨ç›¸å…³æ–‡ç« ä¹Ÿä»‹ç»è¿‡å®ƒçš„ä¸‹ä¸€ä»£siovã€‚ä½†ä¸å¯å¦è®¤sriovä¾ç„¶æ˜¯æˆªæ­¢ç›®å‰ä¸ºæ­¢æ‰€æœ‰é«˜æ€§èƒ½ioè™šæ‹ŸåŒ–æŠ€æœ¯é‡Œé¢ä½¿ç”¨æœ€ç®€å•ã€æœ€ç¨³å®šçš„ï¼Œæ‰€ä»¥æˆ‘è§‰å¾—å¤§å®¶è¿˜æ˜¯æœ‰å¿…è¦å¼„æ¸…æ¥šä»–çš„ç›¸å…³åŸç†ã€‚</p>

                <!-- å›¾ç‰‡ç”»å»Š -->
            </main>

        <!-- æ–‡ç« åº•éƒ¨åŒºåŸŸ -->
        <footer class="article-footer">
            <!-- æ ‡ç­¾åŒºåŸŸ -->
            <div class="article-tags-section">
                <h4>ğŸ·ï¸ ç›¸å…³æ ‡ç­¾</h4>
                <div class="tags-cloud">
                    <span class="tag-cloud-item">pcie</span>
                    <span class="tag-cloud-item">SRIOV</span>
                </div>
            </div>

            <!-- åˆ†äº«å’Œäº’åŠ¨ -->
            <div class="article-interaction">
                <div class="social-share">
                    <h4>ğŸ”— åˆ†äº«è¿™ç¯‡æ–‡ç« </h4>
                    <div class="share-buttons">
                        <a href="#" class="share-btn twitter" target="_blank">ğ• Twitter</a>
                        <a href="#" class="share-btn weibo" target="_blank">ğŸ“ å¾®åš</a>
                        <a href="#" class="share-btn linkedin" target="_blank">ğŸ’¼ LinkedIn</a>
                    </div>
                </div>
            </div>

            <!-- ä½œè€…ç­¾åæ¡£ -->
            <div class="author-signature">
                <div class="signature-content">
                    <h4>å…³äºä½œè€…</h4>
                    <p><strong>å‘¨å®œæ³¢</strong>ï¼Œå­—èŠ‚è·³åŠ¨ç«å±±å¼•æ“AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆï¼Œä¸“æ³¨AI Agentã€GPUæ± åŒ–ã€LLMæ¨ç†ä¼˜åŒ–ç­‰å‰æ²¿æŠ€æœ¯ã€‚</p>
                    <div class="author-social">
                        <a href="https://twitter.com/zhyblife99" target="_blank">ğ• Twitter</a>
                        <span class="wechat-hint">ğŸ’¬ å…³æ³¨å¾®ä¿¡å…¬ä¼—å·è·å–æ›´å¤šå†…å®¹</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <aside class="article-sidebar">
        <!-- æ–‡ç« ä¿¡æ¯å¡ç‰‡ -->
        <div class="sidebar-card article-info-card">
            <h3>ğŸ“Š æ–‡ç« ä¿¡æ¯</h3>
            <div class="info-list">
                <div class="info-item">
                    <span class="info-label">å‘å¸ƒæ—¶é—´</span>
                    <span class="info-value">æ—¥ 26 å…­æœˆ 2022</span>
                </div>
                <div class="info-item">
                    <span class="info-label">åˆ†ç±»</span>
                    <span class="info-value">articles</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¢„è®¡é˜…è¯»</span>
                    <span class="info-value">~10 åˆ†é’Ÿ</span>
                </div>
            </div>
        </div>

        <!-- ç›¸å…³æ–‡ç« æ¨è -->
        <div class="sidebar-card related-articles-card">
            <h3>ğŸ“š ç›¸å…³æ–‡ç« </h3>
            <div class="related-list">
            </div>
        </div>

        <!-- æŠ€æœ¯æ ˆå±•ç¤º -->
        <div class="sidebar-card skills-card">
            <h3>ğŸš€ æŠ€æœ¯æ ˆ</h3>
            <div class="skills-list">
                <span class="skill-item">AI Agent</span>
                <span class="skill-item">GPUæ± åŒ–</span>
                <span class="skill-item">LLMæ¨ç†ä¼˜åŒ–</span>
                <span class="skill-item">é«˜æ€§èƒ½è™šæ‹ŸåŒ–</span>
            </div>
        </div>

        <!-- å…³æ³¨å…¬ä¼—å· -->
        <div class="sidebar-card wechat-card">
            <h3>ğŸ”” è®¢é˜…æ›´æ–°</h3>
            <div class="wechat-content">
                <p>æ‰«ç å…³æ³¨å¾®ä¿¡å…¬ä¼—å·</p>
                <img src="./images/qrcode.jpg" alt="å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç " class="sidebar-qrcode">
                <p class="wechat-name">KernelNote</p>
            </div>
        </div>
    </aside>
</div>

<!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
<button class="back-to-top" id="backToTop">
    <span>â†‘</span>
</button>

<script>
// è¿”å›é¡¶éƒ¨åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const backToTop = document.getElementById('backToTop');

    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTop.style.display = 'block';
        } else {
            backToTop.style.display = 'none';
        }
    });

    // ç‚¹å‡»è¿”å›é¡¶éƒ¨
    backToTop.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // ç›®å½•é«˜äº®
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = document.querySelectorAll('.article-content h2, .article-content h3, .article-content h4');

    function updateTocHighlight() {
        let current = '';
        headings.forEach((heading, index) => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100) {
                current = heading.id;
            }
        });

        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#' + current) {
                link.classList.add('active');
            }
        });
    }

    if (tocLinks.length > 0) {
        window.addEventListener('scroll', updateTocHighlight);
        updateTocHighlight();
    }

    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®å½•é¡¹
    tocLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});
</script>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>        <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>
    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>