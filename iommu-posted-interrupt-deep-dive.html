<!DOCTYPE html>
<html lang="zh_cn">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="duma" />

        <meta name="description" content="åºè¨€ interrupt postæ˜¯iommuç¡¬ä»¶åœ¨interrupt remappingåŠŸèƒ½ä¸Šåšçš„ä¸€ä¸ªæ‰©å±•ï¼Œåœ¨è¿™ç§æœºåˆ¶ä½¿èƒ½çš„æƒ…å†µä¸‹ç›´é€šè®¾å¤‡çš„ä¸­æ–­æ³¨å…¥å¯ä»¥é¿å…vcpuçš„é€€å‡ºå’Œvmmçš„å‚ä¸ï¼Œä»è€Œå‡å°‘ç›´é€šåœºæ™¯ä¸‹çš„è™šæ‹ŸåŒ–å¼€é”€ã€‚æŒ‰ç…§æƒ¯ä¾‹æˆ‘ â€¦
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="iommu, interrupt posting, articles, " />
        <title>æ·±å…¥äº†è§£iommuç³»åˆ—æœ€ç»ˆç« ï¼šInterrupt Posting æœºåˆ¶å’Œå·¥ä½œåŸç†  Â· KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link href="https://kernelnote.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢ - Full Atom Feed" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LRRMJ08SPD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LRRMJ08SPD');
</script>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./pages/about.html">about</a></li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<!-- æ–‡ç« å¤´éƒ¨åŒºåŸŸ -->
<header class="article-header">
    <div class="article-header-container">
        <!-- ä½œè€…ä¿¡æ¯åŒºåŸŸ -->
        <div class="article-author-section">
            <img src="./images/wechat.jpeg" alt="å‘¨æ¯…åš" class="author-avatar">
            <div class="author-info">
                <h3 class="author-name">å‘¨å®œæ³¢</h3>
                <p class="author-title">AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆ | AI Agentä¸“å®¶</p>
            </div>
        </div>

        <!-- æ–‡ç« æ ‡é¢˜å’Œå…ƒä¿¡æ¯ -->
        <div class="article-meta-section">
            <h1 class="article-title">
                æ·±å…¥äº†è§£iommuç³»åˆ—æœ€ç»ˆç« ï¼šInterrupt Posting æœºåˆ¶å’Œå·¥ä½œåŸç†
            </h1>

            <div class="article-meta-info">
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“…</span>
                    <time datetime="2022-04-26T00:00:00+08:00">äºŒ 26 å››æœˆ 2022</time>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“</span>
                    <span class="category-tag">articles</span>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ·ï¸</span>
                    <span class="article-tag">iommu</span>
                    <span class="article-tag">interrupt posting</span>
                </div>
            </div>

            <!-- å¤šåª’ä½“é“¾æ¥åŒºåŸŸ -->
        </div>
    </div>
</header>

<!-- æ–‡ç« ä¸»ä½“å†…å®¹ -->
<div class="article-container">
    <div class="article-main">
        <!-- æ–‡ç« å†…å®¹ -->
            <main class="article-content article-content-no-toc">
                
                <h4>åºè¨€</h4>
<p>interrupt postæ˜¯iommuç¡¬ä»¶åœ¨interrupt remappingåŠŸèƒ½ä¸Šåšçš„ä¸€ä¸ªæ‰©å±•ï¼Œåœ¨è¿™ç§æœºåˆ¶ä½¿èƒ½çš„æƒ…å†µä¸‹ç›´é€šè®¾å¤‡çš„ä¸­æ–­æ³¨å…¥å¯ä»¥é¿å…vcpuçš„é€€å‡ºå’Œvmmçš„å‚ä¸ï¼Œä»è€Œå‡å°‘ç›´é€šåœºæ™¯ä¸‹çš„è™šæ‹ŸåŒ–å¼€é”€ã€‚æŒ‰ç…§æƒ¯ä¾‹æˆ‘ä»¬è¿˜æ˜¯å…ˆè®²ä¸€ä¸‹ç¡¬ä»¶å±‚é¢çš„æœºåˆ¶å’Œè½¯ä»¶å±‚çš„ä½¿èƒ½ã€‚</p>
<h4>ç¡¬ä»¶å±‚æœºåˆ¶</h4>
<p>iommuç¡¬ä»¶ä¸Šæ˜¯é€šè¿‡capability register(CAP_REG)å½“ä¸­çš„PIè¿™ä¸ªfieldæ¥è¡¨ç¤ºå…¶æ˜¯å¦æ”¯æŒposted interruptï¼Œå…·ä½“çš„æ ¼å¼å¦‚ä¸‹</p>
<p><img alt="pi_cap_reg" src="images/pi_cap_reg.png"></p>
<p><img alt="pi_field" src="images/pi_field.png">
<center> å›¾1</center>
å¦å¤–ï¼Œåœ¨IRTE(interrupt remap table entry) çš„æ ¼å¼å½“ä¸­IMä½ç½®1è¡¨ç¤ºä¸­æ–­æ¨¡å¼ä¸ºposted interrupt</p>
<p><img alt="irte_pi" src="images/irte_pi.png">
<center> å›¾2</center></p>
<p>ç»“åˆå›¾2æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹posted interrupts irteå½“ä¸­éœ€è¦é‡ç‚¹å…³æ³¨çš„fieldã€‚</p>
<ul>
<li>
<p>Posted Descriptor Address High
bits 127:96 è¡¨ç¤ºPosted interrupt Descriptorå†…å­˜åœ°å€çš„63:32ä½</p>
</li>
<li>
<p>Posted Descriptor Address Low
bits 63:38 è¡¨ç¤ºPosted Interrup Descriptorå†…å­˜åœ°å€çš„31:6ä½</p>
</li>
<li>
<p>Urgent(URG)
è¡¨ç¤ºè¿™ä¸ªä¸­æ–­æ˜¯å¦éœ€è¦åŠæ—¶è¢«å¤„ç†</p>
</li>
<li>
<p>vector bits 23:16
æ³¨æ„è¿™ä¸ªè·Ÿinterrupt remapping çš„irteå½“ä¸­çš„vectoræœ‰æœ¬è´¨çš„åŒºåˆ«ï¼›åœ¨interrupt remapping åœºæ™¯ä¸‹è¿™ä¸ªvectorå°±æ˜¯è¦æŠ•é€’çš„ä¸­æ–­å‘é‡ï¼Œè€Œinterrupt poståœºæ™¯ä¸‹ï¼Œç¡¬ä»¶é€šè¿‡ä¸ªvectoræ¥è®¡ç®—éœ€è¦å°†Post interrut requestçš„å“ªä¸€ä½ç½®ä¸Šã€‚</p>
</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹Posted  Interrupt Decsriptorï¼Œå…·ä½“çš„formatå¦‚ä¸‹</p>
<p><img alt="PID.png" src="images/PID.png">
<center> å›¾3</center></p>
<ul>
<li>NDST ï¼š Notification Destination</li>
</ul>
<p>è¡¨ç¤ºä¸­æ–­è¦æŠ•é€’åˆ°çš„ç›®æ ‡ç‰©ç†cpu APIC-ID(ä¹Ÿå°±æ˜¯vcpuæ‰€åœ¨çš„ç‰©ç†cpu)ï¼Œè¿™é‡Œåˆåˆ†ä¸ºä¸¤ç§åœºæ™¯ï¼šä¸€ç§æ˜¯xAPICçš„åœºæ™¯ï¼Œbits 303:296è¡¨ç¤º APIC Destionationdi[7:0]ï¼Œä¸€ç§æ˜¯x2APICåœºæ™¯ï¼Œåˆ™ bits 319:288 è¡¨ç¤ºAPIC DestionationID[31:0]</p>
<ul>
<li>
<p>NVï¼šNotification Vector
  è¿™é‡Œçš„vectorä¸»è¦æ˜¯ç”¨æ¥åšä¸€äº›äº‹ä»¶çš„é€šçŸ¥ï¼Œå…·ä½“åœ¨åé¢çš„è½¯ä»¶å±‚çš„åˆ†æå½“ä¸­ä¼šè¯¦ç»†ä»‹ç»ã€‚</p>
</li>
<li>
<p>SNï¼šSuppress Notification</p>
</li>
</ul>
<p>å¦‚æœç½®ä½ï¼Œåˆ™non-urgentçš„ä¸­æ–­é€šçŸ¥äº‹ä»¶å°†ä¼šè¢«æŠ‘åˆ¶ã€‚</p>
<ul>
<li>ONï¼šOutstanding Notificaion</li>
</ul>
<p>å¦‚æœç½®ä½åˆ™è¡¨ç¤ºæœ‰pending çš„ä¸­æ–­é€šçŸ¥äº‹ä»¶å¾…å¤„ç†ï¼Œé€šå¸¸æƒ…å†µä¸‹ONä½ä¸€èˆ¬æ˜¯è½¯ä»¶å³vmmä¾§æ¸…ç†ï¼Œiommuç¡¬ä»¶ç½®ä½ã€‚</p>
<ul>
<li>PIRï¼šPost Interrupt Request
   ç”¨æ¥è®°å½•ä¸­æ–­è¯·æ±‚çš„vectorï¼Œå¤§å°ä¸º256 bitsï¼Œæ¯ä¸ªbitè¡¨ç¤ºä¸€ä¸ªvectorã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹iommuç¡¬ä»¶å¯¹posted interrupt çš„å¤„ç†æµç¨‹ï¼š</p>
<ul>
<li>
<p>ç¡¬ä»¶è¯»å–IRTEçš„IM fieldï¼Œå¦‚æœä¸º1åˆ™ï¼š</p>
<ul>
<li>ç¡¬ä»¶ä»¥posted interruptçš„æ ¼å¼æ¥è§£æIRTE</li>
<li>ä»IRTEå½“ä¸­è¯»å–PIDï¼Œvector value, URG</li>
</ul>
</li>
<li>
<p>ç¡¬ä»¶å¯¹posted-interrupt descriptorè¿›è¡Œread-modify-write åŸå­æ“ä½œå…·ä½“æµç¨‹å¦‚ä¸‹</p>
<ul>
<li>iommu ç¡¬ä»¶ ECAP_REGçš„MTS(memory type support)ç½®1ï¼Œä¸”MTSä¸ºwrite-back(WB)ã€‚WBæ¨¡å¼ä¸‹å¯¹ä¸»å­˜çš„è¯»å–æˆ–è€…å†™å…¥æ“ä½œæ—¶éƒ½ä¼šè¢«cacheã€‚å¦å¤–ï¼Œå¯¹cacheçš„å†™å…¥å¹¶ä¸ä¼šç«‹å³syncåˆ°ä¸»å­˜é‡Œé¢ï¼Œè¿™äº›å†™å…¥çš„å†…éƒ¨ä¼šä¸€ç›´ç´¯ç§¯åœ¨cacheå½“ä¸­ï¼Œåªæœ‰å½“éœ€è¦é‡Šæ”¾cacheç©ºé—´æ—¶è¿™äº›å†…å®¹æ‰ä¼šè¢«å†™å…¥åˆ°å†…å­˜ã€‚</li>
<li>ç¡¬ä»¶ä»PIDè¯»å–ç›¸å…³çš„å†…å®¹ï¼ŒåŒæ—¶å°†cache-lineè®¾ç½®ä¸ºEçŠ¶æ€å³å½“å‰çš„æ•°æ®åªå­˜åœ¨äºè¿™ä¸ªcache lineå½“ä¸­ä¸”æ•°æ®è·Ÿä¸»å­˜ä¸€è‡´</li>
<li>æ ¹æ®vectorè®¡ç®—å‡ºPIRå½“ä¸­éœ€è¦ç½®ä¸Šçš„ä½ã€‚</li>
<li>è®¡ç®—X=((0N == 0) &amp;(URG|(SN == 0))) çš„å€¼ï¼Œå¦‚æœX == 1åˆ™è®¾ç½®ONä½ã€‚</li>
<li>è®©cache-lineè®¾ç½®ä¸ºå…¨å±€å¯è§‚å¯ŸçŠ¶æ€ï¼Œè¿™æ ·å…¶ä»–çš„cache agentå°±å¯ä»¥å—…æ¢åˆ°è¿™ä¸ªcacheçš„ç›¸å…³ä¿®æ”¹ã€‚å®Œæˆè¿™ä¸€æ­¥ä¹‹ååœ¨æŸäº›æ—¶å€™å°†cacheçš„å€¼å†™å›ä¸»å­˜ã€‚</li>
</ul>
</li>
<li>
<p>å¦‚æœX == 1åˆ™å…·ä½“çš„ä¸­æ–­é€šçŸ¥äº‹ä»¶æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ç¡¬ä»¶ä»NSDT fieldè¯»å–ç›®æ ‡ç‰©ç†cpuçš„apic-idï¼Œä»NV fieldæ‹¿åˆ° notification interrupt çš„ä¸­æ–­vectorã€‚</li>
<li>ç¡¬ä»¶æ ¼å¼åŒ–å‡ºä¸€ä¸ªnotification interruptï¼Œå…¶ä¸­Delivery modeè®¾ç½®ä¸ºFixed(000b)ï¼ŒRe-direction Hint fieldè¢«è®¾ç½®ä¸º0bï¼ŒTrigger Mode ä¸ºEdgeï¼Œ Trigger Mode Level ä¸ºAsserted</li>
<li>cpuæ”¶åˆ°notifcationä¹‹åå¦‚æœæ­¤æ—¶vcpuåœ¨non-rootæ¨¡å¼ï¼Œåˆ™vmxç¡¬ä»¶ä¼šå°†pirå¯¹åº”çš„vectorè‡ªåŠ¨sycåˆ°vIRRå½“ä¸­(è¿™ä¸ªä¸»è¦ä¾èµ–äºapicvï¼Œå› æ­¤å¦‚æœapicvæ²¡æœ‰ä½¿èƒ½çš„è¯åˆ™posted interruptä¸èƒ½æ­£å¸¸ä½¿ç”¨)ï¼Œè¿™æ ·vcpuåœ¨non-rootæ¨¡å¼ä¸‹å°±æŠŠè¿™ä¸ªä¸­æ–­å¤„ç†äº†ã€‚</li>
</ul>
</li>
</ul>
<h4>è½¯ä»¶ä½¿èƒ½</h4>
<p>vmmä¼šä¸ºæ¯ä¸ªvcpu(å…·ä½“åœ¨per vcpuçš„vcpu_vmxæ•°æ®ç»“æ„å½“ä¸­)åˆ›å»ºä¸€ä¸ªpi_descçš„æ•°æ®ç»“æ„ï¼Œå…·ä½“å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="nt">struct</span><span class="w"> </span><span class="nt">pi_desc</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">u32</span><span class="w"> </span><span class="err">pir</span><span class="cp">[</span><span class="mi">8</span><span class="cp">]</span><span class="p">;</span><span class="w">     </span><span class="c">/* Posted interrupt requested */</span>
<span class="w">        </span><span class="err">union</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="err">struct</span><span class="w"> </span><span class="err">{</span>
<span class="w">                                </span><span class="c">/* bit 256 - Outstanding Notification */</span>
<span class="w">                        </span><span class="err">u16</span><span class="w">     </span><span class="n">on</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                                </span><span class="c">/* bit 257 - Suppress Notification */</span>
<span class="w">                                </span><span class="n">sn</span><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                                </span><span class="c">/* bit 271:258 - Reserved */</span>
<span class="w">                                </span><span class="n">rsvd_1</span><span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="mi">14</span><span class="p">;</span>
<span class="w">                                </span><span class="c">/* bit 279:272 - Notification Vector */</span>
<span class="w">                        </span><span class="err">u8</span><span class="w">      </span><span class="err">nv</span><span class="p">;</span>
<span class="w">                                </span><span class="c">/* bit 287:280 - Reserved */</span>
<span class="w">                        </span><span class="err">u8</span><span class="w">      </span><span class="err">rsvd_2</span><span class="p">;</span>
<span class="w">                                </span><span class="c">/* bit 319:288 - Notification Destination */</span>
<span class="w">                        </span><span class="err">u32</span><span class="w">     </span><span class="err">ndst</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span><span class="o">;</span>
<span class="w">                </span><span class="nt">u64</span><span class="w"> </span><span class="nt">control</span><span class="o">;</span>
<span class="w">        </span><span class="err">}</span><span class="o">;</span>
<span class="w">        </span><span class="nt">u32</span><span class="w"> </span><span class="nt">rsvd</span><span class="cp">[</span><span class="mi">6</span><span class="cp">]</span><span class="o">;</span>
<span class="err">}</span><span class="w"> </span><span class="nt">__aligned</span><span class="o">(</span><span class="nt">64</span><span class="o">);</span>
</code></pre></div>

<p>ä¸Šå›¾çš„æ•°æ®ç»“æ„è·Ÿç¡¬ä»¶å®šä¹‰æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚æ¥ç€æˆ‘ä»¬çœ‹ä¸€ä¸‹posted interruptçš„åœ¨è½¯ä»¶å±‚é¢çš„ç›¸å…³è®¾ç½®ï¼Œåœ¨interrupt remapping ä½¿èƒ½çš„æ—¶å€™ä¼šç»™ç¡¬ä»¶ä¸­æ–­åˆ›å»ºirqfd(å»ºè®®å¤§å®¶å…ˆçœ‹ä¸€ä¸‹<a href="https://mp.weixin.qq.com/s/xZyZmHZSOWwHkHTNLBmLeA">æ·±å…¥äº†è§£iommuç³»åˆ—å››:interrupt remappingå·¥ä½œæœºåˆ¶è§£æ</a> è¿™ç¯‡æ–‡ç« )ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªconsumer</p>
<div class="highlight"><pre><span></span><code><span class="n">irqfd</span><span class="o">-&gt;</span><span class="n">consumer</span><span class="p">.</span><span class="n">add_producer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kvm_arch_irq_bypass_add_producer</span>
</code></pre></div>

<p>è¿™ä¸ªadd_producerå‡½æ•°ä¼šè°ƒç”¨<code>kvm_x86_ops-&gt;update_pi_irte</code> ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°æ ¸å¿ƒé€»è¾‘</p>
<div class="highlight"><pre><span></span><code><span class="w">                </span><span class="cm">/*</span>
<span class="cm">                 * VT-d PI cannot support posting multicast/broadcast</span>
<span class="cm">                 * interrupts to a vCPU, we still use interrupt remapping</span>
<span class="cm">                 * for these kind of interrupts.</span>
<span class="cm">                 *</span>
<span class="cm">                 * For lowest-priority interrupts, we only support</span>
<span class="cm">                 * those with single CPU as the destination, e.g. user</span>
<span class="cm">                 * configures the interrupts via /proc/irq or uses</span>
<span class="cm">                 * irqbalance to make the interrupts single-CPU.</span>
<span class="cm">                 *</span>
<span class="cm">                 * We will support full lowest-priority interrupt later.</span>
<span class="cm">                 */</span>

<span class="w">                </span><span class="nx">kvm_set_msi_irq</span><span class="p">(</span><span class="nx">kvm</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">irq</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">kvm_intr_is_single_vcpu</span><span class="p">(</span><span class="nx">kvm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">irq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">vcpu</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="cm">/*</span>
<span class="cm">                         * Make sure the IRTE is in remapped mode if</span>
<span class="cm">                         * we don&#39;t handle it in posted mode.</span>
<span class="cm">                         */</span>
<span class="w">                        </span><span class="nx">ret</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">irq_set_vcpu_affinity</span><span class="p">(</span><span class="nx">host_irq</span><span class="p">,</span><span class="w"> </span><span class="nx">NULL</span><span class="p">);</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">ret</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="nx">printk</span><span class="p">(</span><span class="nx">KERN_INFO</span>
<span class="w">                                   </span><span class="s">&quot;failed to back to remapped mode, irq: %u\n&quot;</span><span class="p">,</span>
<span class="w">                                   </span><span class="nx">host_irq</span><span class="p">);</span>
<span class="w">                                </span><span class="nx">goto</span><span class="w"> </span><span class="nx">out</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span>

<span class="w">                        </span><span class="k">continue</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="nx">vcpu_info</span><span class="p">.</span><span class="nx">pi_desc_addr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">__pa</span><span class="p">(</span><span class="nx">vcpu_to_pi_desc</span><span class="p">(</span><span class="nx">vcpu</span><span class="p">));</span>
<span class="w">                </span><span class="nx">vcpu_info</span><span class="p">.</span><span class="nx">vector</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">irq</span><span class="p">.</span><span class="nx">vector</span><span class="p">;</span>

<span class="w">                </span><span class="nx">trace_kvm_pi_irte_update</span><span class="p">(</span><span class="nx">host_irq</span><span class="p">,</span><span class="w"> </span><span class="nx">vcpu</span><span class="o">-&gt;</span><span class="nx">vcpu_id</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="o">-&gt;</span><span class="nx">gsi</span><span class="p">,</span>
<span class="w">                                </span><span class="nx">vcpu_info</span><span class="p">.</span><span class="nx">vector</span><span class="p">,</span><span class="w"> </span><span class="nx">vcpu_info</span><span class="p">.</span><span class="nx">pi_desc_addr</span><span class="p">,</span><span class="w"> </span><span class="nx">set</span><span class="p">);</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">set</span><span class="p">)</span>
<span class="w">                        </span><span class="nx">ret</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">irq_set_vcpu_affinity</span><span class="p">(</span><span class="nx">host_irq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">vcpu_info</span><span class="p">);</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                        </span><span class="nx">ret</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">irq_set_vcpu_affinity</span><span class="p">(</span><span class="nx">host_irq</span><span class="p">,</span><span class="w"> </span><span class="nx">NULL</span><span class="p">);</span>
</code></pre></div>

<p>ä¸Šé¢çš„é€»è¾‘æˆªå–è‡³ <code>vmx_update_pi_irte</code> å‡½æ•°ï¼Œé¦–å…ˆposted interruptåªæ”¯æŒmsi æˆ–è€…msixä¸­æ–­ï¼Œå…¶æ¬¡å¤šæ’­å’Œå¹¿æ’­çš„ä¸­æ–­ä¹Ÿæ˜¯posted interruptä¸æ”¯æŒçš„ã€‚æ‰€ä»¥å‡½æ•°é€»è¾‘é¦–å…ˆåˆ¤æ–­ä¸­æ–­æ³¨å…¥å¯¹è±¡æ˜¯ä¸æ˜¯single vcpuï¼Œå¦‚æœä¸æ˜¯åˆ™è¿˜æ˜¯è¦èµ° remapped modeã€‚å¦‚æœæ˜¯åˆ™å¼€å§‹å¯¹PID ç›¸å…³çš„æ•°æ®ç»“æ„è¿›è¡Œåˆå§‹åŒ–ï¼Œä»è¿™é‡Œé¢ä¹Ÿèƒ½çœ‹åˆ°vectorä¹Ÿå°±æ˜¯éœ€è¦æ³¨å…¥åˆ°guestå½“ä¸­çš„ä¸­æ–­å‘é‡ã€‚æ¥ç€å¦‚æœsetä¸ºtrueåˆ™è°ƒç”¨<code>irq_set_vcpu_affinity</code>ï¼Œ è¿™ä¸ªå‡½æ•°æœ€ç»ˆä¼šè°ƒåˆ°è¿™ä¸ªirqæ‰€å±äºçš„irq chipçš„</p>
<div class="highlight"><pre><span></span><code><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_set_vcpu_affinity</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">vcpu_info</span><span class="p">)</span>
</code></pre></div>

<p>ä» interrupt remappingçš„é‚£ç¯‡æ–‡ç« æˆ‘ä»¬çŸ¥é“è¿™ä¸ªchipæ˜¯ <code>intel_ir_chip</code> ï¼Œå› æ­¤å¯¹åº”çš„å…·ä½“çš„callbackå‡½æ•°ä¸º <code>intel_ir_set_vcpu_affinity</code>ã€‚æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å…·ä½“é€»è¾‘</p>
<div class="highlight"><pre><span></span><code><span class="nx">static</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">intel_ir_set_vcpu_affinity</span><span class="p">(</span><span class="nx">struct</span><span class="w"> </span><span class="nx">irq_data</span><span class="w"> </span><span class="o">*</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">void</span><span class="w"> </span><span class="o">*</span><span class="nx">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="nx">struct</span><span class="w"> </span><span class="nx">intel_ir_data</span><span class="w"> </span><span class="o">*</span><span class="nx">ir_data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">data</span><span class="o">-&gt;</span><span class="nx">chip_data</span><span class="p">;</span>
<span class="w">        </span><span class="nx">struct</span><span class="w"> </span><span class="nx">vcpu_data</span><span class="w"> </span><span class="o">*</span><span class="nx">vcpu_pi_info</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">info</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* stop posting interrupts, back to remapping mode */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">vcpu_pi_info</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">modify_irte</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ir_data</span><span class="o">-&gt;</span><span class="nx">irq_2_iommu</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">ir_data</span><span class="o">-&gt;</span><span class="nx">irte_entry</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">struct</span><span class="w"> </span><span class="nx">irte</span><span class="w"> </span><span class="nx">irte_pi</span><span class="p">;</span>

<span class="w">                </span><span class="cm">/*</span>
<span class="cm">                 * We are not caching the posted interrupt entry. We</span>
<span class="cm">                 * copy the data from the remapped entry and modify</span>
<span class="cm">                 * the fields which are relevant for posted mode. The</span>
<span class="cm">                 * cached remapped entry is used for switching back to</span>
<span class="cm">                 * remapped mode.</span>
<span class="cm">                 */</span>
<span class="w">                </span><span class="nx">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">irte_pi</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">sizeof</span><span class="p">(</span><span class="nx">irte_pi</span><span class="p">));</span>
<span class="w">                </span><span class="nx">dmar_copy_shared_irte</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">irte_pi</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">ir_data</span><span class="o">-&gt;</span><span class="nx">irte_entry</span><span class="p">);</span>

<span class="w">                </span><span class="cm">/* Update the posted mode fields */</span>
<span class="w">                </span><span class="nx">irte_pi</span><span class="p">.</span><span class="nx">p_pst</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="nx">irte_pi</span><span class="p">.</span><span class="nx">p_urgent</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                </span><span class="nx">irte_pi</span><span class="p">.</span><span class="nx">p_vector</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">vcpu_pi_info</span><span class="o">-&gt;</span><span class="nx">vector</span><span class="p">;</span>
<span class="w">                </span><span class="nx">irte_pi</span><span class="p">.</span><span class="nx">pda_l</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="nx">vcpu_pi_info</span><span class="o">-&gt;</span><span class="nx">pi_desc_addr</span><span class="w"> </span><span class="o">&gt;&gt;</span>
<span class="w">                                </span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">PDA_LOW_BIT</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="nx">UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nx">PDA_LOW_BIT</span><span class="p">);</span>
<span class="w">                </span><span class="nx">irte_pi</span><span class="p">.</span><span class="nx">pda_h</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="nx">vcpu_pi_info</span><span class="o">-&gt;</span><span class="nx">pi_desc_addr</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span>
<span class="w">                                </span><span class="o">~</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="nx">UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nx">PDA_HIGH_BIT</span><span class="p">);</span>

<span class="w">                </span><span class="nx">modify_irte</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ir_data</span><span class="o">-&gt;</span><span class="nx">irq_2_iommu</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">irte_pi</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>åœ¨è¿™ä¸ªå‡½æ•°å®ç°é‡Œé¢ï¼Œ<code>irq_data-&gt;irte_entry</code>é‡Œé¢ä»ç„¶æ˜¯remapped modeï¼Œç„¶åé€šè¿‡copyä¸€ä»½å‰¯æœ¬å°†å…¶ä¿®æ”¹æˆ posted modeï¼Œæœ€åé€šè¿‡<code>modify_irte</code> è¿™ä¸ªå‡½æ•°å°†irteå†™å…¥åˆ°iommuç¡¬ä»¶å½“ä¸­ã€‚è‡³æ­¤ï¼Œposted interrupt modeçš„irte è®¾ç½®æˆåŠŸã€‚</p>
<p>è¯´å®Œposted interrupt mode irteè®¾ç½®ä¹‹åï¼Œä¸‹é¢æˆ‘ä»¬æ¥è®²ä¸€ä¸‹vmm æ˜¯å¦‚ä½•ä½¿ç”¨ posted interruptæ¥delivery ä¸­æ–­çš„ã€‚è¿™é‡Œéœ€è¦å†å¤šè®²å‡ å¥ï¼Œposted interrupt åº”ç”¨åœºæ™¯æœ‰ä¸¤ç±»ï¼šä¸€ç±»æ˜¯ç›´é€šè®¾å¤‡åœºæ™¯ç¡¬ä»¶ç›´æ¥å°†è®¾å¤‡ä¸­æ–­æ³¨å…¥åˆ°guesté‡Œé¢ï¼Œå¦å¤–ä¸€ç±»æ˜¯vmmä¾§é€šè¿‡posted interruptæœºåˆ¶æ¥å®ç°æ¨¡æ‹Ÿè®¾å¤‡çš„ä¸­æ–­æ³¨å…¥æ¯”å¦‚virtioè®¾å¤‡ã€‚å…ˆè¯´è¯´ç›´é€šè®¾å¤‡çš„åœºæ™¯ï¼Œ<strong>åœ¨è¿™ç§åœºæ™¯ä¸‹ä¸­æ–­æ³¨å…¥å®Œå…¨ä¸éœ€è¦vmmå‚ä¸ï¼Œæ•´ä¸ªæµç¨‹å®Œå…¨ç”±ç¡¬ä»¶å®Œæˆ(å‰ææ˜¯è¯´vcpuåˆšå¥½å¤„äºnon-rootæ¨¡å¼)</strong>ã€‚ä½†æ˜¯æœ‰æ²¡æœ‰æƒ³è¿‡è®¾å¤‡åœ¨æ³¨å…¥ä¸­æ–­çš„çš„æ—¶å€™åˆšå¥½vcpuåœ¨rootæ¨¡å¼ä¸‹è¿™ä¸ªæ—¶å€™è¦æ€ä¹ˆæ“ä½œå‘¢ï¼Ÿè¿™ä¸ªå°±æ¶‰åŠåˆ°vcpuçŠ¶æ€è·Ÿinterrupt remappingç¡¬ä»¶ä¹‹é—´çš„åŒæ­¥äº†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹ç¡¬ä»¶ä¸­æ–­æ³¨å…¥ä¸vcpu æ‰€å¤„äºçš„è¿è¡ŒçŠ¶æ€ä¹‹é—´æ˜¯å¦‚ä½•åŒæ­¥çš„(vcpu runningçŠ¶æ€è¿™é‡Œå°±ä¸è®²äº†)ã€‚</p>
<ul>
<li>
<p>vcpu è¢«æŠ¢å 
vcpuçº¿ç¨‹é€€åˆ°rootæ¨¡å¼æ—¶å¯èƒ½ä¼šè¢«é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡æŠ¢å ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­åœ¨vmmä¾§ä¸posted interrputæœ‰å…³çš„æ ¸å¿ƒé€»è¾‘ä¸º<code>vmx_sched_out-&gt;vcpu_put-&gt;vmx_vcpu_pi_put</code> ï¼Œå…¶ä¸­vmx_vcpu_pi_putä¼šå°†SNç½®ä¸Šï¼Œé‚£ä¹ˆåœ¨è¿™ç§åœºæ™¯ä¸‹ç¡¬ä»¶å°±ä¸ä¼šè§¦å‘notification interrupt ç»™ç›¸åº”çš„cpuã€‚</p>
</li>
<li>
<p>vcpu å†æ¬¡è¢«è°ƒåº¦
vcpu è¿›ç¨‹å†æ¬¡è¢«è°ƒåº¦çš„æ—¶å€™ï¼Œåœ¨vmmä¾§çš„æ ¸å¿ƒé€»è¾‘ä¸º<code>vmx_sched_in-&gt;vcpu_load-&gt;vmx_vcpu_pi_load</code>ï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹ <code>vmx_vcpu_pi_load</code> è¿™ä¸ªå‡½æ•°æ ¸å¿ƒé€»è¾‘åœ¨äºå¦‚æœvcpuå½“å‰è¿è¡Œçš„cpuè·Ÿä¹‹å‰çš„cpuä¸ä¸€æ ·åˆ™éœ€è¦æ›´æ–°pid_descå½“ä¸­çš„NDSTä½ï¼Œå¦å¤–å¦‚æœsnä½è¢«ç½®ä¸Šåˆ™éœ€è¦cleanæ‰ã€‚è¿™é‡Œæœ‰ä¸ªé—®é¢˜å°±æ˜¯å½“vmmä¾§åœ¨ä¿®æ”¹çš„æ—¶å€™å¯èƒ½iommuçš„ç¡¬ä»¶ä¾§ä¹Ÿå¯èƒ½åœ¨ä¿®æ”¹ï¼Œå› æ­¤ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜åœ¨å®ç°å½“ä¸­ä½¿ç”¨äº†cmpxchg64å‡½æ•°æ¥å®ç°atomic read-modify-writeã€‚</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>......
        /* The full case.  */
        do {
                old.control = new.control = pi_desc-&gt;control;

                dest = cpu_physical_id(cpu);

                if (x2apic_enabled())
                        new.ndst = dest;
                else
                        new.ndst = (dest &lt;&lt; 8) &amp; 0xFF00;

                new.sn = 0;
        } while (cmpxchg64(&amp;pi_desc-&gt;control, old.control,
                           new.control) != old.control);
......
</code></pre></div>

<ul>
<li>vcpu blockçŠ¶æ€
å½“vcpu ä¸»åŠ¨haltå‡ºæ¥æ—¶ä¼šè¿›å…¥blockï¼Œå†è¿›å…¥åˆ°çœŸæ­£blockä¹‹å‰ä¼šæœ‰ä¸€ä¸ªpre blockçš„æ“ä½œã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¼šè°ƒç”¨<code>pi_pre_block</code> å‡½æ•°å¯¹pir_descå½“ä¸­ç›¸å…³fieldè¿›è¡Œä¿®æ­£ï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å…·ä½“é€»è¾‘ï¼š</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="n">local_irq_disable</span><span class="p">();</span>
<span class="w"> </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">pre_pcpu</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">pre_pcpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
<span class="w">                </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">blocked_vcpu_on_cpu_lock</span><span class="p">,</span><span class="w"> </span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">pre_pcpu</span><span class="p">));</span>
<span class="w">                </span><span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">blocked_vcpu_list</span><span class="p">,</span>
<span class="w">                              </span><span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">blocked_vcpu_on_cpu</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">pre_pcpu</span><span class="p">));</span>
<span class="w">                </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">blocked_vcpu_on_cpu_lock</span><span class="p">,</span><span class="w"> </span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">pre_pcpu</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>

<p>è¿™éƒ¨åˆ†é€»è¾‘æ˜¯åˆ¤æ–­vcpuçš„pre_cpuæ˜¯å¦ä¸º-1(default value ä¸º-1)ï¼Œå¦‚æœä¸ä¸º-1åˆ™æ‰“ä¸ªwarning stackï¼›å¦‚æœä¸º-1åˆ™å°†pre_cpuèµ‹å€¼ä¸ºå½“å‰vcpuæ‰€åœ¨çš„ç‰©ç†cpuï¼Œå¹¶ä¸”æŠŠvcpuæ”¾å…¥åˆ°è¿™ä¸ªç‰©ç†cpuçš„ block_vcpu_listå½“ä¸­ã€‚æ¥ç€å¾€ä¸‹çœ‹</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="nt">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="err">old.control</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">new.control</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">pi_desc-&gt;control</span><span class="p">;</span>

<span class="w">                </span><span class="err">WARN((pi_desc-&gt;sn</span><span class="w"> </span><span class="err">==</span><span class="w"> </span><span class="err">1),</span>
<span class="w">                     </span><span class="err">&quot;</span><span class="n">Warning</span><span class="p">:</span><span class="w"> </span><span class="n">SN</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">posted-interrupts</span><span class="w"> </span><span class="s2">&quot;</span>
<span class="s2">                     &quot;</span><span class="n">is</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">blocking</span><span class="err">\</span><span class="n">n</span><span class="err">&quot;</span><span class="p">);</span>

<span class="w">                </span><span class="c">/*</span>
<span class="c">                 * Since vCPU can be preempted during this process,</span>
<span class="c">                 * vcpu-&gt;cpu could be different with pre_pcpu, we</span>
<span class="c">                 * need to set pre_pcpu as the destination of wakeup</span>
<span class="c">                 * notification event, then we can find the right vCPU</span>
<span class="c">                 * to wakeup in wakeup handler if interrupts happen</span>
<span class="c">                 * when the vCPU is in blocked state.</span>
<span class="c">                 */</span>
<span class="w">                </span><span class="err">dest</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">cpu_physical_id(vcpu-&gt;pre_pcpu)</span><span class="p">;</span>

<span class="w">                </span><span class="err">if</span><span class="w"> </span><span class="err">(x2apic_enabled())</span>
<span class="w">                        </span><span class="err">new.ndst</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">dest</span><span class="p">;</span>
<span class="w">                </span><span class="err">else</span>
<span class="w">                        </span><span class="err">new.ndst</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">(dest</span><span class="w"> </span><span class="err">&lt;&lt;</span><span class="w"> </span><span class="err">8)</span><span class="w"> </span><span class="err">&amp;</span><span class="w"> </span><span class="err">0xFF00</span><span class="p">;</span>

<span class="w">                </span><span class="c">/* set &#39;NV&#39; to &#39;wakeup vector&#39; */</span>
<span class="w">                </span><span class="err">new.nv</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">POSTED_INTR_WAKEUP_VECTOR</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="nt">while</span><span class="w"> </span><span class="o">(</span><span class="nt">cmpxchg64</span><span class="o">(&amp;</span><span class="nt">pi_desc-</span><span class="o">&gt;</span><span class="nt">control</span><span class="o">,</span><span class="w"> </span><span class="nt">old</span><span class="p">.</span><span class="nc">control</span><span class="o">,</span>
<span class="w">                           </span><span class="nt">new</span><span class="p">.</span><span class="nc">control</span><span class="o">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nt">old</span><span class="p">.</span><span class="nc">control</span><span class="o">);</span>
</code></pre></div>

<p>è¿™éƒ¨åˆ†é€»è¾‘å½“ä¸­é¦–å…ˆåˆ¤æ–­SNæ˜¯å¦è¢«ç½®ä¸Šï¼Œå¦‚æœç½®ä¸Šåˆ™æ‰“å°ä¸€ä¸‹warningã€‚åŸå› æ˜¯è¯´vcpuæ˜¯ä¸»åŠ¨haltå‡ºæ¥å¹¶ä¸æ˜¯è¢«æŠ¢å çš„æ‰€ä»¥ç†è®ºæ˜¯ä¸ä¼šèµ°åˆ°pi_putçš„ç›¸å…³é€»è¾‘çš„ï¼Œä½†æ˜¯ä¹Ÿä¸å½±å“æ­£å¸¸åŠŸèƒ½æ‰€ä»¥åªæ˜¯warningä¸€ä¸‹ã€‚æ¥ç€ä»ç„¶æ˜¯é€šè¿‡cmpxchg64è¿™ä¸ªåŸå­æ“ä½œå°†NDSTè®¾ç½®ä¸ºpre_pcpuï¼ŒåŒæ—¶å°†nvè®¾ç½®ä¸º<code>POSTED_INTR_WAKEUP_VECTOR</code> ã€‚è¿™é‡Œå¤šè¯´å‡ å¥nvå³notification vectoræœ‰ä¸¤ç§ï¼šä¸€ç§å°±æ˜¯ <code>POSTED_INTR_VECTOR</code> å³å½“cpuæ”¶åˆ°è¿™ä¸ªä¸­æ–­æ—¶å¦‚æœvcpuå¤„äºnon-rootæ—¶åˆ™vmxç¡¬ä»¶æŠŠè‡ªåŠ¨æŠŠpir syncåˆ°virrå³åœ¨non-rootæ¨¡å¼å°†ä¸­æ–­å¤„ç†æ‰ï¼›å¦å¤–ä¸€ç§å°±æ˜¯å‰é¢æåˆ°çš„<code>POSTED_INTR_WAKEUP_VECTOR</code> ï¼Œå½“cpuæ”¶åˆ°è¿™ä¸ªä¸­æ–­æ˜¯å°±ä¼šæŠŠblockåœ¨è¯¥pcpuä¸Šçš„block_vcpu_listä¸Šçš„vcpuå”¤é†’ï¼Œç„¶ååœ¨vmentryè¿‡ç¨‹ä¸­å°†ä¸­æ–­æ³¨å…¥åˆ°vmå½“ä¸­ï¼Œè‡³äºè¿™ä¸ªå…·ä½“çš„æ³¨å…¥é€»è¾‘å°†åœ¨åé¢è¿›è¡Œå…·ä½“ä»‹ç»ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="w">     </span><span class="o">/*</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">vCPU</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">interrupt</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">posted</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="w">  </span><span class="o">*/</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pi_test_on</span><span class="p">(</span><span class="n">pi_desc</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                </span><span class="n">__pi_post_block</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="w">        </span><span class="n">local_irq_enable</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">pre_pcpu</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p>ä¸Šé¢çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå¦‚æœç¡¬ä»¶å·²ç»å°†onè®¾ç½®ä¸Šè¯´æ˜ç¡¬ä»¶ä¾§å‡†å¤‡å‘é€notification interruptäº†ï¼Œæ‰€ä»¥ä¸èƒ½è®©vcpuè¿›è¡ŒblockçŠ¶æ€ï¼Œè¿™é‡Œæœ‰è°ƒç”¨<code>__pi_post_block(vcpu)</code>ï¼Œ ä¸‹é¢æˆ‘ä»¬æ¥è®²ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ã€‚</p>
<p>å½“vcpuç»“æŸblockçŠ¶æ€æ—¶åœ¨post_blocké˜¶æ®µä¹Ÿä¼šè°ƒç”¨<code>__pi_post_block(vcpu)</code> ï¼Œå…·ä½“å®ç°å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code>static void __pi_post_block(struct kvm_vcpu *vcpu)
{
        struct pi_desc <span class="gs">*pi_desc = vcpu_to_pi_desc(vcpu);</span>
<span class="gs">        struct pi_desc old, new;</span>
<span class="gs">        unsigned int dest;</span>

<span class="gs">        do {</span>
<span class="gs">                old.control = new.control = pi_desc-&gt;control;</span>
<span class="gs">                WARN(old.nv != POSTED_INTR_WAKEUP_VECTOR,</span>
<span class="gs">                     &quot;Wakeup handler not enabled while the VCPU is blocked\n&quot;);</span>

<span class="gs">                dest = cpu_physical_id(vcpu-&gt;cpu);</span>

<span class="gs">                if (x2apic_enabled())</span>
<span class="gs">                        new.ndst = dest;</span>
<span class="gs">                else</span>
<span class="gs">                        new.ndst = (dest &lt;&lt; 8) &amp; 0xFF00;</span>

<span class="gs">                /*</span> set &#39;NV&#39; to &#39;notification vector&#39; */
                new.nv = POSTED_INTR_VECTOR;
        } while (cmpxchg64(&amp;pi_desc-&gt;control, old.control,
                           new.control) != old.control);

        if (!WARN_ON_ONCE(vcpu-&gt;pre_pcpu == -1)) {
                spin_lock(&amp;per_cpu(blocked_vcpu_on_cpu_lock, vcpu-&gt;pre_pcpu));
                list_del(&amp;vcpu-&gt;blocked_vcpu_list);
                spin_unlock(&amp;per_cpu(blocked_vcpu_on_cpu_lock, vcpu-&gt;pre_pcpu));
                vcpu-&gt;pre_pcpu = -1;
        }
}
</code></pre></div>

<p>çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å…·ä½“é€»è¾‘ï¼šå…ˆå°†pi_descçš„NDSTè®¾ç½®ä¸ºvcpuå½“å‰è¦è¿è¡Œçš„ç‰©ç†cpuï¼Œå°†nvè®¾ç½®ä¸º<code>POSTED_INTR_VECTOR</code> ï¼Œç„¶åå¦‚æœ<code>vcpu-&gt;pre_pcpu</code> ä¸æ˜¯-1åˆ™vcpuä»è¯¥ç‰©ç†cpuçš„blocked_vcpu_listå½“ä¸­åˆ é™¤æ‰ï¼Œç„¶åå°†pre_pcpuå†é‡ç½®ä¸º-1ã€‚</p>
<p>ä¸Šé¢èŠ±äº†ç‚¹ç¯‡å¹…ä»‹ç»äº†ä¸€ä¸‹åœ¨vcpuå¤„äºä¸åŒè¿è¡ŒçŠ¶æ€æ—¶æ˜¯å¦‚ä½•è·Ÿposted interrupt ç¡¬ä»¶ä¹‹é—´åŒæ­¥ç›¸å…³ä¿¡æ¯çš„ã€‚ä½†æ˜¯è¿™ç§åŒæ­¥å¹¶ä¸èƒ½ä¿è¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„ä¸€è‡´æ€§ï¼Œå³iommuç¡¬ä»¶å‘å‡º<code>POSTED_INTR_VECTOR</code> æ—¶vcpuå¯èƒ½å¤„äºrootæ¨¡å¼ï¼Œé‚£åœ¨è¿™ç§æƒ…å†µä¸‹è¦å¦‚ä½•å¤„ç†å‘¢ï¼Ÿé¦–å…ˆï¼Œå†…æ ¸æ˜¯æ³¨å†Œäº†è¿™ä¸ªvectorçš„ä¸­æ–­å¤„ç†å‡½æ•°çš„å³ç³»ç»Ÿæ˜¯èƒ½å¤Ÿå“åº”è¿™ä¸ªä¸­æ–­çš„åªæ˜¯è¯´è¿™ä¸ªvectorçš„ä¸­æ–­å¤„ç†å‡½æ•°ä¸ºç©ºï¼›å…¶æ¬¡å½“vcpuå†æ¬¡è¿›å…¥åˆ°vmæ—¶ä¼šå°†pir syncåˆ°virrå½“ä¸­å³ä¸­æ–­ä¹Ÿä¸ä¼šä¸¢ï¼Œå”¯ä¸€å½±å“çš„å¯èƒ½å°±æ˜¯ä¸­æ–­å¤„ç†çš„å®æ—¶æ€§ã€‚</p>
<p>å›åˆ°vmmä¾§å¦‚ä½•é€šè¿‡posted interrupt æœºåˆ¶delivery æ¨¡æ‹Ÿè®¾å¤‡çš„ä¸­æ–­ã€‚ä»¥virtioè®¾å¤‡ä¸ºä¾‹ï¼Œvirtioè®¾å¤‡ä¸»è¦æ˜¯é€šè¿‡irqfdæ¥è§¦å‘ä¸­æ–­(irqfdçš„setupæµç¨‹è¿™é‡Œå°±ä¸ç»†è®²äº†)ï¼Œæ•´ä¸ªä¸­æ–­çš„è§¦å‘æµç¨‹å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="n">irqfd_inject</span><span class="o">-&gt;</span><span class="n">kvm_set_irq</span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">kvm_set_msi</span><span class="o">-&gt;</span><span class="n">kvm_irq_delivery_to_apic</span>
</code></pre></div>

<p>æœ€ç»ˆä¼šè°ƒåˆ° <code>__apic_accept_irq-&gt;deliver_posted_interrupt-&gt;vmx_deliver_posted_interrupt</code></p>
<div class="highlight"><pre><span></span><code>static void vmx_deliver_posted_interrupt(struct kvm_vcpu *vcpu, int vector)
{
        struct vcpu_vmx <span class="gs">*vmx = to_vmx(vcpu);</span>
<span class="gs">        int r;</span>

<span class="gs">        r = vmx_deliver_nested_posted_interrupt(vcpu, vector);</span>
<span class="gs">        if (!r)</span>
<span class="gs">                return;</span>

<span class="gs">        if (pi_test_and_set_pir(vector, vmx-&gt;pi_desc))</span>
<span class="gs">                return;</span>
<span class="gs">        /*</span> If a previous notification has sent the IPI, nothing to do.  */
        if (pi_test_and_set_on(vmx-&gt;pi_desc))
                return;

        if (!kvm_vcpu_trigger_posted_interrupt(vcpu, false))
                kvm_vcpu_kick(vcpu);
}
</code></pre></div>

<p>çœ‹ä¸€ä¸‹ä¸Šé¢å‡½æ•°çš„å…·ä½“å®ç°ï¼šå¦‚æœæ˜¯nestedæ¨¡å¼ä¸‹åˆ™èµ°nested posted interruptï¼Œæ¥ç€åœ¨è½¯ä»¶ä¾§æ¨¡ä»¿pi ç¡¬ä»¶çš„ç›¸å…³æ“ä½œå¦‚è®¾ç½®pirï¼Œç½®onä½ï¼›å¦‚æœè¿™ä¸¤ä¸ªéƒ½å·²ç»è®¾ç½®è¿‡äº†åˆ™è¯´æ˜å·²ç»æœ‰ä¸€ä¸ªä¸­æ–­æµç¨‹åœ¨è¿›è¡Œå½“ä¸­äº†(irqfdæ˜¯å¯ä»¥è¿ç»­è§¦å‘çš„)ï¼Œæ¥ç€çœ‹ä¸€ä¸‹<code>kvm_vcpu_trigger_posted_interrupt</code> </p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">kvm_vcpu_trigger_posted_interrupt</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kvm_vcpu</span><span class="w"> </span><span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
<span class="w">                                                     </span><span class="kt">bool</span><span class="w"> </span><span class="n">nested</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SMP</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">pi_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nested</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">POSTED_INTR_NESTED_VECTOR</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">POSTED_INTR_VECTOR</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IN_GUEST_MODE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="cm">/*</span>
<span class="cm">                 * The vector of interrupt to be delivered to vcpu had</span>
<span class="cm">                 * been set in PIR before this function.</span>
<span class="cm">                 *</span>
<span class="cm">                 * Following cases will be reached in this block, and</span>
<span class="cm">                 * we always send a notification event in all cases as</span>
<span class="cm">                 * explained below.</span>
<span class="cm">                 *</span>
<span class="cm">                 * Case 1: vcpu keeps in non-root mode. Sending a</span>
<span class="cm">                 * notification event posts the interrupt to vcpu.</span>
<span class="cm">                 *</span>
<span class="cm">                 * Case 2: vcpu exits to root mode and is still</span>
<span class="cm">                 * runnable. PIR will be synced to vIRR before the</span>
<span class="cm">                 * next vcpu entry. Sending a notification event in</span>
<span class="cm">                 * this case has no effect, as vcpu is not in root</span>
<span class="cm">                 * mode.</span>
<span class="cm">                 *</span>
<span class="cm">                 * Case 3: vcpu exits to root mode and is blocked.</span>
<span class="cm">                 * vcpu_block() has already synced PIR to vIRR and</span>
<span class="cm">                 * never blocks vcpu if vIRR is not cleared. Therefore,</span>
<span class="cm">                 * a blocked vcpu here does not wait for any requested</span>
<span class="cm">                 * interrupts in PIR, and sending a notification event</span>
<span class="cm">                 * which has no effect is safe here.</span>
<span class="cm">                 */</span>

<span class="w">                </span><span class="n">apic</span><span class="o">-&gt;</span><span class="n">send_IPI_mask</span><span class="p">(</span><span class="n">get_cpu_mask</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">),</span><span class="w"> </span><span class="n">pi_vec</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>å‡½æ•°å½“ä¸­çš„æ³¨é‡Šå·²ç»è¯´çš„æ¯”è¾ƒæ¸…æ¥šï¼Œè¿™é‡Œç®€å•è¯´å‡ å¥ã€‚å¦‚æœç›®æ ‡vcpuåœ¨non-rootæ¨¡å¼ï¼Œåˆ™é€šè¿‡ç»™è¯¥vcpuæ‰€åœ¨çš„ç‰©ç†cpuå‘é€<code>POSTED_INTR_VECTOR</code>(æ¨¡æ‹Ÿpiç¡¬ä»¶çš„è¡Œä¸º) ï¼Œç„¶ååœ¨non-rootæ¨¡å¼ä¸‹å°†ä¸­æ–­å¤„ç†æ‰ã€‚å¦‚æœvcpuåœ¨rootæ¨¡å¼ï¼Œåˆ™é€šè¿‡<code>kvm_vcpu_kick</code>å°†vcpuå”¤é†’ï¼Œç„¶åvcpuåœ¨vmentryçš„è¿‡ç¨‹ä¸­ä¼šå°†ä¸­æ–­å¤„ç†æ‰ï¼Œå…·ä½“å¯ä»¥ä»”ç»†é˜…è¯»ä¸€ä¸‹è¿™ä¸ªå‡½æ•°<code>kvm_x86_ops-&gt;sync_pir_to_irr</code> ã€‚</p>
<h4>æ€»ç»“å’Œæ‰©å±•</h4>
<p>posted interrupt æœºåˆ¶æå‡äº†è™šæ‹ŸåŒ–åœºæ™¯ä¸‹ç›´é€šè®¾å¤‡çš„ä¸­æ–­æ³¨å…¥æ•ˆç‡ï¼ŒåŒæ—¶åˆ©ç”¨è¿™ç§æœºåˆ¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å‡å°‘å…¶ä»–ä¸­æ–­åœºæ™¯çš„å¼€é”€ï¼Œæ¯”å¦‚å­—èŠ‚è™šæ‹ŸåŒ–åŒå­¦åŸºäºposted interruptæœºåˆ¶æå‡ºçš„pvipiæ–¹æ¡ˆï¼Œå…¶æ€§èƒ½æ¯”ç›®å‰intel çš„ipi virtualizaion æ€§èƒ½è¦å¥½å¾ˆå¤šã€‚å½“ç„¶ï¼Œè¿˜æœ‰å…¶ä»–ä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„ç©æ³•ï¼Œåé¢æœ‰æœºä¼šæˆ‘ä»¬ä¹Ÿä¼šå¯¹å¤–exposeã€‚</p>
<h5>Reference</h5>
<ul>
<li>Minimizing VMExits in Private Cloud by Aggressive PV IPI and Passthrough Timer - Qiao Hua &amp; Zhou Yibo, ByteDance</li>
<li>https://patchwork.kernel.org/project/kvm/patch/0C23CC2D-B770-43D0-8215-20CE591F2E8F@bytedance.com/</li>
</ul>

                <!-- å›¾ç‰‡ç”»å»Š -->
            </main>

        <!-- æ–‡ç« åº•éƒ¨åŒºåŸŸ -->
        <footer class="article-footer">
            <!-- æ ‡ç­¾åŒºåŸŸ -->
            <div class="article-tags-section">
                <h4>ğŸ·ï¸ ç›¸å…³æ ‡ç­¾</h4>
                <div class="tags-cloud">
                    <span class="tag-cloud-item">iommu</span>
                    <span class="tag-cloud-item">interrupt posting</span>
                </div>
            </div>

            <!-- åˆ†äº«å’Œäº’åŠ¨ -->
            <div class="article-interaction">
                <div class="social-share">
                    <h4>ğŸ”— åˆ†äº«è¿™ç¯‡æ–‡ç« </h4>
                    <div class="share-buttons">
                        <a href="#" class="share-btn twitter" target="_blank">ğ• Twitter</a>
                        <a href="#" class="share-btn weibo" target="_blank">ğŸ“ å¾®åš</a>
                        <a href="#" class="share-btn linkedin" target="_blank">ğŸ’¼ LinkedIn</a>
                    </div>
                </div>
            </div>

            <!-- ä½œè€…ç­¾åæ¡£ -->
            <div class="author-signature">
                <div class="signature-content">
                    <h4>å…³äºä½œè€…</h4>
                    <p><strong>å‘¨å®œæ³¢</strong>ï¼Œå­—èŠ‚è·³åŠ¨ç«å±±å¼•æ“AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆï¼Œä¸“æ³¨AI Agentã€GPUæ± åŒ–ã€LLMæ¨ç†ä¼˜åŒ–ç­‰å‰æ²¿æŠ€æœ¯ã€‚</p>
                    <div class="author-social">
                        <a href="https://twitter.com/zhyblife99" target="_blank">ğ• Twitter</a>
                        <span class="wechat-hint">ğŸ’¬ å…³æ³¨å¾®ä¿¡å…¬ä¼—å·è·å–æ›´å¤šå†…å®¹</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <aside class="article-sidebar">
        <!-- æ–‡ç« ä¿¡æ¯å¡ç‰‡ -->
        <div class="sidebar-card article-info-card">
            <h3>ğŸ“Š æ–‡ç« ä¿¡æ¯</h3>
            <div class="info-list">
                <div class="info-item">
                    <span class="info-label">å‘å¸ƒæ—¶é—´</span>
                    <span class="info-value">äºŒ 26 å››æœˆ 2022</span>
                </div>
                <div class="info-item">
                    <span class="info-label">åˆ†ç±»</span>
                    <span class="info-value">articles</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¢„è®¡é˜…è¯»</span>
                    <span class="info-value">~10 åˆ†é’Ÿ</span>
                </div>
            </div>
        </div>

        <!-- ç›¸å…³æ–‡ç« æ¨è -->
        <div class="sidebar-card related-articles-card">
            <h3>ğŸ“š ç›¸å…³æ–‡ç« </h3>
            <div class="related-list">
            </div>
        </div>

        <!-- æŠ€æœ¯æ ˆå±•ç¤º -->
        <div class="sidebar-card skills-card">
            <h3>ğŸš€ æŠ€æœ¯æ ˆ</h3>
            <div class="skills-list">
                <span class="skill-item">AI Agent</span>
                <span class="skill-item">GPUæ± åŒ–</span>
                <span class="skill-item">LLMæ¨ç†ä¼˜åŒ–</span>
                <span class="skill-item">é«˜æ€§èƒ½è™šæ‹ŸåŒ–</span>
            </div>
        </div>

        <!-- å…³æ³¨å…¬ä¼—å· -->
        <div class="sidebar-card wechat-card">
            <h3>ğŸ”” è®¢é˜…æ›´æ–°</h3>
            <div class="wechat-content">
                <p>æ‰«ç å…³æ³¨å¾®ä¿¡å…¬ä¼—å·</p>
                <img src="./images/qrcode.jpg" alt="å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç " class="sidebar-qrcode">
                <p class="wechat-name">KernelNote</p>
            </div>
        </div>
    </aside>
</div>

<!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
<button class="back-to-top" id="backToTop">
    <span>â†‘</span>
</button>

<script>
// è¿”å›é¡¶éƒ¨åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const backToTop = document.getElementById('backToTop');

    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTop.style.display = 'block';
        } else {
            backToTop.style.display = 'none';
        }
    });

    // ç‚¹å‡»è¿”å›é¡¶éƒ¨
    backToTop.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // ç›®å½•é«˜äº®
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = document.querySelectorAll('.article-content h2, .article-content h3, .article-content h4');

    function updateTocHighlight() {
        let current = '';
        headings.forEach((heading, index) => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100) {
                current = heading.id;
            }
        });

        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#' + current) {
                link.classList.add('active');
            }
        });
    }

    if (tocLinks.length > 0) {
        window.addEventListener('scroll', updateTocHighlight);
        updateTocHighlight();
    }

    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®å½•é¡¹
    tocLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});
</script>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>        <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>
    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>