<!DOCTYPE html>
<html lang="zh_cn">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="duma" />

        <meta name="description" content="åºè¨€ qemu çš„å¼ºå¤§ä¸ä»…åœ¨äºå…¶èƒ½å¤Ÿæ¨¡æ‹Ÿå„ç§å„æ ·çš„è®¾å¤‡å¦‚cpuã€å†…å­˜ã€ç½‘å¡ã€ç£ç›˜ç­‰ï¼Œè€Œä¸”è¿˜åœ¨äºå®ƒç²¾å¦™çš„æ¶æ„æ¨¡å¼ä¹Ÿç§°ä¸ºqemu object model â€¦
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="qemu, virtio, articles, " />
        <title>æ·±å…¥ç†è§£qemu QOMä¹‹virtioè®¾å¤‡åˆå§‹åŒ–  Â· KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link href="https://kernelnote.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢ - Full Atom Feed" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LRRMJ08SPD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LRRMJ08SPD');
</script>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./pages/about.html">about</a></li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<!-- æ–‡ç« å¤´éƒ¨åŒºåŸŸ -->
<header class="article-header">
    <div class="article-header-container">
        <!-- ä½œè€…ä¿¡æ¯åŒºåŸŸ -->
        <div class="article-author-section">
            <img src="./images/wechat.jpeg" alt="å‘¨æ¯…åš" class="author-avatar">
            <div class="author-info">
                <h3 class="author-name">å‘¨å®œæ³¢</h3>
                <p class="author-title">AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆ | AI Agentä¸“å®¶</p>
            </div>
        </div>

        <!-- æ–‡ç« æ ‡é¢˜å’Œå…ƒä¿¡æ¯ -->
        <div class="article-meta-section">
            <h1 class="article-title">
                æ·±å…¥ç†è§£qemu QOMä¹‹virtioè®¾å¤‡åˆå§‹åŒ–
            </h1>

            <div class="article-meta-info">
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“…</span>
                    <time datetime="2022-05-16T00:00:00+08:00">ä¸€ 16 äº”æœˆ 2022</time>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“</span>
                    <span class="category-tag">articles</span>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ·ï¸</span>
                    <span class="article-tag">qemu</span>
                    <span class="article-tag">virtio</span>
                </div>
            </div>

            <!-- å¤šåª’ä½“é“¾æ¥åŒºåŸŸ -->
        </div>
    </div>
</header>

<!-- æ–‡ç« ä¸»ä½“å†…å®¹ -->
<div class="article-container">
    <div class="article-main">
        <!-- æ–‡ç« å†…å®¹ -->
            <main class="article-content article-content-no-toc">
                
                <h4>åºè¨€</h4>
<p>qemu çš„å¼ºå¤§ä¸ä»…åœ¨äºå…¶èƒ½å¤Ÿæ¨¡æ‹Ÿå„ç§å„æ ·çš„è®¾å¤‡å¦‚cpuã€å†…å­˜ã€ç½‘å¡ã€ç£ç›˜ç­‰ï¼Œè€Œä¸”è¿˜åœ¨äºå®ƒç²¾å¦™çš„æ¶æ„æ¨¡å¼ä¹Ÿç§°ä¸ºqemu object modelã€‚è¿™ç§QOMçš„ç¼–ç¨‹æ¨¡å¼æˆ–è€…è¯´æ¡†æ¶ä½¿å¾—å„ä¸ªå¼€å‘è€…éå¸¸æ–¹ä¾¿è€Œä¸”å¿«é€Ÿçš„åœ¨qemuå½“ä¸­æ·»åŠ å„ç§è®¾å¤‡æ¨¡å‹ï¼Œè¿™ç¯‡æ–‡ç« å°±ä»¥kvmè™šæ‹ŸåŒ–å½“ä¸­æœ€å¸¸è§çš„virtioè®¾å¤‡ä¸ºä¾‹æ¥è®²è®²QOMã€‚</p>
<h4>QOMè®²è§£</h4>
<p>qom ä»æœ¬è´¨ä¸Šæ¥è®²å®ƒä»ç„¶æ˜¯ä¸€ä¸ªé¢å‘å¯¹è±¡çš„ç¼–ç¨‹æ¨¡å¼ï¼Œå› ä¸ºqemuæ˜¯cè¯­è¨€æ¥å®ç°çš„ï¼Œæ‰€æ‹Ÿç›¸å…³çš„å¯¹è±¡è½½ä½“éƒ½æ˜¯structureã€‚åœ¨qemuå½“ä¸­ï¼Œæ‰€æœ‰çš„è®¾å¤‡åœ¨ç»è¿‡æŠ½è±¡ä¹‹åéƒ½å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªobjectï¼Œè¿™ä¸ªobjectæœ‰ä¸¤ä¸ªå±æ€§ï¼štypeå’Œobjectclassã€‚objectå’Œobjectclasså¯ä»¥ç†è§£ä¸ºqemuå½“ä¸­æ‰€æœ‰è®¾å¤‡çš„åŸºç±»ï¼Œè€Œtypeåˆ™å®šä¹‰äº†æ¯ç§objectçš„ç›¸å…³åˆå§‹åŒ–çš„å…·ä½“æ–¹å¼ã€‚ä¸‹é¢æˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸€ä¸‹typeçš„æ¨¡æ¿</p>
<div class="highlight"><pre><span></span><code><span class="n">struct</span><span class="w"> </span><span class="n">TypeImpl</span>
<span class="err">{</span>
<span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>

<span class="w">    </span><span class="n">size_t</span><span class="w"> </span><span class="n">class_size</span><span class="p">;</span>

<span class="w">    </span><span class="n">size_t</span><span class="w"> </span><span class="n">instance_size</span><span class="p">;</span>

<span class="w">    </span><span class="n">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">class_init</span><span class="p">)(</span><span class="n">ObjectClass</span><span class="w"> </span><span class="o">*</span><span class="n">klass</span><span class="p">,</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="o">*</span><span class="k">data</span><span class="p">);</span>
<span class="w">    </span><span class="n">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">class_base_init</span><span class="p">)(</span><span class="n">ObjectClass</span><span class="w"> </span><span class="o">*</span><span class="n">klass</span><span class="p">,</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="o">*</span><span class="k">data</span><span class="p">);</span>

<span class="w">    </span><span class="n">void</span><span class="w"> </span><span class="o">*</span><span class="n">class_data</span><span class="p">;</span>

<span class="w">    </span><span class="n">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">instance_init</span><span class="p">)(</span><span class="k">Object</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">);</span>
<span class="w">    </span><span class="n">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">instance_post_init</span><span class="p">)(</span><span class="k">Object</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">);</span>
<span class="w">    </span><span class="n">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">instance_finalize</span><span class="p">)(</span><span class="k">Object</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">);</span>

<span class="w">    </span><span class="n">bool</span><span class="w"> </span><span class="n">abstract</span><span class="p">;</span>

<span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span>
<span class="w">    </span><span class="n">TypeImpl</span><span class="w"> </span><span class="o">*</span><span class="n">parent_type</span><span class="p">;</span>

<span class="w">    </span><span class="n">ObjectClass</span><span class="w"> </span><span class="o">*</span><span class="k">class</span><span class="p">;</span>

<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="n">num_interfaces</span><span class="p">;</span>
<span class="w">    </span><span class="n">InterfaceImpl</span><span class="w"> </span><span class="n">interfaces</span><span class="o">[</span><span class="n">MAX_INTERFACES</span><span class="o">]</span><span class="p">;</span>
<span class="err">}</span><span class="p">;</span>
</code></pre></div>

<p>qemuå½“ä¸­è®¾å¤‡çš„å®ç°ï¼Œä»æœ¬è´¨ä¸Šæ¥è®²å°±æ˜¯å®ç°è¯¥è®¾å¤‡çš„typeå½“ä¸­å¦‚ä¸Šæ‰€ç¤ºçš„ç›¸å…³callbackå‡½æ•°ï¼Œä»¥åŠå®šä¹‰è¯¥è®¾å¤‡å…·ä½“çš„instance(objectçš„å­ç±»)å’Œclass(objectclassçš„å­ç±»)ï¼Œå¦å¤–ä»ä¸Šé¢ä¹Ÿå¯ä»¥çœ‹åˆ°æ¯ä¸ªtypeä¹Ÿéƒ½ä¼šæœ‰è‡ªå·±çš„parentã€‚å¦‚æœåªæ˜¯åŸºäºè¿™äº›ï¼Œå¯èƒ½å„ä½çœ‹å®˜åœ¨è®¤çŸ¥ä¸Šè¿˜æ˜¯æ¯”è¾ƒæ¨¡ç³Šã€‚é‚£ä¸‹é¢æˆ‘ä»¬ä»¥virtio-netè®¾å¤‡ä¸ºä¾‹ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•é€šè¿‡QOMè¿™ä¸ªæ¶æ„åˆå§‹åŒ–èµ·æ¥çš„ã€‚</p>
<h4>QOM classå’Œinstanceåˆå§‹åŒ–</h4>
<p>é¦–å…ˆå¦‚æœè¦ä½¿ç”¨virtio-netåˆ™åœ¨qemuå‘½ä»¤è¡Œé‡Œéœ€è¦åŠ å…¥å¦‚ä¸‹opts sample:</p>
<div class="highlight"><pre><span></span><code><span class="o">-</span><span class="nx">device</span><span class="w"> </span><span class="nx">virtio</span><span class="o">-</span><span class="nx">net</span><span class="o">-</span><span class="nx">pci</span><span class="p">,</span><span class="nx">netdev</span><span class="p">=</span><span class="nx">xx</span><span class="p">,</span><span class="nx">mac</span><span class="p">=</span><span class="nx">xx</span><span class="p">,</span><span class="nx">bus</span><span class="p">=</span><span class="nx">pci</span><span class="m m-Double">.0</span><span class="p">,</span><span class="kd">addr</span><span class="p">=</span><span class="nx">xx</span>
</code></pre></div>

<p>ç„¶ååœ¨ qemu mainçš„å‡½æ•°å½“ä¸­é€šè¿‡å¦‚ä¸‹é€»è¾‘å¯¹ç›¸å…³çš„deviceè¿›è¡Œåˆå§‹åŒ–</p>
<div class="highlight"><pre><span></span><code>qemu_opts_foreach(qemu_find_opts(&quot;device&quot;),
                      device_init_func, NULL, &amp;error_fatal);
</code></pre></div>

<p>æ¥ç€é€šè¿‡<code>device_init_func-&gt;qdev_device_add</code> è¿™ä¸ªè°ƒç”¨æ ˆæ¥è¿›è¡Œè®¾å¤‡åˆå§‹åŒ–ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>qdev_device_add</code>çš„æ ¸å¿ƒçš„é€»è¾‘</p>
<div class="highlight"><pre><span></span><code><span class="n">DeviceClass</span><span class="w"> </span><span class="o">*</span><span class="n">dc</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">driver</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">;</span>
<span class="n">DeviceState</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NULL</span><span class="p">;</span>
<span class="n">BusState</span><span class="w"> </span><span class="o">*</span><span class="n">bus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NULL</span><span class="p">;</span>
<span class="o">......</span><span class="w"> </span>

<span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qemu_opt_get</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;driver&quot;</span><span class="p">);</span>

<span class="o">......</span>

<span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qdev_get_device_class</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="p">,</span><span class="w"> </span><span class="n">errp</span><span class="p">);</span>

<span class="o">........</span>
<span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qemu_opt_get</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;bus&quot;</span><span class="p">);</span>
<span class="o">.......</span>

<span class="w"> </span><span class="o">/*</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">*/</span>
<span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEVICE</span><span class="p">(</span><span class="n">object_new</span><span class="p">(</span><span class="n">driver</span><span class="p">));</span>

<span class="o">.......</span>
</code></pre></div>

<p>æˆ‘ä»¬å…ˆåˆ—ä¸¾ä¸€éƒ¨åˆ†æ ¸å¿ƒå®ç°ï¼Œè¿™é‡Œçš„driverå°±æ˜¯ä¸Šé¢çš„<code>virtio-net-pci</code>ã€‚ä¸ºäº†æ›´å¥½çš„æ¥è¯´æ˜åé¢çš„é€»è¾‘æˆ‘ä»¬å…ˆæŠŠ<code>virtio-net-pci</code>çš„typeï¼Œinstanceï¼Œ classå„è‡ªçš„å…³è”æè¿°ä¸€ä¸‹ã€‚</p>
<ul>
<li>type</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb">----------------------------------------------------------------------------</span><span class="nv">&gt;</span><span class="c">parent</span>
<span class="c">TYPE_VIRTIO_NET_PCI</span><span class="nb">-</span><span class="nv">&gt;</span><span class="c">TYPE_VIRTIO_PCI</span><span class="nb">-</span><span class="nv">&gt;</span><span class="c">TYPE_PCI_DEVICE</span><span class="nb">-</span><span class="nv">&gt;</span><span class="c">TYPE_DEVICE</span><span class="nb">-</span><span class="nv">&gt;</span><span class="c">TYPE_OBJECT</span>
</code></pre></div>

<p>ä¸Šé¢çš„æ¯ä¸€ç§typeéƒ½ä¼šè°ƒç”¨ç›¸åº”çš„typeæ³¨å†Œå‡½æ•°ï¼Œå°†æ‰€åº”çš„type infoæ³¨å†Œåˆ°qemuçš„<code>MODULE_INIT_QOM</code> çš„qlistå½“ä¸­ã€‚è¿˜æ˜¯ä»¥<code>virtio-net-pci</code> ä¸ºä¾‹å­</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">VirtioPCIDeviceTypeInfo</span><span class="w"> </span><span class="n">virtio_net_pci_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">.</span><span class="n">base_name</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="n">TYPE_VIRTIO_NET_PCI</span><span class="p">,</span>
<span class="w">    </span><span class="o">.</span><span class="n">generic_name</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;virtio-net-pci&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="o">.</span><span class="n">transitional_name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;virtio-net-pci-transitional&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="o">.</span><span class="n">non_transitional_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;virtio-net-pci-non-transitional&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="o">.</span><span class="n">instance_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sizeof</span><span class="p">(</span><span class="n">VirtIONetPCI</span><span class="p">),</span>
<span class="w">    </span><span class="o">.</span><span class="n">instance_init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">virtio_net_pci_instance_init</span><span class="p">,</span>
<span class="w">    </span><span class="o">.</span><span class="n">class_init</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">virtio_net_pci_class_init</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">virtio_net_pci_register</span><span class="p">(</span><span class="nb nb-Type">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">virtio_pci_types_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtio_net_pci_info</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>é€šè¿‡virtio_net_pci_registeræ¥è¿›è¡Œä¿¡æ¯æ³¨å†Œï¼Œç„¶åæœ€ç»ˆä¼šè°ƒç”¨ <code>type_init(virtio_net_pci_register)</code> åˆå§‹åŒ–è¿™ä¸ªæ³¨å†Œã€‚è¿™ä¸ª<code>type_init</code>å‡½æ•°ç›¸å½“å…³é”®ï¼Œå…¶å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">#define type_init(function) module_init(function, MODULE_INIT_QOM)</span>

<span class="c1">#define module_init(function, type)                                         \</span>
<span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">))</span><span class="w"> </span><span class="n">do_qemu_init_</span><span class="w"> </span><span class="c1">## function(void)    \</span>
<span class="p">{</span><span class="w">                                                                           </span>\
<span class="w">    </span><span class="n">register_module_init</span><span class="p">(</span><span class="n">function</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">);</span><span class="w">                                   </span>\
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">ModuleTypeList</span><span class="w"> </span><span class="o">*</span><span class="n">find_type</span><span class="p">(</span><span class="n">module_init_type</span><span class="w"> </span><span class="n">type</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">    </span><span class="n">init_lists</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="n">init_type_list</span><span class="o">[</span><span class="n">type</span><span class="o">]</span><span class="p">;</span>
<span class="err">}</span>

<span class="n">void</span><span class="w"> </span><span class="n">register_module_init</span><span class="p">(</span><span class="n">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="n">void</span><span class="p">),</span><span class="w"> </span><span class="n">module_init_type</span><span class="w"> </span><span class="n">type</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">    </span><span class="n">ModuleEntry</span><span class="w"> </span><span class="o">*</span><span class="n">e</span><span class="p">;</span>
<span class="w">    </span><span class="n">ModuleTypeList</span><span class="w"> </span><span class="o">*</span><span class="n">l</span><span class="p">;</span>

<span class="w">    </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_malloc0</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">));</span>
<span class="w">    </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="p">;</span>
<span class="w">    </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>

<span class="w">    </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_type</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>

<span class="w">    </span><span class="n">QTAILQ_INSERT_TAIL</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<span class="err">}</span>
</code></pre></div>

<p><strong>åœ¨cè¯­è¨€é‡Œé¢ï¼Œé€šè¿‡<code>__attribute__((constructor)</code> æ¥ä¿®é¥°çš„ä»£ç æ˜¯å¯ä»¥åœ¨mainå‡½æ•°è¿è¡Œä¹‹å‰æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨qemu mainå‡½æ•°ç›¸å…³é€»è¾‘ä¹‹å‰ä¼šå®Œæˆæ‰€æœ‰typeåœ¨QOM listä¸Šçš„æ³¨å†Œã€‚ç„¶åé€šè¿‡ä¸‹é¢çš„è°ƒç”¨æ ˆå®Œæˆæ‰€æœ‰type çš„å…·ä½“æ³¨å†Œé€»è¾‘(åŒ…å«äº†typeçš„åˆ›å»º)</strong>ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="nx">qemu_init</span><span class="o">-&gt;</span><span class="nx">module_call_init</span><span class="o">-&gt;</span><span class="nx">virtio_net_pci_register</span><span class="o">-&gt;</span><span class="nx">type_register</span>
<span class="w">                                                        </span><span class="o">-&gt;</span><span class="nx">type_register_internal</span>
<span class="w">                                                            </span><span class="o">-&gt;</span><span class="nx">type_new</span>
</code></pre></div>

<ul>
<li>instance</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb">-----------------------------------------</span><span class="c">åŒ…å«</span><span class="nb">----------------------</span><span class="nv">&gt;</span>
<span class="c">VirtIONetPCI</span><span class="nb">-</span><span class="nv">&gt;</span><span class="c">VirtIOPCIProxy</span><span class="nb">-</span><span class="nv">&gt;</span><span class="c">PCIDevice</span><span class="nb">-</span><span class="nv">&gt;</span><span class="c">DeviceState</span><span class="nb">-</span><span class="nv">&gt;</span><span class="c">Object</span>
</code></pre></div>

<ul>
<li>class</li>
</ul>
<p>å…³äºclassè¿™ä¸€å—ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœå­typeæ²¡æœ‰å…·ä½“çš„ç±»åˆ™ç›´æ¥ä½¿ç”¨ parent typeçš„classã€‚</p>
<div class="highlight"><pre><span></span><code><span class="n">VirtioPCIClass</span><span class="o">-&gt;</span><span class="n">PCIDeviceClass</span><span class="o">-&gt;</span><span class="n">DeviceClass</span><span class="o">-&gt;</span><span class="n">ObjectClass</span>
</code></pre></div>

<p>ç†å®Œä»¥ä¸Šçš„é€»è¾‘å…³ç³»ä¹‹åï¼Œæˆ‘ä»¬æ¥ç€ç›¸å…³çš„å®ç°å¾€ä¸‹èµ°ï¼š</p>
<div class="highlight"><pre><span></span><code>dc = qdev_get_device_class(&amp;driver, errp);
</code></pre></div>

<p>æœ‰äº†ä¸Šé¢çš„å…ˆéªŒçŸ¥è¯†è¿™ä¸ªå‡½æ•°çœ‹èµ·æ¥å°±æ¯”è¾ƒå®¹æ˜“ï¼Œå…¶æ ¸å¿ƒé€»è¾‘å°±æ˜¯<strong>é€šè¿‡driverè¿™é‡Œæ˜¯virtio-net-pciæ‰¾åˆ°å…¶æ‰€å±çš„typeï¼Œç„¶åå¯¹typeè¿›è¡Œåˆå§‹åŒ–å¹¶è¿”å›è¿™ä¸ªtypeçš„classã€‚è¿™é‡Œé‡ç‚¹è®²ä¸€ä¸‹<code>type_initialize</code>ï¼Œå®ƒé‡‡ç”¨çš„æ˜¯å¾ªç¯åµŒå¥—é€»è¾‘å…ˆåˆå§‹åŒ–å®Œæˆçš„çˆ¶ç±»ä¹‹åæ‰å®ç°æœ€ç»ˆçš„å­ç±»ã€‚è¿™é‡Œçš„åˆå§‹åŒ–ä¸»è¦<code>class_init</code> å’Œ<code>class_base_init</code>ã€‚è€Œä¸”ä¼šæŠŠåˆå§‹å®Œçš„çˆ¶ç±»çš„å†…å®¹èµ‹ç»™å­ç±»</strong>ï¼Œå…·ä½“èµ‹å€¼é€»è¾‘åœ¨</p>
<div class="highlight"><pre><span></span><code><span class="n">memcpy</span><span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">class_size</span><span class="p">);</span>
</code></pre></div>

<p><strong>æ³¨æ„ï¼Œä¸Šé¢ä¹Ÿæåˆ°å¦‚æœå­typeé‡Œé¢æ²¡æœ‰è®¾ç½®å…·ä½“çš„classï¼Œåˆ™å­typeçš„class_initçš„inputå°±æ˜¯å…¶parent typeçš„classï¼Œæ‰€ä»¥parent typeçš„class_inité‡Œé¢æ‰€åšçš„ä¸€äº›åˆå§‹åŒ–èµ‹å€¼å¯èƒ½ä¼šåœ¨å­typeçš„class_initå‡½æ•°è¢«è¦†ç›–</strong>ã€‚æ¥ç€<code>qdev_device_add</code> æ ¸å¿ƒé€»è¾‘æ¥åˆ°</p>
<div class="highlight"><pre><span></span><code>dev = DEVICE(object_new(driver))
</code></pre></div>

<p>å…ˆçœ‹object_newè¿™ä¸ªå‡½æ•°ï¼Œå…¶å…·ä½“çš„è°ƒç”¨é“¾å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="nx">object_new</span><span class="o">-&gt;</span><span class="nx">object_new_with_type</span><span class="o">-&gt;</span><span class="nx">type_initialize</span>
<span class="w">                                </span><span class="o">-&gt;</span><span class="nx">object_initialize_with_type</span>
</code></pre></div>

<p><code>type_initialize</code> åœ¨ get device classçš„å·²ç»æ‰§è¡Œè¿‡ï¼Œæ‰€ä»¥æœ€ç»ˆå®ç°çš„æ ¸å¿ƒé€»è¾‘åœ¨<code>object_initialize_with_type</code> ã€‚åœ¨è¿™ä¸ªå‡½æ•°å½“ä¸­ä¹Ÿæ˜¯é€šè¿‡å¾ªç¯åµŒå¥—çš„æ–¹å¼æ¥è°ƒç”¨<code>instance_init</code> å’Œ <code>instance_post_init</code>ã€‚</p>
<h4>virtio-net realized</h4>
<p>virtio-netè®¾å¤‡å®ä¾‹åŒ–çš„å®Œæˆæ˜¯é€šè¿‡<code>qdev_device_add</code> å½“ä¸­çš„è¿™ä¸ªå‡½æ•°æ¥è§¦å‘çš„</p>
<div class="highlight"><pre><span></span><code>object_property_set_bool(OBJECT(dev), true, &quot;realized&quot;, &amp;err)
</code></pre></div>

<p>å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å…·ä½“çš„è°ƒç”¨é“¾</p>
<div class="highlight"><pre><span></span><code><span class="n">object_property_set_bool</span><span class="o">-&gt;</span><span class="n">object_property_set_qobject</span><span class="o">-&gt;</span><span class="n">object_property_set</span>

<span class="o">-&gt;</span><span class="n">object_property_find</span><span class="o">-&gt;</span><span class="n">object_class_property_find</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">ObjectProperty</span><span class="w"> </span><span class="o">*</span><span class="n">object_class_property_find</span><span class="p">(</span><span class="n">ObjectClass</span><span class="w"> </span><span class="o">*</span><span class="n">klass</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span>
<span class="w">                                           </span><span class="n">Error</span><span class="w"> </span><span class="o">**</span><span class="n">errp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ObjectProperty</span><span class="w"> </span><span class="o">*</span><span class="n">prop</span><span class="p">;</span>
<span class="w">    </span><span class="n">ObjectClass</span><span class="w"> </span><span class="o">*</span><span class="n">parent_klass</span><span class="p">;</span>

<span class="w">    </span><span class="n">parent_klass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object_class_get_parent</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parent_klass</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object_class_property_find</span><span class="p">(</span><span class="n">parent_klass</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">prop</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_hash_table_lookup</span><span class="p">(</span><span class="n">klass</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error_setg</span><span class="p">(</span><span class="n">errp</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Property &#39;.</span><span class="si">%s</span><span class="s2">&#39; not found&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">prop</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>ä»ä¸Šé¢çš„å®ç°é€»è¾‘æ¥çœ‹ï¼Œä¾ç„¶æ˜¯å¾ªç¯åµŒå¥—é€»è¾‘ä»å­ç±»ä¸€ç›´åˆ°çˆ¶ç±»ï¼Œç›´åˆ°æ‰¾åˆ°æœ‰è®¾ç½®è¿‡nameä¸º"realized" ç‰¹æ€§çš„ç±»ã€‚é€šè¿‡èµ°è¯»ä»£ç å¯ä»¥å‘ç°åœ¨<code>DeviceClass</code> çš„ <code>class_init</code> å‡½æ•°å®ç°é‡Œé¢æ˜¯æœ‰è®¾ç½®è¿‡çš„ï¼Œå…·ä½“å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="n">device_class_init</span><span class="o">-&gt;</span>
<span class="w">    </span><span class="n">object_class_property_add_bool</span><span class="p">(</span><span class="n">class</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;realized&quot;</span><span class="p">,</span>
<span class="w">                                   </span><span class="n">device_get_realized</span><span class="p">,</span><span class="w"> </span><span class="n">device_set_realized</span><span class="p">,</span>
<span class="w">                                   </span><span class="o">&amp;</span><span class="n">error_abort</span><span class="p">);</span>
</code></pre></div>

<p>å› æ­¤å®ç°é€»è¾‘ä¼šç›´æ¥è°ƒç”¨åˆ°<code>device_set_realized</code>ï¼Œè¿™ä¸ªå‡½æ•°å½“ä¸­è°ƒç”¨çš„æ ¸å¿ƒå®ç°ä¸º</p>
<div class="highlight"><pre><span></span><code>DeviceClass *dc = DEVICE_GET_CLASS(dev);

......

dc-&gt;realize(dev, &amp;local_err);
.......
</code></pre></div>

<p>å†æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªrealize callbackå…·ä½“çš„å®ç°ã€‚å†æ¬¡èµ°è¯»ç›¸å…³çš„ä»£ç ï¼Œå¯ä»¥å‘ç°ç›¸å…³çš„realize èµ‹å€¼æœ‰ä¸¤å¤„ï¼šä¸€å¤„æ˜¯åœ¨<code>PCIDeviceClass</code>  çš„ <code>class_init</code> å‡½æ•°</p>
<div class="highlight"><pre><span></span><code><span class="nx">static</span><span class="w"> </span><span class="nx">void</span><span class="w"> </span><span class="nx">pci_device_class_init</span><span class="p">(</span><span class="nx">ObjectClass</span><span class="w"> </span><span class="o">*</span><span class="nx">klass</span><span class="p">,</span><span class="w"> </span><span class="nx">void</span><span class="w"> </span><span class="o">*</span><span class="nx">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nx">DeviceClass</span><span class="w"> </span><span class="o">*</span><span class="nx">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">DEVICE_CLASS</span><span class="p">(</span><span class="nx">klass</span><span class="p">);</span>

<span class="w">    </span><span class="nx">k</span><span class="o">-&gt;</span><span class="nx">realize</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">pci_qdev_realize</span><span class="p">;</span><span class="w">   </span><span class="c1">//realizeå‡½æ•°</span>
<span class="w">    </span><span class="nx">k</span><span class="o">-&gt;</span><span class="nx">unrealize</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">pci_qdev_unrealize</span><span class="p">;</span>
<span class="w">    </span><span class="nx">k</span><span class="o">-&gt;</span><span class="nx">bus_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">TYPE_PCI_BUS</span><span class="p">;</span>
<span class="w">    </span><span class="nx">device_class_set_props</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span><span class="w"> </span><span class="nx">pci_props</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>å¦å¤–ä¸€å¤„åœ¨ <code>VirtioPCIClass</code> çš„<code>class_init</code> å¤„</p>
<div class="highlight"><pre><span></span><code><span class="n">static</span> <span class="n">void</span> <span class="n">virtio_pci_class_init</span><span class="p">(</span><span class="n">ObjectClass</span> <span class="o">*</span><span class="n">klass</span><span class="p">,</span> <span class="n">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DeviceClass</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="n">DEVICE_CLASS</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
    <span class="n">PCIDeviceClass</span> <span class="o">*</span><span class="n">k</span> <span class="o">=</span> <span class="n">PCI_DEVICE_CLASS</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
    <span class="n">VirtioPCIClass</span> <span class="o">*</span><span class="n">vpciklass</span> <span class="o">=</span> <span class="n">VIRTIO_PCI_CLASS</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>

    <span class="n">device_class_set_props</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">virtio_pci_properties</span><span class="p">);</span>
    <span class="n">k</span><span class="o">-&gt;</span><span class="n">realize</span> <span class="o">=</span> <span class="n">virtio_pci_realize</span><span class="p">;</span>
    <span class="n">k</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">=</span> <span class="n">virtio_pci_exit</span><span class="p">;</span>
    <span class="n">k</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_REDHAT_QUMRANET</span><span class="p">;</span>
    <span class="n">k</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">VIRTIO_PCI_ABI_VERSION</span><span class="p">;</span>
    <span class="n">k</span><span class="o">-&gt;</span><span class="n">class_id</span> <span class="o">=</span> <span class="n">PCI_CLASS_OTHERS</span><span class="p">;</span>
    <span class="n">device_class_set_parent_realize</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">virtio_pci_dc_realize</span><span class="p">,</span>
                                    <span class="o">&amp;</span><span class="n">vpciklass</span><span class="o">-&gt;</span><span class="n">parent_dc_realize</span><span class="p">);</span> <span class="o">//</span>
    <span class="n">dc</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">virtio_pci_reset</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><code>device_class_set_parent_realize</code>  çš„æ ¸å¿ƒé€»è¾‘æ˜¯å°†dc çš„realizeèµ‹å€¼ä¸º <code>virtio_pci_dc_realize</code> ï¼Œç„¶åå°†<code>vpciklass-&gt;parent_dc_realize</code>  è®¾ç½®ä¸ºdcçš„åˆå§‹å€¼å³<code>pci_qdev_realize</code> ã€‚</p>
<div class="highlight"><pre><span></span><code>static void virtio_pci_dc_realize(DeviceState <span class="gs">*qdev, Error *</span>*errp)
{
    VirtioPCIClass *vpciklass = VIRTIO_PCI_GET_CLASS(qdev);
    VirtIOPCIProxy *proxy = VIRTIO_PCI(qdev);
    PCIDevice *pci_dev = &amp;proxy-&gt;pci_dev;

    if (!(proxy-&gt;flags &amp; VIRTIO_PCI_FLAG_DISABLE_PCIE) &amp;&amp;
        virtio_pci_modern(proxy)) {
        pci_dev-&gt;cap_present |= QEMU_PCI_CAP_EXPRESS;
    }

    vpciklass-&gt;parent_dc_realize(qdev, errp);
}
</code></pre></div>

<p>ç”±äºçˆ¶ç±»åˆå§‹åŒ–åœ¨å‰å­ç±»åˆå§‹åŒ–åœ¨å(å­ç±»è¦†ç›–äº†çˆ¶ç±»çš„å®ç°)ï¼Œå› æ­¤ <code>virtio-net</code> å®ä¾‹åŒ–çš„è°ƒç”¨é“¾åˆ°ç›®å‰ä¸ºæ­¢å¦‚ä¸‹æ‰€ç¤º</p>
<div class="highlight"><pre><span></span><code><span class="n">device_set_realized</span><span class="o">-&gt;</span><span class="n">virtio_pci_dc_realize</span><span class="o">-&gt;</span><span class="n">pci_qdev_realize</span>
</code></pre></div>

<p>æ¥ç€å¾€ä¸‹çœ‹pci_qdev_realizeçš„æ ¸å¿ƒå®ç°</p>
<div class="highlight"><pre><span></span><code><span class="n">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">pci_qdev_realize</span><span class="p">(</span><span class="n">DeviceState</span><span class="w"> </span><span class="o">*</span><span class="n">qdev</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="o">**</span><span class="n">errp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PCIDevice</span><span class="w"> </span><span class="o">*</span><span class="n">pci_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">PCIDevice</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">qdev</span><span class="p">;</span>
<span class="w">    </span><span class="n">PCIDeviceClass</span><span class="w"> </span><span class="o">*</span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PCI_DEVICE_GET_CLASS</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
<span class="w">    </span><span class="n">ObjectClass</span><span class="w"> </span><span class="o">*</span><span class="n">klass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OBJECT_CLASS</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>

<span class="w">    </span><span class="p">......</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">realize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">realize</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">local_err</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">local_err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">error_propagate</span><span class="p">(</span><span class="n">errp</span><span class="p">,</span><span class="w"> </span><span class="n">local_err</span><span class="p">);</span>
<span class="w">            </span><span class="n">do_pci_unregister_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="p">.......</span>
<span class="p">}</span>
</code></pre></div>

<p>ä¸Šé¢çš„å®ç°å½“ä¸­è°ƒç”¨äº† <code>PCIDeviceClass</code> çš„ <code>realize</code> ï¼Œ å®ƒçš„åˆå§‹åŒ–æ˜¯åœ¨ <code>VirtioPCIClass</code> çš„ <code>class_init</code> åˆå§‹åŒ–çš„</p>
<div class="highlight"><pre><span></span><code><span class="n">k</span><span class="o">-&gt;</span><span class="n">realize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">virtio_pci_realize</span><span class="p">;</span>
</code></pre></div>

<p>æ¥ç€çœ‹<code>virtio_pci_realize</code> çš„å…·ä½“å®ç°</p>
<div class="highlight"><pre><span></span><code>static void virtio_pci_realize(PCIDevice <span class="gs">*pci_dev, Error *</span>*errp)
{
    VirtIOPCIProxy *proxy = VIRTIO_PCI(pci_dev);
    VirtioPCIClass *k = VIRTIO_PCI_GET_CLASS(pci_dev);
    Error *local_err = NULL;
    .......

    if (k-&gt;realize) {
        k-&gt;realize(proxy, &amp;local_err);
        if (local_err) {
            goto out;
        }
    }

    .......
}
</code></pre></div>

<p>å…¶è°ƒç”¨çš„æ˜¯<code>VirtioPCIClass</code> çš„ <code>realize</code> å®ç°ï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„èµ‹å€¼æ˜¯åœ¨<code>virtio_net_pci_class_init</code>  é‡Œé¢å®Œæˆçš„ï¼Œå…¶callbackä¸º<code>virtio_net_pci_realize</code> ã€‚</p>
<div class="highlight"><pre><span></span><code>static void virtio_net_pci_realize(VirtIOPCIProxy <span class="gs">*vpci_dev, Error *</span>*errp)
{
    DeviceState *qdev = DEVICE(vpci_dev);
    VirtIONetPCI *dev = VIRTIO_NET_PCI(vpci_dev);
    DeviceState *vdev = DEVICE(&amp;dev-&gt;vdev);
    PCIDevice *pci_dev = &amp;vpci_dev-&gt;pci_dev;
    VirtIONet *net = &amp;dev-&gt;vdev;

    ......

    object_property_set_bool(OBJECT(vdev), &quot;realized&quot;, true, errp);

    .......
}
</code></pre></div>

<p>åˆçœ‹åˆ°è¿™ä¸ªæ¯”è¾ƒç†Ÿæ‚‰çš„å‡½æ•°äº†<code>object_property_set_bool</code>ï¼Œ å…ˆæ¥çœ‹è¿™ä¸ªvdevä¹Ÿå°±æ˜¯ <code>VirtIONet</code>  ç›¸å…³QOMç»“æ„ã€‚</p>
<ul>
<li>type</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb">------------------------------------------------------------------------</span><span class="nv">&gt;</span><span class="c">parent</span>
<span class="c">TYPE_VIRTIO_NET</span><span class="nb">-</span><span class="nv">&gt;</span><span class="c">TYPE_VIRTIO_DEVICE</span><span class="nb">-</span><span class="nv">&gt;</span><span class="c">TYPE_DEVICE</span><span class="nb">-</span><span class="nv">&gt;</span><span class="c">TYPE_OBJECT</span>
</code></pre></div>

<ul>
<li>class</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb">----------------------------------------------------------------</span><span class="nv">&gt;</span>
<span class="c">VirtioDeviceClass</span><span class="nb">-</span><span class="nv">&gt;</span><span class="c">DeviceClass</span><span class="nb">-</span><span class="nv">&gt;</span><span class="c">ObjectClass</span>
</code></pre></div>

<ul>
<li>instance</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="o">----------------------------------------------------------&gt;</span><span class="err">åŒ…å«</span>
<span class="n">VirtIONet</span><span class="o">-&gt;</span><span class="n">VirtIODevice</span><span class="o">-&gt;</span><span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">Object</span>
</code></pre></div>

<p>åœ¨ <code>object_property_set_bool</code> çš„å…·ä½“å®ç°å½“ä¸­ä¼šå¯¹ä¸Šé¢æ‰€åˆ—ä¸¾çš„classè¿›è¡Œinitï¼Œé‚£instanceæ˜¯åœ¨å“ªé‡Œinitçš„å‘¢ï¼Ÿå¦‚æœä½ ä»”ç»†çš„é˜…è¯»è¿‡<code>virtio-net-pci</code> ç›¸å…³åˆå§‹åŒ–ä»£ç ï¼Œä½ ä¼šå‘ç°å®ƒæ˜¯åœ¨è¿™é‡Œé¢å®Œæˆçš„ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">virtio_net_pci_instance_init</span><span class="o">-&gt;</span><span class="n">virtio_instance_init_common</span><span class="o">-&gt;</span><span class="n">object_initialize_child</span><span class="o">-&gt;</span><span class="n">object_initialize</span>
</code></pre></div>

<p>ç†æ¸…virtio-netçš„classå’Œinstanceçš„åˆå§‹åŒ–ä¹‹åï¼Œæ¥ç€çœ‹<code>realize</code> å‡½æ•°çš„è°ƒç”¨ã€‚å…¶å…¥å£è¿˜æ˜¯åœ¨<code>device_set_realized</code> å‡½æ•°ï¼Œç´§æ¥ç€å®ƒä¼šè°ƒç”¨<code>dc-&gt;realize</code> å‡½æ•°å³<code>virtio_device_realize</code> ï¼Œç„¶åä¼šå†è°ƒåˆ°<code>VirtioDeviceClass</code>çš„å…·ä½“å®ç°å‡½æ•°å³<code>vdc-&gt;realize</code>å…·ä½“å‡½æ•°ä¸º<code>virtio_net_device_realize</code> ã€‚æ•…æ•´ä½“è°ƒç”¨é“¾å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="n">device_set_realized</span><span class="o">-&gt;</span><span class="n">virtio_device_realize</span><span class="o">-&gt;</span><span class="n">virtio_net_device_realize</span>
</code></pre></div>

<h4>æ€»ç»“</h4>
<p>qemu QOMçš„è™½ç„¶ç²¾å¦™ï¼Œä½†æ˜¯ç†è§£å’Œåˆ†æèµ·æ¥ç¡®å®ä¸å¤ªå®¹æ˜“ã€‚å»ºè®®å¤§å®¶ä»”ç»†å“ä¸€ä¸‹ä¸Šé¢çš„åˆ†æã€‚åŒæ—¶ï¼Œä¸ºäº†è®©å¤§å®¶æ›´å¥½çš„æ›´å¥½ç†è§£QOMï¼Œåç»­ä¹Ÿä¼šæœ‰æ›´å¤šè¿™æ–¹é¢çš„æ–‡ç« åˆ†äº«ç»™å¤§å®¶ã€‚</p>

                <!-- å›¾ç‰‡ç”»å»Š -->
            </main>

        <!-- æ–‡ç« åº•éƒ¨åŒºåŸŸ -->
        <footer class="article-footer">
            <!-- æ ‡ç­¾åŒºåŸŸ -->
            <div class="article-tags-section">
                <h4>ğŸ·ï¸ ç›¸å…³æ ‡ç­¾</h4>
                <div class="tags-cloud">
                    <span class="tag-cloud-item">qemu</span>
                    <span class="tag-cloud-item">virtio</span>
                </div>
            </div>

            <!-- åˆ†äº«å’Œäº’åŠ¨ -->
            <div class="article-interaction">
                <div class="social-share">
                    <h4>ğŸ”— åˆ†äº«è¿™ç¯‡æ–‡ç« </h4>
                    <div class="share-buttons">
                        <a href="#" class="share-btn twitter" target="_blank">ğ• Twitter</a>
                        <a href="#" class="share-btn weibo" target="_blank">ğŸ“ å¾®åš</a>
                        <a href="#" class="share-btn linkedin" target="_blank">ğŸ’¼ LinkedIn</a>
                    </div>
                </div>
            </div>

            <!-- ä½œè€…ç­¾åæ¡£ -->
            <div class="author-signature">
                <div class="signature-content">
                    <h4>å…³äºä½œè€…</h4>
                    <p><strong>å‘¨å®œæ³¢</strong>ï¼Œå­—èŠ‚è·³åŠ¨ç«å±±å¼•æ“AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆï¼Œä¸“æ³¨AI Agentã€GPUæ± åŒ–ã€LLMæ¨ç†ä¼˜åŒ–ç­‰å‰æ²¿æŠ€æœ¯ã€‚</p>
                    <div class="author-social">
                        <a href="https://twitter.com/zhyblife99" target="_blank">ğ• Twitter</a>
                        <span class="wechat-hint">ğŸ’¬ å…³æ³¨å¾®ä¿¡å…¬ä¼—å·è·å–æ›´å¤šå†…å®¹</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <aside class="article-sidebar">
        <!-- æ–‡ç« ä¿¡æ¯å¡ç‰‡ -->
        <div class="sidebar-card article-info-card">
            <h3>ğŸ“Š æ–‡ç« ä¿¡æ¯</h3>
            <div class="info-list">
                <div class="info-item">
                    <span class="info-label">å‘å¸ƒæ—¶é—´</span>
                    <span class="info-value">ä¸€ 16 äº”æœˆ 2022</span>
                </div>
                <div class="info-item">
                    <span class="info-label">åˆ†ç±»</span>
                    <span class="info-value">articles</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¢„è®¡é˜…è¯»</span>
                    <span class="info-value">~10 åˆ†é’Ÿ</span>
                </div>
            </div>
        </div>

        <!-- ç›¸å…³æ–‡ç« æ¨è -->
        <div class="sidebar-card related-articles-card">
            <h3>ğŸ“š ç›¸å…³æ–‡ç« </h3>
            <div class="related-list">
            </div>
        </div>

        <!-- æŠ€æœ¯æ ˆå±•ç¤º -->
        <div class="sidebar-card skills-card">
            <h3>ğŸš€ æŠ€æœ¯æ ˆ</h3>
            <div class="skills-list">
                <span class="skill-item">AI Agent</span>
                <span class="skill-item">GPUæ± åŒ–</span>
                <span class="skill-item">LLMæ¨ç†ä¼˜åŒ–</span>
                <span class="skill-item">é«˜æ€§èƒ½è™šæ‹ŸåŒ–</span>
            </div>
        </div>

        <!-- å…³æ³¨å…¬ä¼—å· -->
        <div class="sidebar-card wechat-card">
            <h3>ğŸ”” è®¢é˜…æ›´æ–°</h3>
            <div class="wechat-content">
                <p>æ‰«ç å…³æ³¨å¾®ä¿¡å…¬ä¼—å·</p>
                <img src="./images/qrcode.jpg" alt="å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç " class="sidebar-qrcode">
                <p class="wechat-name">KernelNote</p>
            </div>
        </div>
    </aside>
</div>

<!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
<button class="back-to-top" id="backToTop">
    <span>â†‘</span>
</button>

<script>
// è¿”å›é¡¶éƒ¨åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const backToTop = document.getElementById('backToTop');

    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTop.style.display = 'block';
        } else {
            backToTop.style.display = 'none';
        }
    });

    // ç‚¹å‡»è¿”å›é¡¶éƒ¨
    backToTop.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // ç›®å½•é«˜äº®
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = document.querySelectorAll('.article-content h2, .article-content h3, .article-content h4');

    function updateTocHighlight() {
        let current = '';
        headings.forEach((heading, index) => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100) {
                current = heading.id;
            }
        });

        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#' + current) {
                link.classList.add('active');
            }
        });
    }

    if (tocLinks.length > 0) {
        window.addEventListener('scroll', updateTocHighlight);
        updateTocHighlight();
    }

    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®å½•é¡¹
    tocLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});
</script>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>        <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>
    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>