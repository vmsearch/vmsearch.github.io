<!DOCTYPE html>
<html lang="zh_cn">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="duma" />

        <meta name="description" content="åºè¨€ iommuç³»åˆ—äºŒä¸»è¦ä»‹ç»äº†dma remappingçš„å·¥ä½œåŸç†ï¼Œè¿™ä¸€ç¯‡æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹iommu ä¸­æ–­é‡æ˜ å°„çš„featureåœ¨è™šæ‹ŸåŒ–åœºæ™¯å’Œéè™šæ‹ŸåŒ–åœºæ™¯ä¸‹æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ åº•å±‚ç¡¬ä»¶å·¥ä½œåŸç† è°ˆåˆ°ä¸­æ–­å¤§å®¶å¯èƒ½ä¸å¤ªä¼šç›´æ¥è”æƒ³åˆ°iommuè¿™ä¸ªç¡¬ä»¶ï¼Œè€Œäº‹å® â€¦
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="iommu, interrupt remapping, articles, " />
        <title>æ·±å…¥äº†è§£iommuç³»åˆ—ä¸‰ï¼šinterrupt remapping åº•å±‚ç¡¬ä»¶å·¥ä½œåŸç†å’Œé©±åŠ¨åˆå§‹åŒ–  Â· KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link href="https://kernelnote.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢ - Full Atom Feed" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LRRMJ08SPD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LRRMJ08SPD');
</script>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./pages/about.html">about</a></li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<!-- æ–‡ç« å¤´éƒ¨åŒºåŸŸ -->
<header class="article-header">
    <div class="article-header-container">
        <!-- ä½œè€…ä¿¡æ¯åŒºåŸŸ -->
        <div class="article-author-section">
            <img src="./images/wechat.jpeg" alt="å‘¨æ¯…åš" class="author-avatar">
            <div class="author-info">
                <h3 class="author-name">å‘¨å®œæ³¢</h3>
                <p class="author-title">AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆ | AI Agentä¸“å®¶</p>
            </div>
        </div>

        <!-- æ–‡ç« æ ‡é¢˜å’Œå…ƒä¿¡æ¯ -->
        <div class="article-meta-section">
            <h1 class="article-title">
                æ·±å…¥äº†è§£iommuç³»åˆ—ä¸‰ï¼šinterrupt remapping åº•å±‚ç¡¬ä»¶å·¥ä½œåŸç†å’Œé©±åŠ¨åˆå§‹åŒ–
            </h1>

            <div class="article-meta-info">
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“…</span>
                    <time datetime="2022-02-15T00:00:00+08:00">äºŒ 15 äºŒæœˆ 2022</time>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“</span>
                    <span class="category-tag">articles</span>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ·ï¸</span>
                    <span class="article-tag">iommu</span>
                    <span class="article-tag">interrupt remapping</span>
                </div>
            </div>

            <!-- å¤šåª’ä½“é“¾æ¥åŒºåŸŸ -->
        </div>
    </div>
</header>

<!-- æ–‡ç« ä¸»ä½“å†…å®¹ -->
<div class="article-container">
    <div class="article-main">
        <!-- æ–‡ç« å†…å®¹ -->
            <main class="article-content article-content-no-toc">
                
                <h3>åºè¨€</h3>
<p>iommuç³»åˆ—äºŒä¸»è¦ä»‹ç»äº†dma remappingçš„å·¥ä½œåŸç†ï¼Œè¿™ä¸€ç¯‡æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹iommu ä¸­æ–­é‡æ˜ å°„çš„featureåœ¨è™šæ‹ŸåŒ–åœºæ™¯å’Œéè™šæ‹ŸåŒ–åœºæ™¯ä¸‹æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>
<h3>åº•å±‚ç¡¬ä»¶å·¥ä½œåŸç†</h3>
<p>è°ˆåˆ°ä¸­æ–­å¤§å®¶å¯èƒ½ä¸å¤ªä¼šç›´æ¥è”æƒ³åˆ°iommuè¿™ä¸ªç¡¬ä»¶ï¼Œè€Œäº‹å®ä¸Šåœ¨è™šæ‹ŸåŒ–æœªå‡ºç°ä¹‹å‰ä¸­æ–­çš„å¤„ç†ç¡®å®ä¸éœ€è¦iommuçš„å‚ä¸ã€‚interrupt remapping of iommuçš„å¼•å…¥ä¸»è¦æ˜¯ä¸ºäº†è§£å†³è™šæ‹ŸåŒ–åœºæ™¯ç›´é€šè®¾å¤‡çš„ä¸­æ–­æŠ•é€’é—®é¢˜ï¼Œç”±äºiommuçš„æœ€é‡è¦çš„åŠŸèƒ½æ˜¯dmaå¤„ç†ï¼Œå› æ­¤åœ¨interrupt  remapping enableçš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿå½“ä¸­æ‰€æœ‰ä»¥message signal çš„å½¢å¼æ¥è§¦å‘çš„ä¸­æ–­éƒ½æ˜¯éœ€è¦iommuæ¥å¤„ç†çš„ã€‚æˆ–è€…æœ‰äººä¼šé—®ä¸ºä»€ä¹ˆæ˜¯message singal interrupt(msi æˆ–è€…msix)å‘¢ï¼Ÿå› ä¸ºæ‰€æœ‰çš„msiä¸­æ–­æœ€åº•å±‚çš„å®ç°æ–¹å¼æ˜¯å¾€ç‰¹å®šçš„åœ°å€(0xFEEX_XXXXh)è§¦å‘ä¸€ä¸ªdma writeæ“ä½œï¼Œiommuä¹Ÿæ˜¯é€šè¿‡0xFEE è¿™ä¸ªprefixæ¥åˆ¤æ–­æŸä¸ªdma write æ˜¯å¦æ˜¯ä¸€ä¸ªä¸­æ–­è¯·æ±‚ã€‚å¼•å…¥äº†iommuä¹‹åï¼Œç³»ç»Ÿå½“ä¸­pcieæˆ–è€…pciè®¾å¤‡ï¼Œioapicï¼Œhpet(æœ‰äº›å¹³å°hpetæ˜¯æ”¯æŒmsiä¸­æ–­çš„)ç­‰è¿™äº›è®¾å¤‡çš„msi or msixä¸­æ–­è¯·æ±‚éƒ½ä¼šç»è¿‡iommuè¿›è¡Œå¤„ç†ã€‚</p>
<p>ä¸ºäº†è®©å¤§å®¶æ›´å¥½çš„ç†è§£interrupt remappingçš„å·¥ä½œæœºåˆ¶ï¼Œæˆ‘ä»¬å¯¹æ¯”ä¸€ä¸‹ç›¸å…³è®¾å¤‡åœ¨remappingå’Œéremappingè¿™ä¸¤ç§æ¨¡å¼ä¸‹çš„ä¸­æ–­æŠ•é€’å’Œå¤„ç†æ–¹å¼(è¿™ä¸¤ç§æ–¹å¼çš„å¯¹æ¯”éƒ½æ˜¯åœ¨ç³»ç»Ÿå¼•å…¥äº†iommuçš„èƒŒæ™¯ä¸‹)ã€‚é¦–å…ˆä»‹ç»ä¸€ä¸‹ioapicï¼Œioapicåœ¨ç³»ç»Ÿç¡¬ä»¶æ¶æ„å½“ä¸­æ‰€å¤„çš„ä½ç½®å¦‚å›¾1æ‰€ç¤ºï¼š</p>
<p><img alt="ioapic" src="images/ioapic.png"></p>
<p><center> å›¾1</center>
é€šå¸¸æƒ…å†µä¸‹æ“ä½œç³»ç»Ÿæ˜¯é€šè¿‡acpiè¡¨æ¥å‘ç°ioapicçš„ï¼Œå½“ç„¶æœ‰äº›å¹³å°ä¹Ÿå·²ç»æ”¯æŒé€šè¿‡pcieåè®®æ¥å‘ç°ioapicï¼Œå…¶ä»–å¤–è®¾æ¯”å¦‚å¤§éƒ¨åˆ†çš„legacyè®¾å¤‡çš„ä¸­æ–­éƒ½æ˜¯éœ€è¦é€šè¿‡ioapicè¿›è¡Œè·¯ç”±ï¼Œé‚£ä¹ˆä¸åŒè®¾å¤‡çš„ä¸­æ–­æ˜¯å¦‚ä½•é€šè¿‡ioapicæŠ•é€’çš„å‘¢ï¼ŸåŸæ¥ioapicç»´æŠ¤äº†ä¸€ä¸ªredirection tableï¼Œå½“æŸä¸ªè®¾å¤‡ä¸­æ–­åˆ°è¾¾ioapicæ—¶ï¼Œå®ƒä¼šæ ¹æ®Redirection Tableæ ¼å¼åŒ–å‡ºä¸€ä¸ªmessage  signal interrupt å‘å¾€ç›¸åº”çš„cpuã€‚å…·ä½“çš„redirection table entryçš„æ ¼å¼å¦‚ä¸‹ï¼š</p>
<p><img alt="ioapic_redirection_table" src="images/ioapic_redirection_table.png"></p>
<p><center> å›¾2 </center> </p>
<p>æ¥ç€æˆ‘ä»¬çœ‹ä¸€ä¸‹åœ¨interrupt remapping enableçš„åœºæ™¯ä¸‹ï¼Œioapicçš„redirection table entryçš„æ ¼å¼æ˜¯ä»€ä¹ˆæ ·çš„ã€‚</p>
<p><img alt="rte_remapping" src="images/rte_remapping.png"></p>
<p><center>å›¾3</center></p>
<p>é€šè¿‡å›¾2å’Œå›¾3çš„å¯¹æ¯”æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°ä¸€äº›ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œè¿™é‡Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹RTEåœ¨interrupt remapping æ¨¡å¼ä¸‹æ–°å¼•å…¥çš„ä¸€äº›å­—æ®µè¯´æ˜ï¼š</p>
<ul>
<li>bits 49:63 å¯¹åº”çš„æ˜¯<strong>interrupt_index[14:0]</strong>ï¼Œbit 11å¯¹åº”çš„æ˜¯<strong>interrup_index[15]</strong> å³ç¬¬15ä½ï¼Œå…³äºè¿™ä¸ª16bitsçš„interrupt_indexåé¢ä¼šè¯¦ç»†è¯´æ˜</li>
<li>bit 48è¡¨ç¤ºæ˜¯å¦ä¸ºremappingçš„ä¸­æ–­æ ¼å¼ï¼Œæ‰€ä»¥å¿…é¡»è¦ç½®1</li>
<li>bits 10:8 è¡¨ç¤º<strong>SHV(SubHandle Valid)</strong>ï¼Œå¼ºåˆ¶è®¾ç½®ä¸º000bè¡¨ç¤ºSHVä¸å¯ç”¨ã€‚å…³äºSHVåé¢ä¹Ÿä¼šè®²åˆ°
è‡³äºå…¶ä»–ä¸¤ç§æ¨¡å¼éƒ½æœ‰çš„å­—æ®µæ¯”å¦‚vector, Trigger Mode, delivery statusç­‰éœ€è¦å¯¹é½ã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘æ¥çœ‹ä¸€ä¸‹pciæˆ–è€…pcieè®¾å¤‡çš„msi or msix ä¸­æ–­åœ¨ä¸¤ç§æ¨¡å¼çš„å·®å¼‚ç‚¹ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹éremappingæ¨¡å¼ä¸‹message address å’Œmessage dataçš„formatã€‚</p>
<p><img alt="msi_address" src="images/msi_address.png"></p>
<p><center>å›¾4 </center></p>
<p><img alt="message_data" src="images/message_data.png">
<center>å›¾5</center></p>
<p>å›¾4å’Œå›¾5å‘ˆç°çš„æ˜¯åœ¨éremappingæ¨¡å¼ä¸‹msiçš„addresså’Œdataçš„ç›¸å…³fieldï¼Œä¸‹é¢æˆ‘ä»¬é‡ç‚¹æ¥çœ‹ä¸€ä¸‹remappingæ¨¡å¼ä¸‹çš„addresså’Œdataã€‚</p>
<p><img alt="remap_msi" src="images/remap_msi.png"></p>
<p><center>å›¾6</center></p>
<p>å¯¹ç…§å›¾6è¿˜æ˜¯æ€»ç»“ä¸€ä¸‹åœ¨remappingæ¨¡å¼ä¸‹çš„ä¸åŒç‚¹ï¼š</p>
<ul>
<li>address register bit 4éœ€è¦ç½®ä¸º1ï¼Œè¡¨ç¤ºä¸ºinterrupt remappingæ¨¡å¼ã€‚</li>
<li>adress register bit 3 è¡¨ç¤ºçš„æ˜¯SubHandle Valid(SHV)ï¼Œè¿™é‡Œå¼ºåˆ¶ä¸º1å³SubHandleæ˜¯æœ‰æ•ˆçš„ã€‚</li>
<li>address register bits 19:5 è¡¨ç¤ºçš„æ˜¯interrupt_indexçš„0~14ä½ï¼Œbit 2è¡¨ç¤ºçš„æ˜¯interrupt_indexçš„ç¬¬15ä½ã€‚è¿™é‡Œçš„interrup_indexæŒ‡çš„æ˜¯<strong>Interrupt Remapping Table Entry(IRTE)</strong> å®ƒé‡Œé¢å­˜å‚¨çš„æ˜¯interrupt è¯·æ±‚çš„å…·ä½“å†…å®¹ã€‚é€šå¸¸æƒ…å†µä¸‹pciæˆ–è€…pcieè®¾å¤‡ä¸€èˆ¬éƒ½ä¼šä½¿èƒ½å¤šä¸ªè¿™é‡Œä»¥Næ¥ä»£æ›¿ä¸­æ–­vectorï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬è¦ä¸ºè¿™ä¸ªN ä¸ªvectoråˆ†é…Nä¸ªè¿ç»­çš„IRTE enteriesã€‚è¿™é‡Œçš„interrup_indexæŒ‡çš„æ˜¯ç¬¬ä¸€ä¸ª IRTE entryï¼Œå› ä¸ºSHVæ˜¯enableçš„æ‰€ä»¥åé¢çš„N-1ä¸ªè¿ç»­çš„IRTE entriesæ˜¯é€šè¿‡baseçš„interrupt_indexåŠ ä¸Šè¿™ä¸ªsubhandleæ¥å¯»å€çš„ã€‚</li>
<li>ç¬¬ä¸€ä¸ª IRTE entryçš„data register å…¨éƒ¨è®¾ç½®ä¸º0ï¼ŒåN-1çš„IRTEçš„data register bits 15:0 è®¾ç½®ä¸ºsubhandleã€‚</li>
</ul>
<p>ä¸Šé¢è®²äº†IRTEï¼Œè®²äº†SHVï¼Œè®²äº†interrupt_indexï¼Œè®²äº†subhandleï¼Œè¿™äº›æ¦‚å¿µä¹‹é—´æœ‰ä»€ä¹ˆå…³è”ï¼Ÿiommuç¡¬ä»¶åˆæ˜¯æ€ä¹ˆä½¿ç”¨è¿™äº›ä¿¡æ¯çš„å‘¢ï¼Ÿè¦å›ç­”å¥½è¿™äº›é—®é¢˜æˆ‘ä»¬è¿˜æ˜¯è¦ä»æœ€åº•å±‚æ¥çœ‹ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹åœ¨interrupt remappingæ¨¡å¼ä¸‹ä»¥iommuè§†è§’çœ‹åˆ°çš„message signal interrupt requestæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ</p>
<p><img alt="remap_intrq" src="images/remap_intrq.png">
<center>å›¾7</center>
å½“iommuè§£æå‡ºè¿™äº›ä¿¡æ¯ä¹‹åè®¡ç®—irteçš„ç´¢å¼•çš„å…¬å¼å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">SHV</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">irte_index</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">address</span><span class="p">.</span><span class="nx">handle</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">irte_index</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">address</span><span class="p">.</span><span class="nx">handle</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">subhandle</span>
<span class="p">}</span>
</code></pre></div>

<p>è¿™ä¸ªHANDLEç­‰ä»·äºå›¾6å½“ä¸­çš„interrupt_indexã€‚æ‰¾åˆ°ç›¸åº”çš„irte indexä¹‹åï¼Œiommuç¡¬ä»¶å°±ä¼šç»“åˆç›¸å…³çš„ä¿¡æ¯æŠŠä¸­æ–­deliveryåˆ°ç›¸åº”çš„cpuä¸Šï¼Œå…·ä½“çš„irteçš„æ ¼å¼å¦‚ä¸‹ï¼š</p>
<p><img alt="irte" src="images/irte.png"></p>
<p><center>å›¾8</center>
ä»å›¾8ä¸­æ˜¯ä¸æ˜¯çœ‹åˆ°äº†å¾ˆå¤šç†Ÿæ‚‰çš„fieldï¼Œå…¶å®å°±æ˜¯æŠŠä¸€äº›éremappingæ¨¡å¼ä¸‹çš„fieldç§»åˆ°äº†IRTE entryé‡Œé¢ã€‚</p>
<p>æ­£å¸¸æƒ…å†µä¸‹iommuç¡¬ä»¶æ˜¯èƒ½å¤Ÿå…¼å®¹interrupt remappingå’Œéremappingè¿™ä¸¤ä¸­æ–­è¯·æ±‚çš„ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹éremappingæ¨¡å¼ä¸‹çš„ä¸­æ–­è¯·æ±‚çš„æ ¼å¼ã€‚</p>
<p><img alt="common_intq" src="images/common_intq.png"></p>
<p><center>å›¾9</center>
è®²å®Œäº†è¿™ä¸¤ä¸­ä¸åŒä¸­æ–­æ¨¡å¼çš„interrupt request æ ¼å¼ï¼Œä¸‹é¢æˆ‘ä»¬æ¥è®²ä¸€ä¸‹iommuç¡¬ä»¶æ˜¯å¦‚ä½•å…¼å®¹è¿™ä¸¤ç§ä¸­æ–­è¯·æ±‚çš„ï¼š</p>
<ul>
<li>iommuç¡¬ä»¶é€šè¿‡0xFEEæ¥ç¡®è®¤åˆ°æ¥çš„dmaå†™è¯·æ±‚æ˜¯ä¸æ˜¯ä¸€ä¸ªä¸­æ–­è¯·æ±‚ã€‚</li>
<li>å¦‚æœinterrupt remappingæ²¡æœ‰enable(IRES å­—æ®µåœ¨Global Status Registeræ²¡æœ‰ç½®ä¸Š)ï¼Œåˆ™ä¸­æ–­æŒ‰ç…§Compatibility Format interrupt requestæ¥å¤„ç†ã€‚</li>
<li>å¦‚æœinterrupt remapping enableäº†å³IRESåœ¨Global Status Registerç½®ä½ï¼Œé‚£ä¹ˆä¸­æ–­å…·ä½“å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š<ul>
<li>å¦‚æœinterrupt request æ˜¯compatibility formatåˆ™å…·ä½“å¤„ç†å¦‚ä¸‹ï¼š<ul>
<li>å¦‚æœExtended interrupt Mode enable(Interrupt Remapping Table Address register çš„EIME å­—æ®µè¢«ç½®ä¸Š)æˆ–è€…Compatibility format interrupts è¢«disabled(Global Status registerçš„CFISè¢«clear)åˆ™è¿™ä¸ªä¸­æ–­è¯·æ±‚å°†ä¼šè¢«blockï¼›å¦‚æœä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æˆç«‹åˆ™ä¸­æ–­å°†ä¼špass throughå³bypass remappingã€‚</li>
</ul>
</li>
<li>å¦‚æœinterrupt request æ˜¯ remapping æ ¼å¼åˆ™å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š<ul>
<li>é¦–å…ˆæ£€æŸ¥reserved å­—æ®µæ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸ä¸º0åˆ™ä¸­æ–­è¯·æ±‚è¢«blockï¼›å¦‚æœä¸º0åˆ™source-id, Handle, SHVï¼ŒSubhandleå°†è¢«è§£æå‡ºæ¥</li>
<li>æ ¹æ®è§£æå‡ºæ¥çš„ç›¸å…³ä¿¡æ¯è®¡ç®—irte_indexï¼Œå¦‚æœirte_indexå¤§äºinterrupt remapping tables sizeåˆ™ä¸­æ–­è¯·æ±‚è¢«block</li>
<li>å¦‚æœirte_indexæ˜¯ä¸€ä¸ªåœ¨æ­£å¸¸èŒƒå›´å†…çš„å€¼åˆ™ä»interrupt remapping tableæˆ–è€…ä»interrupt Entry Cacheé‡Œé¢è·å–ç›¸å¯¹åº”çš„IRTEã€‚</li>
<li>å¦‚æœIRTEå­˜åœ¨ï¼Œåˆ™iommuç¡¬ä»¶è¿˜éœ€è¦ç¡®è®¤SVT, SID, SQè¿™äº›å­—æ®µæ˜¯å¦æ­£ç¡®ã€‚</li>
</ul>
</li>
<li>å¦‚æœIRTEçš„Mode field clear(å³IM=0ï¼Œå¦‚æœIM=1åˆ™è¡¨ç¤ºè¿™ä¸ªä¸­æ–­æ˜¯post interruptï¼Œå…³äºpiæˆ‘ä»¬ä¸‹ä¸€ç¯‡å†ç»†è®²)<ul>
<li>iommu ç¡¬ä»¶æ ¹æ®interrupt remapping æ ¼å¼å¯¹IRTEè¿›è¡Œè§£æï¼Œå¦‚æœå‘ç°æŸäº›filedå¼‚å¸¸åˆ™è¯¥ä¸­æ–­è¢«block</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>è®²å®Œäº†è¿™äº›å¤§å®¶å¯èƒ½å·²ç»ç†è§£ä¸­æ–­remappingæ˜¯æ€ä¹ˆä¸€å›äº‹äº†ï¼Œè¿™ä¸ªfeatureçš„é‡ç‚¹å°±åœ¨<strong>remapping</strong>ä¸Šã€‚ä¸ºä»€ä¹ˆè¦remappingå‘¢ï¼Ÿé¦–å…ˆï¼Œé€šè¿‡ä¸Šé¢çš„åˆ†æå¤§å®¶ä¹Ÿéƒ½åº”è¯¥çŸ¥é“åœ¨éè™šæ‹ŸåŒ–çš„åœºæ™¯ä¸‹ç›¸å…³è®¾å¤‡çš„ä¸­æ–­å¤„ç†ä¸€å®šæ˜¯ä¸éœ€è¦remappingçš„ï¼Œæ­£å¦‚å‰é¢çš„è¡Œæ–‡æ‰€è¯´æœ‰ä¸ªCFIS fieldæ¥å†³å®šåœ¨ä¸­æ–­remapping åŠŸèƒ½enableçš„æƒ…å†µä¸‹å¦‚æœCFIS setåˆ™å°±å¯ä»¥å¤„ç†Compatibility format interruptsï¼Œå…·ä½“æè¿°å¦‚ä¸‹ï¼š</p>
<p><img alt="cfis.png" src="images/cfis.png">
<center>å›¾10</center></p>
<p>ä»ä¸Šé¢çš„è§£é‡Šå¯ä»¥çœ‹åˆ°åœ¨interrupt remapping enabledçš„åœºæ™¯ä¸‹ï¼Œ<strong>CFISåªæœ‰åœ¨x2apic disabledçš„æƒ…å†µä¸‹å®ƒæ‰èƒ½èµ·æ•ˆæœã€‚ä½†æ˜¯ç›®å‰ä¸»æµçš„x86çš„æœåŠ¡å™¨x2apicéƒ½æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´CFISå°±æ˜¯è¿™ä¸ªæ‘†è®¾æ ¹æœ¬ç”¨ä¸èµ·æ¥ã€‚æ‰€ä»¥åªè¦æ˜¯iommuæ‰“å¼€çš„åœºæ™¯ä¸‹ï¼Œç›¸å…³è®¾å¤‡çš„msi or msixä¸­æ–­ä¸€å®šæ˜¯èµ°ä¸­æ–­remappingçš„(å³ä½¿ä½ çš„è®¾å¤‡å¹¶ä¸æ˜¯ç›´é€šç»™vmçš„)ï¼Œæ— å½¢ä¸­é™ä½äº†ä¸­æ–­çš„å¤„ç†æ•ˆç‡ã€‚ä»è¿™ä¸€ç‚¹ä¹Ÿèƒ½è¯´æ˜intelåœ¨è®¾è®¡interrup remappingçš„æ—¶å€™è€ƒè™‘çš„å¹¶ä¸æ˜¯å¾ˆå…¨é¢</strong>ã€‚</p>
<p>æˆ‘ä»¬æ¥ç€è¯´è™šæ‹ŸåŒ–åœºæ™¯ï¼Œå¦‚æœä½ æƒ³æŠŠpci or pcieè®¾å¤‡ç›´é€šç»™è™šæ‹Ÿæœºåˆ™ä¸­æ–­remappingæ˜¯å¿…é¡»çš„ï¼ŒåŸå› å…¶å®ä¹Ÿå¾ˆç®€å•ï¼šå› ä¸ºpcieè®¾å¤‡åœ¨hostä¸Šä½¿èƒ½çš„æ—¶å€™å…¶åŸç”Ÿé©±åŠ¨ä¼šä¸ºå…¶åˆ†é…ä¸­æ–­irqï¼Œé‚£ä¹ˆå½“å…¶ç›´é€šåˆ°vmé‡Œé¢çš„æ—¶å€™guest osä¼šå†ä¸€æ¬¡ä¸ºå…¶åˆ†é…ä¸­æ–­irqï¼Œé‚£è¿™ä¸¤è€…å¦‚æœè¦å…³è”èµ·æ¥åªèƒ½é€šè¿‡ä¸­æ–­remappingçš„æ–¹å¼ã€‚</p>
<h3>OSå±‚ä»£ç å®ç°</h3>
<h5>interrupt remappingåˆå§‹åŒ–</h5>
<p>ä¸­æ–­ remapping featureçš„åˆå§‹åŒ–æ˜¯ä»<code>enable_IR_x2apic</code> è¿™ä¸ªå‡½æ•°å¼€å§‹çš„ï¼Œå…·ä½“å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="nt">void</span><span class="w"> </span><span class="nt">__init</span><span class="w"> </span><span class="nt">enable_IR_x2apic</span><span class="o">(</span><span class="nt">void</span><span class="o">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="err">unsigned</span><span class="w"> </span><span class="err">long</span><span class="w"> </span><span class="err">flags</span><span class="p">;</span>
<span class="w">        </span><span class="err">int</span><span class="w"> </span><span class="err">ret,</span><span class="w"> </span><span class="err">ir_stat</span><span class="p">;</span>

<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">(skip_ioapic_setup)</span>
<span class="w">                </span><span class="err">return</span><span class="p">;</span>

<span class="w">        </span><span class="err">ir_stat</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">irq_remapping_prepare()</span><span class="p">;</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">(ir_stat</span><span class="w"> </span><span class="err">&lt;</span><span class="w"> </span><span class="err">0</span><span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"> </span><span class="err">!x2apic_supported())</span>
<span class="w">                </span><span class="err">return</span><span class="p">;</span>

<span class="w">        </span><span class="err">ret</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">save_ioapic_entries()</span><span class="p">;</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">(ret)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="err">pr_info(&quot;Saving</span><span class="w"> </span><span class="err">IO-APIC</span><span class="w"> </span><span class="err">state</span><span class="w"> </span><span class="n">failed</span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">d</span><span class="err">\</span><span class="n">n</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">                </span><span class="err">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nt">local_irq_save</span><span class="o">(</span><span class="nt">flags</span><span class="o">);</span>
<span class="w">        </span><span class="nt">legacy_pic-</span><span class="o">&gt;</span><span class="nt">mask_all</span><span class="o">();</span>
<span class="w">        </span><span class="nt">mask_ioapic_entries</span><span class="o">();</span>

<span class="w">        </span><span class="c">/* If irq_remapping_prepare() succeeded, try to enable it */</span>
<span class="w">        </span><span class="nt">if</span><span class="w"> </span><span class="o">(</span><span class="nt">ir_stat</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nt">0</span><span class="o">)</span>
<span class="w">                </span><span class="nt">ir_stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">try_to_enable_IR</span><span class="o">();</span>
<span class="w">        </span><span class="c">/* ir_stat contains the remap mode or an error code */</span>
<span class="w">        </span><span class="nt">try_to_enable_x2apic</span><span class="o">(</span><span class="nt">ir_stat</span><span class="o">);</span>

<span class="w">        </span><span class="nt">if</span><span class="w"> </span><span class="o">(</span><span class="nt">ir_stat</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nt">0</span><span class="o">)</span>
<span class="w">                </span><span class="nt">restore_ioapic_entries</span><span class="o">();</span>
<span class="w">        </span><span class="nt">legacy_pic-</span><span class="o">&gt;</span><span class="nt">restore_mask</span><span class="o">();</span>
<span class="w">        </span><span class="nt">local_irq_restore</span><span class="o">(</span><span class="nt">flags</span><span class="o">);</span>
<span class="err">}</span>
</code></pre></div>

<p>å…ˆè¯´ä¸€ä¸‹<code>irq_remapping_prepare</code>ï¼Œå…¶æ ¸å¿ƒé€»è¾‘è°ƒç”¨<code>intel_irq_remap_os</code> çš„<code>prepare</code>å³<code>intel_prepare_irq_remapping</code>å‡½æ•°ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å…·ä½“å®ç°é€»è¾‘ã€‚é¦–å…ˆä¼šå»è§£ædmar_tableå¦‚æœå¤§å®¶è¯»è¿‡iommuåˆå§‹åŒ–é‚£ç¯‡æ–‡ç« åº”è¯¥æ˜¯æœ‰æ‰€äº†è§£ï¼Œæ¥ç€ä¼šé€šè¿‡dmarçš„flagæ¥åˆ¤æ–­æ˜¯å¦æ”¯æŒinterrup remappingï¼Œå…·ä½“è§ä¸‹å›¾ä¸­flagç¤ºæ„</p>
<p><img alt="dmar_acpi_table2" src="images/dmar_acpi_table.png">
<center> å›¾11</center>
æ¥ç€åˆ¤æ–­ç³»ç»Ÿå½“ä¸­çš„ioapicæ˜¯ä¸æ˜¯ä¹Ÿéƒ½å·²ç»ä¸enable interrupt remappingçš„iommuç›¸å…³è”èµ·æ¥äº†ã€‚ç„¶åéå†æ‰€æœ‰çš„iommuç¡¬ä»¶æ˜¯ä¸æ˜¯éƒ½æ”¯æŒirq remappingï¼Œä¸»è¦æ˜¯åˆ¤æ–­DMAR_ECAP_REGå¯„å­˜å™¨çš„bit 3æ˜¯å¦ç½®ä½å¦‚ä¸º1åˆ™è¯´æ˜æ”¯æŒirq remappingï¼Œå…·ä½“å¦‚ä¸‹</p>
<p><img alt="ecap_reg" src="images/ecap_reg.png">
<center>å›¾12</center></p>
<p>ç„¶åå¦‚æœç³»ç»Ÿæ”¯æŒx2apicåˆ™é€šè¿‡dmar table flagçš„Flagsçš„bit 1æ¥åˆ¤æ–­iommuç¡¬ä»¶æ˜¯å¦enableäº†x2apic(æ³¨å¦‚æœè¿™ä¸ªbitè¢«æ¸…0åˆ™è¡¨ç¤ºenableäº†)ï¼Œæ¥ç€éå†æ‰€æœ‰çš„iommuç¡¬ä»¶é€šè¿‡æ£€æµ‹å›¾12å½“ä¸­çš„cap regsiterçš„EIM fieldæ˜¯å¦ä¸º0(ä¸º0åˆ™è¡¨ç¤ºåªæ”¯æŒxAPICï¼Œä¸º1åˆ™è¡¨ç¤ºç›´æ¥x2APIC)ï¼Œå¦‚æœæœ‰ä¸€ä¸ªiommuç¡¬ä»¶capä¸æ”¯æŒEIMï¼Œåˆ™æ•´ä¸ªeim_modä¹Ÿä¼šè®¾ç½®ä¸ºfalseã€‚æ¥ä¸‹æ¥æ‰å¼€å§‹è¿›å…¥çœŸæ­£çš„æ ¸å¿ƒé€»è¾‘</p>
<div class="highlight"><pre><span></span><code><span class="w">       </span><span class="n">for_each_iommu</span><span class="p">(</span><span class="n">iommu</span><span class="p">,</span><span class="w"> </span><span class="n">drhd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">intel_setup_irq_remapping</span><span class="p">(</span><span class="n">iommu</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to setup irq remapping for %s\n&quot;</span><span class="p">,</span>
<span class="w">                               </span><span class="n">iommu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">                        </span><span class="n">goto</span><span class="w"> </span><span class="nf">error</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>

<p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°å®ƒä¼šä¸ºæ¯ä¸ªiommuç¡¬ä»¶æ¥åˆ›å»ºirq_remappingç›¸å…³çš„ä¿¡æ¯ï¼Œå…·ä½“è¿˜æ˜¯è¦åˆ†æä¸€ä¸‹<code>intel_setup_irq_remapping</code>è¿™ä¸ªå‡½æ•°ã€‚é¦–å…ˆä¸ºæ¯ä¸ªiommuåˆ†é…ir_tableç»“æ„ï¼Œæ¥ç€åˆ›å»º1Må¤§å°çš„ä¸­æ–­remapping tableï¼Œæ¥ç€åˆ›å»ºbitmapä¸»è¦æ˜¯ç”¨å®ƒæ¥ç®¡ç†tableå½“ä¸­æœ‰å“ªäº›irteå¯ç”¨ï¼Œç„¶åå†åˆ›å»ºir_domainå’Œir_msi_domainè¿™ä¸¤ç±»ä¸­æ–­domainï¼Œlinuxå½“ä¸­çš„irq domainæ˜¯ä¸€ä¸ªæ ‘å½¢ç»“æ„å…·ä½“å…³ç³»å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code>x86_vector_domain ---- çˆ¶äº²
      |
      |
   ir_domain   -------- å„¿å­
      |
      |
   ir_msi_domain -------å­™å­
</code></pre></div>

<p>æ¥ä¸‹æ¥é€šè¿‡<code>iommu_set_irq_remapping</code> è¿™ä¸ªå‡½æ•°æ¥è®¾ç½®irte tableçš„åŸºåœ°å€</p>
<div class="highlight"><pre><span></span><code><span class="kd">addr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">virt_to_phys</span><span class="p">((</span><span class="nx">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="nx">iommu</span><span class="o">-&gt;</span><span class="nx">ir_table</span><span class="o">-&gt;</span><span class="kd">base</span><span class="p">);</span>

<span class="nx">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">iommu</span><span class="o">-&gt;</span><span class="nx">register_lock</span><span class="p">,</span><span class="w"> </span><span class="nx">flags</span><span class="p">);</span>
<span class="c1">//å°†ir tableçš„åŸºåœ°å€å†™åˆ°IRTAå¯„å­˜å™¨</span>
<span class="nx">dmar_writeq</span><span class="p">(</span><span class="nx">iommu</span><span class="o">-&gt;</span><span class="nx">reg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">DMAR_IRTA_REG</span><span class="p">,</span>
<span class="w">                    </span><span class="p">(</span><span class="kd">addr</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">IR_X2APIC_MODE</span><span class="p">(</span><span class="nx">mode</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">INTR_REMAP_TABLE_REG_SIZE</span><span class="p">);</span>
<span class="c1">//è¿™ä¸€æ­¥çš„ä½œç”¨ä¸»æ˜¯é€šçŸ¥ç¡¬ä»¶å»æ›´æ–°irte tableçš„æŒ‡é’ˆï¼Œé¿å…æœ‰cacheæ®‹ç•™</span>
<span class="cm">/* Set interrupt-remapping table pointer */</span>
<span class="nx">writel</span><span class="p">(</span><span class="nx">iommu</span><span class="o">-&gt;</span><span class="nx">gcmd</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">DMA_GCMD_SIRTP</span><span class="p">,</span><span class="w"> </span><span class="nx">iommu</span><span class="o">-&gt;</span><span class="nx">reg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">DMAR_GCMD_REG</span><span class="p">);</span>
</code></pre></div>

<p>ä¸Šé¢åŸºæœ¬ä¸ŠæŠŠæ•´ä¸ªåˆå§‹åŒ–çš„æµç¨‹è®²å®Œäº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹interrupt remappingæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>
<h3>æ€»ç»“</h3>
<p>ä¸Šé¢åŸºæœ¬ä¸ŠæŠŠinterrupt remappingçš„ç¡¬ä»¶å±‚å·¥ä½œåŸç†å’Œè½¯ä»¶å±‚åˆå§‹åŒ–çš„æµç¨‹è®²å®Œäº†ï¼Œåœ¨ä¸‹åœ¨çš„ç« èŠ‚å½“ä¸­ä¼šè¯¦ç»†ä»‹ç»ä¸€ä¸‹interrupt remappingåœ¨è™šæ‹ŸåŒ–å’Œéè™šæ‹ŸåŒ–è¿™ä¸¤ç§åœºæ™¯ä¸‹çš„å·¥ä½œæœºåˆ¶ã€‚</p>

                <!-- å›¾ç‰‡ç”»å»Š -->
            </main>

        <!-- æ–‡ç« åº•éƒ¨åŒºåŸŸ -->
        <footer class="article-footer">
            <!-- æ ‡ç­¾åŒºåŸŸ -->
            <div class="article-tags-section">
                <h4>ğŸ·ï¸ ç›¸å…³æ ‡ç­¾</h4>
                <div class="tags-cloud">
                    <span class="tag-cloud-item">iommu</span>
                    <span class="tag-cloud-item">interrupt remapping</span>
                </div>
            </div>

            <!-- åˆ†äº«å’Œäº’åŠ¨ -->
            <div class="article-interaction">
                <div class="social-share">
                    <h4>ğŸ”— åˆ†äº«è¿™ç¯‡æ–‡ç« </h4>
                    <div class="share-buttons">
                        <a href="#" class="share-btn twitter" target="_blank">ğ• Twitter</a>
                        <a href="#" class="share-btn weibo" target="_blank">ğŸ“ å¾®åš</a>
                        <a href="#" class="share-btn linkedin" target="_blank">ğŸ’¼ LinkedIn</a>
                    </div>
                </div>
            </div>

            <!-- ä½œè€…ç­¾åæ¡£ -->
            <div class="author-signature">
                <div class="signature-content">
                    <h4>å…³äºä½œè€…</h4>
                    <p><strong>å‘¨å®œæ³¢</strong>ï¼Œå­—èŠ‚è·³åŠ¨ç«å±±å¼•æ“AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆï¼Œä¸“æ³¨AI Agentã€GPUæ± åŒ–ã€LLMæ¨ç†ä¼˜åŒ–ç­‰å‰æ²¿æŠ€æœ¯ã€‚</p>
                    <div class="author-social">
                        <a href="https://twitter.com/zhyblife99" target="_blank">ğ• Twitter</a>
                        <span class="wechat-hint">ğŸ’¬ å…³æ³¨å¾®ä¿¡å…¬ä¼—å·è·å–æ›´å¤šå†…å®¹</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <aside class="article-sidebar">
        <!-- æ–‡ç« ä¿¡æ¯å¡ç‰‡ -->
        <div class="sidebar-card article-info-card">
            <h3>ğŸ“Š æ–‡ç« ä¿¡æ¯</h3>
            <div class="info-list">
                <div class="info-item">
                    <span class="info-label">å‘å¸ƒæ—¶é—´</span>
                    <span class="info-value">äºŒ 15 äºŒæœˆ 2022</span>
                </div>
                <div class="info-item">
                    <span class="info-label">åˆ†ç±»</span>
                    <span class="info-value">articles</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¢„è®¡é˜…è¯»</span>
                    <span class="info-value">~10 åˆ†é’Ÿ</span>
                </div>
            </div>
        </div>

        <!-- ç›¸å…³æ–‡ç« æ¨è -->
        <div class="sidebar-card related-articles-card">
            <h3>ğŸ“š ç›¸å…³æ–‡ç« </h3>
            <div class="related-list">
            </div>
        </div>

        <!-- æŠ€æœ¯æ ˆå±•ç¤º -->
        <div class="sidebar-card skills-card">
            <h3>ğŸš€ æŠ€æœ¯æ ˆ</h3>
            <div class="skills-list">
                <span class="skill-item">AI Agent</span>
                <span class="skill-item">GPUæ± åŒ–</span>
                <span class="skill-item">LLMæ¨ç†ä¼˜åŒ–</span>
                <span class="skill-item">é«˜æ€§èƒ½è™šæ‹ŸåŒ–</span>
            </div>
        </div>

        <!-- å…³æ³¨å…¬ä¼—å· -->
        <div class="sidebar-card wechat-card">
            <h3>ğŸ”” è®¢é˜…æ›´æ–°</h3>
            <div class="wechat-content">
                <p>æ‰«ç å…³æ³¨å¾®ä¿¡å…¬ä¼—å·</p>
                <img src="./images/qrcode.jpg" alt="å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç " class="sidebar-qrcode">
                <p class="wechat-name">KernelNote</p>
            </div>
        </div>
    </aside>
</div>

<!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
<button class="back-to-top" id="backToTop">
    <span>â†‘</span>
</button>

<script>
// è¿”å›é¡¶éƒ¨åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const backToTop = document.getElementById('backToTop');

    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTop.style.display = 'block';
        } else {
            backToTop.style.display = 'none';
        }
    });

    // ç‚¹å‡»è¿”å›é¡¶éƒ¨
    backToTop.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // ç›®å½•é«˜äº®
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = document.querySelectorAll('.article-content h2, .article-content h3, .article-content h4');

    function updateTocHighlight() {
        let current = '';
        headings.forEach((heading, index) => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100) {
                current = heading.id;
            }
        });

        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#' + current) {
                link.classList.add('active');
            }
        });
    }

    if (tocLinks.length > 0) {
        window.addEventListener('scroll', updateTocHighlight);
        updateTocHighlight();
    }

    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®å½•é¡¹
    tocLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});
</script>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>        <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>
    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>