<!DOCTYPE html>
<html lang="zh_cn">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="duma" />

        <meta name="description" content="å‰è¨€ firmwareå¯ä»¥ç†è§£ä¸ºæœåŠ¡å™¨ä¸Šä¸€ç±»ä¸“ç”¨è½¯ä»¶ï¼Œå®ƒçš„ä¸»åŠŸèƒ½æ˜¯å¯¹ç›¸å…³è®¾å¤‡æä¾›æ›´åŠ åº•å±‚çš„æ§åˆ¶ã€‚å¸¸è§çš„firmwareæ¯”å¦‚æœåŠ¡å™¨ä¸Šè¦ä½¿ç”¨çš„biosç­‰ï¼Œå¦å¤–ï¼Œç½‘å¡å’Œvgaç­‰è®¾å¤‡éƒ½éœ€è¦ä½¿ç”¨è‡ªå·±å›ºæœ‰çš„fwã€‚åœ¨è¿™ç¯‡æ–‡ç« å½“ä¸­ï¼Œç¬”è€…æ‰“ç®—ç»“åˆi440fx machine å¹³å° â€¦
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="qemu, firmware, articles, " />
        <title>qemuå½“ä¸­firmwareçš„å…·ä½“å®ç°è§£æ  Â· KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link href="https://kernelnote.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢ - Full Atom Feed" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LRRMJ08SPD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LRRMJ08SPD');
</script>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>KernelNote - AIåŸºç¡€è®¾æ–½æŠ€æœ¯åšå®¢</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./pages/about.html">about</a></li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<!-- æ–‡ç« å¤´éƒ¨åŒºåŸŸ -->
<header class="article-header">
    <div class="article-header-container">
        <!-- ä½œè€…ä¿¡æ¯åŒºåŸŸ -->
        <div class="article-author-section">
            <img src="./images/wechat.jpeg" alt="å‘¨æ¯…åš" class="author-avatar">
            <div class="author-info">
                <h3 class="author-name">å‘¨å®œæ³¢</h3>
                <p class="author-title">AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆ | AI Agentä¸“å®¶</p>
            </div>
        </div>

        <!-- æ–‡ç« æ ‡é¢˜å’Œå…ƒä¿¡æ¯ -->
        <div class="article-meta-section">
            <h1 class="article-title">
                qemuå½“ä¸­firmwareçš„å…·ä½“å®ç°è§£æ
            </h1>

            <div class="article-meta-info">
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“…</span>
                    <time datetime="2022-09-25T00:00:00+08:00">æ—¥ 25 ä¹æœˆ 2022</time>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ“</span>
                    <span class="category-tag">articles</span>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">ğŸ·ï¸</span>
                    <span class="article-tag">qemu</span>
                    <span class="article-tag">firmware</span>
                </div>
            </div>

            <!-- å¤šåª’ä½“é“¾æ¥åŒºåŸŸ -->
        </div>
    </div>
</header>

<!-- æ–‡ç« ä¸»ä½“å†…å®¹ -->
<div class="article-container">
    <div class="article-main">
        <!-- æ–‡ç« å†…å®¹ -->
            <main class="article-content article-content-no-toc">
                
                <h4>å‰è¨€</h4>
<p>firmwareå¯ä»¥ç†è§£ä¸ºæœåŠ¡å™¨ä¸Šä¸€ç±»ä¸“ç”¨è½¯ä»¶ï¼Œå®ƒçš„ä¸»åŠŸèƒ½æ˜¯å¯¹ç›¸å…³è®¾å¤‡æä¾›æ›´åŠ åº•å±‚çš„æ§åˆ¶ã€‚å¸¸è§çš„firmwareæ¯”å¦‚æœåŠ¡å™¨ä¸Šè¦ä½¿ç”¨çš„biosç­‰ï¼Œå¦å¤–ï¼Œç½‘å¡å’Œvgaç­‰è®¾å¤‡éƒ½éœ€è¦ä½¿ç”¨è‡ªå·±å›ºæœ‰çš„fwã€‚åœ¨è¿™ç¯‡æ–‡ç« å½“ä¸­ï¼Œç¬”è€…æ‰“ç®—ç»“åˆi440fx machine å¹³å°ä»ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ç»™å¤§å®¶è®²ä¸€ä¸‹firmwareçš„ä½¿èƒ½å’Œæ•°æ®è®¿é—®æœºåˆ¶ï¼š
- bios åŠ è½½æµç¨‹
- bioså¯¹ç›¸å…³æ•°æ®è®¿é—®æœºåˆ¶çš„å®ç°
- ç›¸å…³è®¾å¤‡firmwareå¤„ç†</p>
<h4>BIOSåŠ è½½</h4>
<p>firwmareé€šå¸¸æ˜¯è¦è¢«åŠ è½½åˆ°æŒ‡å®šçš„ROMé‡Œé¢çš„ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹åœ¨qemuå½“ä¸­è¿™ä¸€å—æ˜¯å¦‚ä½•å®ç°çš„ã€‚å…·ä½“çš„é€»è¾‘åœ¨<code>pc_system_firmware_init</code> è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨i440fx machineçš„ <code>pc_init1</code> ä¸­è°ƒç”¨ï¼Œç›¸å…³è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">pc_init1</span><span class="o">-&gt;</span><span class="n">pc_memory_init</span><span class="o">-&gt;</span><span class="n">pc_system_firmware_init</span>
</code></pre></div>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>pc_system_firmware_init</code> å…·ä½“å®ç°ï¼Œå…¶æ ¸å¿ƒé€»è¾‘ä¼šéšç€vmçš„å¯åŠ¨æ–¹å¼ä¸åŒè€Œä¸åŒã€‚</p>
<ul>
<li>å¦‚æœèµ°çš„æ˜¯legacyçš„æ¨¡å¼å³é€šè¿‡ä½¿ç”¨seabiosæ¥å¯åŠ¨ï¼Œåˆ™ä¼šèµ°åˆ°<code>x86_bios_rom_init</code> è¿™ä¸ªå‡½æ•°ã€‚</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">x86_bios_rom_init</span><span class="p">(</span><span class="n">MemoryRegion</span><span class="w"> </span><span class="o">*</span><span class="n">rom_memory</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="w"> </span><span class="n">isapc_ram_fw</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">filename</span><span class="p">;</span>
<span class="w">    </span><span class="n">MemoryRegion</span><span class="w"> </span><span class="o">*</span><span class="n">bios</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">isa_bios</span><span class="p">;</span>
<span class="w">    </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">bios_size</span><span class="p">,</span><span class="w"> </span><span class="n">isa_bios_size</span><span class="p">;</span>
<span class="w">    </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="o">/*</span><span class="w"> </span><span class="n">BIOS</span><span class="w"> </span><span class="nb">load</span><span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bios_name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">bios_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BIOS_FILENAME</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qemu_find_file</span><span class="p">(</span><span class="n">QEMU_FILE_TYPE_BIOS</span><span class="p">,</span><span class="w"> </span><span class="n">bios_name</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">bios_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_image_size</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">bios_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bios_size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="p">(</span><span class="n">bios_size</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">65536</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">goto</span><span class="w"> </span><span class="n">bios_error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">bios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_malloc</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bios</span><span class="p">));</span>
<span class="w">    </span><span class="n">memory_region_init_ram</span><span class="p">(</span><span class="n">bios</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;pc.bios&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bios_size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_fatal</span><span class="p">);</span>

<span class="w">    </span><span class="o">.......</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rom_add_file_fixed</span><span class="p">(</span><span class="n">bios_name</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint32_t</span><span class="p">)(</span><span class="o">-</span><span class="n">bios_size</span><span class="p">),</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="o">.</span><span class="w"> </span><span class="o">......</span>

<span class="w">    </span><span class="o">/*</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="mi">128</span><span class="n">KB</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">BIOS</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">ISA</span><span class="w"> </span><span class="n">space</span><span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="n">isa_bios_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MIN</span><span class="p">(</span><span class="n">bios_size</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">KiB</span><span class="p">);</span>
<span class="w">    </span><span class="n">isa_bios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_malloc</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">isa_bios</span><span class="p">));</span>
<span class="w">    </span><span class="n">memory_region_init_alias</span><span class="p">(</span><span class="n">isa_bios</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;isa-bios&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bios</span><span class="p">,</span>
<span class="w">                             </span><span class="n">bios_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">isa_bios_size</span><span class="p">,</span><span class="w"> </span><span class="n">isa_bios_size</span><span class="p">);</span>
<span class="w">    </span><span class="n">memory_region_add_subregion_overlap</span><span class="p">(</span><span class="n">rom_memory</span><span class="p">,</span>
<span class="w">                                        </span><span class="mh">0x100000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">isa_bios_size</span><span class="p">,</span>
<span class="w">                                        </span><span class="n">isa_bios</span><span class="p">,</span>
<span class="w">                                        </span><span class="mi">1</span><span class="p">);</span>
<span class="w">   </span><span class="o">.......</span>

<span class="w">    </span><span class="o">/*</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">bios</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="n">memory_region_add_subregion</span><span class="p">(</span><span class="n">rom_memory</span><span class="p">,</span>
<span class="w">                                </span><span class="p">(</span><span class="n">uint32_t</span><span class="p">)(</span><span class="o">-</span><span class="n">bios_size</span><span class="p">),</span>
<span class="w">                                </span><span class="n">bios</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>æ ¸å¿ƒå®ç°å¦‚ä¸Šæ‰€ç¤ºï¼Œè¿™ä¸ªå‡½æ•°é‡Œé¢ä¸»è¦å¹²å¦‚ä¸‹å‡ ä»¶äº‹ï¼š</p>
<ul>
<li>æ‰¾åˆ°åå­—ä¸º<code>bios.bin</code> çš„æ–‡ä»¶ï¼Œè·å–å…¶å¤§å°ç„¶åé€šè¿‡<code>rom_add_file_fixed</code> å»åŠ è½½<code>bios.bin</code> çš„æ•°æ®ã€‚</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">rom_add_file_fixed</span><span class="o">-&gt;</span><span class="n">rom_add_file</span>
</code></pre></div>

<p><strong><code>rom_add_file</code> å°†bios.binçš„æ•°æ®è¯»åˆ°<code>rom-&gt;data</code> æ‰€æŒ‡å‘çš„å†…å­˜é‡Œé¢ï¼Œå¹¶å°†<code>rom-&gt;addr</code> èµ‹å€¼ä¸º<code>4G - bios.size</code>ï¼Œç„¶åé€šè¿‡<code>rom_insert</code> å°†è¿™ä¸ª<code>rom</code> æ”¾åˆ°å…¨å±€<code>roms</code> listé‡Œé¢</strong>ã€‚</p>
<ul>
<li>å¦å¤–ä¸€ä»¶æ ¸å¿ƒçš„äº‹æƒ…å°±æ˜¯é€šè¿‡<code>memory_region_init_ram</code> åˆ›å»ºä¸€ä¸ªå¤§å°ä¸º<code>bios_size</code> åä¸º<code>pc.bios</code> çš„<code>ram</code>ï¼ŒåŒæ—¶é€šè¿‡aliasçš„æ–¹å¼åˆ›å»ºä¸€ä¸ªå¤§å°ä¸º128KBçš„isa-bios subregionï¼Œ<strong>è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†å°†<code>bios</code> æœ€åçš„128KBçš„å†…å®¹mapåˆ°èµ·å§‹åœ°å€ä¸º<code>0xe0000</code> çš„å†…å­˜å½“ä¸­ï¼Œæœ€åå°†<code>bios memregion</code>æ·»åŠ ä¸º<code>rom_memory</code> çš„<code>subregion</code>ï¼Œaddrä¸º<code>4G - bios_size</code></strong>ã€‚</li>
</ul>
<p><strong>ä»ä¸Šé¢æ¥çœ‹ï¼Œ<code>pc.bios</code> çš„å†…å­˜ç©ºé—´å’ŒçœŸå®çš„<code>rom file</code> å¹¶æ²¡æœ‰å…³è”èµ·æ¥ï¼Œé‚£è¿™ä¸¤è€…åˆ°åº•æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™äº§ç”Ÿå…³è”çš„å‘¢ï¼Ÿåˆ«ç€æ€¥åé¢ä¼šè¯¦ç»†é“æ¥</strong>ã€‚</p>
<ul>
<li>å¦‚æœvmæ˜¯é€šè¿‡uefiçš„æ–¹å¼æ¥å¯åŠ¨çš„è¯ï¼Œåˆ™biosåŠ è½½çš„æ ¸å¿ƒé€»è¾‘åœ¨<code>pc_system_flash_map</code> è¿™ä¸ªå‡½æ•°ã€‚å†ä»‹ç»è¿™ä¸ªå‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸‹å…³äºflashçš„èƒŒæ™¯çŸ¥è¯†ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚æœvmè¦é€šè¿‡uefiçš„æ–¹å¼å¯åŠ¨åˆ™qemuä¾§çš„ç›¸å…³é…ç½®æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿå…·ä½“å¦‚ä¸‹ï¼š</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="o">-</span><span class="n">drive</span><span class="w"> </span><span class="n">file</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">OVMF</span><span class="o">/</span><span class="n">OVMF_CODE</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span><span class="k">if</span><span class="o">=</span><span class="n">pflash</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">readonly</span><span class="o">=</span><span class="n">on</span><span class="w"> </span>
<span class="o">-</span><span class="n">drive</span><span class="w"> </span><span class="n">file</span><span class="o">=/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">volcstack</span><span class="o">/</span><span class="n">nvram</span><span class="o">/</span><span class="n">OVMF_VARS</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span><span class="k">if</span><span class="o">=</span><span class="n">pflash</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="mi">1</span>
</code></pre></div>

<p>ä»ä¸Šé¢çš„qemu cmdæ¥çœ‹ï¼Œuefi biosçš„åŠ è½½æ˜¯é€šè¿‡qemuå½“ä¸­ç±»å‹ä¸ºpflashçš„block driveæ¥åŠ è½½çš„ï¼Œè€Œä¸”å…¶åŒ…å«äº†ä¸¤éƒ¨åˆ†ï¼š<strong>ä¸€éƒ¨åˆ†ä¸ºovmf codeå³uefi bios çœŸå®è¦è¿è¡Œçš„ä»£ç ï¼Œ å¦ä¸€éƒ¨åˆ†ä¸ºovmf varså³è¿è¡Œçš„æ—¶å€™éœ€è¦çš„ä¸€äº›å˜é‡</strong>ã€‚è‡³äºè¿™ä¸ªdriveå¦‚ä½•è¢«åˆå§‹åŒ–ï¼Œç”±äºè¿™ä¸ªä¸æ˜¯æœ¬ç¯‡æ–‡ç« çš„é‡ç‚¹æ‰€ä»¥è¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚ä¸‹é¢æˆ‘ä»¬æ¥é‡ç‚¹ä»‹ç»ä¸€ä¸‹å­˜å‚¨uefi bios çš„flashæ˜¯å¦‚ä½•è¢«åˆ›å»ºçš„ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>flash</code> çš„åˆ›å»ºæµç¨‹ç›¸å…³è°ƒç”¨å…³ç³»</p>
<div class="highlight"><pre><span></span><code><span class="n">pc_machine_initfn</span><span class="o">-&gt;</span><span class="n">pc_system_flash_create</span><span class="o">-&gt;</span><span class="n">pc_pflash_create</span><span class="o">-&gt;</span><span class="n">qdev_new</span><span class="p">(</span><span class="n">TYPE_PFLASH_CFI01</span><span class="p">)</span>
</code></pre></div>

<p>ä¸Šé¢çš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯åœ¨<code>realiezed</code> ä¹‹å‰ï¼Œå…ˆæŠŠdevç»™åˆ›å»ºå‡ºæ¥ã€‚æ¥ç€å†å›åˆ°<code>pc_system_firmware_init</code> è¿™ä¸ªå‡½æ•°æ¶‰åŠåˆ°ç›¸å…³çš„é€»è¾‘å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pcms</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="o">//</span><span class="n">å°†flashè·Ÿç³»ç»Ÿå½“ä¸­typeä¸ºIF_PFLASHçš„driveå…³è”èµ·æ¥</span>
<span class="w">        </span><span class="n">pflash_cfi01_legacy_drive</span><span class="p">(</span><span class="n">pcms</span><span class="o">-&gt;</span><span class="n">flash</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">,</span>
<span class="w">                                  </span><span class="n">drive_get</span><span class="p">(</span><span class="n">IF_PFLASH</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">));</span>
<span class="w">        </span><span class="o">//</span><span class="n">è·å–ç›¸åº”çš„åç«¯block</span><span class="w"> </span><span class="n">backend</span><span class="err">ï¼Œ</span><span class="n">è¿™é‡Œå°±æ˜¯rawæ ¼å¼çš„file</span>
<span class="w">        </span><span class="n">pflash_blk</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pflash_cfi01_get_blk</span><span class="p">(</span><span class="n">pcms</span><span class="o">-&gt;</span><span class="n">flash</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
</code></pre></div>

<p>å…·ä½“é€»è¾‘è§æ³¨é‡Šï¼Œä¸‹é¢æˆ‘ä»¬è¿˜æ˜¯æ¥ç€çœ‹<code>pc_system_flash_map</code> ï¼Œå…¶æ ¸å¿ƒå®ç°é€»è¾‘å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pcms</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">system_flash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcms</span><span class="o">-&gt;</span><span class="n">flash</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">blk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pflash_cfi01_get_blk</span><span class="p">(</span><span class="n">system_flash</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">blk</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">        </span><span class="k">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blk_getlength</span><span class="p">(</span><span class="n">blk</span><span class="p">);</span>

<span class="w">        </span><span class="p">.........</span>

<span class="w">        </span><span class="n">total_size</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">size</span><span class="p">;</span>
<span class="w">        </span><span class="n">qdev_prop_set_uint32</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">(</span><span class="n">system_flash</span><span class="p">),</span><span class="w"> </span><span class="ss">&quot;num-blocks&quot;</span><span class="p">,</span>
<span class="w">                             </span><span class="k">size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">FLASH_SECTOR_SIZE</span><span class="p">);</span>
<span class="w">        </span><span class="o">//</span><span class="n">è°ƒç”¨realized</span><span class="w"> </span><span class="n">å‡½æ•°</span><span class="err">ï¼Œ</span><span class="n">å¯¹flashè¿›è¡Œåˆå§‹åŒ–</span><span class="w"> </span>
<span class="w">        </span><span class="n">sysbus_realize_and_unref</span><span class="p">(</span><span class="n">SYS_BUS_DEVICE</span><span class="p">(</span><span class="n">system_flash</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_fatal</span><span class="p">);</span>
<span class="w">        </span><span class="n">sysbus_mmio_map</span><span class="p">(</span><span class="n">SYS_BUS_DEVICE</span><span class="p">(</span><span class="n">system_flash</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                        </span><span class="mh">0x100000000</span><span class="n">ULL</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">total_size</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">flash_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pflash_cfi01_get_memory</span><span class="p">(</span><span class="n">system_flash</span><span class="p">);</span>
<span class="w">            </span><span class="n">pc_isa_bios_init</span><span class="p">(</span><span class="n">rom_memory</span><span class="p">,</span><span class="w"> </span><span class="n">flash_mem</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="p">);</span>

<span class="w">            </span><span class="cm">/* Encrypt the pflash boot ROM */</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kvm_memcrypt_enabled</span><span class="p">())</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="n">flash_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memory_region_get_ram_ptr</span><span class="p">(</span><span class="n">flash_mem</span><span class="p">);</span>
<span class="w">                </span><span class="n">flash_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memory_region_size</span><span class="p">(</span><span class="n">flash_mem</span><span class="p">);</span>
<span class="w">                </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kvm_memcrypt_encrypt_data</span><span class="p">(</span><span class="n">flash_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">flash_size</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                    </span><span class="n">error_report</span><span class="p">(</span><span class="ss">&quot;failed to encrypt pflash rom&quot;</span><span class="p">);</span>
<span class="w">                    </span><span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">                </span><span class="err">}</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>
</code></pre></div>

<p>ç»“åˆä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬æ¥ä»”ç»†ç†ä¸€ä¸‹ç›¸å…³å®ç°ï¼š</p>
<ul>
<li>é¦–å…ˆï¼Œå¯¹flashè¿›è¡Œ<code>realized</code> ï¼Œå…·ä½“è°ƒç”¨é€»è¾‘å¦‚ä¸‹</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">sysbus_realize_and_unref</span><span class="o">-&gt;</span><span class="n">pflash_cfi01_realize</span>
</code></pre></div>

<p>æœ€ç»ˆå®ç°åœ¨<code>pflash_cfi01_realize</code> è¿™ä¸ªå‡½æ•°ï¼ŒèŠ‚é€‰æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="n">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">pflash_cfi01_realize</span><span class="p">(</span><span class="n">DeviceState</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="o">**</span><span class="n">errp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ERRP_GUARD</span><span class="p">();</span>
<span class="w">    </span><span class="n">PFlashCFI01</span><span class="w"> </span><span class="o">*</span><span class="n">pfl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PFLASH_CFI01</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">total_len</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="p">......</span>

<span class="w">    </span><span class="n">total_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">sector_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">nb_blocs</span><span class="p">;</span>

<span class="w">    </span><span class="n">memory_region_init_rom_device</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">,</span><span class="w"> </span><span class="n">OBJECT</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">pflash_cfi01_ops</span><span class="p">,</span>
<span class="w">        </span><span class="n">pfl</span><span class="p">,</span>
<span class="w">        </span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">total_len</span><span class="p">,</span><span class="w"> </span><span class="n">errp</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">errp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memory_region_get_ram_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">);</span>
<span class="w">    </span><span class="n">sysbus_init_mmio</span><span class="p">(</span><span class="n">SYS_BUS_DEVICE</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">blk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">perm</span><span class="p">;</span>
<span class="w">        </span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">ro</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">blk_supports_write_perm</span><span class="p">(</span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">blk</span><span class="p">);</span>
<span class="w">        </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BLK_PERM_CONSISTENT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">ro</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">BLK_PERM_WRITE</span><span class="p">);</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blk_set_perm</span><span class="p">(</span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">blk</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">,</span><span class="w"> </span><span class="n">BLK_PERM_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">errp</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">ro</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">blk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">blk_check_size_and_read_all</span><span class="p">(</span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">blk</span><span class="p">,</span><span class="w"> </span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="n">total_len</span><span class="p">,</span>
<span class="w">                                         </span><span class="n">errp</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">vmstate_unregister_ram</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfl</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE</span><span class="p">(</span><span class="n">pfl</span><span class="p">));</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">......</span>
<span class="p">}</span>
</code></pre></div>

<p>ç»“åˆä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹å…·ä½“çš„å®ç°ï¼š</p>
<p>1) <code>memory_region_init_rom_device</code> åˆå§‹åŒ–ä¸€æ®µromçš„å†…å­˜ï¼Œå¹¶ç»‘å®šç›¸åº”çš„<code>mem ops</code>ã€‚qemuå½“ä¸­<code>rom</code> å†…å­˜éƒ½æ˜¯åªè¯»çš„ä¸”ä½œä¸ºä¸€æ®µram mapåˆ°guestå†…å­˜ç©ºé—´ã€‚å¯¹è¿™æ®µå†…å­˜çš„è¯»å°±ç›´æ¥èµ°æ™®é€šçš„å†…å­˜è¯»å†™çš„æ–¹å¼ï¼Œå†™çš„è¯å› ä¸ºè¿™æ®µå†…å­˜æ˜¯<code>read only</code> æ‰€ä»¥ä¼štrapåˆ°qemuç„¶åæ‰§è¡Œè¯¥æ®µå†…å­˜ç»‘å®šçš„opsæ‰€å¯¹åº”çš„<code>write</code></p>
<p>2) <code>sysbus_init_mmio</code> åˆå§‹åŒ–<code>flash</code> è®¾å¤‡å¯¹åº”çš„mmioç©ºé—´ã€‚</p>
<p>3) å°†æ•°æ®ä»ç£ç›˜è¯»åˆ°flashæ‰€å¯¹åº”çš„å†…å­˜å½“ä¸­ã€‚</p>
<ul>
<li>
<p>æ¥ç€è°ƒç”¨ <code>sysbus_mmio_map</code> å¯¹ä¸Šé¢mmioç©ºé—´è¿›è¡Œæ˜ å°„ï¼Œèµ·å§‹åœ°å€ä¸º<code>4G - file.size</code></p>
</li>
<li>
<p>æœ€åè°ƒç”¨<code>pc_isa_bios_init</code> å°† uefi biosæœ€å128KBæ˜ å°„åˆ°isa spaceï¼Œå…·ä½“åšæ³•è·Ÿleacyæ¨¡å¼ä¸€æ ·è¿™é‡Œå°±ä¸ç»†è®²äº†ã€‚</p>
</li>
</ul>
<h4>BIOSå¯¹ç›¸å…³æ•°æ®è®¿é—®</h4>
<p>ä¸Šé¢èŠå®Œäº†biosçš„åŠ è½½ï¼Œä¸‹é¢æˆ‘ä»¬æ¥èŠèŠqemuå½“ä¸­BIOSå¯¹ç›¸å…³æ•°æ®è®¿é—®å®ç°ã€‚ä¸ºäº†BIOSæ›´åŠ æ–¹ä¾¿çš„è®¿é—®ç›¸å…³çš„æ•°æ®æ¯”å¦‚cpuä¸ªæ•°ï¼ŒACPIè¡¨ï¼Œmemç­‰ä¿¡æ¯qemué‡Œé¢å¼•å…¥äº†<code>fw_cfg</code> æœºåˆ¶ã€‚ç®€å•çš„æ¥è¯´fw_cfgå½“ä¸­å®šä¹‰äº†ä¸€ç³»åˆ—çš„keyå’Œvalueï¼Œç„¶åbiosé€šè¿‡port ioæ¥è¿›è¡Œç›¸å…³çš„è®¿é—®ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç›¸å…³å®ç°ï¼Œå…·ä½“å‡½æ•°ä¸º<code>fw_cfg_arch_create</code> ï¼Œåœ¨å…¶å®ç°å½“ä¸­ä¸»è¦åšäº†ä¸‹é¢å‡ ä¸ªäº‹æƒ…ï¼š</p>
<ul>
<li>è°ƒç”¨<code>fw_cfg_init_io_dma</code> åˆ›å»º<code>TYPE_FW_CFG_IO</code> è®¾å¤‡å’Œç»‘å®šç›¸å…³<code>port io</code>ã€‚å…¶ä¸­<code>iobase ä¸º0x511, dma_iobase ä¸º0x515</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nx">FWCfgState</span><span class="w"> </span><span class="o">*</span><span class="nx">fw_cfg_init_io_dma</span><span class="p">(</span><span class="nx">uint32_t</span><span class="w"> </span><span class="nx">iobase</span><span class="p">,</span><span class="w"> </span><span class="nx">uint32_t</span><span class="w"> </span><span class="nx">dma_iobase</span><span class="p">,</span>
<span class="w">                                </span><span class="nx">AddressSpace</span><span class="w"> </span><span class="o">*</span><span class="nx">dma_as</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nx">DeviceState</span><span class="w"> </span><span class="o">*</span><span class="nx">dev</span><span class="p">;</span>
<span class="w">    </span><span class="nx">SysBusDevice</span><span class="w"> </span><span class="o">*</span><span class="nx">sbd</span><span class="p">;</span>
<span class="w">    </span><span class="nx">FWCfgIoState</span><span class="w"> </span><span class="o">*</span><span class="nx">ios</span><span class="p">;</span>
<span class="w">    </span><span class="nx">FWCfgState</span><span class="w"> </span><span class="o">*</span><span class="nx">s</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nx">dma_requested</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">dma_iobase</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">dma_as</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//åˆ›å»ºTYPE_FW_CFG_IOè®¾å¤‡</span>
<span class="w">    </span><span class="nx">dev</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">qdev_new</span><span class="p">(</span><span class="nx">TYPE_FW_CFG_IO</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">dma_requested</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">qdev_prop_set_bit</span><span class="p">(</span><span class="nx">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;dma_enabled&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">object_property_add_child</span><span class="p">(</span><span class="nx">OBJECT</span><span class="p">(</span><span class="nx">qdev_get_machine</span><span class="p">()),</span><span class="w"> </span><span class="nx">TYPE_FW_CFG</span><span class="p">,</span>
<span class="w">                              </span><span class="nx">OBJECT</span><span class="p">(</span><span class="nx">dev</span><span class="p">));</span>

<span class="w">    </span><span class="nx">sbd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">SYS_BUS_DEVICE</span><span class="p">(</span><span class="nx">dev</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//è°ƒç”¨devçš„realizedå‡½æ•°</span>
<span class="w">    </span><span class="nx">sysbus_realize_and_unref</span><span class="p">(</span><span class="nx">sbd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">error_fatal</span><span class="p">);</span>
<span class="w">    </span><span class="nx">ios</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">FW_CFG_IO</span><span class="p">(</span><span class="nx">dev</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//å°†com_iomemä¸iobaseç»‘å®š</span>
<span class="w">    </span><span class="nx">sysbus_add_io</span><span class="p">(</span><span class="nx">sbd</span><span class="p">,</span><span class="w"> </span><span class="nx">iobase</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">ios</span><span class="o">-&gt;</span><span class="nx">comb_iomem</span><span class="p">);</span>

<span class="w">    </span><span class="nx">s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">FW_CFG</span><span class="p">(</span><span class="nx">dev</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="o">-&gt;</span><span class="nx">dma_enabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* 64 bits for the address field */</span>
<span class="w">        </span><span class="nx">s</span><span class="o">-&gt;</span><span class="nx">dma_as</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">dma_as</span><span class="p">;</span>
<span class="w">        </span><span class="nx">s</span><span class="o">-&gt;</span><span class="nx">dma_addr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//å°†dam_iomemä¸dma_iobaseç»‘å®š</span>
<span class="w">        </span><span class="nx">sysbus_add_io</span><span class="p">(</span><span class="nx">sbd</span><span class="p">,</span><span class="w"> </span><span class="nx">dma_iobase</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">s</span><span class="o">-&gt;</span><span class="nx">dma_iomem</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>ç›¸å…³é€»è¾‘å¦‚ä¸Šï¼Œè¿™é‡Œé‡ç‚¹è®²ä¸€ä¸‹<code>sysbus_realize_and_unref</code> ï¼Œå®ƒæœ€ç»ˆè°ƒç”¨çš„å‡½æ•°ä¸º<code>fw_cfg_io_realize</code>ï¼Œå…¶æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="nx">static</span><span class="w"> </span><span class="nx">void</span><span class="w"> </span><span class="nx">fw_cfg_io_realize</span><span class="p">(</span><span class="nx">DeviceState</span><span class="w"> </span><span class="o">*</span><span class="nx">dev</span><span class="p">,</span><span class="w"> </span><span class="nx">Error</span><span class="w"> </span><span class="o">**</span><span class="nx">errp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nx">ERRP_GUARD</span><span class="p">();</span>
<span class="w">    </span><span class="nx">FWCfgIoState</span><span class="w"> </span><span class="o">*</span><span class="nx">s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">FW_CFG_IO</span><span class="p">(</span><span class="nx">dev</span><span class="p">);</span>

<span class="w">    </span><span class="nx">fw_cfg_file_slots_allocate</span><span class="p">(</span><span class="nx">FW_CFG</span><span class="p">(</span><span class="nx">s</span><span class="p">),</span><span class="w"> </span><span class="nx">errp</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">errp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* when using port i/o, the 8-bit data register ALWAYS overlaps</span>
<span class="cm">     * with half of the 16-bit control register. Hence, the total size</span>
<span class="cm">     * of the i/o region used is FW_CFG_CTL_SIZE */</span>
<span class="w">    </span><span class="nx">memory_region_init_io</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">s</span><span class="o">-&gt;</span><span class="nx">comb_iomem</span><span class="p">,</span><span class="w"> </span><span class="nx">OBJECT</span><span class="p">(</span><span class="nx">s</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">fw_cfg_comb_mem_ops</span><span class="p">,</span>
<span class="w">                          </span><span class="nx">FW_CFG</span><span class="p">(</span><span class="nx">s</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;fwcfg&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">FW_CFG_CTL_SIZE</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">FW_CFG</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">dma_enabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">memory_region_init_io</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">FW_CFG</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">dma_iomem</span><span class="p">,</span><span class="w"> </span><span class="nx">OBJECT</span><span class="p">(</span><span class="nx">s</span><span class="p">),</span>
<span class="w">                              </span><span class="o">&amp;</span><span class="nx">fw_cfg_dma_mem_ops</span><span class="p">,</span><span class="w"> </span><span class="nx">FW_CFG</span><span class="p">(</span><span class="nx">s</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;fwcfg.dma&quot;</span><span class="p">,</span>
<span class="w">                              </span><span class="nx">sizeof</span><span class="p">(</span><span class="nx">dma_addr_t</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">fw_cfg_common_realize</span><span class="p">(</span><span class="nx">dev</span><span class="p">,</span><span class="w"> </span><span class="nx">errp</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>1) è°ƒç”¨<code>memory_region_init_io</code> å¯¹<code>comb_iomem</code> å’Œ<code>dma_iomem</code> ç›¸å…³è”çš„<code>mem_ops</code> è¿›è¡Œåˆå§‹åŒ–</p>
<p>2) è°ƒç”¨<code>fw_cfg_common_realize</code> å¯¹<code>fw_cfg</code> é€šç”¨éƒ¨åˆ†è¿›è¡Œåˆå§‹åŒ–ï¼Œæ¯”å¦‚<code>FW_CFG_UUID</code> ï¼Œ<code>FW_CFG_ID</code>ï¼Œ<code>FW_CFG_BOOT_MENU</code> ç­‰ã€‚å¦å¤–å°±æ˜¯è®¾ç½®<code>fw_cfg_machine_ready</code> call backã€‚</p>
<p>å›åˆ°<code>fw_cfg_arch_create</code> ç»§ç»­å¾€ä¸‹çœ‹ï¼Œä¸Šé¢åˆå§‹åŒ–å®Œioä¹‹åå¼€å§‹è°ƒç”¨<code>fw_cfg_add_xxx</code>çš„æ¥å£æ·»åŠ ä¸€äº›keyå’Œvalueã€‚æ¯”è¾ƒé‡è¦çš„æœ‰</p>
<div class="highlight"><pre><span></span><code>FW_CFG_NB_CPUS FW_CFG_MAX_XPUS FW_CFG_ACPI_TABLES FW_CFG_E820_TABLE FW_CFG_NUMA
</code></pre></div>

<p>å»ºè®®å¤§å®¶å¯ä»¥ç¿»ä»£ç å†ä»”ç»†çœ‹ä¸€ï¼Œè¿™äº›ä¿¡æ¯åœ¨biosé˜¶æ®µéœ€è¦è¯»å–çš„ä¸€äº›ä¿¡æ¯ã€‚</p>
<h4>è®¾å¤‡fwçš„å¤„ç†</h4>
<p>åœ¨qemuå½“ä¸­åˆ†ä¸ºpciè®¾å¤‡å’Œépciè®¾å¤‡æ¯”å¦‚æŒ‚åœ¨isa busä¸Šçš„isa deviceã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹pciè®¾å¤‡fwçš„åŠ è½½ï¼Œå…·ä½“å®ç°åœ¨<code>pci_add_option_rom</code>ã€‚<strong>é€šå¸¸pciè®¾å¤‡æœ‰ä¸€ä¸ªä¸“é—¨çš„rom barï¼Œè®¾å¤‡çš„fwä¼šè¢«åŠ è½½åˆ°è¿™ä¸ªrom baré‡Œé¢</strong>ã€‚æ ¸å¿ƒé€»è¾‘èŠ‚é€‰å¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="o">......</span>

<span class="w">    </span><span class="o">//</span><span class="err">åˆå§‹åŒ–ä¸€æ®µ</span><span class="n">romå†…å­˜</span>
<span class="w">    </span><span class="n">memory_region_init_rom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">rom</span><span class="p">,</span><span class="w"> </span><span class="n">OBJECT</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">romsize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_fatal</span><span class="p">);</span>
<span class="w">    </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memory_region_get_ram_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">rom</span><span class="p">);</span>
<span class="w">    </span><span class="o">//</span><span class="err">å°†</span><span class="n">romfileåŠ è½½åˆ°ä¸Šé¢åˆ†é…çš„å†…å­˜å½“ä¸­</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">load_image_size</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error_setg</span><span class="p">(</span><span class="n">errp</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;failed to load romfile </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">romfile</span><span class="p">);</span>
<span class="w">        </span><span class="n">g_free</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">g_free</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_default_rom</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">/*</span><span class="w"> </span><span class="n">Only</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">default</span><span class="w"> </span><span class="n">rom</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">patched</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="n">needed</span><span class="p">)</span><span class="o">.</span><span class="w"> </span><span class="o">*/</span>
<span class="w">        </span><span class="o">//</span><span class="err">å¯¹ç›¸å…³</span><span class="n">romfileä¿¡æ¯è¿›è¡Œç¡®è®¤</span>
<span class="w">        </span><span class="n">pci_patch_ids</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="o">//</span><span class="err">æ³¨å†Œ</span><span class="n">rom</span><span class="w"> </span><span class="n">bar</span><span class="w"> </span>
<span class="w">    </span><span class="n">pci_register_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="w"> </span><span class="n">PCI_ROM_SLOT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">rom</span><span class="p">);</span>

<span class="w">    </span><span class="o">......</span>
</code></pre></div>

<p>éè¦pciè®¾å¤‡ä¸»è¦æ˜¯é€šè¿‡<code>rom_add_vga</code> å’Œ<code>rom_add_option</code> è¿™ä¸¤ä¸ªromæ“ä½œå‡½æ•°ã€‚ä»–ä»¬æœ€ç»ˆè°ƒç”¨çš„å‡½æ•°éƒ½æ˜¯<code>rom_add_file</code> ä¸Šé¢ä¹Ÿæœ‰ä»‹ç»ï¼Œè¿™é‡Œé¢å†é‡ç‚¹æè¿°ä¸€ä¸‹ä»–çš„é€»è¾‘ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="n">ssize_t</span><span class="w"> </span><span class="n">rom_add_file</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">fw_dir</span><span class="p">,</span>
<span class="w">                     </span><span class="n">hwaddr</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">int32_t</span><span class="w"> </span><span class="n">bootindex</span><span class="p">,</span>
<span class="w">                     </span><span class="nb nb-Type">bool</span><span class="w"> </span><span class="n">option_rom</span><span class="p">,</span><span class="w"> </span><span class="n">MemoryRegion</span><span class="w"> </span><span class="o">*</span><span class="n">mr</span><span class="p">,</span>
<span class="w">                     </span><span class="n">AddressSpace</span><span class="w"> </span><span class="o">*</span><span class="k">as</span><span class="p">)</span>
</code></pre></div>

<p><strong>é¦–å…ˆä¼šæŠŠ<code>rom_file</code> æ•°æ®è¯»åˆ°<code>rom-&gt;data</code> é‡Œé¢ï¼Œç„¶åæ‰§è¡Œ<code>rom_insert</code>ã€‚æ¥ä¸‹æ¥å¦‚æœfw_dirä¸ä¸ºç©ºåˆ™é€šè¿‡<code>fw_cfg_add_file</code> å°†romæ•°æ®æ·»åŠ åˆ°<code>fw_cfg</code> å½“ä¸­ã€‚åä¹‹ï¼Œå¦‚æœfw_dirä¸ºç©ºä½†mrä¸ç©ºåˆ™å°†<code>mr</code>èµ‹ç»™<code>rom-&gt;mr</code>ã€‚æ³¨æ„è¿™ä¸ªæ—¶å€™<code>mr</code>è·Ÿ<code>data</code> è¿˜æ˜¯æ²¡æœ‰å…³è”èµ·æ¥ï¼Œé‚£åˆ°åº•æ˜¯ä»€ä¹ˆæ—¶å€™å‘ç”Ÿå…³è”çš„å‘¢ï¼Ÿä¸Šé¢ä¹Ÿæœ‰æ‰€æåŠï¼Œè¿™é‡Œæˆ‘ä»¬èŠ±ç‚¹æ—¶é—´çœ‹ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚ç­”æ¡ˆå°±æ˜¯åœ¨<code>rom_reset</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹rom_resetæ ¸å¿ƒé€»è¾‘</strong></p>
<div class="highlight"><pre><span></span><code><span class="nx">static</span><span class="w"> </span><span class="nx">void</span><span class="w"> </span><span class="nx">rom_reset</span><span class="p">(</span><span class="nx">void</span><span class="w"> </span><span class="o">*</span><span class="nx">unused</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nx">Rom</span><span class="w"> </span><span class="o">*</span><span class="nx">rom</span><span class="p">;</span>

<span class="w">    </span><span class="nx">QTAILQ_FOREACH</span><span class="p">(</span><span class="nx">rom</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">roms</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">fw_file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * We don&#39;t need to fill in the RAM with ROM data because we&#39;ll fill</span>
<span class="cm">         * the data in during the next incoming migration in all cases.  Note</span>
<span class="cm">         * that some of those RAMs can actually be modified by the guest.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">runstate_check</span><span class="p">(</span><span class="nx">RUN_STATE_INMIGRATE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">isrom</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="cm">/*</span>
<span class="cm">                 * Free it so that a rom_reset after migration doesn&#39;t</span>
<span class="cm">                 * overwrite a potentially modified &#39;rom&#39;.</span>
<span class="cm">                 */</span>
<span class="w">                </span><span class="nx">rom_free_data</span><span class="p">(</span><span class="nx">rom</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">data</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">mr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//å¦‚æœå·²ç»æŒ‡å®šäº†rom mrï¼Œåˆ™å°†æ•°æ®copyåˆ°mrçš„å†…å­˜åŒºåŸŸ</span>
<span class="w">            </span><span class="nx">void</span><span class="w"> </span><span class="o">*</span><span class="nx">host</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">memory_region_get_ram_ptr</span><span class="p">(</span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">mr</span><span class="p">);</span>
<span class="w">            </span><span class="nx">memcpy</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">datasize</span><span class="p">);</span>
<span class="w">            </span><span class="nx">memset</span><span class="p">(</span><span class="nx">host</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">datasize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">romsize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">datasize</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//é€šè¿‡åœ°å€æ‰¾åˆ°ç›¸åº”çš„å†…å­˜ç©ºé—´ï¼Œæ¯”å¦‚ä¸Šé¢çš„pc.bios</span>
<span class="w">            </span><span class="nx">address_space_write_rom</span><span class="p">(</span><span class="nx">rom</span><span class="o">-&gt;</span><span class="k">as</span><span class="p">,</span><span class="w"> </span><span class="nx">rom</span><span class="o">-&gt;</span><span class="kd">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">MEMTXATTRS_UNSPECIFIED</span><span class="p">,</span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">datasize</span><span class="p">);</span>

<span class="w">            </span><span class="nx">address_space_set</span><span class="p">(</span><span class="nx">rom</span><span class="o">-&gt;</span><span class="k">as</span><span class="p">,</span><span class="w"> </span><span class="nx">rom</span><span class="o">-&gt;</span><span class="kd">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">datasize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                              </span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">romsize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">rom</span><span class="o">-&gt;</span><span class="nx">datasize</span><span class="p">,</span>
<span class="w">                              </span><span class="nx">MEMTXATTRS_UNSPECIFIED</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="o">......</span><span class="p">..</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>å…¶ä¸­<code>rom_reset</code> è°ƒç”¨æµç¨‹ä¸º</p>
<div class="highlight"><pre><span></span><code><span class="n">qemu_system_wakeup</span><span class="o">-&gt;</span><span class="n">qemu_device_reset</span><span class="o">-&gt;</span><span class="n">rom_reset</span>

<span class="err">æ³¨ï¼š</span><span class="n">rom_resetä¸ºæ³¨å†Œåœ¨reset</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">listä¸Šçš„ä¸€ä¸ªcallbackå‡½æ•°</span>
</code></pre></div>

<h4>æ€»ç»“</h4>
<p>åŸºäºä¸Šé¢æ‰€è®²æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼Œé¦–å…ˆbiosä¼šè¢«åŠ è½½åˆ°ä¸€æ®µromçš„å†…å­˜å½“ä¸­ï¼Œè¿™æ®µread onlyçš„å†…å­˜ä¼šè¢«mapåˆ°guestå†…å­˜ç©ºé—´ã€‚å¦å¤– ï¼Œä¸ºäº†è®©biosåœ¨å¯åŠ¨çš„è¿‡ç¨‹å½“ä¸­æ›´å¥½çš„å»è®¿é—®æŸäº›æ•°æ®ï¼Œqemuå½“ä¸­å®ç°äº†fw_cfgæœºåˆ¶ã€‚æœ€åï¼Œè®¾å¤‡ç›¸å…³çš„<code>rom file</code>çš„å¤„ç†æ–¹å¼ä¹Ÿåˆ†ä¸ºä¸¤ç§ï¼šä¸€ç§æ˜¯pciè®¾å¤‡ä¼šæœ‰ä¸“é—¨çš„<code>rom bar</code>ï¼Œå¦ä¸€ç§æ˜¯épciè®¾å¤‡åˆ™å¯ä»¥åŠ è½½åˆ°å†…å­˜å½“ä¸­ä¹Ÿå¯ä»¥é€šè¿‡<code>fw_cfg</code>æ¥è¯»å–ã€‚</p>

                <!-- å›¾ç‰‡ç”»å»Š -->
            </main>

        <!-- æ–‡ç« åº•éƒ¨åŒºåŸŸ -->
        <footer class="article-footer">
            <!-- æ ‡ç­¾åŒºåŸŸ -->
            <div class="article-tags-section">
                <h4>ğŸ·ï¸ ç›¸å…³æ ‡ç­¾</h4>
                <div class="tags-cloud">
                    <span class="tag-cloud-item">qemu</span>
                    <span class="tag-cloud-item">firmware</span>
                </div>
            </div>

            <!-- åˆ†äº«å’Œäº’åŠ¨ -->
            <div class="article-interaction">
                <div class="social-share">
                    <h4>ğŸ”— åˆ†äº«è¿™ç¯‡æ–‡ç« </h4>
                    <div class="share-buttons">
                        <a href="#" class="share-btn twitter" target="_blank">ğ• Twitter</a>
                        <a href="#" class="share-btn weibo" target="_blank">ğŸ“ å¾®åš</a>
                        <a href="#" class="share-btn linkedin" target="_blank">ğŸ’¼ LinkedIn</a>
                    </div>
                </div>
            </div>

            <!-- ä½œè€…ç­¾åæ¡£ -->
            <div class="author-signature">
                <div class="signature-content">
                    <h4>å…³äºä½œè€…</h4>
                    <p><strong>å‘¨å®œæ³¢</strong>ï¼Œå­—èŠ‚è·³åŠ¨ç«å±±å¼•æ“AIåŸºç¡€è®¾æ–½æ¶æ„å¸ˆï¼Œä¸“æ³¨AI Agentã€GPUæ± åŒ–ã€LLMæ¨ç†ä¼˜åŒ–ç­‰å‰æ²¿æŠ€æœ¯ã€‚</p>
                    <div class="author-social">
                        <a href="https://twitter.com/zhyblife99" target="_blank">ğ• Twitter</a>
                        <span class="wechat-hint">ğŸ’¬ å…³æ³¨å¾®ä¿¡å…¬ä¼—å·è·å–æ›´å¤šå†…å®¹</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <aside class="article-sidebar">
        <!-- æ–‡ç« ä¿¡æ¯å¡ç‰‡ -->
        <div class="sidebar-card article-info-card">
            <h3>ğŸ“Š æ–‡ç« ä¿¡æ¯</h3>
            <div class="info-list">
                <div class="info-item">
                    <span class="info-label">å‘å¸ƒæ—¶é—´</span>
                    <span class="info-value">æ—¥ 25 ä¹æœˆ 2022</span>
                </div>
                <div class="info-item">
                    <span class="info-label">åˆ†ç±»</span>
                    <span class="info-value">articles</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¢„è®¡é˜…è¯»</span>
                    <span class="info-value">~10 åˆ†é’Ÿ</span>
                </div>
            </div>
        </div>

        <!-- ç›¸å…³æ–‡ç« æ¨è -->
        <div class="sidebar-card related-articles-card">
            <h3>ğŸ“š ç›¸å…³æ–‡ç« </h3>
            <div class="related-list">
            </div>
        </div>

        <!-- æŠ€æœ¯æ ˆå±•ç¤º -->
        <div class="sidebar-card skills-card">
            <h3>ğŸš€ æŠ€æœ¯æ ˆ</h3>
            <div class="skills-list">
                <span class="skill-item">AI Agent</span>
                <span class="skill-item">GPUæ± åŒ–</span>
                <span class="skill-item">LLMæ¨ç†ä¼˜åŒ–</span>
                <span class="skill-item">é«˜æ€§èƒ½è™šæ‹ŸåŒ–</span>
            </div>
        </div>

        <!-- å…³æ³¨å…¬ä¼—å· -->
        <div class="sidebar-card wechat-card">
            <h3>ğŸ”” è®¢é˜…æ›´æ–°</h3>
            <div class="wechat-content">
                <p>æ‰«ç å…³æ³¨å¾®ä¿¡å…¬ä¼—å·</p>
                <img src="./images/qrcode.jpg" alt="å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç " class="sidebar-qrcode">
                <p class="wechat-name">KernelNote</p>
            </div>
        </div>
    </aside>
</div>

<!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
<button class="back-to-top" id="backToTop">
    <span>â†‘</span>
</button>

<script>
// è¿”å›é¡¶éƒ¨åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const backToTop = document.getElementById('backToTop');

    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTop.style.display = 'block';
        } else {
            backToTop.style.display = 'none';
        }
    });

    // ç‚¹å‡»è¿”å›é¡¶éƒ¨
    backToTop.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // ç›®å½•é«˜äº®
    const tocLinks = document.querySelectorAll('.toc-nav a');
    const headings = document.querySelectorAll('.article-content h2, .article-content h3, .article-content h4');

    function updateTocHighlight() {
        let current = '';
        headings.forEach((heading, index) => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100) {
                current = heading.id;
            }
        });

        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#' + current) {
                link.classList.add('active');
            }
        });
    }

    if (tocLinks.length > 0) {
        window.addEventListener('scroll', updateTocHighlight);
        updateTocHighlight();
    }

    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®å½•é¡¹
    tocLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});
</script>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>        <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>
    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>